<!DOCTYPE html>
<html class="ui-page-login">

	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<title></title>
		<link href="../css/mui.min.css" rel="stylesheet" />
		<link href="../css/login.css" rel="stylesheet" />
	</head>

	<body style="height:100%;">
		<div class="mui-content tc" style="background:#F2F2F2;height:100%;">
			<img src="../images/logo.png" style="margin: 10%;" />
			<div id="login-form">
				<div class="mb10">
					<img src="../images/login/name.png" />
					<input id='account' type="text" class="mui-input-clear mui-input f13 txt" placeholder="请输入账号/手机号" />
				</div>
				<div>
					<img src="../images/login/pwd.png" />
					<input id='password' type="password" class="mui-input-clear mui-input f13 txt" placeholder="请输入密码" />
				</div>
			</div>
			<div style="width:80%;line-height:30px;margin:0px auto;" class="tc">
				<img id='login' src="../images/login.png" class="mt20" style="width:100%;" />
				<a id='reg' class="fl csubtitle f13">没有账号?</a>
				<a id='forgetPassword' class="fr csubtitle f13">忘记密码?</a>
			</div>
			<!--第三方登录-->
			<div class="mui-content-padded oauth-area">

			</div>
		</div>

	</body>

</html>
<script src="../js/default.js"></script>
<script src="../js/mui.min.js"></script>
<script src="../js/jquery-1.10.2.min.js"></script>
<script src="../js/login.js"></script>
<script src="../js/base.js"></script>
<script type="text/javascript">
	mui.init({
		statusBarBackground: '#f7f7f7'
	});

	//检查 "登录状态/锁屏状态" 结束
	var loginButton = document.getElementById('login');
	var accountBox = document.getElementById('account');
	var passwordBox = document.getElementById('password');

	//跳转首页
	var toMain = function() {
		mui.openWindow({
			id: 'index',
			url: '../index.html',
			show: {
				autoShow: true,
				duration: base.AnimateDuration
			},
			waiting: {
				autoShow: false
			}
		});
	};
	mui.plusReady(function() {
		plus.screen.lockOrientation("portrait-primary");
		var settings = app.getSettings();

		//第三方登录
		var authBtns = ['qihoo', 'weixin', 'sinaweibo', 'qq']; //配置业务支持的第三方登录
		var auths = {};
		var oauthArea = document.querySelector('.oauth-area');
		plus.oauth.getServices(function(services) {
			for(var i in services) {
				var service = services[i];
				auths[service.id] = service;
				if(~authBtns.indexOf(service.id)) {
					var isInstalled = app.isInstalled(service.id);
					var btn = document.createElement('div');
					//如果微信未安装，则为不启用状态
					btn.setAttribute('class', 'oauth-btn' + (!isInstalled && service.id === 'weixin' ? (' disabled') : ''));
					btn.authId = service.id;
					btn.style.backgroundImage = 'url("../images/' + service.id + '.png")'
					oauthArea.appendChild(btn);
				}
			}
			mui(oauthArea).on('tap', '.oauth-btn', function() {
				if(this.classList.contains('disabled')) {
					plus.nativeUI.toast('您尚未安装微信客户端');
					return;
				}
				var auth = auths[this.authId];
				var waiting = plus.nativeUI.showWaiting();
				auth.login(function() {
					waiting.close();
					plus.nativeUI.toast("登录认证成功");
					auth.getUserInfo(function() {
						plus.nativeUI.toast("获取用户信息成功");
						var name = auth.userInfo.nickname || auth.userInfo.name;
						toMain();
					}, function(e) {
						plus.nativeUI.toast("获取用户信息失败：" + e.message);
					});
				}, function(e) {
					waiting.close();
					plus.nativeUI.toast("登录认证失败：" + e.message);
				});
			});
		}, function(e) {
			oauthArea.style.display = 'none';
			plus.nativeUI.toast("获取登录认证失败：" + e.message);
		});

		//关闭 splash
		setTimeout(function() {
			plus.navigator.closeSplashscreen();
		}, 600);

		//点击登录
		loginButton.addEventListener('tap', function(event) {
			var loginInfo = {
				UserName: accountBox.value,
				Password: passwordBox.value
			};
			//登录
			app.login(loginInfo, function(err) {
				if(err) {
					plus.nativeUI.toast(err);
					return;
				}
				plus.nativeUI.showWaiting("载入中...");
				toMain();
			});
		});

		window.addEventListener('resize', function() {
			oauthArea.style.display = document.body.clientHeight > 400 ? 'block' : 'none';
		}, false);

		//退出登录
		var backButtonPress = 0;
		mui.back = function(event) {
			backButtonPress++;
			if(backButtonPress > 1) {
				plus.runtime.quit();
			} else {
				plus.nativeUI.toast('再按一次退出应用');
			}
			setTimeout(function() {
				backButtonPress = 0;
			}, 1000);
			return false;
		};
	});

	/*
	 * 注册账号
	 */
	document.getElementById('reg').addEventListener('tap', function(event) {
		mui.openWindow({
			id: 'register',
			url: 'register.html',
			preload: true,
			show: {
				aniShow: 'pop-in'
			},
			waiting: {
				autoShow: false
			}
		});
	}, false);

	/*
	 * 忘记密码
	 */
	document.getElementById('forgetPassword').addEventListener('tap', function(event) {
		mui.openWindow({
			url: 'forget_password.html',
			id: 'forget_password',
			preload: true,
			show: {
				aniShow: 'pop-in'
			},
			styles: {
				popGesture: 'hide'
			},
			waiting: {
				autoShow: false
			}
		});
	}, false);
</script>