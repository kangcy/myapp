<!DOCTYPE html>
<html class="ui-page-login">

	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<title></title>
		<link href="../css/mui.min.css" rel="stylesheet" />
		<link href="../css/login.css" rel="stylesheet" />
	</head>

	<body style="height:100%;">
		<div class="mui-content tc" style="background:#F2F2F2;height:100%;">
			<img src="../images/logo.png" style="margin: 10%;" />
			<div id="login-form">
				<div class="mb10">
					<img src="../images/login/name.png" />
					<input id='account' type="text" class="mui-input-clear mui-input f13 txt" placeholder="请输入账号/手机号" />
				</div>
				<div>
					<img src="../images/login/pwd.png" />
					<input id='password' type="password" class="mui-input-clear mui-input f13 txt" placeholder="请输入密码" />
				</div>
			</div>
			<div style="width:80%;line-height:30px;margin:0px auto;" class="tc">
				<img id='login' src="../images/login.png" class="mt20" style="width:100%;" />
				<a id='reg' class="fl csubtitle f13">没有账号?</a>
				<a id='forgetPassword' class="fr csubtitle f13">忘记密码?</a>
			</div>
			<!--第三方登录-->
			<div class="oauth-area" style="float: left;width: 100%;">
				<div style="width:20%;float:left;">&nbsp;</div>
				<div style="width:60%;float:left;">
					<img src="../images/weixin.png" id="weixin" />
					<img src="../images/sinaweibo.png" id="sinaweibo" />
					<img src="../images/sinaweibo.png" id="qq" /></div>
				<div style="width:20%;float:left;">&nbsp;</div>
			</div>
		</div>

	</body>

</html>
<script src="../js/default.js"></script>
<script src="../js/mui.min.js"></script>
<script src="../js/login.js"></script>
<script src="../js/base.js"></script>
<script type="text/javascript">
	mui.init({
		statusBarBackground: '#f7f7f7'
	});

	//检查 "登录状态/锁屏状态" 结束
	var loginButton = document.getElementById('login');
	var accountBox = document.getElementById('account');
	var passwordBox = document.getElementById('password');

	//跳转首页
	var toMain = function() {
		mui.openWindow({
			id: 'index',
			url: '../index.html',
			show: {
				autoShow: true,
				duration: base.AnimateDuration
			},
			waiting: {
				autoShow: false
			}
		});
	};

	var auths = {};
	mui.plusReady(function() {
		plus.screen.lockOrientation("portrait-primary");
		var settings = app.getSettings();

		plus.oauth.getServices(function(services) {
			auths = services;
		}, function(e) {
			alert("获取登录服务列表失败：" + e.message + " - " + e.code);
		});

		//关闭 splash
		setTimeout(function() {
			plus.navigator.closeSplashscreen();
		}, 600);

		//点击登录
		loginButton.addEventListener('tap', function(event) {
			var loginInfo = {
				UserName: accountBox.value,
				Password: passwordBox.value
			};
			//登录
			app.login(loginInfo, function(err) {
				if(err) {
					plus.nativeUI.toast(err);
					return;
				}
				plus.nativeUI.showWaiting("载入中...");
				toMain();
			});
		});

		//退出登录
		var backButtonPress = 0;
		mui.back = function(event) {
			backButtonPress++;
			if(backButtonPress > 1) {
				plus.runtime.quit();
			} else {
				plus.nativeUI.toast('再按一次退出应用');
			}
			setTimeout(function() {
				backButtonPress = 0;
			}, 1000);
			return false;
		};
	});

	/*
	 * 注册账号
	 */
	document.getElementById('reg').addEventListener('tap', function(event) {
		mui.openWindow({
			id: 'register',
			url: 'register.html',
			preload: true,
			show: {
				aniShow: 'pop-in'
			},
			waiting: {
				autoShow: false
			}
		});
	}, false);

	/*
	 * 忘记密码
	 */
	document.getElementById('forgetPassword').addEventListener('tap', function(event) {
		mui.openWindow({
			url: 'forget_password.html',
			id: 'forget_password',
			preload: true,
			show: {
				aniShow: 'pop-in'
			},
			styles: {
				popGesture: 'hide'
			},
			waiting: {
				autoShow: false
			}
		});
	}, false);

	document.getElementById('weixin').addEventListener('tap', function() {
		console.log("微信");
		authLogin('weixin');
	})
	document.getElementById('qq').addEventListener('tap', function() {
		console.log("QQ");
		authLogin('qq');
	})
	document.getElementById('sinaweibo').addEventListener('tap', function() {
		console.log("微博");
		authLogin('sinaweibo');
	})

	// 登录操作 
	function authLogin(type) {
		var s;
		for(var i = 0; i < auths.length; i++) {
			if(auths[i].id == type) {
				s = auths[i];
				break;
			}
		}
		if(!s.authResult) {
			s.login(function(e) {
				mui.toast("登录认证成功！");
				authUserInfo(type);
			}, function(e) {
				mui.toast("登录认证失败！");
			});
		} else {
			mui.toast("已经登录认证！");
		}
	}
	//注销 
	function authLogout() {
		for(var i in auths) {
			var s = auths[i];
			if(s.authResult) {
				s.logout(function(e) {
					console.log("注销登录认证成功！");
				}, function(e) {
					console.log("注销登录认证失败！");
				});
			}
		}
	}
	// 微信登录认证信息 
	function authUserInfo(type) {
		var s;
		for(var i = 0; i < auths.length; i++) {
			if(auths[i].id == type) {
				s = auths[i];
				break;
			}
		}
		if(!s.authResult) {
			mui.toast("未授权登录！");
		} else {
			s.getUserInfo(function(e) {
				var josnStr = JSON.stringify(s.userInfo);
				var jsonObj = s.userInfo;
				console.log("获取用户信息成功：" + josnStr);

				showData(type, jsonObj);
				var loginInfo = {
					UserName: accountBox.value,
					Password: passwordBox.value
				}

				app.login(loginInfo, function(err) {
					if(err) {
						plus.nativeUI.toast(err);
						return;
					}
					plus.nativeUI.showWaiting("载入中...");
					toMain();
				});

				authLogout();
			}, function(e) {
				alert("获取用户信息失败：" + e.message + " - " + e.code);
			});
		}
	}
	// 显示用户头像信息 
	function showData(type, data, loginInfo) {
		switch(type) {
			case 'weixin':
				//{"openid":"oRrdQt8RTwroyZTnROSsJKHRM1Yw","nickname":"一个傻瓜","sex":1,"language":"zh_CN","city":"Changzhou","province":"Jiangsu","country":"CN","headimgurl":"http://wx.qlogo.cn/mmopen/eytJa9K5jkpPNvxRBGM4nIVq8iaaAH7Al37gxgs7t3TomcxByyFmYcvxhmBPRRFwrtKHapYGs8OSTticyOWLhbanpmrgMQiabsR/0","privilege":[],"unionid":"oU5Yyt4lcveMTHQvHHnE_kymcuDQ"}
				loginInfo.UserName = data.headimgurl;
				loginInfo.Password = data.headimgurl;
				loginInfo.Avatar = data.headimgurl;
				break;
			case 'qq':
				//{"ret":0,"msg":"","is_lost":0,"nickname":"你好，陌生人","gender":"男","province":"江苏","city":"南京","figureurl":"http://qzapp.qlogo.cn/qzapp/1104455702/6CDDCBB7B812BEA1D889FD32F6483A99/30","figureurl_1":"http://qzapp.qlogo.cn/qzapp/1104455702/6CDDCBB7B812BEA1D889FD32F6483A99/50","figureurl_2":"http://qzapp.qlogo.cn/qzapp/1104455702/6CDDCBB7B812BEA1D889FD32F6483A99/100","figureurl_qq_1":"http://q.qlogo.cn/qqapp/1104455702/6CDDCBB7B812BEA1D889FD32F6483A99/40","figureurl_qq_2":"http://q.qlogo.cn/qqapp/1104455702/6CDDCBB7B812BEA1D889FD32F6483A99/100","is_yellow_vip":"0","vip":"0","yellow_vip_level":"0","level":"0","is_yellow_year_vip":"0"}
				//headImage.src = data.figureurl_qq_2;
				break;
			case 'sinaweibo':
				//{"id":5332090239,"idstr":"5332090239","class":1,"screen_name":"康春阳93212","name":"康春阳93212","province":"100","city":"1000","location":"其他","description":"","url":"","profile_image_url":"http://tva4.sinaimg.cn/crop.0.0.100.100.50/005OQUftjw8elc7b5ibj4j302s02sa9v.jpg","cover_image_phone":"http://ww1.sinaimg.cn/crop.0.0.640.640.640/549d0121tw1egm1kjly3jj20hs0hsq4f.jpg","profile_url":"u/5332090239","domain":"","weihao":"","gender":"m","followers_count":1,"friends_count":22,"pagefriends_count":0,"statuses_count":0,"favourites_count":0,"created_at":"Wed Oct 15 22:15:06 +0800 2014","following":false,"allow_all_act_msg":false,"geo_enabled":true,"verified":false,"verified_type":-1,"remark":"","ptype":0,"allow_all_comment":true,"avatar_large":"http://tva4.sinaimg.cn/crop.0.0.100.100.180/005OQUftjw8elc7b5ibj4j302s02sa9v.jpg","avatar_hd":"http://tva4.sinaimg.cn/crop.0.0.100.100.1024/005OQUftjw8elc7b5ibj4j302s02sa9v.jpg","verified_reason":"","verified_trade":"","verified_reason_url":"","verified_source":"","verified_source_url":"","follow_me":false,"online_status":0,"bi_followers_count":0,"lang":"zh-cn","star":0,"mbtype":0,"mbrank":0,"block_word":0,"block_app":0,"credit_score":80,"user_ability":0,"urank":3}
				//headImage.src = data.avatar_large;
				break;
			default:
				break;
		}
	}
</script>