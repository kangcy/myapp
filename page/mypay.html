<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title></title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<link rel="stylesheet" href="../css/mui.min.css">
		<link rel="stylesheet" href="../css/animate.css">
		<style type="text/css">
			.mui-bar {
				background: #fff;
			}
			
			#signature {
				width: 75%;
				line-height: 20px;
				white-space: normal;
			}
			
			.mui-table-view-cell {
				padding: .8rem 0.9375rem;
			}
			
			.mui-table-view-cell:after {
				left: 0.9375rem;
				right: 0.9375rem;
			}
			
			.mui-table-view:after {
				height: 0px;
			}
		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav">
			<a class="mui-icon mui-icon-back mui-action-back fl c333"></a>
			<h1 class="mui-title c333">我的打赏</h1>
		</header>
		<div class="mui-content">
			<ul class="mui-table-view f13 mt0">
				<li class="mui-table-view-cell tc">
					<img class="head-img mui-action-preview mt10" id="avatar" src="../images/my/pay.png" style="width:30%;" />
					<p class="f13 c333 mt5">账户余额</p>
					<p class="f25 bold c333 mt5" id="money"></p>
				</li>
				<li class="mui-table-view-cell" id="mypay">
					<p class="f12 c333">打赏记录</p>
				</li>
				<li class="mui-table-view-cell" id="apply">
					<p class="f12 c333">申请提现</p>
					<p class="f11 caaa mt5">提现最小金额300元，收取10%手续费</p>
				</li>
				<li class="mui-table-view-cell">
					<p class="f12 c333">启用打赏</p>
					<p class="f11 caaa mt5">分享文章，读者即可打赏支持</p>
					<div class="divSwitch">
						<div class="my-switch fr" id="autoPaySwitch">
							<div></div>
						</div>
					</div>
				</li>
			</ul>
		</div>
		<div class="mytanbg hide" id="mytanbg"></div>
		<div class="boxshadow hide" id="notice" style="position:fixed;bottom:30%;left:5%;width:90%;z-index:99999;background:#fff;">
			<div style="padding:30px;padding-bottom:15px;">
				<p class="blue f15 bold">打赏功能使用协议</p>
				<p class="c333 f12 mt5">打赏金额满300元方可提现，目前仅支持提现到支付宝账户，申请后5个工作日内发放完毕。</p>
				<p class="c333 f12 mt5">提现收取10%手续费，主要用户支付微信、支付宝相关费用。</p>
				<p class="c333 f12 mt5">打赏功能不可用于募捐，以及各类违法行为，一经发现取消提现资格。</p>
				<p class="c333 f12 mt5">同意本协议方可启用打赏功能。</p>
			</div>
			<div class="full" style="height:2.5rem;line-height:2.5rem;position:relative;border-top:1px solid #eee;">
				<div style="width:50%;" class="tc fl f13" onclick="NotAgree(0)">取消</div>
				<div style="width:50%;" class="tc fl f13" onclick="Agree(0)">同意</div>
				<div style="width:1px;height:100%;border-left:1px solid #eee;position:absolute;left:50%;bottom:0px;"></div>
			</div>
		</div>
	</body>

</html>
<script src="../js/mui.min.js"></script>
<script src="../js/base.js"></script>
<script type="text/javascript">
	var isLoading = false;
	var ispay = 0;
	var userinfo = base.GetUserInfo();
	mui.init();

	mui.ready(function() {

		base.UpdateUser(userinfo.Number, function() {
			userinfo = base.GetUserInfo();
			document.getElementById("money").innerHTML = "￥" + parseFloat(userinfo.Money).toFixed(2);
		})

		if(userinfo.IsPay == 1) {
			base.SwitchChange("autoPaySwitch", true);
		}
	});

	mui.plusReady(function() {
		//是否启用打赏
		document.getElementById("autoPaySwitch").addEventListener('tap', function(event) {
			if(base.RepeatAction()) {
				return;
			}
			if(isLoading) {
				return;
			}
			isLoading = true;
			base.SwitchChange("autoPaySwitch", this.className.indexOf("active") < 0);
			ispay = this.className.indexOf("active") >= 0 ? 1 : 0;

			if(ispay == 1) {
				ActionTan(1);
			} else {
				Agree();
			}
		});

		//我的打赏
		document.getElementById('mypay').addEventListener('tap', function(event) {
			base.OpenWindow("pay", "pay.html", {});
		});

		//申请提现
		document.getElementById('apply').addEventListener('tap', function(event) {
			if(isLoading) {
				return;
			}
			isLoading = true;
			HttpGet(base.RootUrl + "System/CheckApplyMoney", {
				ID: userinfo.ID
			}, function(data) {
				isLoading = false;
				if(data != null) {
					if(data.result) {
						base.OpenWindow("payapply", "payapply.html", {});
					} else {
						mui.toast(data.message);
					}
				}
			});
		});
	});

	function NotAgree() {
		if(base.RepeatAction()) {
			return;
		}
		ispay = 0;
		base.SwitchChange("autoPaySwitch", false);
		ActionTan(0);
		isLoading = false;
	}

	function Agree() {
		if(base.RepeatAction()) {
			return;
		}
		ActionTan(0);
		HttpGet(base.RootUrl + "User/EditPay", {
			ID: userinfo.ID,
			IsPay: ispay
		}, function(data) {
			if(data == null) {
				mui.toast("修改失败");
				base.SwitchChange("autoPaySwitch", false);
			} else {
				if(data.result) {
					userinfo.IsPay = ispay;
					localStorage.setItem('$userinfo', JSON.stringify(userinfo));
				} else {
					mui.toast("修改失败");
					base.SwitchChange("autoPaySwitch", false);
				}
			}
			isLoading = false;
		});
	}

	//操作弹窗
	function ActionTan(index) {
		var noticebg = document.getElementById("mytanbg");
		var notice = document.getElementById("notice");
		if(index == 0) {
			noticebg.classList.add("hide");
			notice.classList.remove("bounceIn");
			notice.classList.add("bounceOut");
			notice.classList.add("hide");
		} else {
			noticebg.classList.remove("hide");
			notice.classList.remove("hide");
			notice.classList.remove("bounceOut");
			notice.classList.add("bounceIn");
		}
	}
</script>