<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title></title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<link rel="stylesheet" href="../css/mui.min.css">
		<link rel="stylesheet" href="../cropper/cropper.css">
	</head>

	<body>
		<!--图片显示容器-->
		<div class="mui-content">
			<div id="changeAvatar" class="touxiang tc" onclick="showActionSheet()">
				<!--触发选择图片事件-->
				<img src="../images/60x60.gif" style="width:60%;" />
				<!--默认图片以及选择裁剪后展示的效果-->
			</div>
			<div style="width:90%;margin: 0 auto;margin-top:30px;">
				<button type="button" class="mui-btn mui-btn-primary mui-btn-block" style="height: 40px;" onclick="postAvatar()">确认提交</button>
				<!--保存数据事件-->
			</div>
			<div style="text-align: center;z-index: 99;width: 100%;height: 2000px;background-color: #f2f2f2 ;position: absolute;top:40px;left: 0px;display: none;" id="spinner">
				<div style="width:90px;padding-top:200px;margin:0 auto;height: 100%;">
					<div style="width:30px;float: left;">
						<span class="mui-spinner" style="height: 20px;"></span>
						<!--等待动画-->
					</div>
					<div style="width:60px;float: left;">请稍等...</div>
					<div class="clear"></div>
				</div>
			</div>
		</div>
		<!--图片编辑容器-->
		<div id="cropperEdit" class="mui-iframe-wrapper full">
			<img id="readyimg" />
			<div class="mui-content-padded">
				<div class="flex-container tc">
					<a><span class="mui-icon mui-icon-closeempty" onclick="closepop()"></span></a>
					<!--关闭裁剪窗口-->
					<a><span class="mui-icon mui-icon-undo" onclick="rotateimgleft()"></span></a>
					<!--左旋转90度-->
					<a><span class="mui-icon mui-icon-redo" onclick="rotateimgright()"></span></a>
					<!--右旋转90度-->
					<a><span class="mui-icon mui-icon-checkmarkempty" onclick="confirm()"></span></a>
					<!--确定选择-->
				</div>
			</div>
		</div>
	</body>

</html>
<script src="../js/default.js"></script>
<script src="../js/jquery-1.10.2.min.js"></script>
<script src="../js/mui.min.js"></script>
<script src="../cropper/cropper.min.js"></script>
<script src="../js/base.js"></script>
<script type="text/javascript">
	var currUserID = base.GetUserID(); //当前登录用户ID

	//启用双击监听
	mui.init({
		gestureConfig: {
			doubletap: true
		},
		swipeBack: false
	});

	//拍照  
	function getImage() {
		var cmr = plus.camera.getCamera();
		cmr.captureImage(function(p) {
			plus.io.resolveLocalFileSystemURL(p, function(entry) {
				var localurl = entry.toLocalURL();
				$("#readyimg").attr("src", localurl);
				cutImg();
			});
		});
	}
	//相册选取  
	function galleryImgs() {
		plus.gallery.pick(function(e) {
			$("#readyimg").attr("src", e);
			cutImg();
		}, function(e) {
			//outSet( "取消选择图片" );  
		}, {
			filter: "image"
		});
	}
	//照片裁剪类  
	function cutImg() {
		$(".mui-content").hide();
		$("#cropperEdit").fadeIn();
		$("#readyimg").cropper({
			checkImageOrigin: true,
			aspectRatio: 1 / 1,
			autoCropArea: 0.3,
			zoom: -0.2
		});
	}
	//确认照片，展示效果  
	function confirm() {
		$("#cropperEdit").fadeOut();
		var dataURL = $("#readyimg").cropper("getCroppedCanvas");
		var imgurl = dataURL.toDataURL("image/jpeg", 0.5);
		$("#changeAvatar > img").attr("src", imgurl);
		$(".mui-content").show();
	}

	//右旋转90度  
	function rotateimgright() {
		$("#readyimg").cropper('rotate', 90);
	}

	//左旋转90度
	function rotateimgleft() {
		$("#readyimg").cropper('rotate', -90);
	}

	//关闭裁剪窗口
	function closepop() {
		$("#cropperEdit").fadeOut();
		$("#readyimg").cropper('destroy');
		$(".mui-content").show();
	}

	function showActionSheet() {
		var bts = [{
			title: "拍照"
		}, {
			title: "从相册选择"
		}];
		plus.nativeUI.actionSheet({
				cancel: "取消",
				buttons: bts
			},
			function(e) {
				if(e.index == 1) {
					getImage();
				} else if(e.index == 2) {
					galleryImgs();
				}
				//outLine( "选择了\""+((e.index>0)?bts[e.index-1].title:"取消")+"\"");  
			}
		);
	}

	//post内容  
	function postAvatar() {
		var petimage = $("#changeAvatar > img").attr("src"); //此时取到的图片已经是base64形式  
		//你的处理代码，改post到服务器了，服务器接收同接收普通post参数一样，只是，存图片的字段改成ntext，这是sql的数据类型，其他数据库同类型，jq的getJSON可能会不执行，因为getJSON是get模式，图片转成base64后，很容易超出最大长度，其实，经过压缩后，一般不会超出的，具体压缩方法下文有  
	}

	mui.plusReady(function() {
		//判断网络类型
		if(plus.networkinfo.getCurrentType() == plus.networkinfo.CONNECTION_NONE) {
			mui.toast("网络异常，请检查网络设置！");
		}

	});
</script>