<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title></title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<link rel="stylesheet" href="../css/mui.min.css">
		<link rel="stylesheet" href="../css/animate.css">
		<link rel="stylesheet" href="../css/img.preview.css">
		<link rel="stylesheet" href="../css/loading.css">
		<style type="text/css">
			/*二级分类*/
			
			.subtype {
				width: 4rem !important;
				height: 4rem !important;
				padding: 0px !important;
				position: relative;
				margin-left: 0.2rem !important;
			}
			
			.subtype:first-child {
				margin-left: 0px !important;
			}
			
			.subtype img {
				width: 100% !important;
				height: 100% !important;
			}
			
			.subtype span {
				position: absolute;
				left: .5rem;
				bottom: -.5rem;
			}
			/**进度条**/
			
			progress {
				border-radius: 2px;
				background-color: #eee;
				height: 1rem;
			}
			
			progress::-webkit-progress-bar {
				background-color: #d7d7d7;
			}
			
			progress::-webkit-progress-value {
				background-color: #aadd6a;
			}
			
			.myprogress {
				position: fixed;
				left: 0px;
				top: 0px;
				width: 100%;
				z-index: 1000;
			}
			
			.myprogress .myaction_body {
				width: 100%;
				padding: 5%;
				display: inline-block;
			}
			
			.mui-table-view:after {
				height: 0px;
			}
		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav">
			<a id="search" class="mui-icon mui-icon-search mui-pull-right blue"></a>
			<h1 class="mui-title c333">精选推荐</h1>
		</header>
		<div class="mui-loader tc" id="loader">
			<div class="line-scale-pulse-out">
				<div></div>
				<div></div>
				<div></div>
				<div></div>
				<div></div>
			</div>
		</div>
		<div class="mui-content">
			<div id="pullrefresh" class="mui-scroll-wrapper" style="top:0px;bottom:0px;">
				<div id="slider" class="mui-slider mui-fullscreen">
					<div id="sliderTop" class="mui-scroll-wrapper mui-slider-indicator mui-segmented-control mui-segmented-control-inverted" style="background:#fff;">
						<div class="mui-scroll" id="sliderTopBody">

						</div>
					</div>
					<div class="mui-slider-group" id="sliderGroup" style="top:2.35rem;">

					</div>
				</div>
			</div>
		</div>
		<!--更新进度条-->
		<div class="mytanbg hide" id="myprogressbg" onclick="CloseUpdate()"></div>
		<div class="myprogress hide" id="myprogress">
			<div class="tc c000 myaction_body">
				<ul class="mui-table-view f13" style="border-radius: 20px;">
					<li class="mui-table-view-cell">
						<p class="full tl mb10 c333" id="checkupdate">更新进度</p>
						<progress class="fl" value="" max="" id="proDownFile" style="width:80%;"></progress>
						<span class="persent fl ml10 caaa" id="persent" style="line-height:1rem;">0%</span>
					</li>
				</ul>
			</div>
		</div>
	</body>

</html>
<script src="../js/default.js"></script>
<script src="../js/mui.min.js"></script>
<script src="../js/mui.pullToRefresh.js"></script>
<script src="../js/mui.pullToRefresh.material.js"></script>
<script src="../js/mui.zoom.js"></script>
<script src="../js/mui.previewimage.js"></script>
<script src="../js/mui.lazyload.js"></script>
<script src="../js/mui.lazyload.img.js"></script>
<script src="../js/jquery-1.10.2.min.js"></script>
<script src="../js/base.js"></script>
<script src="../js/update.js"></script>
<script type="text/javascript">
	var sliders = [];
	var currpage = [];
	var totalpage = [];
	var pagesize = base.PageSize;
	var isLoading = false; //是否数据加载中
	var subindexPage = null;
	var articleTypes = [];
	var currSlider = 0;
	var userinfo = base.GetUserInfo();

	mui.init({

	});

	mui.ready(function() {
		base.ShowSearch();

		//加载类型
		LoadArticleType(function() {
			//遍历父级节点
			var parent = [];
			for(var i = 0; i < articleTypes.length; i++) {
				if(articleTypes[i].ParentID == 0) {
					parent.push(articleTypes[i]);
				}
			}
			//遍历子级节点
			var sliderGroup = $("#sliderGroup");
			for(var i = 0; i < parent.length; i++) {
				if(i == 0) {
					sliders.push(true);
				} else {
					sliders.push(false);
				}
				currpage.push(1);
				totalpage.push(2);

				var child = [];
				for(var j = 0; j < articleTypes.length; j++) {
					if(articleTypes[j].ParentID == parent[i].ID) {
						child.push(articleTypes[j]);
					}
				}

				var html = [];
				if(i == 0) {
					html.push('<div class="mui-slider-item mui-control-content mui-active">');
				} else {
					html.push('<div class="mui-slider-item mui-control-content">');
				}
				html.push('<div class="mui-scroll-wrapper">');
				html.push('<div id="scroll' + i + '" class="mui-scroll scrolls">');
				if(child.length > 0) {
					html.push('<div id="sliderChild' + i + '" class="mui-scroll-wrapper mui-slider-indicator mui-segmented-control mui-segmented-control-inverted subtypebody mb10" style="background:#eee;height:5.3rem;">');
					html.push('<div class="mui-scroll mt10" style="height:4rem;">');
					for(var l = 0; l < child.length; l++) {
						html.push('<div class="mui-control-item subtype topic" typeid="' + child[l].ID + '" typename="' + child[l].Name + '"><img src="' + child[l].Cover + '" /><span class="cfff f12">' + child[l].Name + '</span></div>');
					}
					html.push('</div></div>');
				}
				html.push('<div id="scroll-view' + i + '"></div>');
				html.push('</div>');
				html.push('</div>');
				html.push('</div>');
				sliderGroup.append(html.join(""));
				if(child.length > 0) {
					mui('#sliderChild' + i).scroll().reLayout();
				}
			}

			//重新注册滑动切换事件
			mui("#slider").slider();

			//监听滑动切换事件
			document.getElementById('slider').addEventListener('slide', function(e) {
				var index = e.detail.slideNumber;
				if(!sliders[index]) {
					document.getElementById("loader").classList.remove("hide");
					Load(index, parent[index].ID, function() {
						sliders[index] = true;
						++currpage[index];
						isLoading = false;
					})
				}
			});

			mui.each(document.querySelectorAll('#sliderGroup .scrolls'), function(index, pullRefreshEl) {
				mui(pullRefreshEl).pullToRefresh({
					down: {
						callback: function() {
							var self = this;
							if(isLoading == true) {
								return;
							}
							isLoading = true;
							setTimeout(function() {
								currpage[index] = 1;
								totalpage[index] = 2;
								document.getElementById('scroll-view' + index).innerHTML = "";
								Load(index, parent[index].ID, function() {
									++currpage[index];
									self.endPullDownToRefresh();
									self.refresh(true);
									isLoading = false;
								})
							}, 500);
						}
					},
					up: {
						auto: index == 0 ? true : false,
						callback: function() {
							var self = this;
							isLoading = true;
							if(currpage[index] > totalpage[index]) {
								isLoading = false;
								self.endPullUpToRefresh(currpage[index] > totalpage[index]);
								return false;
							}
							setTimeout(function() {
								Load(index, parent[index].ID, function() {
									++currpage[index];
									self.endPullUpToRefresh(currpage[index] > totalpage[index]);
									isLoading = false;
								})
							}, 500);
						}
					}
				});
			});
		});

		base.InitScroll();

		base.ShowUser("#slider"); //用户信息

		base.ShowArticle("#slider", "List", userinfo.ID); //文章信息

		//分类列表
		mui("#slider").on('tap', '.topic', function(event) {
			var typeId = this.getAttribute("typeid");
			var typeName = this.getAttribute("typename");
			base.OpenWindow("article", "article.html", {
				ArticleType: typeId,
				ArticleTypeName: typeName
			});
		});
	});

	mui.plusReady(function() {
		//判断网络状态
		base.NetChange();

		mui.previewImage({
			callback: function(index) {
				if(subindexPage == null) {
					subindexPage = plus.webview.getWebviewById("subindex");
				}
				subindexPage.evalJS("PreviewTan(" + index + ")");
			}
		});

		//检查更新
		CheckUpdate(function(index) {
			if(subindexPage == null) {
				subindexPage = plus.webview.getWebviewById("subindex");
			}
			subindexPage.evalJS("PreviewTan2(" + index + ")");
		});
	});

	/**
	 * 加载数据
	 */
	function Load(index, typeId, callback) {
		var data = {
			page: currpage[index],
			rows: pagesize,
			TypeID: typeId
		};
		HttpGet(base.RootUrl + "Article/All", data, function(data) {
			if(data != null) {
				totalpage[index] = data.totalpage;
				var length = data.records;
				if(length > 0) {
					document.getElementById("loader").classList.add("hide");
					var table = document.getElementById('scroll-view' + index);
					for(var i = 0, len = data.list.length; i < len; i++) {
						var div = base.AppendArticle(data.list[i]);
						if(table) {
							table.appendChild(div);
						}
					}
				} else {
					setTimeout(function() {
						document.getElementById("loader").classList.add("hide");
					}, 1000);
				}
			} else {
				document.getElementById("loader").classList.add("hide");
			}
			if($.isFunction(callback)) {
				callback();
			}
			document.body.removeAttribute('data-imageLazyload');
			mui(document).imageLazyload({
				placeholder: base.DefaultImg,
				diff: window.innerHeight
			});
		});
	}

	//加载文章类型
	function LoadArticleType(callback) {
		HttpGet(base.RootUrl + "ArticleType/All", {}, function(data) {
			if(data != null) {
				var length = data.list.length;
				if(length > 0) {
					articleTypes = data.list;
					var table = $('#sliderTopBody');
					var index = 0;
					for(var i = 0, len = data.list.length; i < len; i++) {
						if(data.list[i].ParentID == 0) {
							var div = appendPTypeStr(data.list[i], index);
							table.append(div);
							index += 1
						}
					}
					mui('#sliderTop').scroll().reLayout();
				}
				if($.isFunction(callback)) {
					callback();
				}
			}
		});
	}

	/**
	 * 拼接文章类型
	 */
	function appendPTypeStr(item, index) {
		if(index == 0) {
			return '<div class="mui-control-item f13 topic mui-active" typeid="' + item.ID + '" typename="' + item.Name + '">' + item.Name + '</div>';
		} else {
			return '<div class="mui-control-item f13 topic " typeid="' + item.ID + '" typename="' + item.Name + '">' + item.Name + '</div>';
		}
	}

	//关闭更新弹窗
	function CloseUpdate() {
		document.getElementById("myprogressbg").classList.add("hide");
		document.getElementById("myprogress").classList.add("hide");
		document.getElementById("myprogress").classList.remove("bounceIn");
		if(subindexPage == null) {
			subindexPage = plus.webview.getWebviewById("subindex");
		}
		subindexPage.evalJS("PreviewTan2(0)");
	}
</script>