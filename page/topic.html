<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title></title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<link rel="stylesheet" href="../css/mui.min.css">
		<link rel="stylesheet" href="../css/animate.css">
		<link rel="stylesheet" href="../css/img.preview.css">
		<link rel="stylesheet" href="../css/loading.min.css">
		<style type="text/css">
			/*二级分类*/
			
			.subtype {
				width: 4rem !important;
				height: 4rem !important;
				padding: 0px !important;
				position: relative;
				margin-left: 0.2rem !important;
			}
			
			.subtype:first-child {
				margin-left: 0px !important;
			}
			
			.subtype img {
				width: 100% !important;
				height: 100% !important;
			}
			
			.subtype span {
				position: absolute;
				left: .5rem;
				bottom: -.5rem;
			}
			/**进度条**/
			
			progress {
				border-radius: 2px;
				background-color: #eee;
				height: 1rem;
			}
			
			progress::-webkit-progress-bar {
				background-color: #d7d7d7;
			}
			
			progress::-webkit-progress-value {
				background-color: #aadd6a;
			}
			
			.myprogress {
				position: fixed;
				left: 0px;
				top: 0px;
				width: 100%;
				z-index: 1000;
			}
			
			.myprogress .myaction_body {
				width: 100%;
				padding: 5%;
				display: inline-block;
			}
			
			.mui-table-view:after {
				height: 0px;
			}
		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav bounceInDown" id="search" onclick="Search()">
			<div class="mui-input-row mui-search fl" style="width:86%;display:inline-block;">
				<input type="search" class="c999" placeholder="搜索昵称、标题、支持语音搜索" style="height:34px;font-size:15px;" disabled="disabled">
			</div>
			<div class="fr tc" style="width:10%;height:100%;display:inline-block;background:url(../images/base/adduser.png) center center no-repeat;background-size:20px" onclick="AddUser()">

			</div>
		</header>
		<div class="loading" id="loader"> 
			<div class="card">
				<span class="circles-loader"></span>
			</div>
		</div>
		<div class="mui-content">
			<div id="slider" class="mui-slider mui-fullscreen">
				<div id="sliderTop" class="mui-scroll-wrapper mui-slider-indicator mui-segmented-control mui-segmented-control-inverted" style="background:#fff;">
					<div class="mui-scroll" id="sliderTopBody">

					</div>
				</div>

				<div class="mui-slider-group" id="sliderGroup" style="top:2.36rem;">

				</div>
			</div>
		</div>
		<!--更新进度条-->
		<div class="mytanbg hide" id="myprogressbg" onclick="CloseUpdate()"></div>
		<div class="myprogress hide" id="myprogress">
			<div class="tc c000 myaction_body">
				<ul class="mui-table-view f13" style="border-radius: 20px;">
					<li class="mui-table-view-cell">
						<p class="full tl mb10 c333" id="checkupdate">更新进度</p>
						<progress class="fl" value="" max="" id="proDownFile" style="width:80%;"></progress>
						<span class="persent fl ml10 caaa" id="persent" style="line-height:1rem;">0%</span>
					</li>
				</ul>
			</div>
		</div>
	</body>

</html>
<script src="../js/jquery-1.10.2.min.js"></script>
<script src="../js/mui.min.js"></script>
<script src="../js/base.js"></script>
<script src="../js/mui.pullToRefresh.js"></script>
<script src="../js/mui.pullToRefresh.material.js"></script>
<script src="../js/mui.zoom.js"></script>
<script src="../js/mui.previewimage.js"></script>
<script src="../js/update.js"></script>
<script type="text/javascript">
	var sliders = [];
	var currpage = [];
	var totalpage = [];
	var pagesize = base.PageSize;
	var isLoading = false; //是否数据加载中
	var subindexPage = null;
	var articleTypes = [];
	var currSlider = 0;
	var userinfo = base.GetUserInfo();

	mui.init();

	mui.ready(function() {

		//加载类型
		LoadArticleType(function() {
			//遍历父级节点
			var parent = [];
			for(var i = 0; i < articleTypes.length; i++) {
				if(articleTypes[i].ParentID == 0) {
					parent.push(articleTypes[i]);
				}
			}
			//遍历子级节点
			var sliderGroup = $("#sliderGroup");
			for(var i = 0; i < parent.length; i++) {
				if(i == 0) {
					sliders.push(true);
				} else {
					sliders.push(false);
				}
				currpage.push(1);
				totalpage.push(2);

				var child = [];
				for(var j = 0; j < articleTypes.length; j++) {
					if(articleTypes[j].ParentID == parent[i].ID) {
						child.push(articleTypes[j]);
					}
				}

				var html = [];
				if(i == 0) {
					html.push('<div class="mui-slider-item mui-control-content mui-active">');
				} else {
					html.push('<div class="mui-slider-item mui-control-content">');
				}
				html.push('<div class="mui-scroll-wrapper">');
				html.push('<div id="scroll' + i + '" class="mui-scroll scrolls">');
				if(child.length > 0) {
					html.push('<div id="sliderChild' + i + '" class="mui-scroll-wrapper mui-slider-indicator mui-segmented-control mui-segmented-control-inverted subtypebody mb10" style="background:#f5f5f5;height:5.3rem;">');
					html.push('<div class="mui-scroll mt10" style="height:4rem;">');
					for(var l = 0; l < child.length; l++) {
						html.push('<div class="mui-control-item subtype topic" typeid="' + child[l].ID + '" typename="' + child[l].Name + '"><img data-lazyload="' + child[l].Cover + '" /><span class="cfff f12">' + child[l].Name + '</span></div>');
					}
					html.push('</div></div>');
				}

				//精选添加轮播 
				if(i == 0) {
					html.push('<div style="background:#f5f5f5;height:8.8rem;"><div id="banner"></div></div>');
				}

				html.push('<div id="scroll-view' + i + '"></div>');
				html.push('<div id="none' + i + '" class="full tc hide"><img src="../images/my/444.png" class="none" /><p class="f13 mt10">这里还没有内容</p></div>');
				html.push('</div>');
				html.push('</div>');
				html.push('</div>');
				sliderGroup.append(html.join(""));
				if(child.length > 0) {
					mui('#sliderChild' + i).scroll().reLayout();
				}
				if(i == 0) {
					HttpGet(base.RootUrl + "System/Banner", {}, function(data) {
						if(data != null) {
							var length = data.records;
							if(length > 0) {
								var banner = $("#banner");
								var bannerHtml = [];
								bannerHtml.push('<div class="mui-slider-group mui-slider-group2 mui-slider-loop">');
								for(var j = 0, len = length; j < len; j++) {
									if(j == 0 || j == length - 1) {
										bannerHtml.push('<div class="mui-slider-item mui-slider-item-duplicate">');
									} else {
										bannerHtml.push('<div class="mui-slider-item">');
									}
									bannerHtml.push('<a href="' + data.list[j].Link + '"><img src="' + data.list[j].Cover + '"></a></div>');
								}
								bannerHtml.push('</div>');
								bannerHtml.push('<div class="mui-slider-indicator">');
								for(var j = 0, len = length - 2; j < len; j++) {
									if(j == 0) {
										bannerHtml.push('<div class="mui-indicator mui-active"></div>');
									} else {
										bannerHtml.push('<div class="mui-indicator"></div>');
									}
								}
								bannerHtml.push('</div>');
								banner.append(bannerHtml.join(""));
								banner.addClass("mui-slider");
								banner.css({
									"height": "8rem",
									"top": "0px"
								});

								mui("#banner").slider({
									interval: 5000
								});
							}
						}
					});
				}
			}

			//重新注册滑动切换事件
			base.InitSlider();

			//上划效果
			$("#slider").addClass("bounceInDown");

			//监听滑动切换事件
			document.getElementById('slider').addEventListener('slide', function(e) {
				var index = e.detail.slideNumber;
				if(!sliders[index]) {
					document.getElementById("loader").classList.remove("hide");
					Load(index, parent[index].ID, function() {
						sliders[index] = true;
						++currpage[index];
						isLoading = false;
					})
				}
			});

			mui.each(document.querySelectorAll('#sliderGroup .scrolls'), function(index, pullRefreshEl) {
				mui(pullRefreshEl).pullToRefresh({
					down: {
						callback: function() {
							var self = this;
							if(isLoading == true) {
								return;
							}
							isLoading = true;
							currpage[index] = 1;
							totalpage[index] = 2;
							document.getElementById('scroll-view' + index).innerHTML = "";
							Load(index, parent[index].ID, function() {
								++currpage[index];
								self.endPullDownToRefresh();
								self.refresh(true);
								isLoading = false;
							})
						}
					},
					up: {
						auto: index == 0 ? true : false,
						callback: function() {
							var self = this;
							isLoading = true;
							if(currpage[index] > totalpage[index]) {
								isLoading = false;
								self.endPullUpToRefresh(currpage[index] > totalpage[index]);
								return false;
							}
							Load(index, parent[index].ID, function() {
								++currpage[index];
								self.endPullUpToRefresh(currpage[index] > totalpage[index]);
								isLoading = false;
							})
						}
					}
				});
			});
		});

		base.ShowUser("#slider");

		base.ShowArticle("#slider", "List", userinfo.Number);

		//分类列表
		mui("#slider").on('tap', '.topic', function(event) {
			var index = $(this).index();
			ChangeSlider(index);
		});
	});

	mui.plusReady(function() {
		base.ArticleAction("#slider", userinfo);

		mui.previewImage({
			callback: function(index) {
				if(subindexPage == null) {
					subindexPage = plus.webview.getWebviewById("subindex");
				}
				subindexPage.evalJS("PreviewTan(" + index + ")");
			}
		});

		//检查更新
		CheckUpdate(function(index) {
			if(subindexPage == null) {
				subindexPage = plus.webview.getWebviewById("subindex");
			}
			subindexPage.evalJS("PreviewTan2(" + index + ")");
		});
	});

	/**
	 * 加载数据
	 */
	function Load(index, typeId, callback) {
		var data = {
			Number: userinfo.Number,
			page: currpage[index],
			rows: pagesize,
			TypeID: typeId
		};
		HttpGet(base.RootUrl + "Article/All", data, function(data) {
			if(data != null) {
				totalpage[index] = data.totalpage;
				var length = data.records;
				if(length > 0) {
					document.getElementById("loader").classList.add("hide");
					document.getElementById("none" + index).classList.add("hide");
					var table = document.getElementById('scroll-view' + index);
					for(var i = 0, len = data.list.length; i < len; i++) {
						var div = base.AppendArticle(userinfo.Number, data.list[i], false, false, false);
						if(table) {
							table.appendChild(div);
						}
					}
				} else {
					document.getElementById("loader").classList.add("hide");
					document.getElementById("none" + index).classList.remove("hide");
				}
			} else {
				document.getElementById("loader").classList.add("hide");
				document.getElementById("none" + index).classList.remove("hide");
			}
			if($.isFunction(callback)) {
				callback();
			}
		});
	}

	//加载文章类型
	function LoadArticleType(callback) {
		HttpGet(base.RootUrl + "ArticleType/All", {}, function(data) {
			if(data != null) {
				var length = data.list.length;
				if(length > 0) {
					articleTypes = data.list;
					var table = $('#sliderTopBody');
					var index = 0;
					for(var i = 0, len = data.list.length; i < len; i++) {
						if(data.list[i].ParentID == 0) {
							var div = appendPTypeStr(data.list[i], index);
							table.append(div);
							index += 1
						}
					}
					mui('#sliderTop').scroll().reLayout();
				}
				if($.isFunction(callback)) {
					callback();
				}
			}
		});
	}

	/**
	 * 拼接文章类型
	 */
	function appendPTypeStr(item, index) {
		if(index == 0) {
			return '<div class="mui-control-item f12 topic mui-active" typeid="' + item.ID + '" typename="' + item.Name + '">' + item.Name + '</div>';
		} else {
			return '<div class="mui-control-item f12 topic" typeid="' + item.ID + '" typename="' + item.Name + '">' + item.Name + '</div>';
		}
	}

	//关闭更新弹窗
	function CloseUpdate() {
		document.getElementById("myprogressbg").classList.add("hide");
		document.getElementById("myprogress").classList.add("hide");
		document.getElementById("myprogress").classList.remove("bounceIn");
		if(subindexPage == null) {
			subindexPage = plus.webview.getWebviewById("subindex");
		}
		subindexPage.evalJS("PreviewTan2(0)");
	}

	//搜索
	function Search() {
		base.OpenWindow("search", "search.html", {});
	}

	//添加用户
	function AddUser() {
		base.OpenWindow("addfan", "addfan.html", {});
	}
</script>