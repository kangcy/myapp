<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title></title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<link rel="stylesheet" href="../mincss/mui.min.css">
		<link rel="stylesheet" href="../mincss/fan.min.css">
		<link rel="stylesheet" href="../mincss/animate.min.css">
		<link rel="stylesheet" href="../swipe/swiper.min.css">
		<style type="text/css">
			#divLocation {
				background: #f5f5f5;
			}
			
			#divLocation div {
				height: 2rem;
				line-height: 2rem;
				background: #fff;
				display: inline-block;
			}
			
			#btn {
				background: #5E92D7;
				height: 2rem;
				line-height: 2rem;
				width: 10rem;
				border-radius: 20px;
				display: inline-block;
			}
			
			.my-pagination {
				transition: transform .3s;
				position: relative;
			}
			
			.my-pagination ul {
				display: -webkit-box;
				margin: 0px;
				padding: 0px;
				width: 60%;
				margin: 0 20%;
			}
			
			.my-pagination li {
				display: block;
				background: #fff;
				overflow: hidden;
				box-flex: 1;
				-moz-box-flex: 1;
				-webkit-box-flex: 1;
				height: 2.5rem;
				line-height: 2.5rem;
				position: relative;
				font-size: 15px;
				transition: transform .25s;
			}
			
			.my-pagination .tabs_border {
				position: absolute;
				bottom: 0;
				width: 100%;
				left: 0;
				height: 2px;
				background-color: #f5f5f5;
				z-index: 0;
				transition: transform .25s cubic-bezier(.645, .045, .355, 1);
				list-style: none;
			}
			
			.my-pagination .swiper-pagination-bullet {
				text-align: center;
				border-radius: 0;
				opacity: 1;
			}
			
			.my-pagination .swiper-pagination-bullet-active {
				color: #20a0ff;
			}
			
			.swiper-container {
				background: #f5f5f5;
			}
			
			.scroll-wrapper {
				position: absolute;
				z-index: 0;
				top: 0px;
				bottom: 0px;
				left: 0;
				width: 100%;
				background: #f5f5f5;
				overflow: hidden;
			}
			
			.icon {
				width: 1rem !important;
			}
			
			.green {
				color: #24b224;
			}
			
			.red {
				color: #e33e3e;
			}
			
			.mui-table-view-cell:after {
				left: 3.5rem !important;
			}
			
			#address .flex-row {
				padding: 0.825rem 0.9375rem;
				position: relative;
				background: #fff;
			}
			
			#address .flex-row:after {
				position: absolute;
				right: 0;
				bottom: 0;
				left: 0;
				height: 1px;
				content: '';
				-webkit-transform: scaleY(.5);
				transform: scaleY(.5);
				background-color: #e8e8e8;
			}
			
			#address .flex-row.noborder:after {
				height: 0px;
			}
			
			#address .flex-row :first-child {
				flex: 0 0 50%;
			}
			
			#address .flex-row :last-child {
				flex: 0 0 50%;
			}
			
			.cancel {
				width: 70%;
				display: inline-block !important;
				border-radius: 30px;
				padding: 0.525rem 0.9375rem;
			}
			
			.jroll-infinite-tip {
				padding: 1rem 0 1rem 0;
			}
		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav tc" id="header">
			<a class="mui-icon mui-icon-back mui-action-back fl cfff"></a>
			<h1 class="mui-title cfff">添加关注</h1>
		</header>

		<div class="mui-content" id="muicontent">
			<div class="my-pagination" id="pagination">
				<ul class="my-pagination-ul swiper-pagination-clickable"> </ul>
				<div class="tabs_active" id="pagination_border"></div>
				<div class="tabs_border"></div>
			</div>
			<div class="swiper-container swiper-container-horizontal" id="swiper-container">
				<div class="swiper-wrapper">
					<div class="swiper-slide">
						<div id="wrapper0" class="scroll-wrapper">
							<div id="scroll0" class="scroller" style="background:#fff;"></div>
						</div>
					</div>
					<div class="swiper-slide">
						<div id="divLocation" class="hide" style="position:fixed;top:0px;left:0px;width:100%;z-index:99;">
							<a href="#" class="c333">
								<div class="mt10 mb10 full f12">
									<i class="mui-icon mui-icon-location f14 ml10 mr5 blue bold"></i><span id="location"></span><span class="mui-icon mui-icon-arrowright fr mr10 mt8 blue f16"></span>
								</div>
							</a>
						</div>
						<div id="wrapper1" class="scroll-wrapper">
							<div id="scroll1" class="scroller" style="background:#fff;"></div>
						</div>
						<div id="showPosition" class="full tc hide" style="height:100%;background:#fff;">
							<p class="f12 c999" style="padding-top:30%">看看周围的人都在玩什么</p>
							<p class="mt10 f12 c999">请确保已经连接网络并打开了定位服务</p>
							<div id="btn" class="mt20 f13 cfff">开启定位服务</div>
						</div>
					</div>
				</div>
			</div>
		</div>
		<div id="address" class="mui-popover mui-popover-action mui-popover-bottom">
			<div class="flex-box flex-row noborder f13">
				<div class="flex-item full tc" style="flex: 0 0 100%;">
					<span class="cfff f14 cancel" onclick="ClearPosition()">清除位置缓存</span>
				</div>
			</div>
			<div class="flex-box flex-row noborder f13">
				<div class="flex-item red full tc" style="flex: 0 0 100%;">
					<a href="#address" class="red">取消</a>
				</div>
			</div>
		</div>
	</body>

</html>
<script src="../minjs/mui.min.js"></script>
<script src="../js/base.min.js"></script>
<script src="../swipe/swiper.min.js"></script>
<script src="../jroll/jroll.min.js"></script>
<script src="../jroll/jroll-pulldown.js"></script>
<script src="../jroll/jroll-infinite.js"></script>
<script src="../js/imgcache.js"></script>
<script type="text/javascript">
	var userinfo = base.GetUserInfo();
	var $border = base.Get("pagination_border");
	var scroll0, scroll1 = null;
	var currpage = [1, 1];
	var totalpage = [1, 1];
	var pageLoading = [false, false];
	var isLoading = false;
	var pagesize = 10;
	var PageName = "addfaninfo";
	var position = base.GetCurrentPosition();
	mui.init({
		beforeback: function() {
			if(base.CheckWaiting()) {
				return false;
			}
		}
	});
	mui.ready(function() {
		base.Immersed();

		mui.each(base.Get(".cancel"), function() {
			this.style.background = base.BrowserName() + 'linear-gradient(left,#ff6900 0%,#fb2879 100%)';
		})

		base.Get("btn").addEventListener("tap", function() {
			OpenPosition();
		});

		base.Get("divLocation").addEventListener("tap", function() {
			if(isLoading) {
				return false;
			}
			isLoading = true;
			mui('#address').popover('show');
			isLoading = false;
		});
	});

	mui.plusReady(function() {
		var mySwiper = new Swiper('#swiper-container', {
			pagination: '.my-pagination-ul',
			paginationClickable: true,
			paginationBulletRender: function(swiper, index, className) {
				switch(index) {
					case 0:
						name = '猜你喜欢';
						break;
					case 1:
						name = '同城热门';
						break;
					default:
						name = '';
				}
				return '<li class="' + className + '"><span class="f14">' + name + '</span></li>';
			},
			onTransitionStart: function(swiper) {
				var $this = mui("#pagination li")[swiper.activeIndex]
				$border.style.width = $this.clientWidth * 0.5 + "px";
				$border.style.transform = "translateX(" + ($this.offsetLeft + $this.clientWidth * (1 - 0.5) / 2) + "px)";

				if(swiper.activeIndex == 1 && scroll1 == null) {
					scroll1 = new JRoll("#wrapper1", {
						scrollBarY: false
					});
					//滚动加载
					scroll1.infinite({
						getData: function(page, callback, errorCallback) {
							currpage[1] = page;
							LoadScroll1({
								success: function(data) {
									scroll1.options.total = totalpage[1];
									callback(data);
								},
								error: function() {
									errorCallback()
								}
							});
						},
						render: function(data) {
							var div = base.AppendUser(data, false, true, false, "", true, true)
							return div.outerHTML;
						}
					});
				}
			},
			onInit: function(swiper) {
				var swiperheight = (window.innerHeight - base.Get("header").clientHeight - base.Get("pagination").clientHeight) + "px";
				base.Get("swiper-container").style.height = swiperheight;

				var $this = mui("#pagination li")[0];
				$border.style.width = $this.clientWidth * 0.5 + "px";
				$border.style.transform = "translateX(" + ($this.offsetLeft + $this.clientWidth * (1 - 0.5) / 2) + "px)";

				scroll0 = new JRoll("#wrapper0", {
					scrollBarY: false
				});
				//下拉刷新
				scroll0.pulldown({
					refresh: function(complete) {
						currpage[0] = 1;
						scroll0.options.page = 1;
						scroll0.scrollTo(0, 44, 0, true); //滚回顶部
						LoadScroll0({
							success: function(data) {
								complete();
								scroll0.scroller.innerHTML = "";
								scroll0.options.total = totalpage[0];
								scroll0.infinite_callback(data);
							}
						});
					}
				});
				//滚动加载
				scroll0.infinite({
					getData: function(page, callback, errorCallback) {
						currpage[0] = page;
						LoadScroll0({
							success: function(data) {
								scroll0.options.total = totalpage[0];
								callback(data);
							},
							error: function() {
								errorCallback()
							}
						});
					},
					render: function(data) {
						var div = base.AppendUser(data, true, true, false, "", false, true);
						return div.outerHTML;
					}
				});
			}
		})

		if(base.IsNullOrEmpty(position.CityCode)) {
			mui.toast("定位失败,请开启定位权限");
		} else {
			base.Get("location").innerHTML = position.City + "," + position.District + "," + position.Street;
			InitPosition();
		}

		base.ShowUser("#swiper-container");
		base.UserFan("#swiper-container", userinfo);
	});

	//用户
	function LoadScroll0(parms) {
		if(pageLoading[0]) {
			return;
		}
		pageLoading[0] = true;
		if(currpage[0] > totalpage[0]) {
			pageLoading[0] = false;
			return false;
		}
		var data = {
			page: currpage[0],
			rows: pagesize,
			Number: userinfo.Number
		}

		LoadPullList(base.RootUrl + "User/RecommendAll", data, true, 0, parms, function(a) {
			mui.later(function() {
				parms.success(a);
				pageLoading[0] = false;
			}, 200)
		});
	}

	//同城
	function LoadScroll1(parms) {
		if(pageLoading[1]) {
			return;
		}
		pageLoading[1] = true;
		if(currpage[1] > totalpage[1]) {
			pageLoading[1] = false;
			return false;
		}
		var data = {
			page: currpage[1],
			rows: pagesize,
			Number: userinfo.Number,
			CityCode: position.CityCode
		}

		LoadPullList(base.RootUrl + "User/CityAll", data, true, 1, parms, function(a) {
			mui.later(function() {
				parms.success(a);
				pageLoading[1] = false;
			}, 200)
		});
	}

	function LoadPullList(url, data, showNone, index, parms, callback) {
		HttpGet(url, data, function(data) {
			if(data != null) {
				if(data.result) {
					totalpage[index] = data.totalpage;
					if(data.list) {
						callback(data.list);
					} else {
						callback([]);
					}
					return;
				}
			}
			totalpage[index] = 1;
			callback([]);
		});
	}

	//初始化定位
	function InitPosition() {
		if(userinfo.ShowPosition == 0) {
			base.AddClass(["#divLocation", "#wrapper1"], "hide");
			base.RemoveClass(["#showPosition"], "hide");
		} else {
			base.AddClass(["#showPosition"], "hide");
			base.RemoveClass(["#divLocation", "#wrapper1"], "hide");
			base.Get("scroll1").style.paddingTop = base.Get("divLocation").clientHeight + "px";
			if(scroll1 != null) {
				currpage[1] = 1;
				totalpage[1] = 1;

				if(scroll1 != null) {
					scroll1.options.page = 1;
					scroll1.scroller.innerHTML = ""; //清空内容
					scroll1.scrollTo(0, 0); //滚回顶部
					LoadScroll1({
						success: function(data) {
							scroll1.options.total = totalpage[1];
							scroll1.infinite_callback(data);
						},
						error: function() {
							scroll1.infinite_error_callback()
						}
					});
				}
			}
		}
	}

	//开启定位
	function OpenPosition() {
		if(isLoading) {
			return false;
		}
		isLoading = true;
		HttpGet(base.RootUrl + "User/EditSecret", {
			ID: userinfo.ID,
			Name: "ShowPosition",
			Show: 1
		}, function(data) {
			if(data == null) {
				mui.toast("开启定位服务失败");
			} else {
				if(data.result) {
					userinfo.ShowPosition = 1;
					localStorage.setItem('$userinfo', JSON.stringify(userinfo));
					InitPosition();
				} else {
					mui.toast("开启定位服务失败");
				}
			}
			isLoading = false;
		});
	}

	//清除定位
	function ClearPosition() {
		if(isLoading) {
			return false;
		}
		isLoading = true;
		mui('#address').popover('hide');
		HttpGet(base.RootUrl + "User/EditSecret", {
			ID: userinfo.ID,
			Name: "ShowPosition",
			Show: 0
		}, function(data) {
			if(data == null) {
				mui.toast("位置信息清除失败");
			} else {
				if(data.result) {
					userinfo.ShowPosition = 0;
					localStorage.setItem('$userinfo', JSON.stringify(userinfo));
					InitPosition();
					mui.toast("位置信息已清除");
				} else {
					mui.toast("位置信息清除失败");
				}
			}
			isLoading = false;
		});
	}
</script>