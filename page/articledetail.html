<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title></title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<link rel="stylesheet" href="../css/mui.min.css">
		<link rel="stylesheet" href="../css/animate.css">
		<link rel="stylesheet" type="text/css" href="../css/icons-extra.css" />
		<link rel="stylesheet" href="../font-awesome-4.6.3/css/font-awesome.min.css">
		<style type="text/css">
			.detail {
				width: 95%;
				margin: 2.5%;
				padding: 2.5%;
				line-height: 1.5625rem;
				display: inline-block;
			}
			
			.footer div {
				line-height: 2.75rem;
			}
			
			.footer img {
				width: 1.4rem;
				height: 1.4rem;
				margin-top: 0.6rem;
			}
			
			#addcomment {
				width: 40%;
				float: left;
				height: 50px;
				line-height: 50px;
				border-right: 1px solid #ccc;
				text-align: center;
			}
			
			#footer {
				width: 60%;
				float: left;
				height: 50px;
				line-height: 50px;
				text-align: center;
			}
			
			#footer div {
				width: 33.3%;
				float: left;
				height: 50px;
				line-height: 50px;
				text-align: center;
			}
			/**操作**/
			
			.myaction {
				position: fixed;
				left: 0px;
				top: 0px;
				width: 100%;
				z-index: 1000;
				background: #fff;
			}
			
			.myaction .myaction_body {
				padding: 5%;
				padding-top: 2%;
				display: inline-block;
			}
			
			.myaction .myaction_items {
				width: 33.3%;
				float: left;
				position: relative;
				padding-bottom: 1.2rem;
			}
			
			.myaction .myaction_items img {
				width: 40%;
			}
			
			.myaction .myaction_items p {
				position: absolute;
				left: 0px;
				bottom: 0.4rem;
				width: 100%;
			}
			
			#useravatar1 {
				width: 3rem;
				height: 3rem;
				border-radius: 50%;
				border: 2px solid #fff;
			}
			
			.cover {
				background: RGBA(255, 255, 255, 0.6);
				height: 100%;
				z-index: -1;
				border-radius: 10px;
				margin-top: 4rem !important;
			}
			
			.bg {
				width: 100%;
				position: relative;
				z-index: 1;
				background: url("http://139.224.51.196/Source/bg/1.jpg") no-repeat;
				background-size: 100% auto;
				background-color: #E7CEC9;
				min-height: 100%;
			}
			
			.fa-music {
				padding: 0.35rem;
				background: #fff;
				border-radius: 50px;
				color: #333;
				box-shadow: 0px 0px 1px #333;
				width: 1.5rem;
				height: 1.5rem;
				box-shadow: 0px 0.05px 0.05px #333;
			}
			
			.fa-music[play=stop] {
				animation: rotate 4s linear infinite;
				-webkit-animation: rotate 4s linear infinite;
				-ms-animation: rotate 4s linear infinite;
				-moz-animation: rotate 4s linear infinite;
				-o-animation: rotate 4s linear infinite;
			}
			/**通用样式**/
			
			.music {
				width: 100%;
				height: 42px;
				border-radius: 5px;
				margin: 10px 8px 0 0;
				background: #f6f6f6;
				padding: 0;
				line-height: 42px;
				cursor: pointer;
			}
			
			.music[play=on] i {
				background-image: url("../images/article/on.png");
			}
			
			.music[play=stop] i {
				background-image: url("../images/article/off.png");
			}
			
			.music i {
				float: left;
				width: 25px;
				height: 25px;
				background-size: contain;
				background-repeat: no-repeat;
				background-position: center;
				margin: 8px 10px 0 15px;
			}
			
			.music span {
				width: calc(100% - 70px);
				width: -webkit-calc(100% - 70px);
				margin: 0;
				white-space: nowrap;
				overflow: hidden;
				text-overflow: ellipsis;
				float: left;
				text-align: left;
			}
			/*模板选择*/
			
			#temps {
				background: #eee;
				height: 100px;
				position: fixed;
				bottom: 0px;
				top: auto;
				z-index: 99999;
				border: 0px;
			}
			
			.temp {
				width: 80px !important;
				height: 80px !important;
				padding: 0px !important;
				position: relative;
				margin-left: 8px !important;
			}
			
			.temp:first-child {
				margin-left: 10px !important;
			}
			
			.temp:last-child {
				margin-right: 10px !important;
			}
			
			.temp img {
				width: 100% !important;
				height: 100% !important;
			}
			
			.temp.hover img {
				border: 2px solid #ed5565;
			}
		</style>
	</head>

	<body id="body">
		<header class="mui-bar mui-bar-nav" id="header">
			<a id="back" class="mui-icon mui-icon-back fl"></a>
			<a id="action" class="mui-icon mui-icon-more fr hide" style="font-size:30px;" onclick="ActionTan(1)"></a>
			<h1 class="mui-title c333 user">作者主页</h1>
		</header>
		<div class="mui-iframe-wrapper" style="top: 46px; bottom:50px;">
			<div class="mui-content mui-scroll-wrapper">
				<div class="mui-scroll bg">
					<!--通用样式-->
					<div id="main0" class="hide">
						<div class="f13 tl detail">
							<div class="full tl">
								<p class="f20 c000" id="title0"></p>
								<span class="mt0 mb0 csubtitle f13" id="createdate0"></span>
								<span class="mb0 blue ml10 user mt10" userid="0" id="nickname0"></span>
								<span class="mt0 mb0 ml10 csubtitle f13" id="views0"></span>
								<p id="music0" play="on" class="music" onclick="switchsound()">
									<i></i>
									<span id="musicname0"></span>
								</p>
							</div>
							<div class="c000 full mt20" id="desc0">

							</div>
						</div>
					</div>
					<!--排版1-->
					<div id="main1" class="hide">
						<div class="tc" style="width:95%;margin:0px 2.5%;padding-top:2.5%;">
							<div class="full" style="position:relative;">
								<img id="useravatar1" />
								<p class="full mb0 user blue mt10" userid="0" id="nickname1"></p>
								<i id="music1" class="fa fa-music f13" onclick="switchsound()" style="position:absolute;right:0px;top:0px;"></i>
							</div>
						</div>
						<div class="f13 tl detail cover">
							<div class="full tc">
								<p class="mt10 mb0 f20 c000" id="title1"></p>
								<p class="mt0 mb10 full csubtitle f13 tc">
									<span id="createdate1"></span>
									<span class="ml10" id="views1"></span>
								</p>
							</div>
							<div class="c000 full" id="desc1">

							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
		<div class="mui-bar mui-bar-tab">
			<div id="addcomment">
				<span class="mui-icon mui-icon-chat c999" style="font-size:20px;margin-right:3px;"></span>
				<span class="c999" style="font-size:15px;">添加评论</span>
			</div>
			<div id="footer">
				<div>
					<span id="comment" class="mui-icon mui-icon-chatbubble c999" style="font-size:28px;"><span class="mui-badge mui-badge-danger" id="footer_comment">0</span></span>
				</div>
				<div>
					<span id="zan" class="mui-icon mui-icon-extra mui-icon-extra-heart c999" style="font-size:22px;padding-top: 15px;"><span class="mui-badge mui-badge-danger" id="footer_zan">0</span></span>
				</div>
				<div>
					<span id="share" class="mui-icon mui-icon-extra mui-icon-extra-share c999" style="font-size:20px;" onclick="ShareTan(1)"></span>
				</div>
			</div>
		</div>
		<!--模板选择-->
		<div id="temps" class="mui-scroll-wrapper mui-slider-indicator mui-segmented-control hide" style="">
			<div class="mui-scroll" style="height:100px;margin-top:10px;">
				<div class="mui-control-item temp" index="0"><img src="../images/share/1.png" /></div>
				<div class="mui-control-item temp" index="1"><img src="../images/share/2.png" /></div>
				<div class="mui-control-item temp" index="2"><img src="../images/share/3.png" /></div>
				<div class="mui-control-item temp" index="3"><img src="../images/share/4.png" /></div>
				<div class="mui-control-item temp" index="4"><img src="../images/share/5.png" /></div>
				<div class="mui-control-item temp" index="5"><img src="../images/share/6.png" /></div>
				<div class="mui-control-item temp" index="6"><img src="../images/share/7.png" /></div>
				<div class="mui-control-item temp" index="7"><img src="../images/share/8.png" /></div>
				<div class="mui-control-item temp" index="8"><img src="../images/share/9.png" /></div>
			</div>
		</div>
		<!--分享-->
		<div class="mytanbg hide" id="mysharebg" onclick="ShareTan(0)"></div>
		<div class="myshare hide" id="myshare">
			<p class="f16 c000 tc mt10 mb0">分享到</p>
			<div class="tc c000 myshare_body">
				<div class="myshare_items" onclick="ShareAction(1)"><img src="../images/share/1.png" />
					<p class="f11 mb0 c000">朋友圈</p>
				</div>
				<div class="myshare_items" onclick="ShareAction(2)"><img src="../images/share/2.png" />
					<p class="f11 mb0 c000">微信</p>
				</div>
				<div class="myshare_items" onclick="ShareAction(3)"><img src="../images/share/3.png" />
					<p class="f11 mb0 c000">新浪微博</p>
				</div>
				<div class="myshare_items" onclick="ShareAction(4)"><img src="../images/share/4.png" />
					<p class="f11 mb0 c000">QQ</p>
				</div>
				<div class="myshare_items" onclick="ShareAction(5)"><img src="../images/share/5.png" />
					<p class="f11 mb0 c000">QQ空间</p>
				</div>
				<div class="myshare_items" onclick="ShareAction(6)"><img src="../images/share/6.png" />
					<p class="f11 mb0 c000">其他</p>
				</div>
				<div class="myshare_items" onclick="ShareAction(7)"><img src="../images/share/7.png" />
					<p class="f11 mb0 c000">复制链接</p>
				</div>
				<div id="isnotkeep" class="myshare_items" onclick="ShareAction(8)"><img src="../images/share/8.png" />
					<p class="f11 mb0 c000" style="">收藏</p>
				</div>
				<div id="iskeep" class="myshare_items hide"><img src="../images/share/10.png" />
					<p class="f11 mb0 c000" style="">收藏</p>
				</div>
				<div class="myshare_items" onclick="ShareAction(9)"><img src="../images/share/9.png" />
					<p class="f11 mb0 c000">举报</p>
				</div>
				<div class="c000 mt10 f11 fl btnExit" onclick="ShareTan(0)">取消</div>
			</div>
		</div>
		<!--操作-->
		<div class="mytanbg hide" id="myactionbg" onclick="ActionTan(0)"></div>
		<div class="myaction hide" id="myaction">
			<div class="tc c000 myaction_body">
				<div class="myaction_items" onclick="Delete()"><img src="../images/article/1.png" />
					<p class="f11 mb0 c000">删除</p>
				</div>
				<div class="myaction_items" onclick="Edit()"><img src="../images/article/3.png" />
					<p class="f12 mb0 c000">编辑</p>
				</div>
				<div class="myaction_items" onclick="Power()"><img src="../images/article/4.png" />
					<p class="f13 mb0 c000">权限</p>
				</div>
			</div>
		</div>
	</body>

</html>
<script src="../js/default.js"></script>
<script src="../js/mui.min.js"></script>
<script src="../js/jquery-1.10.2.min.js"></script>
<script src="../js/base.js"></script>
<script src="../js/music.js"></script>
<script type="text/javascript">
	var ArticleID = 0; //文章ID
	var ArticlePower = 0; //分享权限
	var ArticlePowerPwd = ""; //分享权限密码
	var ArticleUserID = 0; //文章作者
	var ArticleType = 0; //文章类型ID
	var ArticleTypeName = ""; //文章类型名称
	var Comments = 0;
	var Source = ""; //来源
	var ShareInfo = {}; //分享信息
	var isLoading = false;
	var currEditID = 0; //当前操作对象ID
	var MusicID = ""; //音乐控件ID
	var MusicUrl = ""; //音乐播放地址
	var userinfo = base.GetUserInfo();
	//启用双击监听
	mui.init({
		gestureConfig: {
			doubletap: true
		},
		swipeBack: false
	});

	mui.ready(function() {
		base.InitScroll();

		//模板选择
		mui('#temps').on('tap', '.temp', function() {
			$(".temp").removeClass("hover");
			$(this).addClass("hover");

		});

		//点赞
		document.getElementById('zan').addEventListener('tap', function(event) {
			HttpGet(base.RootUrl + "Zan/Edit", {
				ID: userinfo.ID,
				ArticleID: ArticleID
			}, function(data) {
				if(data != null) {
					mui.toast(data.result ? "感谢您的点赞~" : data.message);
					if(data.result) {
						$("#footer_zan").html(data.message);
					}
				}
			});
		})

		//添加评论
		document.getElementById('addcomment').addEventListener('tap', function(event) {
			base.OpenWindow("addcomment", "addcomment.html", {
				ArticleID: ArticleID
			});
		})

		//文章评论
		document.getElementById('comment').addEventListener('tap', function(event) {
			base.OpenWindow("articleComment", "articleComment.html", {
				ArticleID: ArticleID,
				CommentTitle: Comments + "条评论"
			});
		});

		//打开外链
		mui('#detail').on('tap', 'span.link', function() {
			var link = this.getAttribute("link");
			if(base.IsNullOrEmpty(link)) {
				return;
			}
			base.OpenWindow("showhref", "showhref.html", {
				Link: link
			});
		});

		//重新加载数据
		window.addEventListener("UpdatePower", function(e) {
			ArticlePower = e.detail.ArticlePower;
			ArticlePowerPwd = e.detail.ArticlePowerPwd;
			ArticleType = e.detail.ArticleType;
			ArticleTypeName = e.detail.ArticleTypeName;
		});
	});

	var Intent = null,
		File = null,
		Uri = null,
		main = null;
	mui.plusReady(function() {
		//判断网络类型
		if(plus.networkinfo.getCurrentType() == plus.networkinfo.CONNECTION_NONE) {
			mui.toast("网络异常，请检查网络设置！");
		}

		var self = plus.webview.currentWebview();
		ArticleID = self.ArticleID || 0;
		Source = self.Source || "Add";

		Load(function() {
			var page = plus.webview.getWebviewById("addarticle");
			if(page != null) {
				plus.webview.close(page);
			}
		});

		//返回
		mui.back = function() {
			if(Source == "Add") {
				var editimage = plus.webview.getWebviewById("editimage");
				plus.webview.close(editimage);
			}
			plus.webview.close(self);
		}

		//返回
		document.getElementById("back").addEventListener('tap', function(event) {
			mui.back();
		});

		//分享设置
		updateSerivces();
		if(plus.os.name == "Android") {
			Intent = plus.android.importClass("android.content.Intent");
			File = plus.android.importClass("java.io.File");
			Uri = plus.android.importClass("android.net.Uri");
			main = plus.android.runtimeMainActivity();
		}
	});

	//复制到剪贴板
	function copyToClip() {
		var Context = plus.android.importClass("android.content.Context");
		var main = plus.android.runtimeMainActivity();
		var clip = main.getSystemService(Context.CLIPBOARD_SERVICE);
		plus.android.invoke(clip, "setText", ShareInfo.Url);
		mui.toast("复制成功");
	}

	//更新文章评论数
	function UpdateComment() {
		Comments += 1;
		$("#footer_comment").html(Comments);
	}

	//重新加载数据
	function UpdateDetail() {
		Load(function() {
			plus.webview.close("addarticle");
		});
	}

	//加载文章
	function Load(callback) {
		var data = {
			ID: userinfo.ID,
			ArticleID: ArticleID
		}
		HttpGet(base.RootUrl + "Article/Detail", data, function(data) {
			if(data != null) {
				if(data.result) {
					data = data.message
					ArticlePower = data.ArticlePower;
					ArticlePowerPwd = data.ArticlePowerPwd;
					ArticleType = data.TypeID;
					ArticleTypeName = data.TypeName;
					ArticleUserID = data.CreateUserID;

					$(".user").attr("userid", ArticleUserID);

					//段落
					var html = [];
					var parts = data.ArticlePart;
					for(var i = 0; i < parts.length; i++) {
						var part = parts[i];
						if(part.Types == 1) {
							//图片
							html.push('<div class="full f13 mt10"><img src="' + part.Introduction + '" class="full" /></div>');
						} else if(part.Types == 2) {
							//文本
							html.push('<div class="full f13 mt10">' + part.Introduction + '</div>');
						} else if(part.Types == 3) {
							//视频
							html = appendStr("点击添加视频", "video", part.ID);
						}
					}

					$("#footer_zan").html(data.Goods);
					$("#footer_comment").html(data.Comments);

					//排版
					var mainIndex = 1;
					$("#title" + mainIndex).html(data.Title);
					$("#nickname" + mainIndex).html(data.NickName).attr("userid", userinfo.ID);
					$("#createdate" + mainIndex).html(data.CreateDateText);
					$("#views" + mainIndex).html("阅读  " + data.Views);
					$("#desc" + mainIndex).html(html.join(""));

					//音乐
					MusicID = "music" + mainIndex;
					MusicUrl = data.MusicUrl;
					if(!base.IsNullOrEmpty(data.MusicUrl)) {
						if(data.AutoMusic == 1) {
							document.addEventListener('touchstart', startsound);
						}
					} else {
						$("#music" + mainIndex).addClass("hide");
					}

					switch(mainIndex) {
						case 0:
							$("#musicname0").html(data.MusicName);
							$("#main" + mainIndex).removeClass("hide");
							break;
						case 1:
							$("#useravatar1").attr("src", data.Avatar);
							$("#main1").removeClass("hide");
							break;
						default:
							break;
					}

					Comments = data.Comments;

					//显示操作
					if(userinfo.ID == ArticleUserID) {
						$("#action").removeClass("hide");
					} else {
						base.ShowUser("#body");
					}

					//分享信息
					ShareInfo.Title = data.Title;
					ShareInfo.Cover = data.Cover;
					ShareInfo.Url = data.ShareUrl;

					//收藏状态
					CheckKeep();
				} else {
					mui.toast(data.message);
					plus.webview.currentWebview().close();
				}
			}
			if($.isFunction(callback)) {
				callback();
			}
			setTimeout(function() {
				plus.nativeUI.closeWaiting();
			}, 300);
		});
	}

	//删除
	function Delete() {
		ActionTan(0);
		var btnArray = ['确定', '取消'];
		mui.confirm('删除后将无法在微信浏览器中浏览', '确定要删除这篇文章吗？', btnArray, function(e) {
			if(e.index == 0) {
				HttpGet(base.RootUrl + "Article/Delete", {
					ID: userinfo.ID,
					ArticleID: ArticleID
				}, function(data) {
					if(data != null) {
						if(data.result) {
							plus.webview.close("articledetail");
						}
					}
				});
			}
		});
	}

	//编辑 
	function Edit() {
		ActionTan(0);
		plus.nativeUI.showWaiting("载入中...");
		base.OpenWindow("addarticle", "addarticle.html", {
			ArticleID: ArticleID,
			Source: Source
		});
	}

	//权限
	function Power() {
		ActionTan(0);
		base.OpenWindow("sharesetting", "sharesetting.html", {
			ArticleID: ArticleID,
			ArticlePower: ArticlePower,
			ArticlePowerPwd: ArticlePowerPwd,
			ArticleType: ArticleType,
			ArticleTypeName: ArticleTypeName
		});
	}

	//判断是否收藏
	function CheckKeep() {
		if(base.CheckKeep(userinfo.KeepText, ArticleID)) {
			$("#iskeep,#isnotkeep").toggleClass("hide");
		} else {
			document.getElementById("isnotkeep").addEventListener('tap', function(e) {
				if(isLoading)
					return;
				isLoading = true;
				HttpGet(base.RootUrl + "Keep/Edit", {
					ID: userinfo.ID,
					ArticleID: ArticleID
				}, function(data) {
					if(data != null) {
						if(data.result) {
							base.AddKeep(userinfo, ArticleID);
							$("#iskeep,#isnotkeep").toggleClass("hide");
						}
						mui.toast(data.result ? "收藏成功" : data.message);
					}
					isLoading = false;
				});
			});
		}
	}

	//分享
	var shares = null; //分享服务
	var shareImageUrl = ''; //分享图片地址

	//更新分享服务
	function updateSerivces() {
		plus.share.getServices(function(s) {
			shares = {};
			for(var i in s) {
				var t = s[i];
				shares[t.id] = t;
			}
			console.log("获取分享服务列表成功");
		}, function(e) {
			console.log("获取分享服务列表失败：" + e.message);
		});
	}

	//分享弹窗
	function ShareTan(index) {
		if(ArticlePower == 0) {
			return mui.toast("私密文章不可以分享");
		}
		if(index == 0) {
			$("#mysharebg").addClass("hide");
			$("#myshare").removeClass("bounceIn").addClass("bounceOut");
		} else {
			$("#mysharebg").removeClass("hide");
			$("#myshare").removeClass("hide").removeClass("bounceOut").addClass("bounceIn");
		}
	}

	//操作弹窗
	function ActionTan(index) {
		if(index == 0) {
			$("#myactionbg").addClass("hide");
			$("#myaction").removeClass("bounceIn").addClass("bounceOut");
		} else {
			$("#myactionbg").removeClass("hide");
			$("#myaction").removeClass("hide").removeClass("bounceOut").addClass("bounceIn");
		}
	}

	//分享信息
	function ShareAction(index) {
		ShareTan(1); //关闭分享弹窗

		//系统分享
		if(index == 6) {
			ShareTan(0);
			ShareSystem();
			return;
		}
		//复制链接
		if(index == 7) {
			ShareTan(0);
			copyToClip();
			return;
		}
		//收藏
		if(index == 8) {
			return;
		}
		//举报
		if(index == 9) {
			return;
		}

		var id = "";
		var ex = "";
		switch(index) {
			//朋友圈
			case 1:
				id = "weixin";
				ex = "WXSceneTimeline";
				break;
				//微信
			case 2:
				id = "weixin";
				ex = "WXSceneSession";
				break;
				//新浪微博
			case 3:
				id = "sinaweibo";
				ex = "";
				break;
				//qq
			case 4:
				id = "qq";
				ex = "";
				break;
				//qq空间
			case 5:
				id = "qq";
				ex = "";
				break;
			default:
				break;
		}
		var s = null;
		if(!id || !(s = shares[id])) {
			console.log("无效的分享服务！");
			return;
		}
		if(s.authenticated) {
			shareMessage(s, ex, id);
		} else {
			mui.toast("授权中");
			s.authorize(function() {
				shareMessage(s, ex, id);
			}, function(e) {
				mui.toast("认证授权失败");
			});
		}
	}

	//系统分享
	function ShareSystem() {
		if(plus.os.name !== "Android") {
			plus.nativeUI.alert("此平台暂不支持系统分享功能!");
			return;
		}
		var intent = new Intent(Intent.ACTION_SEND);
		intent.setType("text/plain");
		intent.putExtra(Intent.EXTRA_SUBJECT, "【我的GO-" +
			ShareInfo.Title + "】" + " " + ShareInfo.Url);
		intent.putExtra(Intent.EXTRA_TEXT, "【我的GO-" +
			ShareInfo.Title + "】" + " " + ShareInfo.Url);
		intent.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK);
		main.startActivity(Intent.createChooser(intent, "系统分享"));
		base.ShareLog(userinfo.ID, ArticleID, "system");
	}

	//发送分享信息
	function shareMessage(s, ex, id) {
		var msg = {
			href: ShareInfo.Url,
			title: "【我的GO-" + ShareInfo.Title + "】",
			content: ShareInfo.Title,
			thumbs: [ShareInfo.Cover],
			pictures: [ShareInfo.Cover],
			extra: {
				scene: ex
			}
		};
		s.send(msg, function() {
			ShareTan(0);
			mui.toast("分享成功");
			base.ShareLog(userinfo.ID, ArticleID, id);
		}, function(e) {
			mui.toast("分享失败");
		});
	}
</script>