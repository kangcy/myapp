<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title></title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<link rel="stylesheet" href="../mincss/mui.min.css">
		<link rel="stylesheet" href="../mincss/img.preview.min.css">
		<link rel="stylesheet" href="../mincss/loading.min.css">
		<style type="text/css">
			.tip {
				position: fixed;
				bottom: 2%;
				text-align: center;
				width: 100%;
				z-index: 2;
			}
			
			.tip div {
				padding: 10px 20px;
				border-radius: 10px;
				background: rgba(0, 0, 0, 0.5);
				color: #fff;
				display: inline-block;
			}
			
			.thirdfloor .cover {
				position: absolute;
				left: 0px;
				top: 0px;
				width: 100%;
				height: 100%;
			}
			
			.thirdfloor.yescheck .cover {
				background: rgba(0, 0, 0, 0.5);
			}
			
			.thirdfloor .icon {
				position: absolute;
				right: 0.5rem;
				top: 0.5rem;
				width: 1.3rem;
				height: 1.3rem;
			}
			
			.thirdfloor.nocheck .icon {
				background: url(../images/my/nocheck.png) no-repeat;
				background-size: 100% 100%;
				background-position: center center;
			}
			
			.thirdfloor.yescheck .icon {
				background: url(../images/my/check.png) no-repeat;
				background-size: 100% 100%;
				background-position: center center;
			}
		</style>
	</head>

	<body id="main">

	</body>

</html>
<script src="../minjs/mui.min.js"></script>
<script src="../minjs/base.min.js"></script>
<script src="../minjs/mui.pullToRefresh.min.js"></script>
<script src="../minjs/mui.pullToRefresh.material.min.js"></script>
<script src="../minjs/PullRefresh.min.js"></script>
<script src="../minjs/mui.zoom.min.js"></script>
<script src="../minjs/mui.previewimage.min.js"></script>
<script type="text/javascript">
	pagesize = 18;
	var UserNumber = 0;
	var PreviewEnable = true; //是否启用图片预览
	var $confirm = null;
	var mask = base.CreateMask(false, function() {
		base.CloseWaiting();
	});

	mui.init({
		gestureConfig: {
			doubletap: true,
			longtap: true
		}
	});

	mui.ready(function() {

		mui('#main').load("../part/list.html", function(response) {
			$confirm = base.Get("confirm");
			base.Immersed();
			base.Get("title").innerHTML = "相册";
			$confirm.innerHTML = "删除";
			$confirm.onclick = function() {
				Confirm()
			};
			base.Get("none_img").setAttribute("src", "../images/my/666.png");
			base.Get("none_tip").innerHTML = "这里还没有内容";

			var div = document.createElement('div');
			div.className = 'tip f11 hide';
			div.setAttribute("id", "tip");
			div.innerHTML = "<div>在动态中发表的图片会自动加入相册<br />（长按删除选中图片）</div>";
			base.Get("main").appendChild(div);

			base.InitScroll();

			mui.previewImage();
		});
	});

	mui.plusReady(function() {
		var self = plus.webview.currentWebview();
		UserNumber = self.UserNumber || "";

		if(UserNumber != "") {
			base.InitPull("scroll", function() {
				PreviewEnable = true;
			});

			//选中切换
			mui("#scroll").on('tap', '.thirdfloor', function(event) {
				if(PreviewEnable) {
					return;
				}
				this.classList.toggle("yescheck");
				if(mui(".yescheck").length > 0) {
					$confirm.classList.remove("hide");
				} else {
					$confirm.classList.add("hide");
				}
			});

			if(UserNumber == userinfo.Number) {
				base.Get("tip").classList.remove("hide");
				mui("#scroll").on('longtap', '.thirdfloor', function(event) {
					PreviewEnable = false;
					Preview(PreviewEnable, this);
				});
			}
		}
	});

	function Preview(PreviewEnable, $this) {
		//屏蔽图片预览
		mui.setPreviewEnable(PreviewEnable);
		if(PreviewEnable) {
			base.AddClass([".yescheck,#confirm"], "hide");
			base.RemoveClass([".thirdfloor"], "nocheck yescheck");
		} else {
			base.RemoveClass([".yescheck,#confirm"], "hide");
			base.AddClass([".thirdfloor"], "nocheck");
			$this.classList.add("yescheck");
		}
	}

	/**
	 * 加载数据
	 */
	function Load(callback) {
		var data = {
			page: currpage,
			rows: pagesize,
			Number: userinfo.Number,
			UserNumber: UserNumber
		};
		LoadPull(base.RootUrl + "Api/User/Pic", data, true, false, function(item) {
			return AppendStr(item);
		}, callback);
	}

	function AppendStr(item) {
		var div = document.createElement('div');
		if(PreviewEnable) {
			div.className = 'thirdfloor';
		} else {
			div.className = 'thirdfloor nocheck';
		}
		div.style.position = "relative";
		div.setAttribute("pid", item.ID);
		div.innerHTML = '<img src="' + base.ShowThumb(item.Introduction, 2) + '" href="' + base.ShowThumb(item.Introduction, 1) + '" data-preview-src="" data-preview-group="0" /><div class="cover ' + (PreviewEnable ? "hide" : "") + '"></div><div class="icon"></div>';
		return div;
	}

	function Confirm() {
		if(isLoading) {
			return false;
		}
		isLoading = true;
		var check = mui(".yescheck");
		if(check.length == 0) {
			isLoading = false;
			return mui.toast("请选择图片");
		}
		var $this = this;
		var btnArray = ['确定', '取消'];
		mui.confirm('删除后不可恢复,确定删除选中图片？', '', btnArray, function(e) {
			if(e.index < 0) {
				return;
			}
			if(e.index == 0) {
				mask.show();
				base.ShowWaiting("正在删除");
				var ids = [];
				mui.each(check, function(i, item) {
					ids.push(item.getAttribute("pid"));
				});
				HttpGet(base.RootUrl + "User/PicDelete", {
						ID: userinfo.ID,
						PartID: ids.join(",")
					},
					function(data) {
						mui.later(function() {
							mask.close();
							if(data != null) {
								if(data.result) {
									PreviewEnable = true;
									Preview(PreviewEnable);
									mui.each(check, function(i, item) {
										base.Get("scroll-view").removeChild(item);
									});
								} else {
									mui.toast(data.message);
								}
							}
							isLoading = false;
						}, 500);
					});
			} else {
				isLoading = false;
			}
		});
	}
</script>