<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title></title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<link rel="stylesheet" href="../css/mui.min.css">
		<style type="text/css">
			body {
				background: #eee;
			}
			
			.mui-bar {
				background: #fff;
			}
			
			.mui-table-view-cell {
				padding: .8rem 0.9375rem;
			}
			
			.mui-table-view-cell:after {
				left: 0.9375rem;
				right: 0.9375rem;
			}
			
			.mui-table-view:after {
				height: 0px;
			}
		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav">
			<a id="back" class="mui-icon mui-icon-back fl"></a>
			<h1 class="mui-title c333">通用设置</h1>
		</header>
		<div class="mui-content">
			<ul class="mui-table-view f13" style="margin-top:0px;">
				<li class="mui-table-view-cell" onclick="BindPhone()">
					<span class="fl">绑定手机号</span>
					<span class="mui-pull-right caaa">18652913873</span>
				</li>
				<li class="mui-table-view-cell">
					<span class="fl">绑定微信账号</span>
					<div class="mui-switch mui-active" id="weixinSwitch">
						<div class="mui-switch-handle"></div>
					</div>
				</li>
				<li class="mui-table-view-cell">
					<span class="fl">绑定微博账号</span>
					<div class="mui-switch mui-active" id="weiboSwitch">
						<div class="mui-switch-handle"></div>
					</div>
				</li>
				<li class="mui-table-view-cell" onclick="BindEmail()">
					<span class="fl">绑定邮箱</span>
					<span class="mui-pull-right caaa">735149528@qq.com</span>
				</li>
				<li class="mui-table-view-cell">
					<span class="fl">清除缓存</span>
					<span class="mui-pull-right caaa">600M</span>
				</li>
				<li class="mui-table-view-cell">
					<span class="fl">分享带昵称</span>
					<div class="mui-switch mui-active">
						<div class="mui-switch-handle"></div>
					</div>
				</li>
				<li class="mui-table-view-cell">
					<span class="fl">音乐自动播放</span>
					<div class="mui-switch mui-active">
						<div class="mui-switch-handle"></div>
					</div>
				</li>
				<li class="mui-table-view-cell" onclick="Share(1)">
					检查更新
				</li>
			</ul>
			<div style="background: #eee;width:100%;height:10px;"></div>
			<ul class="mui-table-view f13">
				<li class="mui-table-view-cell">
					<a id="exit" style="text-align: center;color: #FF3B30;">
						退出登录
					</a>
				</li>
			</ul>
		</div>

	</body>

</html>
<script src="../js/default.js"></script>
<script src="../js/jquery-1.10.2.min.js"></script>
<script src="../js/mui.min.js"></script>
<script src="../js/base.js"></script>
<script src="../js/login.js"></script>
<script type="text/javascript">
	mui.init({
		gestureConfig: {
			doubletap: true
		},
		swipeBack: false //启用右滑关闭功能
	});

	mui.ready(function() {
		var btnArray = ['去绑定', '取消'];
		mui.confirm('提示', '您还没有绑定手机号，绑定后账号更安全。', btnArray, function(e) {
			if(e.index == 0) {
				BindPhone();
			}
		});

		//绑定微信切换
		document.getElementById("weixinSwitch").addEventListener('toggle', function(event) {
			var status = event.detail.isActive;
			if(status) {
				authLogin('weixin');
			} else {

			}
		});

		//绑定微博切换
		document.getElementById("weiboSwitch").addEventListener('toggle', function(event) {
			var status = event.detail.isActive;
			if(status) {
				authLogin('sinaweibo');
			} else {

			}
		});
	});

	var auths = {};
	mui.plusReady(function() {
		plus.oauth.getServices(function(services) {
			auths = services;
		}, function(e) {
			alert("获取登录服务列表失败：" + e.message + " - " + e.code);
		});

		//返回
		mui.back = function() {
			plus.webview.close(plus.webview.currentWebview());
		}

		//返回
		document.getElementById("back").addEventListener('tap', function(event) {
			mui.back();
		});

		//退出操作
		document.getElementById('exit').addEventListener('tap', function() {
			var btnArray = [{
				title: "注销当前账号"
			}, {
				title: "直接关闭应用"
			}];
			plus.nativeUI.actionSheet({
				cancel: "取消",
				buttons: btnArray
			}, function(event) {
				var index = event.index;
				switch(index) {
					case 1:
						var btnArray = ['确定退出', '取消'];
						mui.confirm('提示', '退出当前账号不会删除任何数据，下次登录仍可使用本账号。', btnArray, function(e) {
							if(e.index == 0) {
								app.loginOut();
								var loginPage = plus.webview.getWebviewById("login");
								if(loginPage != null) {
									plus.webview.close(loginPage)
								}
								var indexPage = plus.webview.getWebviewById("index");
								if(indexPage != null) {
									plus.webview.close(indexPage)
								}
								var subindexPage = plus.webview.getWebviewById("subindex");
								if(subindexPage != null) {
									plus.webview.close(subindexPage)
								}
								mui.openWindow({
									url: 'login.html',
									id: 'login',
									show: {
										autoShow: true,
										duration: base.AnimateDuration
									},
									waiting: {
										autoShow: false
									}
								});
							}
						});
						break;
					case 2:
						plus.runtime.quit();
						break;
				}
			});
		}, false);
	});

	//绑定手机号
	function BindPhone() {
		mui.openWindow({
			id: 'bindphone',
			url: 'bindphone.html',
			show: {
				autoShow: true,
				duration: base.AnimateDuration
			},
			waiting: {
				autoShow: false
			}
		});
	}

	//绑定邮箱
	function BindEmail() {
		mui.openWindow({
			id: 'bindemail',
			url: 'bindemail.html',
			show: {
				autoShow: true,
				duration: base.AnimateDuration
			},
			waiting: {
				autoShow: false
			}
		});
	}

	//登录操作 
	function authLogin(type) {
		mui.toast("正在授权~~")
		var s;
		for(var i = 0; i < auths.length; i++) {
			if(auths[i].id == type) {
				s = auths[i];
				break;
			}
		}
		if(!s.authResult) {
			s.login(function(e) {
				mui.toast("绑定中~~");
				authUserInfo(type);
			}, function(e) {
				mui.toast("登录认证失败~~");
			});
		} else {
			mui.toast("已登录认证~~");
		}
	}

	//注销 
	function authLogout() {
		for(var i in auths) {
			var s = auths[i];
			if(s.authResult) {
				s.logout(function(e) {
					console.log("注销登录认证成功~~");
				}, function(e) {
					console.log("注销登录认证失败~~");
				});
			}
		}
	}

	//登录认证信息 
	function authUserInfo(type) {
		var s;
		for(var i = 0; i < auths.length; i++) {
			if(auths[i].id == type) {
				s = auths[i];
				break;
			}
		}
		if(!s.authResult) {
			mui.toast("未授权登录！");
		} else {
			s.getUserInfo(function(e) {
				var josnStr = JSON.stringify(s.userInfo);
				var jsonObj = s.userInfo;
				console.log("获取用户信息成功：" + josnStr);

				var loginInfo = showData(type, jsonObj);
				app.loginThird(loginInfo, function(err) {
					if(err) {
						mui.toast(err);
						return;
					}
					plus.nativeUI.showWaiting("载入中...");
					toMain();
				});

				authLogout();
			}, function(e) {
				mui.toast("获取用户信息失败：" + e.message + " - " + e.code);
			});
		}
	}

	//显示用户信息 
	function showData(type, data) {
		var loginInfo = {};
		switch(type) {
			case 'weixin':
				//{"openid":"oRrdQt8RTwroyZTnROSsJKHRM1Yw","nickname":"一个傻瓜","sex":1,"language":"zh_CN","city":"Changzhou","province":"Jiangsu","country":"CN","headimgurl":"http://wx.qlogo.cn/mmopen/eytJa9K5jkpPNvxRBGM4nIVq8iaaAH7Al37gxgs7t3TomcxByyFmYcvxhmBPRRFwrtKHapYGs8OSTticyOWLhbanpmrgMQiabsR/0","privilege":[],"unionid":"oU5Yyt4lcveMTHQvHHnE_kymcuDQ"}
				loginInfo.NickName = data.nickname;
				loginInfo.Avatar = data.headimgurl;
				loginInfo.Sex = data.sex == 1 ? 0 : 1;
				loginInfo.OpenID = data.openid;
				break;
			case 'sinaweibo':
				//{"id":5332090239,"idstr":"5332090239","class":1,"screen_name":"康春阳93212","name":"康春阳93212","province":"100","city":"1000","location":"其他","description":"","url":"","profile_image_url":"http://tva4.sinaimg.cn/crop.0.0.100.100.50/005OQUftjw8elc7b5ibj4j302s02sa9v.jpg","cover_image_phone":"http://ww1.sinaimg.cn/crop.0.0.640.640.640/549d0121tw1egm1kjly3jj20hs0hsq4f.jpg","profile_url":"u/5332090239","domain":"","weihao":"","gender":"m","followers_count":1,"friends_count":22,"pagefriends_count":0,"statuses_count":0,"favourites_count":0,"created_at":"Wed Oct 15 22:15:06 +0800 2014","following":false,"allow_all_act_msg":false,"geo_enabled":true,"verified":false,"verified_type":-1,"remark":"","ptype":0,"allow_all_comment":true,"avatar_large":"http://tva4.sinaimg.cn/crop.0.0.100.100.180/005OQUftjw8elc7b5ibj4j302s02sa9v.jpg","avatar_hd":"http://tva4.sinaimg.cn/crop.0.0.100.100.1024/005OQUftjw8elc7b5ibj4j302s02sa9v.jpg","verified_reason":"","verified_trade":"","verified_reason_url":"","verified_source":"","verified_source_url":"","follow_me":false,"online_status":0,"bi_followers_count":0,"lang":"zh-cn","star":0,"mbtype":0,"mbrank":0,"block_word":0,"block_app":0,"credit_score":80,"user_ability":0,"urank":3}
				loginInfo.NickName = data.screen_name;
				loginInfo.Avatar = data.avatar_large;
				loginInfo.Sex = data.gender == "m" ? 0 : 1;
				loginInfo.OpenID = data.id;
				break;
			default:
				break;
		}
		return loginInfo;
	}
</script>