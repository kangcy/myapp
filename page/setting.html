<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title>设置</title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<link rel="stylesheet" href="../css/mui.min.css">
		<link rel="stylesheet" href="../css/animate.css">
		<style type="text/css">
			body {
				background: #eee;
			}
			
			.mui-bar {
				background: #fff;
			}
			
			.mui-table-view-cell {
				padding: .8rem 0.9375rem;
			}
			
			.mui-table-view:after {
				height: 0px;
			}
			/**进度条**/
			
			progress {
				border-radius: 2px;
				background-color: #eee;
				height: 1rem;
			}
			
			progress::-webkit-progress-bar {
				background-color: #d7d7d7;
			}
			
			progress::-webkit-progress-value {
				background-color: #aadd6a;
			}
			
			.myprogress {
				position: fixed;
				left: 0px;
				top: 0px;
				width: 100%;
				z-index: 1000;
				display: block;
			}
			
			.myprogress .myaction_body {
				width: 100%;
				padding: 5%;
				display: inline-block;
			}
		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav">
			<a id="back" class="mui-icon mui-icon-back fl"></a>
			<h1 class="mui-title c333">设置</h1>
		</header>
		<div class="mui-content">
			<ul class="mui-table-view f13">
				<li class="mui-table-view-cell" id="account">
					<a class="mui-navigate-right">
						<span class="fl">账号管理</span>
						<span class="fr caaa"></span>
					</a>
				</li>
				<li class="mui-table-view-cell" id="secret">
					<a class="mui-navigate-right">
						<span class="fl">隐私设置</span>
						<span class="fr caaa"></span>
					</a>
				</li>
			</ul>
			<ul class="mui-table-view f13 mt15">
				<li class="mui-table-view-cell">
					<p class="fl full c000">图片水印</p>
					<span class="fl caaa f11 mt5">开启后新导入图片自动添加水印</span>
					<div class="divSwitch2">
						<div class="my-switch fr" id="drawSwitch">
							<div></div>
						</div>
					</div>
				</li>
				<li class="mui-table-view-cell">
					<span class="fl">分享带昵称</span>
					<div class="divSwitch">
						<div class="my-switch fr" id="shareNickSwitch">
							<div></div>
						</div>
					</div>
				</li>
				<li class="mui-table-view-cell">
					<span class="fl">音乐自动播放</span>
					<div class="divSwitch">
						<div class="my-switch fr" id="autoMusicSwitch">
							<div></div>
						</div>
					</div>
				</li>
				<li class="mui-table-view-cell" id="checkupdate">
					<span class="fl">检查更新</span>
					<span class="fr caaa" id="version"></span>
				</li>
			</ul>
			<ul class="mui-table-view f13 mt15">
				<li class="mui-table-view-cell">
					<a id="exit" style="text-align: center;color: #FF3B30;">
						退出登录
					</a>
				</li>
			</ul>
		</div>
		<!--更新进度条-->
		<div class="mytanbg hide" id="myprogressbg"></div>
		<div class="myprogress hide" id="myprogress">
			<div class="tc c000 myaction_body">
				<ul class="mui-table-view f13" style="border-radius: 20px;">
					<li class="mui-table-view-cell">
						<p class="full tl mb10 c333" id="checkupdate">更新进度</p>
						<progress class="fl" value="" max="" id="proDownFile" style="width:80%;"></progress>
						<span class="persent fl ml10 caaa" id="persent" style="line-height:1rem;">0%</span>
					</li>
				</ul>
			</div>
		</div>

	</body>

</html>
<script src="../js/default.js"></script>
<script src="../js/mui.min.js"></script>
<script src="../js/base.js"></script>
<script type="text/javascript">
	var isLoading = false; //是否操作中
	var userinfo = base.GetUserInfo();
	mui.init({
		gestureConfig: {
			doubletap: true
		},
		swipeBack: false //启用右滑关闭功能
	});
	mui.ready(function() {

		//启用水印
		if(userinfo.UseDraw == 1) {
			base.SwitchChange("drawSwitch", true)
		}

		//分享带昵称
		if(userinfo.ShareNick == 1) {
			base.SwitchChange("shareNickSwitch", true)
		}

		//自动播放音乐
		if(userinfo.AutoMusic == 1) {
			base.SwitchChange("autoMusicSwitch", true)
		}

		//是否启用水印
		document.getElementById("drawSwitch").addEventListener('tap', function(event) {
			if(isLoading) {
				return false;
			}
			isLoading = true;
			var draw = this.className.indexOf("active") >= 0;
			base.SwitchChange("drawSwitch", !draw);
			HttpGet(base.RootUrl + "User/EditUseDraw", {
				ID: userinfo.ID,
				UseDraw: draw ? 0 : 1
			}, function(data) {
				if(data == null) {
					mui.toast("修改失败");
					base.SwitchChange("drawSwitch", draw);
				} else {
					if(data.result) {
						userinfo.UseDraw = draw ? 0 : 1;
						localStorage.setItem('$userinfo', JSON.stringify(userinfo));
					} else {
						mui.toast("修改失败");
						base.SwitchChange("drawSwitch", draw);
					}
				}
				isLoading = false;
			});
		});

		//是否分享昵称
		document.getElementById("shareNickSwitch").addEventListener('tap', function(event) {
			if(isLoading) {
				return mui.toast("编辑中~~");
			}
			isLoading = true;
			var shareNick = this.className.indexOf("active") >= 0;
			base.SwitchChange("shareNickSwitch", !shareNick);
			HttpGet(base.RootUrl + "User/EditShareNick", {
				ID: userinfo.ID,
				ShareNick: shareNick ? 0 : 1
			}, function(data) {
				if(data == null) {
					mui.toast("修改失败");
					base.SwitchChange("shareNickSwitch", autoMusic);
				} else {
					if(data.result) {
						userinfo.ShareNick = shareNick ? 0 : 1
						localStorage.setItem('$userinfo', JSON.stringify(userinfo));
					} else {
						mui.toast("修改失败");
						base.SwitchChange("shareNickSwitch", autoMusic);
					}
				}
				isLoading = false;
			});
		});

		//是否自动播放音乐
		document.getElementById("autoMusicSwitch").addEventListener('tap', function(event) {
			if(isLoading) {
				return mui.toast("编辑中~~");
			}
			isLoading = true;
			var autoMusic = this.className.indexOf("active") >= 0;
			base.SwitchChange("autoMusicSwitch", !autoMusic);
			HttpGet(base.RootUrl + "User/EditAutoMusic", {
				ID: userinfo.ID,
				AutoMusic: autoMusic ? 0 : 1
			}, function(data) {
				if(data == null) {
					mui.toast("修改失败");
					base.SwitchChange("autoMusicSwitch", autoMusic);
				} else {
					if(data.result) {
						userinfo.AutoMusic = autoMusic ? 0 : 1
						localStorage.setItem('$userinfo', JSON.stringify(userinfo));
					} else {
						mui.toast("修改失败");
						base.SwitchChange("autoMusicSwitch", autoMusic);
					}
				}
				isLoading = false;
			});
		});
	});

	var version = "";
	mui.plusReady(function() {

		plus.runtime.getProperty(plus.runtime.appid, function(inf) {
			version = inf.version;
			document.getElementById("version").innerText = "v" + inf.version;
		});

		//退出操作
		document.getElementById('exit').addEventListener('tap', function() {
			var btnArray = [{
				title: "注销当前账号"
			}, {
				title: "直接关闭应用"
			}];
			plus.nativeUI.actionSheet({
				cancel: "取消",
				buttons: btnArray
			}, function(event) {
				switch(event.index) {
					case 1:
						mui.confirm('退出当前账号不会删除任何数据，下次登录仍可使用本账号。', '提示', ['确定退出', '取消'], function(e) {
							if(e.index == 0) {
								app.loginOut();
								plus.webview.close("login")
								plus.webview.close("index")
								plus.webview.close("subindex")
								base.OpenWindow("login", "login.html", {}, "slide-in-bottom");
							}
						});
						break;
					case 2:
						plus.runtime.quit();
						break;
				}
			});
		}, false);

		//检查更新
		document.getElementById("checkupdate").addEventListener('tap', function(event) {
			if(isLoading) {
				return;
			}
			isLoading = true;
			base.ShowWaiting("检查更新中~");
			setTimeout(function() {
				var client;
				if(mui.os.ios) {
					client = 'ios';
				} else {
					client = 'android';
				}
				HttpGet(base.RootUrl + "System/CheckUpdate", {
					version: version,
					client: client
				}, function(data) {
					base.CloseWaiting();
					isLoading = false;
					if(data == null) {
						return mui.toast("网络异常,请稍候再试");
					}
					if(data.result) {
						var remark = data.remark;
						remark = remark.replace(" ", "\n");
						mui.confirm(remark, '发现最新版本', ['立即更新', '暂不更新'], function(z) {
							if(z.index == 0) {
								document.getElementById("checkupdate").style.display = "none";
								document.getElementById("myprogressbg").classList.remove("hide");
								document.getElementById("myprogress").classList.remove("hide");
								document.getElementById("myprogress").classList.add("bounceIn");
								var dtask = plus.downloader.createDownload(data.url, {}, function(d, status) {
									if(status == 200) {
										clearInterval(i);
										document.getElementById("persent").innerHTML = "100%";
										plus.nativeUI.toast("正在准备安装环境，请稍后！");
										setTimeout(function() {
											var path = d.filename;
											plus.runtime.install(path); // 安装下载的apk文件
										}, 1000);
									} else {
										mui.toast("更新失败");
									}
								});
								dtask.start();
								var i = setInterval(function() {
									var totalSize = dtask.totalSize;
									var downloadedSize = dtask.downloadedSize;
									document.getElementById("proDownFile").setAttribute("value", downloadedSize);
									document.getElementById("proDownFile").setAttribute("max", totalSize);
									if(totalSize > 0) {
										document.getElementById("persent").innerHTML = parseInt(100 * downloadedSize / totalSize) + "%";
									}
								}, 100);
							} else {
								document.getElementById("checkupdate").style.display = "block";
							}
						});
					} else {
						document.getElementById("checkupdate").style.display = "block";
						mui.toast(data.message);
					}
				});
			}, 1000);
		});

		//返回
		mui.back = function() {
			plus.webview.close(plus.webview.currentWebview());
		}

		//返回
		document.getElementById("back").addEventListener('tap', function(event) {
			mui.back();
		});

		//账号管理
		document.getElementById('account').addEventListener('tap', function(event) {
			base.OpenWindow("accountsetting", "accountsetting.html", {});
		});

		//隐私设置
		document.getElementById('secret').addEventListener('tap', function(event) {
			base.OpenWindow("secretsetting", "secretsetting.html", {});
		});
	});
</script>