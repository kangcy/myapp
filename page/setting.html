<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title>设置</title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<link rel="stylesheet" href="../mincss/mui.min.css">
		<link rel="stylesheet" href="../mincss/animate.min.css">
		<style type="text/css">
			body {
				background: #eee;
			}
			
			.mui-bar {
				background: #fff;
			}
			
			#muicontent .mui-table-view-cell {
				padding: .8rem 0.9375rem;
			}
			
			#muicontent .mui-table-view:after {
				height: 0px;
			}
			
			#muicontent .mui-icon-arrowright {
				margin-right: -0.3rem;
			}
		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav" id="header">
			<a class="mui-icon mui-icon-back mui-action-back fl cfff"></a>
			<h1 class="mui-title cfff">通用设置</h1>
		</header>
		<!--更新进度条-->
		<div id="updatewrapper"></div>
		<!--操作-->
		<div id="action" class="mui-popover mui-popover-action mui-popover-bottom">
			<ul class="mui-table-view">
				<li class="mui-table-view-cell" id="action_keep">
					<a href="#" class="c333 f13" onclick="Cancel()">注销当前账号</a>
				</li>
				<li class="mui-table-view-cell" id="action_outkeep">
					<a href="#" class="c333 f13" onclick="Close()">直接关闭应用</a>
				</li>
			</ul>
			<ul class="mui-table-view">
				<li class="mui-table-view-cell noborder">
					<a href="#action" class="c333 f13">取消</a>
				</li>
			</ul>
		</div>
		<div class="mui-content" id="muicontent">
			<ul class="mui-table-view f13">
				<li class="mui-table-view-cell" onclick="Account()">
					<span class="fl">账号管理</span>
					<span class="mui-icon mui-icon-arrowright fr caaa f16"></span>
					<span class="fr caaa"></span>
				</li>
				<li class="mui-table-view-cell" id="secret" onclick="Secret()">
					<span class="fl">隐私设置</span>
					<span class="mui-icon mui-icon-arrowright fr caaa f16"></span>
					<span class="fr caaa"></span>
				</li>
			</ul>
			<ul class="mui-table-view f13 mt15">
				<li class="mui-table-view-cell">
					<p class="fl full c000">图片水印</p>
					<span class="fl caaa f11 mt5">开启后新导入图片自动添加水印</span>
					<div class="divSwitch2">
						<div class="my-switch fr" id="drawSwitch">
							<div></div>
						</div>
					</div>
				</li>
				<li class="mui-table-view-cell">
					<span class="fl">分享带昵称</span>
					<div class="divSwitch">
						<div class="my-switch fr" id="shareNickSwitch">
							<div></div>
						</div>
					</div>
				</li>
				<li class="mui-table-view-cell">
					<span class="fl">音乐自动播放</span>
					<div class="divSwitch">
						<div class="my-switch fr" id="autoMusicSwitch">
							<div></div>
						</div>
					</div>
				</li>
				<li class="mui-table-view-cell" id="checkupdate">
					<span class="fl">检查更新</span>
					<span class="fr caaa" id="version"></span>
				</li>
			</ul>
			<ul class="mui-table-view f13 mt15">
				<li class="mui-table-view-cell tc red">
					<div id="exit">
						退出登录
					</div>
				</li>
			</ul>
		</div>
	</body>

</html>
<script src="../minjs/mui.min.js"></script>
<script src="../minjs/base.min.js"></script>
<script src="../minjs/login.min.js"></script>
<script src="../minjs/update.min.js"></script>
<script type="text/javascript">
	var isLoading = false;
	var userinfo = base.GetUserInfo();
	var mask = base.CreateMask(false, function() {
		base.CloseWaiting();
	});

	mui.init();
	mui.ready(function() {
		base.Immersed();

		//启用水印
		if(userinfo.UseDraw == 1) {
			base.SwitchChange("drawSwitch", true)
		}

		//分享带昵称
		if(userinfo.ShareNick == 1) {
			base.SwitchChange("shareNickSwitch", true)
		}

		//自动播放音乐
		if(userinfo.AutoMusic == 1) {
			base.SwitchChange("autoMusicSwitch", true)
		}

		//是否启用水印
		base.Get("drawSwitch").addEventListener('tap', function(event) {
			if(base.RepeatAction()) {
				return;
			}
			if(isLoading) {
				return false;
			}
			isLoading = true;
			var draw = this.className.indexOf("active") >= 0;
			base.SwitchChange("drawSwitch", !draw);
			HttpGet(base.RootUrl + "User/EditUseDraw", {
				ID: userinfo.ID,
				UseDraw: draw ? 0 : 1
			}, function(data) {
				if(data == null) {
					mui.toast("修改失败");
					base.SwitchChange("drawSwitch", draw);
				} else {
					if(data.result) {
						userinfo.UseDraw = draw ? 0 : 1;
						localStorage.setItem('$userinfo', JSON.stringify(userinfo));
					} else {
						mui.toast("修改失败");
						base.SwitchChange("drawSwitch", draw);
					}
				}
				isLoading = false;
			});
		});

		//是否分享昵称
		base.Get("shareNickSwitch").addEventListener('tap', function(event) {
			if(base.RepeatAction()) {
				return;
			}
			if(isLoading) {
				return false;
			}
			isLoading = true;
			var shareNick = this.className.indexOf("active") >= 0;
			base.SwitchChange("shareNickSwitch", !shareNick);
			HttpGet(base.RootUrl + "User/EditShareNick", {
				ID: userinfo.ID,
				ShareNick: shareNick ? 0 : 1
			}, function(data) {
				if(data == null) {
					mui.toast("修改失败");
					base.SwitchChange("shareNickSwitch", autoMusic);
				} else {
					if(data.result) {
						userinfo.ShareNick = shareNick ? 0 : 1
						localStorage.setItem('$userinfo', JSON.stringify(userinfo));
					} else {
						mui.toast("修改失败");
						base.SwitchChange("shareNickSwitch", autoMusic);
					}
				}
				isLoading = false;
			});
		});

		//是否自动播放音乐
		base.Get("autoMusicSwitch").addEventListener('tap', function(event) {
			if(base.RepeatAction()) {
				return;
			}
			if(isLoading) {
				return false;
			}
			isLoading = true;
			var autoMusic = this.className.indexOf("active") >= 0;
			base.SwitchChange("autoMusicSwitch", !autoMusic);
			HttpGet(base.RootUrl + "User/EditAutoMusic", {
				ID: userinfo.ID,
				AutoMusic: autoMusic ? 0 : 1
			}, function(data) {
				if(data == null) {
					mui.toast("修改失败");
					base.SwitchChange("autoMusicSwitch", autoMusic);
				} else {
					if(data.result) {
						userinfo.AutoMusic = autoMusic ? 0 : 1
						localStorage.setItem('$userinfo', JSON.stringify(userinfo));
					} else {
						mui.toast("修改失败");
						base.SwitchChange("autoMusicSwitch", autoMusic);
					}
				}
				isLoading = false;
			});
		});
	});

	var version = "";
	mui.plusReady(function() {

		plus.runtime.getProperty(plus.runtime.appid, function(inf) {
			version = inf.version;
			base.Get("version").innerText = "v" + inf.version;
		});

		//退出操作
		base.Get('exit').addEventListener('tap', function() {
			mui('#action').popover('show');
		}, false);

		//检查更新
		base.Get("checkupdate").addEventListener('tap', function(event) {
			if(base.RepeatAction()) {
				return;
			}
			mask.show();
			base.ShowWaiting("检查更新中");

			//检查更新 
			mui('#updatewrapper').load("../part/update.html", function(response) {
				CheckUpdate(function(index) {
					mask.close();
				});
			});
		});
	});

	//账号管理
	function Account() {
		base.OpenWindow("accountsetting", "accountsetting.html", {});
	}

	//隐私设置
	function Secret() {
		base.OpenWindow("secretsetting", "secretsetting.html", {});
	}

	//注销
	function Cancel() {
		mui('#action').popover('hide');
		mui.confirm('退出当前账号不会删除任何数据，下次登录仍可使用本账号。', '', ['确定退出', '取消'], function(e) {
			if(e.index < 0) {
				return;
			}
			if(e.index == 0) {
				app.loginOut();

				var all = plus.webview.all();
				var launch = plus.webview.getLaunchWebview() //基座，不可以关掉
				for(var i = 0; i < all.length; i++) {
					if(all[i] === launch || all[i].id === "setting")
						continue;
					all[i].hide();
					all[i].close();
					all[i].clear();
				}
				base.OpenWindow("login", "login.html", {}, "zoom-fade-out");
			}
		});
	}

	//关闭 
	function Close() {
		mui('#action').popover('hide');
		plus.runtime.quit();
	}
</script>