<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title></title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<link rel="stylesheet" href="../css/mui.min.css">
		<link rel="stylesheet" href="../css/loading.min.css">
		<link rel="stylesheet" href="../cropper/cropper.css">
	</head>

	<body>
		<header class="mui-bar mui-bar-nav" style="background:#fff;">
			<a class="mui-icon mui-icon-back mui-action-back fl c333"></a>
			<h1 class="mui-title c333" id="title"></h1>
		</header>
		<div class="loading" id="loader">
			<div class="card">
				<span class="circles-loader"></span>
			</div>
		</div>
		<div id="editimage" class="mui-iframe-wrapper full tc" style="top:45px;botom:50px;">
			<img id="readyimg" style="display:none;max-width:100%;max-height:100%;" class="fl" />
		</div>
		<footer class="mui-bar mui-bar-tab" style="background:#F4F4F4;">
			<a class="mui-icon blue fl mt6 ml10" style="font-size:16px;" onclick="showActionSheet()">更换</a>
			<a class="mui-icon blue fr mt6 mr10" style="font-size:16px;" id="confirm">完成</a>
			<div class="mui-title tc">
				<div style="width:150px;display: inline-block;">
					<div style="width:50%;display:inline-block;"><img src="../images/editimage/e1.png" style="width:40px;height:40px;margin-top:3px;" onclick="rotateimgright()" /></div>
					<div style="width:50%;display:inline-block;" id="openpop"><img src="../images/editimage/e2.png" style="width:40px;height:40px;margin-top:3px;" onclick="openpop()" /></div>
					<div style="width:50%;display:none;" id="closepop"><img src="../images/editimage/e4.png" style="width:40px;height:40px;margin-top:3px;" onclick="closepop()" /></div>
					<!--<div style="width:33.3%;display:inline-block;"><img src="../images/editimage/e3.png" style="width:40px;height:40px;margin-top:3px;" onclick="closepop()" /></div>-->
				</div>
			</div>
		</footer>
	</body>

</html>
<script src="../js/jquery-1.10.2.min.js"></script>
<script src="../js/mui.min.js"></script>
<script src="../js/base.js"></script>
<script src="../cropper/cropper.min.js"></script>
<script src="../js/copper2.js"></script>
<script type="text/javascript">
	var totalheight = window.innerHeight - 95;
	var totalwidth = window.innerWidth;
	var Url = "";
	var Source = "";
	var ArticleID = 0;
	var ArticleNumber = "";
	var PartID = 0;
	var isLoading = false;
	var userinfo = base.GetUserInfo();
	var Standard = "";
	var mask = base.CreateMask(false, function() {
		
	});

	mui.init();

	mui.ready(function() {
		$("#editimage").css("height", (totalheight) + "px");
	});

	var contentWebview = null;
	mui.plusReady(function() {
		var self = plus.webview.currentWebview();
		ArticleID = self.ArticleID || 0;
		ArticleNumber = self.ArticleNumber || "";
		PartID = self.PartID || 0;
		Url = self.Url;
		Source = self.Source;
		Standard = self.Standard || "";
		var Title = self.Title || "图片编辑";
		$("#title").html(Title);

		if(base.IsNullOrEmpty(Url)) {
			base.ShowLoading(false);
			showActionSheet();
		} else {
			$("#readyimg").attr("src", Url).load(function() {
				var imagewidth = $("#readyimg").width();
				var imageheight = $("#readyimg").height();
				base.ShowLoading(false);

				if(totalheight > imageheight) {
					$("#readyimg").css("margin-top", (totalheight - imageheight) / 2 + "px");
				} else if(totalwidth > imagewidth) {
					$("#readyimg").css("margin-left", (totalwidth - imagewidth) / 2 + "px");
				} else {
					$("#readyimg").css({
						"width": "auto",
						"height": "auto"
					});
				}
				$("#readyimg").show();
			});
		}

		document.getElementById("confirm").addEventListener('tap', function(event) {
			if(base.RepeatAction()) {
				return;
			}
			confirm(function(src) {
				if(base.IsNullOrEmpty(src)) {
					mui.back();
					return;
				}
				switch(Source) {
					//文章封面
					case "ArticleCover":
						var page = plus.webview.getWebviewById("addarticle");
						page.evalJS("UpdateCover('" + src + "')")
						mui.back();
						break;
						//文章内容
					case "ArticleAvatar":
						if(isLoading) {
							return;
						}
						isLoading = true;
						base.ShowWaiting("正在创建");
						HttpGet(base.RootUrl + "ArticlePart/Edit", {
							ID: userinfo.ID,
							ArticleNumber: ArticleNumber,
							PartID: PartID,
							Types: 1,
							Introduction: src
						}, function(data) {
							base.CloseWaiting();
							if(data != null) {
								if(data.result) {
									var addarticlePage = plus.webview.getWebviewById('addarticle');
									if(addarticlePage) {
										addarticlePage.evalJS("AddPic('" + data.message + "','" + src + "','" + PartID + "')");
									}
									mui.back();
								} else {
									mui.toast(data.message);
								}
							}
							isLoading = false;
						});
						mui.back();
						break;
						//用户封面
					case "UserCover":
						var page = plus.webview.getWebviewById("my.html");
						page.evalJS("UpdateCover('" + src + "')");
						mui.back();
						break;
						//用户头像
					case "UserAvatar":
						var page = plus.webview.getWebviewById("mysetting");
						page.evalJS("UpdateAvatar('" + src + "')");
						mui.back();
						break;
					default:
						mui.back();
						break;
				}
			});
		});
	});
</script>