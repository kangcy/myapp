<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title></title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<link rel="stylesheet" href="../css/mui.min.css">
		<link rel="stylesheet" href="../css/articleType.css">
	</head>

	<body>
		<header class="mui-bar mui-bar-nav">
			<a id="back" class="mui-icon blue fl mt6" style="font-size:16px;">取消</a>
			<a id="submit" class="mui-icon blue fr mt6" style="font-size:16px;">完成</a>
			<h1 class="mui-title c333">文章类别</h1>
		</header>
		<div class="mui-iframe-wrapper" style="top:45px;bottom:0px;">
			<div class="mui-content mui-scroll-wrapper">
				<div id="slider" class="mui-slider mui-fullscreen">
					<div id="sliderTop" class="mui-scroll-wrapper mui-slider-indicator mui-segmented-control mui-segmented-control-inverted" style="background:#fff;">
						<div class="mui-scroll" id="sliderTopBody">

						</div>
					</div>
					<div class="mui-slider-group" id="sliderGroup">

					</div>
				</div>
			</div>
		</div>
	</body>

</html>
<script src="../js/default.js"></script>
<script src="../js/jquery-1.10.2.min.js"></script>
<script src="../js/mui.min.js"></script>
<script src="../js/base.js"></script>
<script type="text/javascript">
	var ArticleID = 0; //文章ID
	var ArticleType = 0; //文章类型ID
	var ArticleTypeName = 0; //文章类型名称
	var userinfo = base.GetUserInfo();
	var shareSettingPage = null;
	mui.init({
		gestureConfig: {
			doubletap: true
		},
		swipeBack: false //启用右滑关闭功能
	});

	$(function() {

		base.InitScroll();

		//选中
		$("#slider").on('tap', 'div.mui-table-view-cell', function(event) {
			$(".check").removeClass("check");
			$(this).find(".oa-contact-icon").addClass("check");
			ArticleType = $(this).find(".oa-contact-icon").attr("type");
			ArticleTypeName = $(this).find(".oa-contact-icon").attr("name");
		});

		//切换
		$("#slider").on('tap', '.mui-control-item', function(event) {
			var index = this.getAttribute("currindex");
			mui('#slider').slider().gotoItem(index);
		});

		//完成
		document.getElementById("submit").addEventListener('tap', function(event) {
			if(mui.os.plus) {
				plus.nativeUI.showWaiting();
			}
			HttpGet(base.RootUrl + "Article/EditArticleType", {
					OpenID: userinfo.OpenID,
					ArticleID: ArticleID,
					ArticleType: ArticleType
				},
				function(data) {
					if(mui.os.plus) {
						plus.nativeUI.closeWaiting();
					}
					mui.toast(data.result ? "编辑成功~" : data.message);
					if(mui.os.plus) {
						if(!shareSettingPage) {
							shareSettingPage = plus.webview.getWebviewById('sharesetting');
						}
						mui.fire(shareSettingPage, "updateArticleType", {
							"ArticleType": ArticleType,
							"ArticleTypeName": ArticleTypeName
						});
						mui.back();
					}
				});
		}, false);
	});

	mui.plusReady(function() {

		var self = plus.webview.currentWebview();
		ArticleID = self.ArticleID;
		ArticleType = self.ArticleType;
		ArticleTypeName = self.ArticleTypeName;

		//加载类型
		LoadArticleType(function() {
			//遍历父级节点
			var parent = [];
			for(var i = 0; i < articleTypes.length; i++) {
				if(articleTypes[i].ParentID == 0) {
					parent.push(articleTypes[i]);
				}
			}
			//遍历子级节点
			var sliderGroup = $("#sliderGroup");
			for(var i = 0; i < parent.length; i++) {
				var child = [];
				for(var j = 0; j < articleTypes.length; j++) {
					if(articleTypes[j].ParentID == parent[i].CurrID) {
						child.push(articleTypes[j]);
					}
				}

				var html = [];
				if(i == 0) {
					html.push('<div class="mui-slider-item mui-control-content mui-active">');
				} else {
					html.push('<div class="mui-slider-item mui-control-content">');
				}
				html.push('<div id="sliderChild' + i + '" class="mui-scroll-wrapper">');
				html.push('<div class="mui-scroll scrolls">');
				for(var l = 0; l < child.length; l++) {
					html.push('<div class="mui-table-view-cell">');
					html.push('<div class="mui-slider-cell">');
					html.push('<div class="oa-contact-cell mui-table"><div class="oa-contact-avatar mui-table-cell"><img src="' + child[l].Cover + '" /></div>');
					html.push('<div class="mui-table-cell"><div class="mui-clearfix"><p class="f13 mt15 c333 ml10">' + child[l].Name + '</p></div></div>');
					html.push('<div class="oa-contact-icon mui-table-cell ' + (child[l].ID == ArticleType ? "check" : "") + '" type="' + child[l].ID + '" name="' + child[l].Name + '"></div>');
					html.push('</div></div></div>');
				}
				html.push('</div>');
				html.push('</div>');
				html.push('</div>');
				sliderGroup.append(html.join(""));
				if(child.length > 0) {
					mui('#sliderChild' + i).scroll().reLayout();
				}
			}

			//重新注册滑动切换事件
			mui("#slider").slider();
		});

		//返回
		document.getElementById("back").addEventListener('tap', function(event) {
			mui.back();
		});
	});

	//加载文章类型
	function LoadArticleType(callback) {
		HttpGet(base.RootUrl + "ArticleType/All", {}, function(data) {
			if(data != null) {
				var length = data.list.length;
				if(length > 0) {
					articleTypes = data.list;
					var table = $('#sliderTopBody');
					var index = 0;
					for(var i = 0, len = data.list.length; i < len; i++) {
						if(data.list[i].ParentID == 0) {
							var div = appendPTypeStr(data.list[i], index);
							table.append(div);
							index += 1;
						}
					}
					mui('#sliderTop').scroll().reLayout();
				}
				if($.isFunction(callback)) {
					callback();
				}
			}
		});
	}

	/**
	 * 拼接文章类型
	 */
	function appendPTypeStr(item, index) {
		if(index == 0) {
			return '<a class="mui-control-item f12 topic mui-active" typeid="' + item.CurrID + '" typename="' + item.Name + '" currindex="' + index + '">' + item.Name + '</a>';
		} else {
			return '<a class="mui-control-item f12 topic " typeid="' + item.CurrID + '" typename="' + item.Name + '" currindex="' + index + '">' + item.Name + '</a>';
		}
	}
</script>