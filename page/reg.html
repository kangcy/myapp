<!DOCTYPE html>
<html class="ui-page-login">

	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<title></title>
		<link href="../css/mui.min.css" rel="stylesheet" />
		<style type="text/css">
			#login-form {
				display: inline-block;
				width: 100%;
			}
			
			#login-form .div1,
			#login-form .div2,
			#login-form .div3,
			#login-form .div4 {
				width: 85%;
				margin: 0px 7.5%;
				border-radius: 30px;
				height: 2.5rem;
				line-height: 2.5rem;
			}
			
			#login-form .div1 {
				background: #EFEFEF;
				background-image: url(../images/login/phone.png);
				background-repeat: no-repeat;
				background-position: 0.8rem 0.6rem;
				background-size: 1.3rem;
			}
			
			#login-form .div2 {
				background: #EFEFEF;
				background-image: url(../images/login/pwd.png);
				background-repeat: no-repeat;
				background-position: 0.8rem 0.6rem;
				background-size: 1.3rem;
			}
			
			#login-form .div3 {
				background: #EFEFEF;
				background-image: url(../images/login/user.png);
				background-repeat: no-repeat;
				background-position: 0.8rem 0.6rem;
				background-size: 1.3rem;
			}
			
			#login-form .div4 {
				color: #fff;
				background: #4087CB;
			}
			
			#login-form .text {
				height: 1.2rem;
				line-height: 1.2rem;
				margin-top: 0.6rem;
				width: 14.5rem;
				border: 0px;
				float: right;
				background: transparent;
				border-left: 1px solid #333;
				text-indent: 0rem;
				color: #999;
				border-radius: 0px;
			}
			
			#login-form .text.reg {
				float: left !important;
				width: 9.1rem;
				margin-left: 2.5rem;
				border-right: 1px solid #4087CB;
			}
			
			#reg {
				display: inline-block;
			}
		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 class="mui-title">注册</h1>
		</header>
		<div class="mui-content mui-scroll-wrapper tc">
			<div class="mui-scroll">
				<div id="login-form">
					<div class="div1 mt20">
						<input id='account' type="tel" class="text f13" placeholder="请输入您的手机号码" />
					</div>
					<div class="div2 mt20">
						<input id='code' type="number" class="text reg f13" placeholder="请输入验证码" /><span class="f13 fl mr10 ml10" style="color:#4087CB;" id="btnCode">获取验证码</span>
					</div>

					<div class="div2 mt20">
						<input id='password' type="password" class="text f13" placeholder="请输入6-16位密码" />
					</div>
					<div class="div2 mt20">
						<input id='password_confirm' type="password" class="text f13" placeholder="请再输入一次密码" />
					</div>
					<div class="div3 mt20">
						<input id='nickname' type="text" class="text f13" placeholder="请输入昵称，最多12字" />
					</div>
					<div class="div4 mt20" id='reg'>
						完成注册
					</div>
					<div class="c999 f13 mt10">
						<div id='notice'>*注册代表您同意<span class="fa-underline" style="color:#4087CB;">《Go服务协议》</span></div>
					</div>
				</div>
			</div>
		</div>
	</body>

</html>
<script type="text/javascript" src="../js/default.js"></script>
<script type="text/javascript" src="../js/mui.min.js"></script>
<script type="text/javascript" src="../js/base.js"></script>
<script type="text/javascript" src="../js/login.js"></script>
<script type="text/javascript">
	var isLoading = false;
	var isCountDown = false; //正在倒计时
	var Province = "";
	var City = "";

	/**
	 * 手机号码校验
	 **/
	var checkPhone = function(phone) {
		phone = phone || '';
		if(phone == '')
			return false;
		return phone.length == 11 && !isNaN(phone) && (/^1[3|4|5|6|7|8|9][0-9]\d{4,8}$/.test(phone));
	};

	(function($, doc) {
		$.init();

		$.ready(function() {
			base.InitScroll();

			//发送验证码
			var btnCode = document.getElementById("btnCode");
			btnCode.addEventListener('tap', function(event) {
				if(isCountDown) {
					return false;
				}
				isCountDown = true;
				var mob = document.getElementById("account").value;
				if(!checkPhone(mob)) {
					isCountDown = false;
					return mui.toast("友情提醒：您输入手机号码格式异常~");
				}
				var time = 60;
				var count = setInterval(function() {
					time--;
					if(time == 0) {
						clearInterval(count);
						isCountDown = false;
						btnCode.innerText = "获取验证码";
					} else {
						btnCode.innerText = time + "秒 ";
					}
				}, 1000);
			});
		})

		$.plusReady(function() {
			//系统定位
			plus.geolocation.getCurrentPosition(function(p) {
				console.log("注册:" + JSON.stringify(p));
				Province = p.address.province;
				City = p.address.city;
			}, function(e) {
				//mui.toast("未授权")
			});

			//返回
			mui.back = function() {
				var self = plus.webview.currentWebview();
				plus.webview.close(self);
			}

			var settings = app.getSettings();
			var accountBox = doc.getElementById('account'); //账号
			var nickname = doc.getElementById('nickname'); //昵称
			var passwordBox = doc.getElementById('password'); //密码
			var passwordConfirmBox = doc.getElementById('password_confirm'); //确认密码

			//注册
			doc.getElementById('reg').addEventListener('tap', function(event) {
				if(isLoading) {
					return false;
				}
				isLoading = true;
				base.ShowWaiting("正在注册~");
				setTimeout(function() {
					var regInfo = {
						UserName: accountBox.value,
						NickName: nickname.value,
						Password: passwordBox.value,
						Province: Province,
						City: City
					};
					var passwordConfirm = passwordConfirmBox.value;
					if(passwordConfirm != regInfo.Password) {
						base.CloseWaiting();
						isLoading=false;
						return mui.toast('密码两次输入不一致');
					}
					app.reg(regInfo, function(err) {
						if(err) {
							base.CloseWaiting();
							mui.toast(err);
							isLoading = false;
							return;
						}
						accountBox.value = "";
						nickname.value = "";
						passwordBox.value = "";
						passwordConfirmBox.value = "";
						plus.nativeUI.toast('注册成功');
						isLoading = false;
						$.openWindow({
							url: 'login.html',
							id: 'login',
							show: {
								aniShow: 'pop-in'
							}
						});
					});
				}, 1000);
			});

			//跳转用户协议页
			doc.getElementById('notice').addEventListener('tap', function(event) {
				base.OpenWindow("notice", "notice.html", {});
			});
		});
	}(mui, document));
</script>