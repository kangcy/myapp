<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title>文章编辑预览</title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<link rel="stylesheet" href="../mincss/mui.min.css">
		<link rel="stylesheet" href="../mincss/animate.min.css">
		<link rel="stylesheet" href="../css/articledetail.min.css">
		<link rel="stylesheet" href="../css/demo.css">
		<style type="text/css">
			.swiper-cover {
				background: transparent;
				position: fixed;
				left: 0;
				bottom: 0;
				width: 100%;
				height: 100%;
				z-index: 999;
			}
			
			.swiper-container {
				position: fixed;
				left: 0;
				bottom: 0;
				z-index: 1000;
			}
			
			.swiper-slide {
				font-size: 18px;
				width: auto;
				height: auto;
				-webkit-box-sizing: border-box;
				box-sizing: border-box;
				padding: 0px 0;
				font-size: 13px;
				font-family: microsoft yahei;
			}
			
			div.background {
				width: 5rem;
				height: 7.25rem;
				margin-right: 0.5rem;
				margin-bottom: 0.2rem;
				float: left;
				display: inline-block;
				position: relative;
				background-size: 150%;
				background-position: center center;
				border-radius: 5px;
			}
			
			div.background.hover {
				border: 2px solid #007aff;
				color: #007aff;
				border-radius: 8px;
			}
			
			div.background:first-child {
				margin-left: 0.5rem;
			}
			
			div.background div {
				position: absolute;
				bottom: 0px;
				font-size: 11px;
				text-align: center;
				width: 100%;
				background: rgba(0, 0, 0, 0.5);
				color: #fff;
				height: 1.6rem;
				line-height: 1.6rem;
				border-radius: 0px 0px 5px 5px;
			}
			
			div.background img {
				width: 100% !important;
				height: 100% !important;
				border-radius: 6px;
			}
			
			#mycolor .color {
				width: 3rem;
				height: 3rem;
				margin: 0.8rem 0.4rem;
				display: inline-block;
				float: left;
			}
			
			#mycool .cool {
				width: 6rem;
				height: 3rem;
				line-height: 3rem;
				margin: 0.8rem 0.4rem;
				display: inline-block;
				float: left;
			}
			
			#mycolor .color.hover {
				background-image: url(../images/addarticle/icon_pic_y.png);
				background-size: 50% 50%;
				background-position: center center;
				background-repeat: no-repeat;
			}
			
			#mycolor .color:first-child,
			#mycool .cool:first-child {
				margin-left: 0.8rem;
			}
			
			#mycolor .color:last-child,
			#mycool .cool:last-child {
				margin-right: 0.4rem;
			}
			
			.icons {
				display: inline-block;
				width: 80%;
				text-align: center;
				position: fixed;
				bottom: 1rem;
				left: 10%;
				z-index: 99999;
			}
			
			.icons .items {
				width: 33.3%;
				display: inline;
				float: left;
				text-align: center;
			}
			
			.icons .items div {
				width: 4rem;
				height: 4rem;
				display: inline-block;
				border-radius: 100%;
				color: #fff;
				background-repeat: no-repeat;
				background-size: 55%;
				background-position: center center;
				margin-bottom: 0.25rem;
			}
			
			.icons div p {
				background: rgba(0, 0, 0, 0.3);
				padding: 0.1rem 0;
				border-radius: 30px;
				color: #fff;
				width: 80%;
				display: inline-block;
				margin-top: 4.5rem;
			}
			
			.icons div.div1 {
				background-image: url(../images/preview/5.png);
			}
			
			.icons div.div2 {
				background-image: url(../images/preview/6.png);
			}
			
			.icons div.div3 {
				background-image: url(../images/preview/9.png);
			}
			/*.swiper-container {
				width: 100%;
				-webkit-perspective: 1200px;
				-moz-perspective: 1200px;
				-ms-perspective: 1200px;
				perspective: 1200px
			}
			
			.swiper-slide {
				width: 50%;
				-webkit-transform-style: preserve-3d;
				-moz-transform-style: preserve-3d;
				-ms-transform-style: preserve-3d;
				transform-style: preserve-3d
			}
			
			.swiper-slide .main-img {
				width: 90%;
				margin: 0 auto;
				padding: 0px;
				-webkit-box-shadow: 0 6px 6px -6px #ccc;
				-moz-box-shadow: 0 6px 6px -6px #ccc;
				box-shadow: 0 6px 6px -6px #ccc;
				background: #fff;
				background-clip: padding-box;
				display: inline-block;
				border-radius: 5px;
				overflow: hidden;
				position: relative;
			}
			
			.swiper-slide .main-img div {
				height: 2rem;
				line-height: 2rem;
				float: left;
				width: 100%;
				color: #664C65;
				font-family: 楷体; 
				position: absolute;
				bottom: 0px;
				left: 0px;
				background: linear-gradient(top, #fff 0%, #e7e7e7 100%);
				background: -webkit-linear-gradient(top, #fff 0%, #e7e7e7 100%);
				background: -ms-linear-gradient(top, #fff 0%, #e7e7e7 100%);
				background: -moz-linear-gradient(top, #fff 0%, #e7e7e7 100%);
				background: -o-linear-gradient(top, #fff 0%, #e7e7e7 100%);
			}*/
		</style>
	</head>
	<!--禁止复制-->

	<body id="body" oncontextmenu="return false" onselectstart="return false">
		<header class="mui-bar" id="header">
			<span class="mui-action-back mui-icon mui-icon-back fl cfff"></span>
			<span class="mui-icon fr mui-text cfff hide" id="submit" onclick="Save()">发布</span>
			<h1 class="mui-title cfff">文章预览</h1>
		</header>
		<div id="loader">
			<div>
				<svg viewBox="25 25 50 50" class="circular">
					<circle cx="50" cy="50" r="20" fill="none" class="path"></circle>
				</svg>
				<p class="tc f12">正在努力加载...</p>
			</div>
		</div>

		<!--漂浮特效-->
		<div id="snowwrapper"></div>
		<canvas id="snowcanvas"></canvas>
		<img id="music1" class="hide" src="../images/article/btn_music.png" onclick="switchsound()" />
		<!--固定背景-->
		<div id="x-bg" class="hide"></div>
		<div id="x-bg-base" class="hide" style="height:100%;opacity:0;"></div>
		<!--内容-->
		<div id="wrapper" class="full fl hide">
			<!--x-cover:滚动背景-->
			<div class="root" id="x-cover">
				<!--头-->
				<div id="x-top" class="full fl hide"></div>
				<div class="full fl well2 mb10" id="x-body">
					<!--用户-->
					<div class="x-head full fl hide" id="x-head">
						<div class="img-container" id="x-avatar">
							<div class="avatar" id="x-avatar-sub">
								<img id="useravatar0" src="../images/avatar.png" class="user">
							</div>
						</div>
						<div class="article-meta full tc" id="x-article">
							<p class="article-title thicker f20 well2" id="title0"></p>
							<p class="time-read mt10 f13">
								<span id="createdate0"></span>
								<span id="nickname0" class="user hide"></span>
								<span class="read-count" id="views0"></span>
							</p>
							<p class="nickname mt10 f13 hide" id="nickname1"></p>
							<p id="music0" play="on" class="music mt10 mb0 hide" onclick="switchsound()">
								<span id="musicname0" class="f11"></span>
							</p>
						</div>
					</div>
					<!--内容-->
					<div class="x-content mt10 full fl" id="x-content">
						<div class="section full" id="desc">
						</div>
						<!--半透明蒙层-->
						<div class="x-bg-blur full" id="x-bg-blur"></div>
					</div>
					<!--半透明蒙层-->
					<div class="x-bg-blur" id="x-bg-blur1"></div>
				</div>

				<!--尾-->
				<img id="x-bottom" class="full fl hide" />
			</div>
		</div>
	</body>

</html>
<script type="text/javascript" src="../js/jquery-1.10.2.min.js"></script>
<script src="../minjs/mui.min.js"></script>
<script src="../js/base.min.js"></script>
<script src="../js/music.js"></script>
<script src="http://player.youku.com/jsapi"></script>
<script src="../js/video.js"></script>
<script src="../js/articledetail_new.min.js"></script>
<script type="text/javascript">
	var Title = "";
	var ThemeColor = "";
	var Part = [];

	var CurrColorTemplate = 0;
	var CurrColorTemplateJson = null; // 当前模板设置
	var Showy = "";

	//显示遮罩
	var mask = base.CreateMask(true, function() {
		base.CloseWaiting();
	});

	//启用双击监听 
	mui.init({
		gestureConfig: {
			doubletap: true
		},
		beforeback: function() {
			if(base.CheckWaiting()) {
				return false;
			}
		}
	});

	mui.ready(function() {
		base.Immersed();
		base.ToTop();

		var headerheight = $header.clientHeight + "px";
		$wrapper.style.paddingTop = $wrapper2.style.top = $wrapper21.style.top = headerheight;

		InitReady();
	});

	var self = null;

	mui.plusReady(function() {
		self = plus.webview.currentWebview();
		ArticleID = self.ArticleID || 0;
		Title = self.Title || "";
		MusicID = self.MusicID || "";
		MusicName = self.MusicName || "";
		MusicUrl = self.MusicUrl || "";
		CurrTemplate = self.ThemeTemplate || 0;
		CurrColorTemplate = self.ColorTemplate || 0;
		Showy = self.Showy || "";
		Part = self.Part || [];
		Load(function(data) {});
	});

	//加载文章
	function Load(callback) {
		HttpGet(base.RootUrl + "Api/Article/Detail", {
			Number: userinfo.Number,
			ArticleID: ArticleID,
			Template: CurrTemplate,
			ColorTemplate: CurrColorTemplate
		}, function(data) {
			data = JSON.parse(data);
			if(data != null) {
				if(data.result) {
					data = data.message;

					Article = data;
					Article.NickName = base.UnUnicodeText(data.NickName);

					if(audio != null) {
						var item = document.getElementById("bgsound")
						item.parentNode.removeChild(item);
						audio = null;
					}

					//段落 
					var html = [];

					//过滤删除项
					var parts = Part.filter(x => {
						return x.Status != 3
					});

					parts.sort(function(a, b) {
						return a.SortID - b.SortID;
					});

					parts.forEach(part => {
						if(part.PartType == 1) {
							//图片
							html.push('<div class="full f13 fl mt10 ' + part.IntroExpand + '"><img onload="LazyImg(this)" src="../images/default.png" data-lazyload="' + base.ShowThumb(part.Introduction, 1) + '" class="full fl" /></div>');
						} else if(part.PartType == 2) {
							//文本
							var txtdiv = document.createElement("div");
							txtdiv.innerHTML = base.UnUnicodeText(part.Introduction);
							$(txtdiv).find(".edit").addClass(part.IntroExpand);
							html.push('<div class="full f13 fl mt10 edit-content" style="position:relative;">' + txtdiv.innerHTML + '</div>');
						} else if(part.PartType == 3) {
							//视频
							html.push('<div class="full f13 fl mt10 hide" style="display:inline-block;">' + AppendVideo(part.Introduction) + '</div>');
							//html.push('<div class="full f13 mt10" style="display:inline-block;position:relative;">' + AppendVideo(part.Introduction) + '<img src="../images/article/bg.png" style="width:3.5rem;position:absolute;top:40%;left:40%;" /></div>');
						} else if(part.PartType == 4) {
							//分隔
							html.push('<div class="full f13 fl mt10" style="display:inline-block;">' + part.Introduction + '</div>');
						}
					})
					if(data.TemplateJson != null) {
						if(data.TemplateJson.ID != 1) {
							CurrTemplateJson = data.TemplateJson;
							if(data.ColorTemplateJson == null) {
								ChangeThemeColor(CurrTemplateJson);
							}
						}
					}
					ChangeThemeColor(data.ColorTemplateJson);
					CurrBackground = data.BackgroundJson;
					base.Get("musicname0").innerHTML = data.MusicName;
					base.Get("useravatar0").setAttribute("src", base.ShowThumb(data.Avatar, 1));
					base.Html(["title", "title0"], Title);
					base.Html(["nickname", "nickname0", "nickname1"], Article.NickName);
					base.Html(["createdate0"], data.CreateDateText);
					base.Html(["views0"], "阅读  " + data.Views);
					base.Get("x-head").classList.remove("hide");
					base.Get("desc").innerHTML = base.UnUnicodeText(html.join(""));

					ChangeBg();

					InitShowy(Showy);

					//实例化播放器
					mui.each(mui(".youku_player"), function() {
						var $this = this;
						ShowVideo($this.getAttribute("id"), $this.getAttribute("sid"));
					})

					mui.each(mui(".video"), function() {
						var $this = this;
						//可以播放
						$this.addEventListener('canplay', function() {
							$this.parentNode.classList.remove("hide");
							//document.addEventListener('touchstart', Video($this));

							/*var img = $($this).next("img")[0];
							img.addEventListener('tap', function() { 
								mui.toast("ok");
								if($this.paused) {
									item.classList.add("hide");
									$this.play();
								} else {
									$this.pause();
								}
							});*/
						});
						//播放结束
						/*$this.addEventListener('ended', function() {
							var img = $($this).next("img")[0];
							item.classList.remove("hide");
						});*/
					});
					$wrapper.classList.remove("hide");
					base.Get("submit").classList.remove("hide");
				} else {
					mui.toast(data.message);
					self.hide();
					self.close();
				}
			}
			if(callback) {
				callback(data);
			}
			base.ShowLoading(false);
			mask.close();
		});
	}

	//初始化装扮 
	function InitShowy(src) {
		if(base.IsNullOrEmpty(src)) {
			return
		}
		LoadScript("../js/snow.js", function() {
			var srcs = src.split("|");
			if(srcs.length > 2) {
				snow.init(srcs[0], srcs[1], srcs[2])
			} else {
				snow.init(src, 1, 0)
			}
		});
	}

	function Save() {
		base.GetView("addarticle").evalJS("Save()");
	}
</script>