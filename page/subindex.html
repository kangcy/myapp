<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title></title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<link rel="stylesheet" href="../mincss/mui.min.css">
		<link rel="stylesheet" href="../mincss/animate.min.css">
		<link rel="stylesheet" href="../mincss/subindex.min.css">
		<style type="text/css">
			.mui-slider-indicator.mui-segmented-control {
				border-bottom: 1px solid #f5f5f5;
			}
			
			.mui-segmented-control.mui-segmented-control-inverted .mui-control-item.mui-active {
				font-weight: bold;
			}
			
			.tabs_active {
				position: absolute;
				bottom: 4px;
				left: 0;
				height: 2px;
				background-color: #20a0ff;
				z-index: 1;
				transition: transform .25s cubic-bezier(.645, .045, .355, 1);
				list-style: none;
			}
			
			.mui-segmented-control.mui-scroll-wrapper .mui-control-item {
				padding: 0 0.8rem;
			}
		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav cfff" id="header">
			<img id="avatar2" src="../images/avatar.png" style="width:30px;margin-top:5px;border-radius:100%;" />
			<a class="mui-icon mui-icon-search fr cfff" id="search"></a>
			<h1 class="mui-title cfff">发现</h1>
		</header>
		<div id="muicontent">
			<div id="slider" class="mui-slider">
				<div id="sliderSegmentedControl" class="mui-scroll-wrapper mui-slider-indicator mui-segmented-control mui-segmented-control-inverted">
					<div class="mui-scroll f14" id="mui-scroll"> </div>
				</div>
			</div>
		</div>
		<div class="mui-bar mui-bar-tab bottom tc cfff zoomIn" id="bottom" style="background:#fff;">
			<div id="add">
				<div class="f13" id="btnAdd">制作我的文章</div>
			</div>
		</div>
		<!--图片操作-->
		<div id="uploadwrapper"></div>
	</body>

</html>
<script src="../minjs/mui.min.js"></script>
<script src="../minjs/base.min.js"></script>
<script src="../minjs/update.min.js"></script>
<script src="../js/subindex.js"></script>
<script type="text/javascript">
	var isLoading = false;
	var self = null;
	var menu = null;
	var scroll = null;
	var groupItems = [];
	var articleTypeHtml = [];
	var headheight = "";
	var bottomheight = "";
	var menu_style = {};

	mui.init();

	mui.ready(function() {
		base.Immersed();
		base.Get("btnAdd").style.background = base.BrowserName() + 'linear-gradient(right,#4e8cfb 0%,#24c3fb 75%,#39b8fd 100%)';
		base.Get("search").addEventListener('tap', function() {
			base.OpenWindow("search", "search.html", {});
		});
	})

	var backButtonPress = 0;
	mui.plusReady(function() {
		plus.navigator.setFullscreen(false);
		self = plus.webview.currentWebview();

		Init(function(data) {
			articleTypeHtml.push('<div class="tabs_active"></div><a class="mui-control-item" href="#articletab0" data-wid="0">推荐</a>');
			groupItems.push({
				id: "articletab0",
				url: "articletab.html",
				index: 0,
				ArticleType: 0,
				PageName: "articletab0"
			})
			mui.each(data, function(i, item) {
				groupItems.push({
					id: "articletab" + item.ID,
					url: "articletab.html",
					index: i + 1,
					ArticleType: item.ID,
					PageName: "articletab" + item.ID
				})
				articleTypeHtml.push('<a class="mui-control-item" href="#articletab' + item.ID + '" data-wid="' + item.ID + '">' + item.Name + '</a>');
			})
			base.Get("mui-scroll").innerHTML = articleTypeHtml.join('');

			scroll = mui('.mui-scroll-wrapper.mui-slider-indicator.mui-segmented-control').scroll({
				scrollY: false,
				scrollX: true,
				indicators: false,
				bounce: true,
				snap: '.mui-control-item'
			});
			headheight = base.Get("header").clientHeight + base.Get("slider").clientHeight;
			bottomheight = base.Get("bottom").clientHeight;
			menu_style = {
				top: headheight,
				bottom: bottomheight,
				left: "100%",
				width: "100%",
				popGesture: "none",
				render: "always",
				scrollIndicator: "none"
			};
		})

		//打开侧滑
		base.Get("avatar2").addEventListener('tap', function() {
			if(isLoading) {
				return false;
			}
			isLoading = true;
			var view = base.GetView("my");
			if(view) {
				plus.webview.show("my", "slide-in-left", base.AnimateDuration, function() {});
			} else {
				base.OpenWindow("my", "my.html", {}, "slide-in-left", false, false, "transparent");
			}
			isLoading = false;
		});

		//新增
		base.Get("add").addEventListener('tap', function() {
			if(isLoading) {
				return false;
			}
			isLoading = true;
			var view = base.GetView("addimage");
			if(view) {
				view.evalJS("ResetAction()");
			} else {
				base.OpenWindow("addimage", "addimage.html", {}, "fade-in", false, false, "transparent");
			}
			isLoading = false;
		});

		mui.back = function() {
			backButtonPress++;
			if(backButtonPress > 1) {
				plus.runtime.quit();
			} else {
				plus.nativeUI.toast('再按一次退出应用');
			}
			mui.later(function() {
				backButtonPress = 0;
			}, 1000);
			return false;
		};

		//检查更新
		mui.later(function() {
			//监听推送消息		
			plus.push.addEventListener("receive", function(msg) {
				if(!base.IsNullOrEmpty(msg.payload)) {
					var param = msg.payload.split('|');
					//系统推荐文章、好友发布文章
					if(param[0] == PushType.Article || param[0] == PushType.FanArticle) {
						base.OpenWindow("articledetail", "articledetail.html", {
							ArticleID: param[1],
							Source: "",
							NickName: ""
						}, null, "none");
					}
					//打开评论
					if(param[0] == PushType.Comment) {
						var param = {
							ArticleID: param[1],
							ArticleNumber: param[2]
						}
						base.OpenWindow("articleComment", "articleComment.html", param);
					}
					//打开打赏
					if(param[0] == PushType.Money) {
						base.OpenWindow("pay", "pay.html", {});
					}
					//打开粉丝
					if(param[0] == PushType.Fan) {
						base.OpenWindow("fan", "fan.html", {});
					}
				}
			}, false);

			document.addEventListener("netchange", function() {
				if(plus.networkinfo.getCurrentType() == plus.networkinfo.CONNECTION_NONE) {
					mui.toast("网络异常，请检查网络设置");
				}
			}, false);
		}, 1000);
	});

	//初始化
	function Init(callback) {
		HttpGet(base.RootUrl + "Api/ArticleType/All2", {}, function(data) {
			data = JSON.parse(data);
			if(data != null) {
				if(data.result) {
					callback(data.message);
				}
			}
		});
	}

	function InitSlider() {
		var headheight = base.Get("header").clientHeight + base.Get("slider").clientHeight;
		var bottomheight = base.Get("bottom").clientHeight;
		var page = plus.webview.create('articletabs.html', 'articletabs', {
			top: headheight + "px",
			bottom: bottomheight + "px",
			left: "0px"
		}, {
			headheight: headheight,
			bottomheight: bottomheight,
			groupItems: JSON.stringify(groupItems)
		});
	}

	function InitChangeItem() {
		mui("#slider").on("tap", ".mui-control-item", function(e) {
			if(isLoading) {
				return;
			}
			isLoading = true;
			var curritem = parseInt(this.getAttribute("data-wid"));
			var olditem = parseInt(mui(".mui-active")[0].getAttribute("data-wid"));
			if(curritem == olditem) {
				return;
			}
			var from = "100%";
			var to = "-100%";
			if(curritem > olditem) {
				from = '-100%';
				to = '100%';
			}
			InitView(curritem, function() {
				var self = base.GetView("articletab" + olditem);
				var menu = base.GetView("articletab" + curritem);
				plus.webview.startAnimation({
						'view': self,
						'styles': {
							'fromLeft': '0',
							'toLeft': from
						},
						'action': 'none'
					}, {
						'view': menu,
						'styles': {
							'fromLeft': to,
							'toLeft': '0'
						},
						'action': 'none'
					},
					function(e) {
						if(e.id == menu.id) {
							scroll.gotoPage(curritem);
							ChangeItem(mui(".mui-control-item")[curritem]);
							isLoading = false;
						}
					})
			})
		});
	}

	function InitChild() {
		InitView(0, function() {
			ChangeItem(mui(".mui-control-item")[0]);
			InitChangeItem();
		});
	}

	//样式切换
	function ChangeItem($this) {
		var item = $this.parentNode.children[0];
		item.style.width = $this.clientWidth + "px";
		item.style.transform = "translateX(" + $this.offsetLeft + "px)";
		base.RemoveClass([".mui-control-item"], "mui-active");
		$this.classList.add("mui-active");
	}

	function Avartar(url) {
		base.Get("avatar2").setAttribute("src", url);
	}

	//开始检测更新
	function InitCheckUpdate() {
		InitChild();
		mui.later(function() {
			Check_Update(function(data) {
				if(!base.IsNullOrEmpty(data)) {
					base.OpenWindow("update", "update.html", {
						url: data.url,
						remark: data.remark
					}, "fade-in", "none");
				}
			});
		}, 2000);
	}
</script>