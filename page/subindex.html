<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title></title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<link rel="stylesheet" href="../mincss/mui.min.css">
		<link rel="stylesheet" href="../mincss/animate.min.css">
		<link rel="stylesheet" href="../mincss/img.preview.min.css">
		<link rel="stylesheet" href="../mincss/loading.min.css">
		<link rel="stylesheet" href="../mincss/subindex.min.css">
	</head>

	<body>
		<!--操作-->
		<div id="actionwrapper"></div>
		<!--更新进度条-->
		<div id="updatewrapper"></div>
		<!--图片操作-->
		<div id="uploadwrapper"></div>
		<div id="offCanvasWrapper" class="mui-off-canvas-wrap mui-draggable">
			<!--侧滑菜单部分-->
			<aside id="offCanvasSide" class="mui-off-canvas-left mui-transitioning">
				<div class="cover fl" id="cover">
					<div class="info">
						<div class="left">
							<img id="avatar" src="../images/logo.png" />
						</div>
						<div class="right tl">
							<p class="cfff nickname f15 textshadow mt10 bold" id="nickname"></p>
							<p class="cfff signature mt5 f12 textshadow" id="signature"></p>
						</div>
					</div>
				</div>
				<div style="width:90%;margin:0px 5%;height:4rem;margin-top:-2rem;" class="fl" id="info">
					<div class="content1 tc cfff fl fullheight mt0">
						<div class="items" id="my-articles">
							<p class="item1 f16 blue" id="articles">0</p>
							<p class="item2 f12 c999">动态</p>
						</div>
						<div class="items" id="my-keeps">
							<p class="item1 f16 blue" id="keeps">0</p>
							<p class="item2 f12 c999">收藏</p>
						</div>
						<div class="items" id="my-follows">
							<p class="item1 f16 blue" id="follows">0</p>
							<p class="item2 f12 c999">关注</p>
						</div>
						<div class="items" id="my-fans">
							<p class="item1 f16 blue" id="fans">0</p>
							<p class="item2 f12 c999">粉丝</p>
						</div>
					</div>
				</div>
				<div class="mui-scroll-wrapper" id="my-wrapper">
					<div class="mui-scroll">
						<div class="mui-content-padded">

							<div class="c333 menu f12" id="my-tip">
								好友动态
							</div>
							<div class="c333 menu f12" id="my-mypic">
								我的相册
							</div>
							<div class="c333 menu f12" id="my-mypay">
								我的打赏
							</div>
							<div class="c333 menu f12" id="my-msg">
								消息中心
							</div>
						</div>
						<div class="splitline"></div>
						<div class="mui-content-padded">
							<div class="c333 menu f12" id="my-feedback">
								意见反馈
							</div>
							<div class="c333 menu f12" id="my-good">
								给个好评
							</div>
							<div class="c333 menu f12" id="my-help">
								帮助中心
							</div>
							<div class="c333 menu f12" id="my-setting">
								设置
							</div>
						</div>
					</div>
				</div>
			</aside>

			<!--主界面部分-->
			<div class="mui-inner-wrap mui-transitioning" style="background:#fff;">
				<header class="mui-bar mui-bar-nav cfff" id="header">
					<img id="avatar2" src="../images/logo.png" style="width:30px;margin-top:5px;border-radius:100%;" />
					<a class="mui-icon mui-icon-search fr cfff" id="search"></a>
					<h1 class="mui-title cfff">发现</h1>
				</header>
				<div class="loading" id="loader">
					<div class="card">
						<span class="circles-loader"></span>
					</div>
				</div>
				<div id="offCanvasContentScroll" class="mui-content">
					<div class="mui-scroll-wrapper" id="scroll-wrapper" style="top:45px;bottom:3rem;background:#fff;">
						<div class="mui-scroll" id="slider">
							<div id="divBanner">
								<div id="banner"></div>
							</div>
							<div id="scroll-view">
							</div>
							<div id="none" class="full tc hide">
								<img src="../images/my/444.png" class="none" id="none_img" />
								<p class="f13 mt10" id="none_tip">这里还没有内容</p>
							</div>
						</div>
					</div>
					<div class="mui-bar mui-bar-tab bottom tc cfff hide" id="bottom">
						<div id="add">
							<div class="f13">我也要发图</div>
						</div>
					</div>
				</div>
				<!-- 遮罩层 -->
				<div class="mui-off-canvas-backdrop"></div>
			</div>
		</div>
	</body>

</html>
<script src="../js/jquery-1.10.2.min.js"></script>
<script src="../minjs/mui.min.js"></script>
<script src="../minjs/base.min.js"></script>
<script src="../minjs/mui.pullToRefresh.min.js"></script>
<script src="../minjs/mui.pullToRefresh.material.min.js"></script>
<script src="../minjs/PullRefresh.min.js"></script>
<script src="../js/mui.zoom.js"></script>
<script src="../js/mui.previewimage.js"></script>
<script src="../js/update.js"></script>
<script src="../js/article.js"></script>
<script src="../js/addarticle.js"></script>
<script type="text/javascript">
	var $cover = base.Get("cover");
	var PageName = "subindex";
	var Cover = "";
	var Avatar = "";
	var FirstLoad = true; //首次加载

	mui.init({
		gestureConfig: {
			doubletap: true
		}
	});

	mui.ready(function() {
		base.Immersed();

		mui('#uploadwrapper').load("../part/pic.html", function(response) {
			base.Get("add").addEventListener('tap', function() {
				length = 0;
				files = [];
				compressIndex = 0; //当前压缩图片索引 
				compressTotal = 0; //需要压缩图片个数
				currUploadImg = [];
				mui('#upload').popover('show');
			});
		});

		LoadUser();

		base.ShowUser("#slider");

		base.ShowArticle("#slider", "List", userinfo.Number);

		base.InitScroll(true);

		//用户封面
		$cover.addEventListener('tap', function() {
			base.OpenWindow("editimage", "editimage.html", {
				Url: userinfo.Cover,
				Source: "UserCover",
				Standard: "UserCover",
				Title: "封面"
			});
		});

		//用户设置
		base.Get("avatar").addEventListener('tap', function() {
			base.OpenWindow("mysetting", "mysetting.html", {});
		});

		//我的文章
		base.Get("my-articles").addEventListener('tap', function() {
			base.OpenWindow("article", "article.html", {
				CreateUserNumber: userinfo.Number,
				ArticleTypeName: "我的动态",
				Source: "My"
			});
		});

		//我的收藏
		base.Get("my-keeps").addEventListener('tap', function() {
			base.OpenWindow("keep", "keep.html", {});
		});

		//我的关注
		base.Get("my-follows").addEventListener('tap', function() {
			base.OpenWindow("follow", "follow.html", {});
		});

		//我的粉丝
		base.Get("my-fans").addEventListener('tap', function() {
			base.OpenWindow("fan", "fan.html", {});
		});

		//我的相册
		base.Get("my-mypic").addEventListener('tap', function() {
			base.OpenWindow("pic", "pic.html", {
				UserNumber: userinfo.Number
			});
		});

		//我的打赏
		base.Get("my-mypay").addEventListener('tap', function() {
			base.OpenWindow("mypay", "mypay.html", {});
		});

		//我的反馈
		base.Get("my-feedback").addEventListener('tap', function() {
			base.OpenWindow("feedback", "feedback.html", {});
		});

		//给个好评
		base.Get("my-good").addEventListener('tap', function() {
			var url = "http://app.qq.com/#id=detail&appid=1106027124"; //应用的appstore地址
			plus.runtime.openURL(url);
		});

		//帮助中心
		base.Get("my-help").addEventListener('tap', function() {
			base.OpenWindow("help", "help.html", {});
		});

		//消息
		base.Get("my-msg").addEventListener('tap', function() {
			base.OpenWindow("tipsetting", "tipsetting.html", {
				Source: "My"
			});
		});

		//系统设置
		base.Get("my-setting").addEventListener('tap', function() {
			base.OpenWindow("setting", "setting.html", {});
		});

		//打开侧滑
		base.Get("avatar2").addEventListener('tap', function() {
			CanvasToggle(true);
		});

		//搜索 
		base.Get("search").addEventListener('tap', function() {
			base.OpenWindow("search", "search.html", {});
		});

		//好友动态
		base.Get("my-tip").addEventListener('tap', function() {
			base.OpenWindow("tip", "tip.html", {});
		});
	});

	var backButtonPress = 0;
	mui.plusReady(function() {

		plus.navigator.setFullscreen(false);

		mui.later(function() {
			plus.webview.close("adv");
			plus.webview.close("guide");
			plus.webview.close("login");
		}, 2000);

		base.InitPull("slider");

		base.ArticleAction("#slider", userinfo);

		mui('#actionwrapper').load("../part/action.html", function(response) {
			mui('#slider').on('tap', '.tanaction', function() {
				var number = this.getAttribute("articleNumber");
				var id = this.getAttribute("articleId");
				var usernumber = this.getAttribute("articleUserNumber");
				ActionTan(true, number, id, usernumber);
			});
		});

		var previewImage = mui.previewImage({
			callback1: function(img) {},
			callback2: function(img) {}
		});

		//检查更新
		mui('#updatewrapper').load("../part/update.html", function(response) {
			CheckUpdate(function(index) {});
		});

		mui.back = function() {
			var check = false;
			mui(".mui-popover").each(function() {
				if(this.classList.contains('mui-active')) {
					mui('#' + this.getAttribute("id")).popover('hide');
					check = true;
				}
			});
			if(check) {
				return;
			}
			if(previewImage && previewImage.isShown()) {
				previewImage.close();
				return;
			}
			if(mui('#offCanvasWrapper').offCanvas().isShown()) {
				CanvasToggle(false);
				return;
			}
			backButtonPress++;
			if(backButtonPress > 1) {
				plus.runtime.quit();
			} else {
				plus.nativeUI.toast('再按一次退出应用');
			}
			mui.later(function() {
				backButtonPress = 0;
			}, 1000);
			return false;
		};

		//监听推送消息		
		plus.push.addEventListener("receive", function(msg) {
			if(!base.IsNullOrEmpty(msg.payload)) {
				var param = msg.payload.split('|');
				//打开文章
				if(param[0] == 0) {
					base.OpenWindow("articledetail", "articledetail.html", {
						ArticleID: param[1],
						Source: "",
						NickName: ""
					});
				}
				//打开评论
				if(param[0] == 1) {
					base.OpenWindow("articleComment", "articleComment.html", {
						ArticleID: param[1],
						ArticleNumber: param[2]
					});
				}
				//打开打赏
				if(param[0] == 2) {
					base.OpenWindow("pay", "pay.html", {});
				}
			}
		}, false);
	});

	//服务器加载用户信息
	function LoadUser() {
		base.UpdateUser(userinfo.Number, function(data) {
			userinfo = data;
			Init();
		});
	}

	//初始化绑定用户信息
	function Init() {
		if(userinfo.Cover != Cover) {
			$cover.style.background = "url(" + base.ShowThumb(userinfo.Cover, 1) + ") center center no-repeat";
			$cover.style.backgroundSize = "cover";
		}
		if(userinfo.Avatar != Avatar) {
			base.Get("avatar").setAttribute("src", base.ShowThumb(userinfo.Avatar, 2));
			base.Get("avatar2").setAttribute("src", base.ShowThumb(userinfo.Avatar, 2));
		}
		base.Get("nickname").innerHTML = base.UnUnicodeText(userinfo.NickName);
		base.Get("signature").innerHTML = base.UnUnicodeText(userinfo.Signature);

		base.Get("follows").innerHTML = userinfo.Follows;
		base.Get("fans").innerHTML = userinfo.Fans;
		base.Get("articles").innerHTML = userinfo.Articles;
		base.Get("keeps").innerHTML = userinfo.Keeps;
		base.Get("my-wrapper").style.top = base.Get("cover").clientHeight + (base.Get("info").clientHeight / 2) + 20 + "px";

		Cover = userinfo.Cover;
		Avatar = userinfo.Avatar;
	}

	//更新本地用户信息
	function Refresh() {
		userinfo = base.GetUserInfo();
		Init();
	}

	//修改封面		 
	function UpdateCover(url) {
		if(userinfo.Cover == url) {
			return;
		}
		HttpGet(base.RootUrl + "User/EditCover", {
			ID: userinfo.ID,
			Cover: url
		}, function(data) {
			if(data.result) {
				$cover.style.background = "url(" + base.ShowThumb(url, 1) + ") fixed center center no-repeat";
				$cover.style.backgroundSize = "cover";

				userinfo.Cover = url;
				localStorage.setItem('$userinfo', JSON.stringify(userinfo));
			} else {
				mui.toast(data.message);
			}
		});
	}

	/**
	 * 加载数据
	 */
	function Load(callback) {
		var data = {
			CurrUserNumber: userinfo.Number,
			page: currpage,
			rows: pagesize
		};
		HttpGet(base.RootUrl + "Api/Article/All", data, function(data) {
			data = JSON.parse(data);
			if(data != null) {
				if(data.result) {
					data = data.message;
					totalpage = data.totalpage;
					base.ShowLoading(false);
					base.Get("none").classList.add("hide");
					var table = base.Get('scroll-view');

					DelayEachArray(data.list, 0, 100, base.CurrAnimate, function(item) {
						var div = base.AppendArticle(userinfo.Number, item, false, false, false);
						if(table) {
							table.appendChild(div);
						}
					})

				} else {
					base.ShowLoading(false);
					base.Get("none").classList.remove("hide");
				}
			}
			if(data == null && currpage == 1) {
				base.ShowLoading(false);
				base.Get("none").classList.remove("hide");
			}

			if(FirstLoad) {
				mui.later(function() {
					base.Get("bottom").classList.remove("hide");
					base.Get("bottom").classList.add("zoomIn");
				}, 400);
			}
			FirstLoad = false;
			if($.isFunction(callback)) {
				callback();
			}
		});
	}

	//显示/关闭侧滑菜单
	function CanvasToggle(show) {
		mui('#offCanvasWrapper').offCanvas(show ? 'show' : 'close');
	}

	function LoadBanner() {
		HttpGet(base.RootUrl + "System/Banner", {}, function(data) {
			if(data != null) {
				var length = data.records;
				if(length > 0) {
					$("#divBanner").css("height", "8.8rem");
					var banner = $("#banner");
					var bannerHtml = [];
					bannerHtml.push('<div class="mui-slider-group mui-slider-group2 mui-slider-loop">');
					for(var j = 0, len = length; j < len; j++) {
						if(j == 0 || j == length - 1) {
							bannerHtml.push('<div class="mui-slider-item mui-slider-item-duplicate">');
						} else {
							bannerHtml.push('<div class="mui-slider-item">');
						}
						bannerHtml.push('<a href="' + data.list[j].Link + '"><img src="' + data.list[j].Cover + '"></a></div>');
					}
					bannerHtml.push('</div>');
					bannerHtml.push('<div class="mui-slider-indicator">');
					for(var j = 0, len = length - 2; j < len; j++) {
						if(j == 0) {
							bannerHtml.push('<div class="mui-indicator mui-active"></div>');
						} else {
							bannerHtml.push('<div class="mui-indicator"></div>');
						}
					}
					bannerHtml.push('</div>');
					banner.append(bannerHtml.join(""));
					banner.addClass("mui-slider");
					banner.css({
						"height": "8rem",
						"top": "0px"
					});

					mui("#banner").slider({
						interval: 5000
					});
				}
			}
		});
	}
</script>