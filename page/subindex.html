<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<title></title>
		<link href="../css/mui.min.css" rel="stylesheet" />
		<link rel="stylesheet" href="../css/img.preview.css">
		<style type="text/css">
			body {
				background: #eee;
			}
			
			.mui-bar {
				background: #fff;
			}
			
			.mui-table-view-cell {
				padding: .8rem 0.9375rem;
			}
			
			.mui-table-view-cell:after {
				left: 0.9375rem;
				right: 0.9375rem;
			}
			 
			.mui-table-view:after {
				height: 0px;
			}
			
			.item {
				width: 28px;
				height: 23px;
				margin-top: 3px;
				display: inline-block;
			}
			
			.item1 {
				background: url(../images/base/01_2.png) no-repeat;
				background-size: 100% 100%;
				background-position: center center;
			}
			
			.active .item1 {
				background: url(../images/base/01_1.png) no-repeat;
				background-size: 100% 100%;
				background-position: center center;
			}
			
			.item2 {
				background: url(../images/base/02_2.png) no-repeat;
				background-size: 100% 100%;
				background-position: center center;
			}
			
			.active .item2 {
				background: url(../images/base/02_1.png) no-repeat;
				background-size: 100% 100%;
				background-position: center center;
			}
			
			.item3 {
				background: url(../images/base/03_2.png) no-repeat;
				background-size: 100% 100%;
				background-position: center center;
			}
			
			.active .item3 {
				background: url(../images/base/03_1.png) no-repeat;
				background-size: 100% 100%;
				background-position: center center;
			}
			
			.item4 {
				position: relative;
				background: url(../images/base/04_2.png) no-repeat;
				background-size: 100% 100%;
				background-position: center center;
			}
			
			.active .item4 {
				background: url(../images/base/04_1.png) no-repeat;
				background-size: 100% 100%;
				background-position: center center;
			}
		</style>
	</head>

	<body>
		<nav class="mui-bar mui-bar-tab" style="border-top:2px solid #eee;">
			<a class="mui-tab-item tc" href="index.html">
				<div class="item item1"></div>
				<p class="mui-tab-label mb0" style="font-size:11px;">首页</p>
			</a>
			<a id="defaultTab" class="mui-tab-item active" href="topic.html">
				<div class="item item2"></div>
				<p class="mui-tab-label mb0" style="font-size:11px;">发现</p>
			</a>
			<a class="mui-tab-item" href="editimage.html">
				<img src="../images/base/add.png" style="height: 40px;margin-top:5px;" />
			</a>
			<a class="mui-tab-item" href="tipsetting.html">
				<div class="item item3"></div>
				<p class="mui-tab-label mb0" style="font-size:11px;">消息</p>
			</a>
			<a class="mui-tab-item" href="my.html">
				<div class="item item4"><span class="mui-badge mui-badge-danger" style="width:10px;height:10px;padding:0px;margin-left: 0px;top: -1px;right:-8px;position:absolute;background:red;"></span></div>
				<p class="mui-tab-label mb0" style="font-size:11px;">我的</p>
			</a>
		</nav>
		<!--检测更新满屏弹窗-->
		<div class="mytanbg hide" id="myprogressbg" onclick="PreviewTan2(0)"></div>
		<!--文章操作弹窗-->
		<div class="mytanbg hide" id="actionTan" onclick="ActionTan2()"></div>
	</body>

</html>
<script src="../js/mui.min.js"></script>
<script src="../js/base.js"></script>
<script src="../js/addarticle.js"></script>
<script type="text/javascript">
	var subPage = null;
	var userinfo = base.GetUserInfo();

	mui.init();

	var subpages = ['index.html', 'topic.html', 'tipsetting.html', 'my.html'];
	var subpage_style = {
		top: '0px',
		bottom: '50px'
	};

	var myPage = null; 
	var aniShow = {};
	var targetTab = subpages[1];
	var activeTab = subpages[1];
	var backButtonPress = 0;
	mui.plusReady(function() {

		//用户信息
		//{"id":"igexin","token":"54f3c1dc7795e813a8e0cdb039becb6f","clientid":"54f3c1dc7795e813a8e0cdb039becb6f","appid":"pPyZWvH3Fa6PXba10aJ009","appkey":"b7dOGlNPHR7pqwUxDhpTi4"}
		//alert(JSON.stringify(plus.push.getClientInfo()));

		//监听推送消息		
		plus.push.addEventListener("receive", function(msg) {
			// 分析msg.payload处理业务逻辑 
			alert("receive" + JSON.stringify(msg));

			//用户手动创建消息
			plus.push.createMessage(msg.content, msg.payload || '', msg);
		}, false);
		plus.push.addEventListener("click", function(msg) {
			alert("click" + JSON.stringify(msg));
		}, false);

		//系统定位
		base.GetCurrentPosition();

		//首页返回键处理
		//1、若侧滑菜单显示，则关闭侧滑菜单
		//2、否则，执行mui框架默认的关闭首页功能

		mui.back = function() {
			backButtonPress++;
			if(backButtonPress > 1) {
				plus.runtime.quit();
			} else {
				plus.nativeUI.toast('再按一次退出应用');
			}
			setTimeout(function() {
				backButtonPress = 0;
			}, 1000);
			return false;
		};

		base.CloseWaiting();

		plus.navigator.closeSplashscreen();
		plus.navigator.setFullscreen(false);

		var self = plus.webview.currentWebview();
		self.show();

		LoadPage();

		//选项卡点击事件
		mui('.mui-bar-tab').on('tap', 'a', function(e) {
			if(userinfo === "{}") {
				base.OpenWindow("login", "login.html", {}, "slide-in-bottom");
				return;
			}

			targetTab = this.getAttribute('href');
			if(targetTab == activeTab) {
				return;
			}

			if(targetTab == "editimage.html") {
				ShowActionSheet();
				return;
			}

			//切换选项卡高亮
			var current = document.querySelector(".active");
			if(!this.classList.contains("active")) {
				current.classList.remove('active');
				this.classList.add('active');
			}

			//刷新用户信息
			if(targetTab == "my.html") {
				if(myPage == null) {
					myPage = plus.webview.getWebviewById("my.html");
				}
				myPage.evalJS("Load()");
			}

			//显示目标选项卡
			//若为iOS平台或非首次显示，则直接显示
			if(mui.os.ios || aniShow[targetTab]) {
				plus.webview.show(targetTab, "none", 250);
			} else {
				//否则，使用fade-in动画，且保存变量
				var temp = {};
				temp[targetTab] = "true";
				mui.extend(aniShow, temp);
				plus.webview.show(targetTab, "none", 250);
			}
			//隐藏当前;
			plus.webview.hide(activeTab);
			//更改当前活跃的选项卡
			activeTab = targetTab;
		});
	});

	function LoadPage() {
		//创建子页面，首个选项卡页面显示，其它均隐藏
		var self = plus.webview.currentWebview();
		for(var i = 0; i < 4; i++) {
			var temp = {};
			var sub = plus.webview.create(subpages[i], subpages[i], subpage_style);
			if(i == 1) {
				temp[subpages[i]] = "true";
				mui.extend(aniShow, temp);
			} else {
				sub.hide();
			}
			self.append(sub);
		}
	}

	//自定义事件，模拟点击“首页选项卡”
	var defaultTab = document.getElementById("defaultTab");
	document.addEventListener('gohome', function(event) {

		//模拟首页点击
		mui.trigger(defaultTab, 'tap');

		//切换选项卡高亮
		var current = document.querySelector(".active");
		if(defaultTab !== current) {
			current.classList.remove('active');
			defaultTab.classList.add('active');
		}
	});

	function PreviewTan2(index) {
		if(index == 0) {
			document.getElementById("myprogressbg").classList.add("hide");
			var topicPage = plus.webview.getWebviewById("topic");
			if(topicPage) {
				topicPage.evalJS("CloseUpdate()");
			}
		} else {
			document.getElementById("myprogressbg").classList.remove("hide");
		}
	}

	//子页面操作弹窗
	function ActionTan(show, pagename) {
		if(show) {
			document.getElementById("actionTan").classList.remove("hide");
		} else {
			document.getElementById("actionTan").classList.add("hide");
		}
		subPage = plus.webview.getWebviewById(pagename);
	}

	//父页面关闭弹窗
	function ActionTan2() {
		subPage.evalJS("ActionTan2()");
	}
</script>