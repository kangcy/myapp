<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<title></title>
		<link href="../css/mui.min.css" rel="stylesheet" />
		<link rel="stylesheet" href="../css/img.preview.css">
		<style type="text/css">
			body {
				background: #eee;
			}
			
			.mui-bar {
				background: #fff;
			}
			
			.mui-table-view-cell {
				padding: .8rem 0.9375rem;
			}
			
			.mui-table-view-cell:after {
				left: 0.9375rem;
				right: 0.9375rem;
			}
			
			.mui-table-view:after {
				height: 0px;
			}
			
			.item {
				width: 28px;
				height: 23px;
				margin-top: 3px;
				display: inline-block;
			}
			
			.item1 {
				background: url(../images/base/01_2.png) no-repeat;
				background-size: 100% 100%;
				background-position: center center;
			}
			
			.active .item1 {
				background: url(../images/base/01_1.png) no-repeat;
				background-size: 100% 100%;
				background-position: center center;
			}
			
			.item2 {
				background: url(../images/base/02_2.png) no-repeat;
				background-size: 100% 100%;
				background-position: center center;
			}
			
			.active .item2 {
				background: url(../images/base/02_1.png) no-repeat;
				background-size: 100% 100%;
				background-position: center center;
			}
			
			.item3 {
				background: url(../images/base/03_2.png) no-repeat;
				background-size: 100% 100%;
				background-position: center center;
			}
			
			.active .item3 {
				background: url(../images/base/03_1.png) no-repeat;
				background-size: 100% 100%;
				background-position: center center;
			}
			
			.item4 {
				position: relative;
				background: url(../images/base/04_2.png) no-repeat;
				background-size: 100% 100%;
				background-position: center center;
			}
			
			.active .item4 {
				background: url(../images/base/04_1.png) no-repeat;
				background-size: 100% 100%;
				background-position: center center;
			}
		</style>
	</head>

	<body>
		<nav class="mui-bar mui-bar-tab">
			<a class="mui-tab-item tc" href="index.html">
				<div class="item item1"></div>
				<p class="mui-tab-label f11 mb0">首页</p>
			</a>
			<a id="defaultTab" class="mui-tab-item active" href="topic.html">
				<div class="item item2"></div>
				<p class="mui-tab-label f11 mb0">发现</p>
			</a>
			<a class="mui-tab-item" href="editimage.html">
				<img src="../images/add2.png" style="width: 60px;height: 40px;margin-top:5px;" />
			</a>
			<a class="mui-tab-item" href="tipsetting.html">
				<div class="item item3"></div>
				<p class="mui-tab-label f11 mb0">消息</p>
			</a>
			<a class="mui-tab-item" href="my.html">
				<div class="item item4"><span class="mui-badge mui-badge-danger" style="width:10px;height:10px;padding:0px;margin-left: 0px;top: -1px;right:-8px;position:absolute;background:red;"></span></div>
				<p class="mui-tab-label f11 mb0">我的</p>
			</a>
		</nav>

		<!--图片预览满屏弹窗-->
		<div class="mui-preview-image mui-fullscreen" id="previewTan"></div>
		<!--检测更新满屏弹窗-->
		<div class="mytanbg hide" id="myprogressbg" onclick="PreviewTan2(0)"></div>
	</body>

</html>
<script src="../js/mui.min.js"></script>
<script src="../js/base.js"></script>
<script type="text/javascript">
	var userinfo = base.GetUserInfo();
	mui.init({
		swipeBack: false //启用右滑关闭功能
	});

	var subpages = ['index.html', 'topic.html', 'tipsetting.html', 'my.html'];
	var subpage_style = {
		top: '0px',
		bottom: '50px'
	};

	var myPage = null;
	var aniShow = {};
	var activeTab = subpages[1];
	var backButtonPress = 0;
	mui.plusReady(function() {

		//首页返回键处理
		//1、若侧滑菜单显示，则关闭侧滑菜单
		//2、否则，执行mui框架默认的关闭首页功能

		mui.back = function() {
			backButtonPress++;
			if(backButtonPress > 1) {
				plus.runtime.quit();
			} else {
				plus.nativeUI.toast('再按一次退出应用');
			}
			setTimeout(function() {
				backButtonPress = 0;
			}, 1000);
			return false;
		};

		base.CloseWaiting();

		plus.navigator.closeSplashscreen();
		plus.navigator.setFullscreen(false);

		var self = plus.webview.currentWebview();
		self.show();

		LoadPage();

		//选项卡点击事件
		mui('.mui-bar-tab').on('tap', 'a', function(e) {

			if(userinfo === "{}") {
				base.OpenWindow("login", "login.html", {}, "slide-in-bottom");
				return;
			}

			var targetTab = this.getAttribute('href');
			if(targetTab == activeTab) {
				return;
			}

			if(targetTab == "editimage.html") {
				galleryImgs()
				return;
			}

			//切换选项卡高亮
			var current = document.querySelector(".active");
			if(!this.classList.contains("active")) {
				current.classList.remove('active');
				this.classList.add('active');
			}

			//刷新用户信息
			if(targetTab == "my.html") {
				if(myPage == null) {
					myPage = plus.webview.getWebviewById("my.html");
				}
				myPage.evalJS("Load()");
			}

			//显示目标选项卡
			//若为iOS平台或非首次显示，则直接显示
			if(mui.os.ios || aniShow[targetTab]) {
				plus.webview.show(targetTab);
			} else {
				//否则，使用fade-in动画，且保存变量
				var temp = {};
				temp[targetTab] = "true";
				mui.extend(aniShow, temp);
				plus.webview.show(targetTab, "none", 250);
			}
			//隐藏当前;
			plus.webview.hide(activeTab);
			//更改当前活跃的选项卡
			activeTab = targetTab;
		});
	});

	function LoadPage() {
		//创建子页面，首个选项卡页面显示，其它均隐藏
		var self = plus.webview.currentWebview();
		for(var i = 0; i < 4; i++) {
			var temp = {};
			var sub = plus.webview.create(subpages[i], subpages[i], subpage_style);
			if(i == 1) {
				temp[subpages[i]] = "true";
				mui.extend(aniShow, temp);
			} else {
				sub.hide();
			}
			self.append(sub);
		}
	}

	//自定义事件，模拟点击“首页选项卡”
	var defaultTab = document.getElementById("defaultTab");
	document.addEventListener('gohome', function(event) {

		//模拟首页点击
		mui.trigger(defaultTab, 'tap');

		//切换选项卡高亮
		var current = document.querySelector(".active");
		if(defaultTab !== current) {
			current.classList.remove('active');
			defaultTab.classList.add('active');
		}
	});

	//相册选取 
	var currUploadImg = [];

	function galleryImgs() {
		plus.gallery.pick(function(e) {
			var length = e.files.length;
			var index = 1;
			for(var i in e.files) {
				mui.toast("正在导入第" + index + "张图片");
				if(index == length) {
					setTimeout(function() {
						if(length > 0) {
							base.ShowWaiting("正在同步文章内容");
						}
					}, index * 2000);
				}

				index += 1;
				//压缩图片 
				var dstname = "_downloads/" + base.GetUid() + ".jpg"; //设置压缩后图片路径

				//压缩图片,并重命名 
				compressImage(e.files[i], dstname, function(status, src) {
					if(!status) {
						length = length - 1;
					}
					if(length <= 0) {
						base.CloseWaiting();
						return;
					}
					if(status) {
						var image = new Image();
						image.src = src;

						if(image.complete) {
							var imgData = getBase64Image(image);
							Upload(imgData, length);
						} else {
							image.onload = function() {
								var imgData = getBase64Image(image);
								Upload(imgData, length);
							}
						};
					}
				});
			}
		}, function(e) {

		}, {
			filter: "image",
			multiple: true,
			maximum: 100
		});
	}

	/* "error:{\"code\":-4,\"message\":\"文件不存在\"}" at page/subindex.html:316
	 src:file:///storage/emulated/0/DidiScreenAd/httpsstatic.udache.comgulfstreamuploadrooster2017012414852244449565f3d30ef10fe32a1c5f6f98536cfab0cmaterial_1485224444960_1080_1920_400.jpg at page/subindex.html:270

	 "event:{\"target\":\"file:///storage/emulated/0/Android/data/io.dcloud.HBuilder/.HBuilder/downloads/1486525314259.jpg\",\"width\":393,\"height\":699,\"size\":48523}" at page/subindex.html:310
	 src:file:///storage/emulated/0/Android/data/io.dcloud.HBuilder/.HBuilder/downloads/1486525314259.jpg at page/subindex.html:270
	  */

	//压缩图片(src：压缩前原始路径,dstname：压缩后保存路径) 
	function compressImage(src, newsrc, callback) {
		plus.zip.compressImage({
				src: src,
				dst: newsrc,
				overwrite: true,
				width: window.innerWidth + "px",
				quality: 80
			},
			function(event) {
				console.log(JSON.stringify("event:" + JSON.stringify(event)));
				callback(true, event.target);
			},
			function(error) {
				mui.toast(error.message);
				console.log(JSON.stringify("error:" + JSON.stringify(error)));
				callback(false, src);
			});
	}

	//将图片压缩转成base64 
	function getBase64Image(img) {
		var canvas = document.createElement("canvas");
		var width = img.width;
		var height = img.height;
		canvas.width = width; /*设置新的图片的宽度*/
		canvas.height = height; /*设置新的图片的长度*/
		var ctx = canvas.getContext("2d");
		ctx.drawImage(img, 0, 0, width, height); /*绘图*/
		return canvas.toDataURL("image/jpeg", 0.8);
	}

	//上传图片到服务器 
	function Upload(imgurl, length) {
		console.log(imgurl);
		mui.post(base.RootUrl + "Upload/Upload", {
			str: imgurl,
			Standard: "Article",
			isDraw: userinfo.UseDraw,
			isThumb: 1
		}, function(data) {
			if(data != null) {
				if(data.result) {
					currUploadImg.push(base.RootUrl + data.message);

					//图片上传完毕，创建文章
					if(currUploadImg.length == length) {
						//创建文章 
						var data = {
							ID: userinfo.ID,
							Cover: currUploadImg.join(","),
							Title: ""
						}
						HttpGet(base.RootUrl + "Article/Edit", data, function(data) {
							base.CloseWaiting();
							currUploadImg = [];
							if(data != null) {
								if(data.result) {
									base.OpenWindow("addarticle", "addarticle.html", {
										ArticleID: data.message.ID,
										ArticleNumber: data.message.Number,
										Source: "Add"
									});
								} else {
									mui.toast(data.message);
								}
							}
						});
					}
				} else {
					mui.toast(data.message);
				}
			}
		}, "json");
	}

	function PreviewTan(index) {
		if(index == 0) {
			document.getElementById("previewTan").classList.remove("mui-preview-in");
			document.getElementById("previewTan").style.display = "none";
			document.getElementById("previewTan").classList.add("mui-preview-out");
		} else {
			document.getElementById("previewTan").classList.remove("mui-preview-out");
			document.getElementById("previewTan").style.display = "block";
			document.getElementById("previewTan").classList.add("mui-preview-in");
		}
	}

	function PreviewTan2(index) {
		if(index == 0) {
			document.getElementById("myprogressbg").classList.add("hide");
			var topicPage = plus.webview.getWebviewById("topic");
			if(topicPage) {
				topicPage.evalJS("CloseUpdate()");
			}
		} else {
			document.getElementById("myprogressbg").classList.remove("hide");
		}
	}
</script>