<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title></title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<link rel="stylesheet" href="../mincss/mui.min.css">
		<link rel="stylesheet" href="../mincss/animate.min.css">
		<link rel="stylesheet" href="../mincss/img.preview.min.css">
		<link rel="stylesheet" href="../mincss/loading.min.css">
		<link rel="stylesheet" href="../mincss/subindex.min.css">
		<style type="text/css">
			.mui-slider-indicator.mui-segmented-control {
				border-bottom: 1px solid #f5f5f5;
			}
			
			.mui-segmented-control.mui-segmented-control-inverted .mui-control-item.mui-active {
				font-weight: bold;
			}
			
			.tabs_active {
				position: absolute;
				bottom: 4px;
				left: 0;
				height: 2px;
				background-color: #20a0ff;
				z-index: 1;
				transition: transform .25s cubic-bezier(.645, .045, .355, 1);
				list-style: none;
			}
			
			.mui-segmented-control.mui-scroll-wrapper .mui-control-item {
				padding: 0 0.8rem;
			}
		</style>
	</head>

	<body>

		<header class="mui-bar mui-bar-nav cfff" id="header">
			<img id="avatar2" src="../images/avatar.png" style="width:30px;margin-top:5px;border-radius:100%;" />
			<a class="mui-icon mui-icon-search fr cfff" id="search"></a>
			<h1 class="mui-title cfff">发现</h1>
		</header>
		<div class="loading hide" id="loader">
			<div class="card">
				<span class="circles-loader"></span>
			</div>
		</div>
		<div id="divBanner">
			<div id="banner"></div>
		</div>
		<div id="muicontent">
			<div id="slider" class="mui-slider">
				<div id="sliderSegmentedControl" class="mui-scroll-wrapper mui-slider-indicator mui-segmented-control mui-segmented-control-inverted">
					<div class="mui-scroll f14" id="mui-scroll"> </div>
				</div>
			</div>
		</div>
		<div class="mui-bar mui-bar-tab bottom tc cfff zoomIn" id="bottom" style="background:#fff;">
			<div id="add">
				<div class="f13" id="btnAdd">制作我的文章</div>
			</div>
		</div>
		<!--图片操作-->
		<div id="uploadwrapper"></div>
	</body>

</html>
<script src="../minjs/mui.min.js"></script>
<script src="../minjs/base.min.js"></script>
<script src="../minjs/refresh.min.js"></script>
<script src="../minjs/update.min.js"></script>
<script src="../js/addarticle.js"></script>
<script src="../js/webviewGroup.js"></script>
<script src="../js/nativeview.js"></script>
<script type="text/javascript">
	var isScroll = false; //是否滚动
	var isPreview = false; //是否图片预览
	var PageName = "subindex";
	var FirstLoad = true; //首次加载  
	var self = null;
	var menu = null;
	var scroll = null;
	var groupItems = [];
	var articleTypeHtml = [];

	mui.init({
		gestureConfig: {
			doubletap: true
		}
	});

	mui.ready(function() {
		base.Immersed();
		base.Get("btnAdd").style.background = base.BrowserName() + 'linear-gradient(right,#4e8cfb 0%,#24c3fb 75%,#39b8fd 100%)';
		base.Get("search").addEventListener('tap', function() {
			base.OpenWindow("search", "search.html", {});
		});

		base.ToTop();
	})

	var backButtonPress = 0;
	mui.plusReady(function() {
		plus.navigator.setFullscreen(false);
		self = plus.webview.currentWebview();

		var headheight = base.Get("header").clientHeight + base.Get("slider").clientHeight;
		var bottomheight = base.Get("bottom").clientHeight;

		HttpGet(base.RootUrl + "Api/ArticleType/All2", {}, function(data) {
			data = JSON.parse(data);
			if(data != null) {
				if(data.result) {
					data = data.message;
					articleTypeHtml.push('<div class="tabs_active"></div><a class="mui-control-item" href="#articletab0" data-wid="articletab0">推荐</a>');
					groupItems.push({
						id: "articletab0",
						url: "articletab.html",
						extras: {
							ArticleType: 0
						}
					})
					mui.each(data, function(i, item) {
						groupItems.push({
							id: "articletab" + item.ID,
							url: "articletab.html",
							extras: {
								ArticleType: item.ID
							}
						})
						articleTypeHtml.push('<a class="mui-control-item" href="#articletab' + item.ID + '" data-wid="articletab' + item.ID + '">' + item.Name + '</a>');
					})
					base.Get("mui-scroll").innerHTML = articleTypeHtml.join('');

					scroll = mui('.mui-scroll-wrapper.mui-slider-indicator.mui-segmented-control').scroll({
						scrollY: false,
						scrollX: true,
						indicators: false,
						bounce: true,
						snap: '.mui-control-item'
					});

					ChangeItem(mui(".mui-control-item")[0])

					var group = new webviewGroup("articletabs.html", {
						items: groupItems,
						onChange: function(obj) {
							scroll.gotoPage(parseInt(obj.index));
							ChangeItem(mui(".mui-control-item")[parseInt(obj.index)]);
						},
						styles: {
							top: headheight + "px",
							bottom: bottomheight + "px",
							render: "always",
							popGesture: "none",
							scrollIndicator: "none",
							backgroundColor: "#ffffff"
						}
					});
					mui("#slider").on("tap", ".mui-control-item", function(e) {
						group.switchTab(this.getAttribute("data-wid"));
					});
				}
			}
		});

		//预加载
		preload();

		//打开侧滑
		base.Get("avatar2").addEventListener('tap', function() {
			openMenu();
		});

		mui.back = function() {
			if(customview.isVisible()) {
				HideView();
				return false;
			}
			if(parseInt(self.getStyle().left) > 0) {
				closeMenu();
				return false;
			}
			var check = false;
			mui(".mui-popover").each(function() {
				if(this.classList.contains('mui-active')) {
					mui('#' + this.getAttribute("id")).popover('hide');
					check = true;
				}
			});
			if(check) {
				return;
			}
			backButtonPress++;
			if(backButtonPress > 1) {
				plus.runtime.quit();
			} else {
				plus.nativeUI.toast('再按一次退出应用');
			}
			mui.later(function() {
				backButtonPress = 0;
			}, 1000);
			return false;
		};

		mui('#uploadwrapper').load("../part/pic.html", function(response) {
			base.Get("add").addEventListener('tap', function() {
				length = 0;
				files = [];
				compressIndex = 0; //当前压缩图片索引 
				compressTotal = 0; //需要压缩图片个数
				currUploadImg = [];
				//mui('#upload').popover('show');
				ShowView();
			});
		});

		//检查更新
		mui.later(function() {
			//监听推送消息		
			plus.push.addEventListener("receive", function(msg) {
				if(!base.IsNullOrEmpty(msg.payload)) {
					var param = msg.payload.split('|');
					//系统推荐文章、好友发布文章
					if(param[0] == PushType.Article || param[0] == PushType.FanArticle) {
						base.OpenWindow("articledetail", "articledetail.html", {
							ArticleID: param[1],
							Source: "",
							NickName: ""
						}, null, "none");
					}
					//打开评论
					if(param[0] == PushType.Comment) {
						var param = {
							ArticleID: param[1],
							ArticleNumber: param[2]
						}
						base.OpenWindow("articleComment", "articleComment.html", param);
					}
					//打开打赏
					if(param[0] == PushType.Money) {
						base.OpenWindow("pay", "pay.html", {});
					}
					//打开粉丝
					if(param[0] == PushType.Fan) {
						base.OpenWindow("fan", "fan.html", {});
					}
				}
			}, false);
		}, 1000);
	});

	//样式切换
	function ChangeItem($this) {
		var item = $this.parentNode.children[0];
		item.style.width = $this.clientWidth + "px";
		item.style.transform = "translateX(" + $this.offsetLeft + "px)";
		base.RemoveClass([".mui-control-item"], "mui-active");
		$this.classList.add("mui-active");
	}

	function LoadBanner() {
		HttpGet(base.RootUrl + "System/Banner", {}, function(data) {
			if(data != null) {
				var length = data.records;
				if(length > 0) {
					$("#divBanner").css("height", "8.8rem");
					var banner = $("#banner");
					var bannerHtml = [];
					bannerHtml.push('<div class="mui-slider-group mui-slider-group2 mui-slider-loop">');
					for(var j = 0, len = length; j < len; j++) {
						if(j == 0 || j == length - 1) {
							bannerHtml.push('<div class="mui-slider-item mui-slider-item-duplicate">');
						} else {
							bannerHtml.push('<div class="mui-slider-item">');
						}
						bannerHtml.push('<a href="' + data.list[j].Link + '"><img src="' + data.list[j].Cover + '"></a></div>');
					}
					bannerHtml.push('</div>');
					bannerHtml.push('<div class="mui-slider-indicator">');
					for(var j = 0, len = length - 2; j < len; j++) {
						if(j == 0) {
							bannerHtml.push('<div class="mui-indicator mui-active"></div>');
						} else {
							bannerHtml.push('<div class="mui-indicator"></div>');
						}
					}
					bannerHtml.push('</div>');
					banner.append(bannerHtml.join(""));
					banner.addClass("mui-slider");
					banner.css({
						"height": "8rem",
						"top": "0px"
					});

					mui("#banner").slider({
						interval: 5000
					});
				}
			}
		});
	}

	function Avartar(url) {
		base.Get("avatar2").setAttribute("src", url);
	}

	//开始检测更新
	function InitCheckUpdate() {
		mui.later(function() {
			Check_Update(function(data) {
				if(!base.IsNullOrEmpty(data)) {
					base.OpenWindow("update", "update.html", {
						url: data.url,
						remark: data.remark
					}, "fade-in", "none");
				}
			});
		}, 1000);
	}

	function preload() {
		var menu_style = {
			left: "-83%",
			width: "83%",
			popGesture: "none",
			render: "always",
			scrollIndicator: "none"
		};

		if(mui.os.ios) {
			menu_style.zindex = -1;
		}

		//处理侧滑导航，为了避免和子页面初始化等竞争资源，延迟加载侧滑页面；
		menu = mui.openWindow({
			id: 'my',
			url: 'my.html',
			styles: menu_style,
			show: {
				aniShow: 'none'
			},
			waiting: {
				autoShow: false
			}
		});

		//启用侧滑拖拽操作，延时的原因是menu页是延时创建的，所以这里需要相应延时
		/*setTimeout(function() {
			self.drag({
				direction: "right",
				moveMode: "followFinger"
			}, {
				view: menu,
				moveMode: "follow"
			}, function(e) {
				if(e.type == "end") {
					if(e.result) {
						if(e.direction == "rtl") {
							self.setStyle({
								mask: 'none',
								left: "0px"
							});
						} else {
							self.setStyle({
								mask: 'rgba(0,0,0,0.5)',
								left: "83%"
							});
						}
					}
				}
				if(e.type == "move" && e.direction == "ltr") {
					var num = 0.5 * e.progress / 100;
					self.setStyle({
						mask: 'rgba(0,0,0,' + num + ')'
					});
				}
			});
		}, 350);*/

		CreatePicView();
	}

	//显示侧滑菜单
	function openMenu() {
		plus.webview.startAnimation({
				'view': self,
				'styles': {
					'fromLeft': '0',
					'toLeft': "83%"
				},
				'action': 'none'
			}, {
				'view': menu,
				'styles': {
					'fromLeft': "-83%",
					'toLeft': '0'
				},
				'action': 'none'
			},
			function(e) {
				if(e.id == menu.id) {
					self.setStyle({
						mask: 'rgba(0,0,0,0.5)'
					});
				}
			})
	};

	//关闭菜单
	function closeMenu() {
		plus.webview.startAnimation({
				'view': self,
				'styles': {
					'fromLeft': "83%",
					'toLeft': "0"
				},
				'action': 'none'
			}, {
				'view': menu,
				'styles': {
					'fromLeft': "0",
					'toLeft': "-83%"
				},
				'action': 'none'
			},
			function(e) {
				if(e.id == self.id) {
					self.setStyle({
						mask: 'none'
					});
				}
			})
	};
	window.addEventListener("menu:close", closeMenu);

	mui.menu = function() {
		if(parseInt(self.getStyle().left) > 0) {
			closeMenu();
		} else {
			openMenu();
		}
	}
</script>