<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<title></title>
		<link href="../css/mui.min.css" rel="stylesheet" />
		<link rel="stylesheet" href="../css/img.preview.css">
		<style type="text/css">
			body {
				background: #eee;
			}
			
			.mui-bar {
				background: #fff;
			}
			
			.mui-table-view-cell {
				padding: .8rem 0.9375rem;
			}
			
			.mui-table-view-cell:after {
				left: 0.9375rem;
				right: 0.9375rem;
			}
			
			.mui-table-view:after {
				height: 0px;
			}
		</style>
	</head>

	<body>
		<nav class="mui-bar mui-bar-tab">
			<a id="defaultTab" class="mui-tab-item link" href="topic.html">
				<span class="mui-icon mui-icon-home" style="font-size:25px;"></span>
				<span class="mui-tab-label">首页</span>
			</a>
			<a class="mui-tab-item" href="editimage.html">
				<img src="../images/add2.png" style="width: 60px;height: 40px;margin-top:5px;" />
			</a>
			<a class="mui-tab-item link" href="my.html">
				<span class="mui-icon mui-icon-contact" style="font-size:25px;"><span class="mui-badge mui-badge-danger" style="width:10px;height:10px;padding:0px;margin-left: 0px;top: 0px;background:red;"></span></span>
				<span class="mui-tab-label">我的</span>
			</a>
		</nav>

		<!--图片预览满屏弹窗-->
		<div class="mui-preview-image mui-fullscreen" id="previewTan"></div>
		<!--检测更新满屏弹窗-->
		<div class="mytanbg hide" id="myprogressbg" onclick="PreviewTan2(0)"></div>
	</body>

</html>
<script src="../js/mui.min.js"></script>
<script src="../js/base.js"></script>
<script type="text/javascript">
	var userinfo = base.GetUserInfo();
	mui.init({
		swipeBack: false //启用右滑关闭功能
	});

	var subpages = ['topic.html', 'my.html'];
	var subpage_style = {
		top: '0px',
		bottom: '50px'
	};

	var myPage = null;
	var aniShow = {};
	var activeTab = subpages[0];
	var backButtonPress = 0;
	mui.plusReady(function() {

		//首页返回键处理
		//1、若侧滑菜单显示，则关闭侧滑菜单
		//2、否则，执行mui框架默认的关闭首页功能

		mui.back = function() {
			backButtonPress++;
			if(backButtonPress > 1) {
				plus.runtime.quit();
			} else {
				plus.nativeUI.toast('再按一次退出应用');
			}
			setTimeout(function() {
				backButtonPress = 0;
			}, 1000);
			return false;
		};

		plus.nativeUI.closeWaiting()

		plus.navigator.closeSplashscreen();
		plus.navigator.setFullscreen(false);

		var self = plus.webview.currentWebview();
		self.show();

		LoadPage();

		//选项卡点击事件

		mui('.mui-bar-tab').on('tap', 'a', function(e) {
			var targetTab = this.getAttribute('href');
			if(targetTab == activeTab) {
				return;
			}

			if(targetTab == "editimage.html") {
				galleryImgs()
				return;
			}

			//刷新用户信息
			if(targetTab == "my.html") {
				if(myPage == null) {
					myPage = plus.webview.getWebviewById("my.html");
				}
				myPage.evalJS("Load()");
			}

			//显示目标选项卡
			//若为iOS平台或非首次显示，则直接显示
			if(mui.os.ios || aniShow[targetTab]) {
				plus.webview.show(targetTab); 
			} else {
				//否则，使用fade-in动画，且保存变量
				var temp = {};
				temp[targetTab] = "true";
				mui.extend(aniShow, temp);
				plus.webview.show(targetTab, "fade-in", 250);
			}
			//隐藏当前;
			plus.webview.hide(activeTab);
			//更改当前活跃的选项卡
			activeTab = targetTab;
		});
	});

	function LoadPage() {
		//创建子页面，首个选项卡页面显示，其它均隐藏
		var self = plus.webview.currentWebview();
		for(var i = 0; i < 2; i++) {
			var temp = {};
			var sub = plus.webview.create(subpages[i], subpages[i], subpage_style);
			if(i == 0) {
				temp[subpages[i]] = "true";
				mui.extend(aniShow, temp);
			} else {
				sub.hide();
			}
			self.append(sub);
		}
	}

	//自定义事件，模拟点击“首页选项卡”
	var defaultTab = document.getElementById("defaultTab");
	document.addEventListener('gohome', function(event) {

		console.log("gohome");

		//模拟首页点击
		mui.trigger(defaultTab, 'tap');

		/*//切换选项卡高亮
		var current = document.querySelector(".mui-bar-tab>.mui-tab-item.mui-active");
		if(defaultTab !== current) {
			current.classList.remove('mui-active');
			defaultTab.classList.add('mui-active');
		}*/
	});

	//相册选取 
	var currUploadImg = [];

	function galleryImgs() {

		plus.gallery.pick(function(e) {

			var index = 1;
			for(var i in e.files) {
				mui.toast("正在导入第" + index + "张图片");
				index += 1;
				//压缩图片 
				var dstname = "_downloads/" + base.GetUid() + ".jpg"; //设置压缩后图片路径

				//压缩图片,并重命名 
				compressImage(e.files[i], dstname, function(src) {
					var image = new Image();
					image.src = src;
					image.onload = function() {
						var imgData = getBase64Image(image);
						Upload(imgData, e.files.length);
					}
				});
			}
		}, function(e) {

		}, {
			filter: "image",
			multiple: true,
			maximum: 100
		});
	}

	//压缩图片(src：压缩前原始路径,dstname：压缩后保存路径) 
	function compressImage(src, newsrc, callback) {
		plus.zip.compressImage({
				src: src,
				dst: newsrc,
				overwrite: true,
				width: window.innerWidth + "px",
				quality: 100
			},
			function(event) {
				callback(event.target);
			},
			function(error) {
				callback(src);
			});
	}

	//将图片压缩转成base64 
	function getBase64Image(img) {
		var canvas = document.createElement("canvas");
		var width = img.width;
		var height = img.height;
		canvas.width = width; /*设置新的图片的宽度*/
		canvas.height = height; /*设置新的图片的长度*/
		var ctx = canvas.getContext("2d");
		ctx.drawImage(img, 0, 0, width, height); /*绘图*/
		return canvas.toDataURL("image/jpeg", 0.8);
	}

	//上传图片到服务器 
	function Upload(imgurl, length) {
		mui.post(base.RootUrl + "Upload/Upload", {
			str: imgurl
		}, function(data) {
			if(data != null) {
				if(data.result) {
					currUploadImg.push(base.RootUrl + data.message);

					//图片上传完毕，创建文章
					if(currUploadImg.length == length) {
						//plus.nativeUI.showWaiting("创建中..."); 
						//创建文章
						var data = {
							ID: userinfo.ID,
							Cover: currUploadImg.join(","),
							Title: ""
						}
						HttpGet(base.RootUrl + "Article/Edit", data, function(data) {
							currUploadImg = [];
							if(data != null) {
								if(data.result) {
									base.OpenWindow("addarticle", "addarticle.html", {
										ArticleID: data.message,
										Source: "Add"
									});
								} else {
									mui.toast(data.message);
								}
							}
						});
					}
				} else {
					mui.toast(data.message);
				}
			}
		}, "json");
	}

	function PreviewTan(index) {
		if(index == 0) {
			document.getElementById("previewTan").classList.remove("mui-preview-in");
			document.getElementById("previewTan").style.display = "none";
			document.getElementById("previewTan").classList.add("mui-preview-out");
		} else {
			document.getElementById("previewTan").classList.remove("mui-preview-out");
			document.getElementById("previewTan").style.display = "block";
			document.getElementById("previewTan").classList.add("mui-preview-in");
		}
	}

	function PreviewTan2(index) {
		if(index == 0) {
			document.getElementById("myprogressbg").classList.add("hide");
			var topicPage = plus.webview.getWebviewById("topic");
			if(topicPage) {
				topicPage.evalJS("CloseUpdate()");
			}
		} else {
			document.getElementById("myprogressbg").classList.remove("hide");
		}
	}
</script>