<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title></title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<link rel="stylesheet" href="../mincss/mui.min.css">
		<link rel="stylesheet" href="../mincss/animate.min.css">
		<link rel="stylesheet" href="../mincss/img.preview.min.css">
		<link rel="stylesheet" href="../mincss/loading.min.css">
		<link rel="stylesheet" href="../mincss/subindex.min.css">
	</head>

	<body>
		<!--操作-->
		<div id="actionwrapper"></div>
		<!--更新进度条-->
		<div id="updatewrapper"></div>
		<!--图片操作-->
		<div id="uploadwrapper"></div>
		<header class="mui-bar mui-bar-nav cfff" id="header">
			<img id="avatar2" src="../images/avatar.png" style="width:30px;margin-top:5px;border-radius:100%;" />
			<a class="mui-icon mui-icon-search fr cfff" id="search"></a>
			<h1 class="mui-title cfff">发现</h1>
		</header>
		<div class="loading" id="loader">
			<div class="card">
				<span class="circles-loader"></span>
			</div>
		</div>
		<div id="divBanner">
			<div id="banner"></div>
		</div>
		<div id="scroll-view">
		</div>
		<div id="none" class="full tc hide">
			<img src="../images/my/444.png" class="none" id="none_img" />
			<p class="f13 mt10" id="none_tip">这里还没有内容</p>
		</div>
		<div class="mui-bar mui-bar-tab bottom tc cfff hide" id="bottom" style="background:#fff;">
			<div id="add">
				<div class="f13" id="btnAdd">制作我的文章</div>
			</div>
		</div>
	</body>

</html>
<script src="../minjs/mui.min.js"></script>
<script src="../minjs/base.min.js"></script>
<script src="../minjs/refresh.min.js"></script>
<script src="../minjs/mui.previewimage.min.js"></script>
<script src="../minjs/mui.zoom.min.js"></script>
<script src="../minjs/update.min.js"></script>
<script src="../js/article.min.js"></script>
<script src="../js/addarticle.js"></script>
<script type="text/javascript">
	var isScroll = false; //是否滚动
	var isSwipeRight = false; //是否右滑
	var isSwipe = false; //是否侧滑
	var isPreview = false; //是否图片预览
	var menu;
	var showMenu = false;
	var PageName = "subindex";
	var FirstLoad = true; //首次加载
	var self = null;

	mui.init({
		gestureConfig: {
			doubletap: true
		}
	});

	mui.ready(function() {
		base.Immersed();

		base.Get("scroll-view").style.paddingTop = base.Get("header").clientHeight + "px";

		var name = base.BrowserName();
		base.Get("btnAdd").style.background = name + 'linear-gradient(right,#4e8cfb 0%,#24c3fb 75%,#39b8fd 100%)';

		//搜索 
		base.Get("search").addEventListener('tap', function() {
			base.OpenWindow("search", "search.html", {});
		});

		base.ToTop();
	})

	var backButtonPress = 0;
	mui.plusReady(function() {
		plus.navigator.setFullscreen(false);
		self = plus.webview.currentWebview();

		Load();

		SetPullEnable(true);

		//上拉加载
		document.addEventListener("plusscrollbottom", pullupRefresh, false);

		mui.later(function() {
			//侧滑菜单默认隐藏，这样可以节省内存；
			menu = mui.preload({
				id: 'my',
				url: 'my.html',
				styles: {
					left: 0,
					width: '100%',
					zindex: 10000,
					scrollIndicator: "none"
				}
			});

			//打开侧滑
			base.Get("avatar2").addEventListener('tap', function() {
				openMenu();
			});
		}, 300)

		window.addEventListener('scroll', function(e) {
			if(isScroll) {
				return;
			}
			isScroll = true;
		});

		window.addEventListener('dragend', function(e) {
			if(isScroll) {
				isScroll = false;
				return;
			}
			if(isSwipeRight) {
				openMenu();
			}
		});

		base.ShowUser("#scroll-view");

		base.ShowArticle("#scroll-view", "List", userinfo.Number);

		ArticleAction("#scroll-view", userinfo);

		//检查更新
		mui('#updatewrapper').load("../part/update.html", function(response) {
			CheckUpdate(function(index) {});
		});

		mui.back = function() {
			if(showMenu) {
				closeMenu();
				return false;
			}
			var check = false;
			mui(".mui-popover").each(function() {
				if(this.classList.contains('mui-active')) {
					mui('#' + this.getAttribute("id")).popover('hide');
					check = true;
				}
			});
			if(check) {
				return;
			}
			if(previewImage && previewImage.isShown()) {
				previewImage.close();
				return;
			}
			backButtonPress++;
			if(backButtonPress > 1) {
				plus.runtime.quit();
			} else {
				plus.nativeUI.toast('再按一次退出应用');
			}
			mui.later(function() {
				backButtonPress = 0;
			}, 1000);
			return false;
		};

		//监听推送消息		
		plus.push.addEventListener("receive", function(msg) {
			if(!base.IsNullOrEmpty(msg.payload)) {
				var param = msg.payload.split('|');
				//系统推荐文章、好友发布文章
				if(param[0] == 0 || param[0] == 4) {
					base.OpenWindow("articledetail", "articledetail.html", {
						ArticleID: param[1],
						Source: "",
						NickName: ""
					}, null, "none");
				}
				//打开评论
				if(param[0] == 1) {
					var param = {
						ArticleID: param[1],
						ArticleNumber: param[2]
					}
					base.OpenWindow("articleComment", "articleComment.html", param);
				}
				//打开打赏
				if(param[0] == 2) {
					base.OpenWindow("pay", "pay.html", {});
				}
				//打开粉丝
				if(param[0] == 3) {
					base.OpenWindow("fan", "fan.html", {});
				}
			}
		}, false);

		mui('#actionwrapper').load("../part/action.html", function(response) {
			mui('#scroll-view').on('tap', '.tanaction', function() {
				var number = this.getAttribute("articleNumber");
				var id = this.getAttribute("articleId");
				var usernumber = this.getAttribute("articleUserNumber");
				SetPullEnable(false);
				ActionTan(true, number, id, usernumber);
			});
			mui('body').on('hidden', '.mui-popover', function(e) {
				SetPullEnable(true);
			});
		});

		mui('#uploadwrapper').load("../part/pic.html", function(response) {
			base.Get("add").addEventListener('tap', function() {
				length = 0;
				files = [];
				compressIndex = 0; //当前压缩图片索引 
				compressTotal = 0; //需要压缩图片个数
				currUploadImg = [];
				mui('#upload').popover('show');
			});
		});
	});

	var previewImage = mui.previewImage({
		callback1: function(img) {
			isPreview = true;
			SetPullEnable(false);
		},
		callback2: function(img) {
			isPreview = false;
			SetPullEnable(true);
		}
	});

	/**
	 * 加载数据
	 */
	function Load(callback) {
		var data = {
			CurrUserNumber: userinfo.Number,
			page: currpage,
			rows: pagesize
		};
		HttpGet(base.RootUrl + "Api/Article/All", data, function(data) {
			data = JSON.parse(data);
			if(data != null) {
				if(data.result) {
					data = data.message;
					totalpage = data.totalpage;
					base.ShowLoading(false);
					base.Get("none").classList.add("hide");
					var table = base.Get('scroll-view');
					mui.each(data.list, function(i, item) {
						var div = AppendArticle(userinfo.Number, item, false, false, false);
						if(table) {
							table.appendChild(div);
						}
					})

				} else {
					base.ShowLoading(false);
					base.Get("none").classList.remove("hide");
				}
			}
			if(data == null && currpage == 1) {
				base.ShowLoading(false);
				base.Get("none").classList.remove("hide");
			}

			if(FirstLoad) {
				base.Get("bottom").classList.remove("hide");
				base.Get("bottom").classList.add("zoomIn");
				base.Get("scroll-view").style.paddingBottom = base.Get("bottom").clientHeight + "px";
			}
			FirstLoad = false;
			if(callback) {
				callback();
			}
		});
	}

	function LoadBanner() {
		HttpGet(base.RootUrl + "System/Banner", {}, function(data) {
			if(data != null) {
				var length = data.records;
				if(length > 0) {
					$("#divBanner").css("height", "8.8rem");
					var banner = $("#banner");
					var bannerHtml = [];
					bannerHtml.push('<div class="mui-slider-group mui-slider-group2 mui-slider-loop">');
					for(var j = 0, len = length; j < len; j++) {
						if(j == 0 || j == length - 1) {
							bannerHtml.push('<div class="mui-slider-item mui-slider-item-duplicate">');
						} else {
							bannerHtml.push('<div class="mui-slider-item">');
						}
						bannerHtml.push('<a href="' + data.list[j].Link + '"><img src="' + data.list[j].Cover + '"></a></div>');
					}
					bannerHtml.push('</div>');
					bannerHtml.push('<div class="mui-slider-indicator">');
					for(var j = 0, len = length - 2; j < len; j++) {
						if(j == 0) {
							bannerHtml.push('<div class="mui-indicator mui-active"></div>');
						} else {
							bannerHtml.push('<div class="mui-indicator"></div>');
						}
					}
					bannerHtml.push('</div>');
					banner.append(bannerHtml.join(""));
					banner.addClass("mui-slider");
					banner.css({
						"height": "8rem",
						"top": "0px"
					});

					mui("#banner").slider({
						interval: 5000
					});
				}
			}
		});
	}

	function Avartar(url) {
		base.Get("avatar2").setAttribute("src", url);
	}

	//显示菜单菜单
	function openMenu() {
		if(isPreview) {
			return;
		}
		if(isSwipe) {
			return;
		}
		isSwipe = true;
		menu.show('slide-in-left', base.AnimateDuration, function() {
			showMenu = true;
			isSwipe = false;
		});
	}

	//关闭侧滑菜单
	function closeMenu() {
		if(isSwipe) {
			return;
		}
		isSwipe = true;
		isScroll = false;
		isSwipeRight = false;

		menu.hide('auto', base.AnimateDuration);
		mui.later(function() {
			showMenu = false;
			isSwipe = false;
		}, base.AnimateDuration)

	}

	window.addEventListener('dragright', function(e) {
		e.detail.gesture.preventDefault();
	});
	window.addEventListener('dragleft', function(e) {
		e.detail.gesture.preventDefault();
	});
	//主界面向右滑动
	window.addEventListener("swiperight", function() {
		isSwipeRight = true;
	});

	window.addEventListener("swipeleft", closeMenu);

	//menu页面向左滑动，关闭菜单
	window.addEventListener("menu:swipeleft", closeMenu);

	//重写mui.menu方法，Android版本menu按键按下可自动打开、关闭侧滑菜单；
	mui.menu = function() {
		if(showMenu) {
			closeMenu();
		} else {
			openMenu();
		}
	}
</script>