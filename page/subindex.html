<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<title></title>
		<link href="../css/mui.min.css" rel="stylesheet" />
	</head>

	<body>
		<nav class="mui-bar mui-bar-tab">
			<a id="defaultTab" class="mui-tab-item link" href="topic.html">
				<span class="mui-icon mui-icon-home"></span>
				<span class="mui-tab-label">首页</span>
			</a>
			<a class="mui-tab-item" href="editimage.html">
				<img src="../images/add2.png" style="width: 60px;height: 40px;margin-top:5px;" />
			</a>
			<a class="mui-tab-item link" href="my.html">
				<span class="mui-icon mui-icon-contact"><span class="mui-badge mui-badge-danger" style="width:10px;height:10px;padding:0px;margin-left: 0px;top: 0px;background:red;"></span></span>
				<span class="mui-tab-label">我的</span>
			</a>
		</nav>
	</body>

</html>
<script src="../js/mui.min.js"></script>
<script src="../js/base.js"></script>
<script type="text/javascript">
	mui.init({
		swipeBack: false //启用右滑关闭功能
	});

	var subpages = ['topic.html', 'my.html'];
	var subpage_style = {
		top: '0px',
		bottom: '50px'
	};

	var aniShow = {};
	var activeTab = subpages[0];
	mui.plusReady(function() {
		plus.nativeUI.closeWaiting()

		plus.navigator.closeSplashscreen();
		plus.navigator.setFullscreen(false);

		var self = plus.webview.currentWebview();
		self.show();

		LoadPage();

		//选项卡点击事件
		var myPage = null;
		mui('.mui-bar-tab').on('tap', 'a', function(e) {
			var targetTab = this.getAttribute('href');
			if(targetTab == activeTab) {
				return;
			}

			if(targetTab == "editimage.html") {
				galleryImgs()
				return;
			}

			//刷新用户信息
			if(targetTab == "my.html") {
				if(myPage == null) {
					myPage = plus.webview.getWebviewById("my.html");
				}
				myPage.evalJS("Load()");
			}

			//显示目标选项卡
			//若为iOS平台或非首次显示，则直接显示
			if(mui.os.ios || aniShow[targetTab]) {
				plus.webview.show(targetTab);
			} else {
				//否则，使用fade-in动画，且保存变量
				var temp = {};
				temp[targetTab] = "true";
				mui.extend(aniShow, temp);
				plus.webview.show(targetTab, "fade-in", 250);
			}
			//隐藏当前;
			plus.webview.hide(activeTab);
			//更改当前活跃的选项卡
			activeTab = targetTab;
		});
	});

	function LoadPage() {
		//创建子页面，首个选项卡页面显示，其它均隐藏
		var self = plus.webview.currentWebview();
		for(var i = 0; i < 2; i++) {
			var temp = {};
			var sub = plus.webview.create(subpages[i], subpages[i], subpage_style);
			if(i == 0) {
				temp[subpages[i]] = "true";
				mui.extend(aniShow, temp);
			} else {
				sub.hide();
			}
			self.append(sub);
		}
	}

	//自定义事件，模拟点击“首页选项卡”
	var defaultTab = document.getElementById("defaultTab");
	document.addEventListener('gohome', function(event) {

		console.log("gohome");

		//模拟首页点击
		mui.trigger(defaultTab, 'tap');

		/*//切换选项卡高亮
		var current = document.querySelector(".mui-bar-tab>.mui-tab-item.mui-active");
		if(defaultTab !== current) {
			current.classList.remove('mui-active');
			defaultTab.classList.add('mui-active');
		}*/
	});

	//相册选取  
	function galleryImgs() {

		plus.gallery.pick(function(e) {

			//压缩图片 
			var dstname = "_downloads/" + base.GetUid() + ".jpg"; //设置压缩后图片路径

			//压缩图片,并重命名
			compressImage(e, dstname, function(src) {
				base.OpenWindow("editimage", "editimage.html", {
					Url: src,
					Source: "AddArticle"
				});
			});
		}, function(e) {

		}, {
			filter: "image",
			maximum: 1
		});
	}

	//压缩图片(src：压缩前原始路径,dstname：压缩后保存路径) 
	function compressImage(src, newsrc, callback) {
		plus.zip.compressImage({
				src: src,
				dst: newsrc,
				overwrite: true,
				width: window.innerWidth + "px",
				quality: 100
			},
			function(event) {
				callback(event.target);
			},
			function(error) {
				callback(src);
			});
	}
</script>