<html>

	<head>
		<meta charset="utf-8">
		<title>Hello MUI</title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<link rel="stylesheet" href="../mincss/mui.min.css">
		<link rel="stylesheet" href="../css/animate.min.css">
		<style type="text/css">
			.bg1 {
				background: transparent;
				background-color: rgba(0, 0, 0, 0.6);
			}
			
			#wrapper {
				position: relative;
				background: url(../images/red/bg.png) center center no-repeat;
				background-size: 100% 100%;
			}
			
			#btnopen {
				width: 35%;
				bottom: 13%;
				position: absolute;
				left: 32.5%;
			}
			
			@keyframes flipInY {
				0% {
					transform: perspective(400px) rotateY(0deg);
				}
				to {
					transform: perspective(400px) rotateY(-360deg);
				}
			}
			
			.flipInY {
				-webkit-animation: flipInY 2s ease;
				-moz-animation: flipInY 2s ease;
				-ms-animation: flipInY 2s ease;
				animation: flipInY 2s ease;
				animation-fill-mode: forwards;
				-webkit-animation-fill-mode: forwards;
				-moz-animation-fill-mode: forwards;
				-ms-animation-fill-mode: forwards
			}
			
			@keyframes jackInTheBox {
				0% {
					opacity: 0;
					transform: scale(.1) rotate(30deg);
					transform-origin: center bottom
				}
				50% {
					transform: rotate(-10deg)
				}
				70% {
					transform: rotate(3deg)
				}
				to {
					opacity: 1;
					transform: scale(1)
				}
			}
			
			@-webkit-keyframes jackInTheBox {
				0% {
					opacity: 0;
					-webkit-transform: scale(.1) rotate(30deg);
					-webkit-transform-origin: center bottom
				}
				50% {
					-webkit-transform: rotate(-10deg)
				}
				70% {
					-webkit-transform: rotate(3deg)
				}
				to {
					opacity: 1;
					-webkit-transform: scale(1)
				}
			}
			
			@-ms-keyframes jackInTheBox {
				0% {
					opacity: 0;
					-ms-transform: scale(.1) rotate(30deg);
					-ms-transform-origin: center bottom
				}
				50% {
					-ms-transform: rotate(-10deg)
				}
				70% {
					-ms-transform: rotate(3deg)
				}
				to {
					opacity: 1;
					-ms-transform: scale(1)
				}
			}
			
			@-moz-keyframes jackInTheBox {
				0% {
					opacity: 0;
					-moz-transform: scale(.1) rotate(30deg);
					-moz-transform-origin: center bottom
				}
				50% {
					-moz-transform: rotate(-10deg)
				}
				70% {
					-moz-transform: rotate(3deg)
				}
				to {
					opacity: 1;
					-moz-transform: scale(1)
				}
			}
			
			.jackInTheBox {
				-webkit-animation: jackInTheBox 0.75s ease;
				-moz-animation: jackInTheBox 0.75s ease;
				-ms-animation: jackInTheBox 0.75s ease;
				animation: jackInTheBox 0.75s ease;
				animation-fill-mode: forwards;
				-webkit-animation-fill-mode: forwards;
				-moz-animation-fill-mode: forwards;
				-ms-animation-fill-mode: forwards
			}
			
			.bg2 {
				background: transparent;
				background: url(../images/red/bg2.png) top center no-repeat;
				background-size: 100% auto;
				background-color: #f72a2b;
				position: relative;
			}
			
			.icon {
				width: 27%;
				margin-top: 90%;
			}
			
			.text {
				color: #fff687;
			}
			
			.more {
				margin-top: 0.35rem;
				margin-right: 0.4rem;
			}
		</style>

	</head>

	<body class="tc bg1" id="main">
		<div class="hide" id="wrapper" style="display:inline-block;">
			<img src="../images/red/img_text.png" style="width:70%;margin-top:20%;" />
			<p class="cfff f14 mt15" id="time"></p>
			<img src="../images/red/open.png" class="hide" id="btnopen" />
		</div>
		<div id="wrapper2" class="hide">
			<header id="header" class="mui-bar" immersed="none">
				<span class="mui-action-back mui-icon mui-icon-left-nav fl cfff"></span>
				<span class="cfff f25 fr more" onclick="Share()">•••</span>
				<h1 class="mui-title cfff">红包详情</h1>
			</header>
			<img src="../images/red/img_logo.png" class="icon" />
			<p class="cfff f15 mt5 mb0">小微篇</p>
			<p class="text f13 mt0">新用户专享红包</p>
			<div style="position:absolute;bottom:0px;width:100%;">
				<p class="text f50 mt0 mb0"><span id="price"></span><span class="f10 mt0">元</span></p>
				<p class="text f13 mt0 mb20" style="text-decoration:underline;" onclick="Share()">喊小伙伴一起领>></p>
				<p class="cfff f10 mb20">已存入您的账户，可用于提现。<span class="text f10 mt0" onclick="mypay()">去看看>></span></p>
			</div>
			<!--分享-->
			<div class="mui-backdrop hide" id="mysharebg" onclick="ShareTan(0)"></div>
			<div class="myshare hide" id="myshare">
				<p class="f16 c333 tc mt10 mb0">分享到</p>
				<div class="tc myshare_body">
					<div class="myshare_items" onclick="ShareAction(1)"><img src="../images/share/01.png" />
						<p class="f11 mb0 c333">朋友圈</p>
					</div>
					<div class="myshare_items" onclick="ShareAction(2)"><img src="../images/share/02.png" />
						<p class="f11 mb0 c333">微信</p>
					</div>
					<div class="myshare_items" onclick="ShareAction(3)"><img src="../images/share/03.png" />
						<p class="f11 mb0 c333">新浪微博</p>
					</div>
					<div class="myshare_items" onclick="ShareAction(4)"><img src="../images/share/04.png" />
						<p class="f11 mb0 c333">QQ</p>
					</div>
					<div class="myshare_items" onclick="ShareAction(5)"><img src="../images/share/05.png" />
						<p class="f11 mb0 c333">QQ空间</p>
					</div>
					<div class="myshare_items" onclick="ShareAction(6)"><img src="../images/share/06.png" />
						<p class="f11 mb0 c333">其他</p>
					</div>
					<div class="c333 mt10 f11 fl btnExit" onclick="ShareTan(0)">取消</div>
				</div>
			</div>
		</div>
	</body>
	<script src="../minjs/mui.min.js"></script>
	<script src="../minjs/base.min.js"></script>
	<script type="text/javascript">
		var isLoading = false;
		var isopen = false;
		var userinfo = base.GetUserInfo();
		var wrapper = base.Get("wrapper");
		var wrapper2 = base.Get("wrapper2");
		var $main = base.Get("main");
		var ShareInfo = {};

		mui.ready(function() {
			base.Immersed();

			wrapper.style.width = window.innerWidth * 0.8 + "px";
			wrapper.style.height = window.innerWidth * 0.8 * 1.3 + "px";
			wrapper.style.marginTop = window.innerHeight * 0.2 + "px";

			HttpGet(base.RootUrl + "Red/LoginRed", {
				number: userinfo.Number
			}, function(data) {
				if(data.result) {
					var rednumber = data.number;
					base.Get("price").innerText = parseFloat(parseInt(data.message) / 100).toFixed(2);
					base.Get("btnopen").addEventListener('tap', function() {
						if(isopen) {
							return false;
						}
						isopen = true;
						this.classList.add("flipInY");
						mui.later(function() {
							wrapper.classList.add("hide");
							$main.classList.remove("bg1");
							$main.classList.add("bg2");
							wrapper2.classList.remove("hide");
							wrapper2.classList.add("fadeIn");

							//拆红包
							HttpGet(base.RootUrl + "Red/OpenRed", {
								number: rednumber,
								usernumber: userinfo.Number
							}, function(data) {
								console.log(JSON.stringify(data))
							});
						}, 1700);
					});
				} else {
					mui.toast(data.message);
				}
			})
		})

		mui.plusReady(function() {
			self = plus.webview.currentWebview();

			var shareUrl = self.ShareUrl || "";
			var shareIcon = self.ShareIcon || "";

			base.Get("time").innerText = self.During || "";
			base.Get("btnopen").classList.remove("hide");

			wrapper.classList.remove("hide");
			wrapper.classList.add("jackInTheBox");

			//分享信息 
			ShareInfo.Title = "您的好友" + base.UnUnicodeText(userinfo.NickName) + "邀请您加入小微篇，随时随地记录精彩生活";
			ShareInfo.Cover = shareIcon;
			ShareInfo.Url = shareUrl + "?key=" + userinfo.Number;

			UpdateSerivces();

			mui.back = function() {
				self.close("red")
			}
		});

		function mypay() {
			base.OpenWindow("mypay", "mypay.html", {});
		}

		//分享
		function Share() {
			mui('#power').popover('toggle');
			ShareTan(1);
		}

		//分享
		function Share() {
			mui('#power').popover('toggle');
			ShareTan(1);
		}

		//分享
		var shares = null; //分享服务
		var shareImageUrl = ''; //分享图片地址

		//更新分享服务
		function UpdateSerivces() {
			plus.share.getServices(function(s) {
				shares = {};
				for(var i in s) {
					var t = s[i];
					shares[t.id] = t;
				}
			}, function(e) {
				console.log("获取分享服务列表失败：" + e.message);
			});
		}

		//分享弹窗
		function ShareTan(index) {
			var myshare = base.Get("myshare");
			if(index == 0) {
				base.Get("mysharebg").classList.add("hide");
				myshare.classList.remove("bounceInUp");
				myshare.classList.add("bounceOutUp");
			} else {
				base.Get("mysharebg").classList.remove("hide");
				myshare.classList.remove("hide");
				myshare.classList.remove("bounceOutUp");
				myshare.classList.add("bounceInUp");
			}
		}

		//分享信息 
		function ShareAction(index) {
			ShareTan(0);

			//系统分享
			if(index == 6) {
				ShareSystem();
				return;
			}
			var id = "";
			var ex = "";
			switch(index) {
				//朋友圈
				case 1:
					id = "weixin";
					ex = "WXSceneTimeline";
					break;
					//微信
				case 2:
					id = "weixin";
					ex = "WXSceneSession";
					break;
					//新浪微博
				case 3:
					id = "sinaweibo";
					ex = "";
					break;
					//qq
				case 4:
					id = "qq";
					ex = "";
					break;
					//qq空间
				case 5:
					id = "qq";
					ex = "";
					break;
				default:
					break;
			}
			var s = null;
			if(!id || !(s = shares[id])) {
				console.log("无效的分享服务！");
				return;
			}
			if(s.authenticated) {
				shareMessage(s, ex, id);
			} else {
				mui.toast("授权中");
				s.authorize(function() {
					shareMessage(s, ex, id);
				}, function(e) {
					mui.toast("认证授权失败");
				});
			}
		}

		//系统分享
		function ShareSystem() {
			if(plus.os.name !== "Android") {
				plus.nativeUI.alert("此平台暂不支持系统分享功能");
				return;
			}
			var Intent = plus.android.importClass("android.content.Intent");
			var File = plus.android.importClass("java.io.File");
			var Uri = plus.android.importClass("android.net.Uri");
			var main = plus.android.runtimeMainActivity();

			var intent = new Intent(Intent.ACTION_SEND);
			intent.setType("text/plain");
			intent.putExtra(Intent.EXTRA_SUBJECT, "");
			intent.putExtra(Intent.EXTRA_TEXT, "分享自「小微篇」" + ShareInfo.Title + " " + ShareInfo.Url);
			intent.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK);
			main.startActivity(Intent.createChooser(intent, "系统分享"));
			base.ShareLog(userinfo.Number, "", "system", 2);
		}

		//发送分享信息 
		function shareMessage(s, ex, id) {
			var msg = {
				href: ShareInfo.Url,
				title: ShareInfo.Title,
				content: "分享自「小微篇」",
				thumbs: [ShareInfo.Cover],
				pictures: [ShareInfo.Cover],
				extra: {
					scene: ex
				}
			};
			s.send(msg, function() {
				mui.toast("分享成功");
				base.ShareLog(userinfo.Number, "", id, 2);
			}, function(e) {
				mui.toast("分享失败");
			});
		}
	</script>

</html>