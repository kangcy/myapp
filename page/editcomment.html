<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title>编辑评论</title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<link rel="stylesheet" href="../css/mui.min.css">
		<style type="text/css">
			body {
				background: #fff;
			}
			
			#remark {
				line-height: 1.25rem;
				margin: 0px 5%;
				width: 90%;
				min-height: 5rem;
				background: #fff;
				padding: 0.3rem 0.5rem;
				border: 1px solid #eee;
			}
			
			#remark img {
				width: 1.25rem;
			}
			
			#commentwrapper {
				position: fixed;
				bottom: 0px;
				width: 100%;
				background: #f5f5f5;
			}
			
			#commentwrapper .flex-box {
				padding: 0.8rem 5%;
			}
			
			.addresswrapper {
				border-radius: 30px;
				display: inline-block;
				line-height: 1.3rem;
			}
			
			.addresswrapper img {
				width: 0.8rem;
				margin: 0.2rem;
				margin-left: 0.5rem;
			}
			
			#addresswrapper1 {
				border: 1px solid #0080ff;
			}
			
			#addresswrapper1 span {
				margin-right: 0.5rem;
				color: #0080ff;
			}
			
			#addresswrapper2 {
				border: 1px solid #999999;
			}
			
			#addresswrapper2 span {
				margin-right: 0.5rem;
				color: #999;
			}
			
			.icon {
				width: 1.5rem !important;
				height: 1.5rem;
				margin: 0.5rem 0px 0px 1.18rem;
				display: inline-block;
			}
			
			#iconTab div {
				display: inline-block;
				width: 100%;
				border-top: 1px solid #eee;
				float: left;
				padding: 0.5rem 0px;
				width: 20%;
				border-left: 1px solid #eee;
			}
			
			#iconTab div:first-child {
				border-left: 0px;
			}
			
			#iconTab div.curr {
				background: #fff;
			}
			
			#iconTab div img {
				width: 1.5rem;
			}
			
			#commentwrapper .mui-slider-group {
				margin-bottom: 1.5rem;
			}
		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav" id="header">
			<a class="mui-icon mui-action-back mui-text cfff fl">取消</a>
			<a id="submit" class="mui-icon mui-text cfff fr">完成</a>
			<h1 class="mui-title cfff" id="title"></h1>
		</header>
		<div class="mui-content">
			<input value="提交" onclick="ShowComment(1)" />
		</div>
		<div id="commentwrapper" class="">
			<div class="flex-box flex-row f12">
				<div style="flex:0 0 25%;" class="flex-item">
					<span onclick="ShowComment(0)" class="fl">取消</span>
				</div>
				<div style="flex:0 0 50%;" class="flex-item tc f14">
					回复楼主
				</div>
				<div style="flex:0 0 25%;" class="flex-item">
					<span onclick="SubmitComment(0)" class="fr">发表</span>
				</div>
			</div>
			<div id='remark' class="emojionearea-editor f12" contenteditable="true" placeholder="250字内" tabindex="0"></div>
			<div class="flex-box flex-row" style="padding: 0.5rem 5%;">
				<div style="flex:0 0 50%;" class="flex-item tl">
					<img src="../images/comment/smile.png" style="width:1.3rem;" onclick="ShowIcon()" />
				</div>
				<div style="flex:0 0 50%;" class="flex-item tr">
					<div id="addresswrapper1" class="addresswrapper" onclick="ShowPosition(0)">
						<img src="../images/comment/dingwei.png" class="fl" />
						<span class="f12" id="address">南京市</span>
					</div>
					<div id="addresswrapper2" class="addresswrapper hide" onclick="ShowPosition(1)">
						<img src="../images/comment/dingwei2.png" class="fl" />
						<span class="f12" id="address">隐藏当前位置</span>
					</div>
				</div>
			</div>
			<div id="slider" class="mui-slider hide">
				<div class="mui-slider-group" style="margin-bottom:0px;">
					<!--人物-->
					<div class="mui-slider-item">
						<div id="slider1" class="mui-slider">
							<div class="mui-slider-group">
								<div class="mui-slider-item" id="icons11"></div>
								<div class="mui-slider-item" id="icons12"></div>
								<div class="mui-slider-item" id="icons13"></div>
								<div class="mui-slider-item" id="icons14"></div>
							</div>
							<div class="mui-slider-indicator">
								<div class="mui-indicator mui-active"></div>
								<div class="mui-indicator"></div>
								<div class="mui-indicator"></div>
								<div class="mui-indicator"></div>
							</div>
						</div>
					</div>
					<!--动植物-->
					<div class="mui-slider-item">
						<div id="slider2" class="mui-slider">
							<div class="mui-slider-group">
								<div class="mui-slider-item" id="icons21"></div>
								<div class="mui-slider-item" id="icons22"></div>
								<div class="mui-slider-item" id="icons23"></div>
								<div class="mui-slider-item" id="icons24"></div>
								<div class="mui-slider-item" id="icons25"></div>
								<div class="mui-slider-item" id="icons26"></div>
								<div class="mui-slider-item" id="icons27"></div>
							</div>
							<div class="mui-slider-indicator">
								<div class="mui-indicator mui-active"></div>
								<div class="mui-indicator"></div>
								<div class="mui-indicator"></div>
								<div class="mui-indicator"></div>
								<div class="mui-indicator"></div>
								<div class="mui-indicator"></div>
								<div class="mui-indicator"></div>
							</div>
						</div>
					</div>
					<!--食物-->
					<div class="mui-slider-item">
						<div id="slider3" class="mui-slider">
							<div class="mui-slider-group">
								<div class="mui-slider-item" id="icons31"></div>
								<div class="mui-slider-item" id="icons32"></div>
								<div class="mui-slider-item" id="icons33"></div>
							</div>
							<div class="mui-slider-indicator">
								<div class="mui-indicator mui-active"></div>
								<div class="mui-indicator"></div>
								<div class="mui-indicator"></div>
							</div>
						</div>
					</div>
					<!--心形-->
					<div class="mui-slider-item">
						<div id="slider4" class="mui-slider">
							<div class="mui-slider-group">
								<div class="mui-slider-item" id="icons41"></div>
								<div class="mui-slider-item" id="icons42"></div>
								<div class="mui-slider-item" id="icons43"></div>
								<div class="mui-slider-item" id="icons44"></div>
								<div class="mui-slider-item" id="icons45"></div>
							</div>
							<div class="mui-slider-indicator">
								<div class="mui-indicator mui-active"></div>
								<div class="mui-indicator"></div>
								<div class="mui-indicator"></div>
								<div class="mui-indicator"></div>
								<div class="mui-indicator"></div>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div id="iconTab" class="hide">
				<div class="inline fl tc curr" onclick="ShowIconTab(0,this)"><img src="http://www.ishaoxia.com/Images/Icons/face/0.png" /></div>
				<div class="inline fl tc" onclick="ShowIconTab(1,this)"><img src="http://www.ishaoxia.com/Images/Icons/animal/49.png" /></div>
				<div class="inline fl tc" onclick="ShowIconTab(2,this)"><img src="http://www.ishaoxia.com/Images/Icons/food/0.png" /></div>
				<div class="inline fl tc" onclick="ShowIconTab(3,this)"><img src="http://www.ishaoxia.com/Images/Icons/heart/0.png" /></div>
				<div class="inline fl tc" onclick="ShowIconTab(4,this)"><img src="http://www.ishaoxia.com/Images/Icons/face/0.png" /></div>
			</div>
		</div>
	</body>

</html>
<script src="../minjs/mui.min.js"></script>
<script src="../minjs/base.min.js"></script>
<script type="text/javascript">
	var saveSelection, restoreSelection;
	var showIcon = false;
	var $edit = base.Get("remark");
	mui.init();

	mui.ready(function() {

		if(window.getSelection && document.createRange) {
			saveSelection = function(el) {
				var range = window.getSelection().getRangeAt(0);
				var preSelectionRange = range.cloneRange();
				preSelectionRange.selectNodeContents(el);
				preSelectionRange.setEnd(range.startContainer, range.startOffset);
				return preSelectionRange.toString().length;
			};

			restoreSelection = function(el, sel) {
				var charIndex = 0,
					range = document.createRange();
				range.setStart(el, 0);
				range.collapse(true);
				var nodeStack = [el],
					node, foundStart = false,
					stop = false;

				while(!stop && (node = nodeStack.pop())) {
					if(node.nodeType == 3) {
						var nextCharIndex = charIndex + node.length;
						if(!foundStart && sel >= charIndex && sel <= nextCharIndex) {
							range.setStart(node, sel - charIndex);
							range.setEnd(node, sel - charIndex);
							stop = true;
						}
						charIndex = nextCharIndex;
					} else {
						var i = node.childNodes.length;
						while(i--) {
							nodeStack.push(node.childNodes[i]);
						}
					}
				}

				sel = window.getSelection();
				sel.removeAllRanges();
				sel.addRange(range);
			}
		} else if(document.selection && document.body.createTextRange) {
			saveSelection = function(el) {
				var selectedTextRange = document.selection.createRange(),
					preSelectionTextRange = document.body.createTextRange();
				preSelectionTextRange.moveToElementText(el);
				preSelectionTextRange.setEndPoint("EndToStart", selectedTextRange);
				var start = preSelectionTextRange.text.length;

				return [start, start + selectedTextRange.text.length];
			};

			restoreSelection = function(el, sel) {
				var textRange = document.body.createTextRange();
				textRange.moveToElementText(el);
				textRange.collapse(true);
				textRange.moveEnd("character", sel[1]);
				textRange.moveStart("character", sel[0]);
				textRange.select();
			};
		}

		$edit.ontouchend = function() {
			$edit.innerHTML = $edit.innerHTML.replace(/(^.{250}).*/g, '$1');
		}
		//face:80
		var fragment = document.createDocumentFragment();
		for(var i = 0; i < 21; i++) {
			var el = document.createElement("img");
			el.setAttribute("src", base.RootUrl + "/Images/Icons/face/" + i + ".png");
			el.className = "icon";
			fragment.appendChild(el);
		}
		base.Get("icons11").appendChild(fragment);
		fragment = document.createDocumentFragment();
		for(var i = 21; i < 42; i++) {
			var el = document.createElement("img");
			el.setAttribute("src", base.RootUrl + "/Images/Icons/face/" + i + ".png");
			el.className = "icon";
			fragment.appendChild(el);
		}
		base.Get("icons12").appendChild(fragment);
		fragment = document.createDocumentFragment();
		for(var i = 42; i < 63; i++) {
			var el = document.createElement("img");
			el.setAttribute("src", base.RootUrl + "/Images/Icons/face/" + i + ".png");
			el.className = "icon";
			fragment.appendChild(el);
		}
		base.Get("icons13").appendChild(fragment);
		fragment = document.createDocumentFragment();
		for(var i = 63; i < 80; i++) {
			var el = document.createElement("img");
			el.setAttribute("src", base.RootUrl + "/Images/Icons/face/" + i + ".png");
			el.className = "icon";
			fragment.appendChild(el);
		}
		base.Get("icons14").appendChild(fragment);

		//animal:147
		var fragment = document.createDocumentFragment();
		for(var i = 1; i < 22; i++) {
			var el = document.createElement("img");
			el.setAttribute("src", base.RootUrl + "/Images/Icons/animal/" + i + ".png");
			el.className = "icon";
			fragment.appendChild(el);
		}
		base.Get("icons21").appendChild(fragment);
		fragment = document.createDocumentFragment();
		for(var i = 22; i < 43; i++) {
			var el = document.createElement("img");
			el.setAttribute("src", base.RootUrl + "/Images/Icons/animal/" + i + ".png");
			el.className = "icon";
			fragment.appendChild(el);
		}
		base.Get("icons22").appendChild(fragment);
		fragment = document.createDocumentFragment();
		for(var i = 43; i < 64; i++) {
			var el = document.createElement("img");
			el.setAttribute("src", base.RootUrl + "/Images/Icons/animal/" + i + ".png");
			el.className = "icon";
			fragment.appendChild(el);
		}
		base.Get("icons23").appendChild(fragment);
		fragment = document.createDocumentFragment();
		for(var i = 64; i < 85; i++) {
			var el = document.createElement("img");
			el.setAttribute("src", base.RootUrl + "/Images/Icons/animal/" + i + ".png");
			el.className = "icon";
			fragment.appendChild(el);
		}
		base.Get("icons24").appendChild(fragment);

		fragment = document.createDocumentFragment();
		for(var i = 85; i < 106; i++) {
			var el = document.createElement("img");
			el.setAttribute("src", base.RootUrl + "/Images/Icons/animal/" + i + ".png");
			el.className = "icon";
			fragment.appendChild(el);
		}
		base.Get("icons25").appendChild(fragment);

		fragment = document.createDocumentFragment();
		for(var i = 106; i < 127; i++) {
			var el = document.createElement("img");
			el.setAttribute("src", base.RootUrl + "/Images/Icons/animal/" + i + ".png");
			el.className = "icon";
			fragment.appendChild(el);
		}
		base.Get("icons26").appendChild(fragment);

		fragment = document.createDocumentFragment();
		for(var i = 127; i < 147; i++) {
			var el = document.createElement("img");
			el.setAttribute("src", base.RootUrl + "/Images/Icons/animal/" + i + ".png");
			el.className = "icon";
			fragment.appendChild(el);
		}
		base.Get("icons27").appendChild(fragment);

		//food:58
		var fragment = document.createDocumentFragment();
		for(var i = 0; i < 21; i++) {
			var el = document.createElement("img");
			el.setAttribute("src", base.RootUrl + "/Images/Icons/food/" + i + ".png");
			el.className = "icon";
			fragment.appendChild(el);
		}
		base.Get("icons31").appendChild(fragment);
		fragment = document.createDocumentFragment();
		for(var i = 21; i < 42; i++) {
			var el = document.createElement("img");
			el.setAttribute("src", base.RootUrl + "/Images/Icons/food/" + i + ".png");
			el.className = "icon";
			fragment.appendChild(el);
		}
		base.Get("icons32").appendChild(fragment);
		fragment = document.createDocumentFragment();
		for(var i = 42; i < 58; i++) {
			var el = document.createElement("img");
			el.setAttribute("src", base.RootUrl + "/Images/Icons/food/" + i + ".png");
			el.className = "icon";
			fragment.appendChild(el);
		}
		base.Get("icons33").appendChild(fragment);

		//heart:147
		var fragment = document.createDocumentFragment();
		for(var i = 1; i < 22; i++) {
			var el = document.createElement("img");
			el.setAttribute("src", base.RootUrl + "/Images/Icons/heart/" + i + ".png");
			el.className = "icon";
			fragment.appendChild(el);
		}
		base.Get("icons41").appendChild(fragment);
		fragment = document.createDocumentFragment();
		for(var i = 22; i < 43; i++) {
			var el = document.createElement("img");
			el.setAttribute("src", base.RootUrl + "/Images/Icons/heart/" + i + ".png");
			el.className = "icon";
			fragment.appendChild(el);
		}
		base.Get("icons42").appendChild(fragment);
		fragment = document.createDocumentFragment();
		for(var i = 43; i < 64; i++) {
			var el = document.createElement("img");
			el.setAttribute("src", base.RootUrl + "/Images/Icons/heart/" + i + ".png");
			el.className = "icon";
			fragment.appendChild(el);
		}
		base.Get("icons43").appendChild(fragment);
		fragment = document.createDocumentFragment();
		for(var i = 64; i < 85; i++) {
			var el = document.createElement("img");
			el.setAttribute("src", base.RootUrl + "/Images/Icons/heart/" + i + ".png");
			el.className = "icon";
			fragment.appendChild(el);
		}
		base.Get("icons44").appendChild(fragment);

		fragment = document.createDocumentFragment();
		for(var i = 85; i < 97; i++) {
			var el = document.createElement("img");
			el.setAttribute("src", base.RootUrl + "/Images/Icons/animal/" + i + ".png");
			el.className = "icon";
			fragment.appendChild(el);
		}
		base.Get("icons45").appendChild(fragment);

		//初始化
		mui("#slider,#slider1,#slider2,#slider3,#slider4").slider({
			interval: 0
		});

		//添加表情
		mui('#commentwrapper').on('tap', '.icon', function() {
			$edit.focus();
			saveSelection($edit);
			pasteHtmlAtCaret('<img src="' + this.getAttribute("src") + '" />');
		});
	})

	mui.plusReady(function() {

	});

	function pasteHtmlAtCaret(html) {
		var sel, range;
		if(window.getSelection) {
			sel = window.getSelection();
			if(sel.getRangeAt && sel.rangeCount) {
				range = sel.getRangeAt(0);
				range.deleteContents();
				var el = document.createElement("div");
				el.innerHTML = html;
				var frag = document.createDocumentFragment(),
					node, lastNode;
				while((node = el.firstChild)) {
					lastNode = frag.appendChild(node);
				}
				range.insertNode(frag);
				if(lastNode) {
					range = range.cloneRange();
					range.setStartAfter(lastNode);
					range.collapse(true);
					sel.removeAllRanges();
					sel.addRange(range);
				}
			}
		} else if(document.selection && document.selection.type != "Control") {
			document.selection.createRange().pasteHTML(html);
		}
	}

	//显示编辑器
	function ShowComment(show) {
		if(show == 0) {
			base.Get("commentwrapper").classList.add("hide");
		} else {
			base.Get("commentwrapper").classList.remove("hide");
		}
	}

	//显示定位
	function ShowPosition(show) {
		if(show == 0) {
			base.Get("addresswrapper1").classList.add("hide");
			base.Get("addresswrapper2").classList.remove("hide");
		} else {
			base.Get("addresswrapper2").classList.add("hide");
			base.Get("addresswrapper1").classList.remove("hide");
		}
	}

	//显示表情
	function ShowIcon(item, show) {
		base.Get("slider").classList.toggle("hide");
		base.Get("iconTab").classList.toggle("hide");
	}

	//表情分类切换
	function ShowIconTab(index, item) {
		$edit.focus();
		mui("#iconTab>div").each(function(i, model) {
			model.classList.remove("curr");
		})
		mui("#slider").slider().gotoItem(index);
		item.classList.add("curr");
	}
</script>