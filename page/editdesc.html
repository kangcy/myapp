<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title>编辑文字</title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<link rel="stylesheet" href="../css/mui.min.css">
		<style type="text/css">
			.mui-bar-tab img {
				width: 35px;
				height: 35px;
				margin-top: 7px;
			}
			
			.color {
				width: 20px;
				height: 20px;
				margin: 15px;
				display: inline-block;
			}
			
			.edit {
				height: auto;
				/*min-height: 300px;*/
				line-height: 1.25rem;
				outline: 0px;
			}
			
			.menu {
				height: 100%;
				float: right;
				display: inline-block;
				background-repeat: no-repeat;
				background-position: center center;
				background-size: auto 70%;
			}
			
			.menu.curr {
				background-color: #0080ff;
				color: #fff;
			}
			
			.menus {
				display: inline-block;
				border: 1px solid #ddd;
				border-radius: 10px;
				float: right;
				height: 45px;
				line-height: 45px;
				overflow: hidden;
			}
			
			#btnBold {
				background-image: url(../images/edittxt/022.png);
			}
			
			#btnBold.curr {
				background-image: url(../images/edittxt/023.png);
			}
			
			#btnItalic {
				background-image: url(../images/edittxt/042.png);
			}
			
			#btnItalic.curr {
				background-image: url(../images/edittxt/043.png);
			}
			
			#btnUnderline {
				background-image: url(../images/edittxt/052.png);
			}
			
			#btnUnderline.curr {
				background-image: url(../images/edittxt/053.png);
			}
			
			#btnLeft {
				background-image: url(../images/edittxt/062.png);
			}
			
			#btnLeft.curr {
				background-image: url(../images/edittxt/063.png);
			}
			
			#btnCenter {
				background-image: url(../images/edittxt/072.png);
			}
			
			#btnCenter.curr {
				background-image: url(../images/edittxt/073.png);
			}
			
			#btnRight {
				background-image: url(../images/edittxt/082.png);
			}
			
			#btnRight.curr {
				background-image: url(../images/edittxt/083.png);
			}
		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav" style="background:#fff;">
			<a class="mui-icon mui-action-back  mui-text c333 fl">取消</a>
			<a id="submit" class="mui-icon  mui-text c333 fr">保存</a>
			<h1 class="mui-title c333">编辑文字</h1>
		</header>
		<div class="mui-content">
			<div style="padding:5%;" id="divedit">

			</div>
		</div>
		<nav id="color" class="mui-bar mui-bar-tab hide" style="background:#fff;bottom:50px;">
			<div class="color fl" style="background:#000;" data-type="ForeColor" data="#000"></div>
			<div class="color fl" style="background:#808080;" data-type="ForeColor" data="#808080"></div>
			<div class="color fl" style="background:#ED2308;" data-type="ForeColor" data="#ED2308"></div>
			<div class="color fl" style="background:#FF8A00;" data-type="ForeColor" data="#FF8A00"></div>
			<div class="color fl" style="background:#39B54A;" data-type="ForeColor" data="#39B54A"></div>
			<div class="color fl" style="background:#167EFB;" data-type="ForeColor" data="#167EFB"></div>
			<div class="color fl" style="background:#B04FBB;" data-type="ForeColor" data="#B04FBB"></div>
		</nav>
		<nav id="bgcolor" class="mui-bar mui-bar-tab hide" style="background:#fff;bottom:50px;">
			<div class="color fl" style="background:#000;" data-type="ForeColor" data="#000"></div>
			<div class="color fl" style="background:#808080;" data-type="BackColor" data="#808080"></div>
			<div class="color fl" style="background:#ED2308;" data-type="BackColor" data="#ED2308"></div>
			<div class="color fl" style="background:#FF8A00;" data-type="BackColor" data="#FF8A00"></div>
			<div class="color fl" style="background:#39B54A;" data-type="BackColor" data="#39B54A"></div>
			<div class="color fl" style="background:#167EFB;" data-type="BackColor" data="#167EFB"></div>
			<div class="color fl" style="background:#B04FBB;" data-type="BackColor" data="#B04FBB"></div>
		</nav>
		<nav id="align" class="mui-bar mui-bar-tab tc hide" style="background:#fff;bottom:50px;">
			<div class="menus" id="align_first">
				<div class="menu format" id="btnLeft"> </div>
				<div class="menu format" id="btnCenter"> </div>
				<div class="menu format" id="btnRight"> </div>
			</div>
		</nav>
		<nav id="fs" class="mui-bar mui-bar-tab tc hide" style="background:#fff;bottom:50px;">
			<div class="menus" id="fs_first">
				<div class="menu f30">
					A
				</div>
				<div class="menu f25">
					A
				</div>
				<div class="menu f20">
					A
				</div>
				<div class="menu f18">
					A
				</div>
				<div class="menu f16">
					A
				</div>
				<div class="menu f14">
					A
				</div>
				<div class="menu f12">
					A
				</div>
			</div>
		</nav>
		<nav id="bold" class="mui-bar mui-bar-tab tc hide" style="background:#fff;bottom:50px;">
			<div class="menus" id="bold_first">
				<!--下划线-->
				<div class="menu" data-type="Underline" id="btnUnderline"> </div>
				<!--斜体-->
				<div class="menu" data-type="Italic" id="btnItalic"> </div>
				<!--加粗-->
				<div class="menu" data-type="Bold" id="btnBold"> </div>
			</div>
		</nav>
		<nav id="common" class="mui-bar mui-bar-tab tc" style="background:#F4F4F4;display:inline-block;">
			<!--上一步-->
			<div class="menu fl">
				<img src="../images/edittxt/prev.png" id="menuPrev" />
			</div>
			<!--下一步-->
			<div class="menu fl">
				<img src="../images/edittxt/next.png" id="menuNext" />
			</div>
			<!--超链接-->
			<div class="menu">
				<img src="../images/edittxt/0112.png" data-type="CreateLink" id="menuLink" />
			</div>
			<!--背景颜色-->
			<div class="menu">
				<img src="../images/edittxt/010.png" id="menuBgColor" />
			</div>
			<!--字体颜色-->
			<div class="menu">
				<img src="../images/edittxt/09.png" id="menuColor" />
			</div>
			<!--文字位置-->
			<div class="menu">
				<img src="../images/edittxt/062.png" class="btnAlign hide" id="menuLeft" />
				<img src="../images/edittxt/072.png" class="btnAlign hide" id="menuCenter" />
				<img src="../images/edittxt/082.png" class="btnAlign hide" id="menuRight" />
			</div>
			<!--字体大小-->
			<div class="menu">
				<img src="../images/edittxt/012.png" id="menuSize" />
			</div>
			<!--加粗-->
			<div class="menu">
				<img src="../images/edittxt/022.png" id="menuBold" />
			</div>
		</nav>
	</body>

</html>
<script src="../js/jquery-1.10.2.min.js"></script>
<script src="../js/mui.min.js"></script>
<script src="../js/base.js"></script>
<script type="text/javascript">
	var ArticleID = 0;
	var ArticleNumber = ""; //文章编号
	var PartID = 0;
	var isLoading = false;
	var userinfo = base.GetUserInfo();

	//编辑变动缓存
	var ActionCache = [];
	var CurrActionCache = 0;

	mui.init();

	mui.ready(function() {
		var limit = window.innerWidth / 8;
		$(".menu").css("width", limit + "px");
		$("#align_first").css("margin-right", limit * 2 + "px");
		$("#fs_first").css("margin-right", limit * 0 + "px");
		$("#bold_first").css("margin-right", limit * 3 + "px");

		//字体大小
		base.Get("menuSize").addEventListener('tap', function(event) {
			$("#color,#bgcolor,#align,#bold").addClass("hide");
			$("#fs").toggleClass("hide");
		}, false);

		//颜色 
		base.Get("menuColor").addEventListener('tap', function(event) {
			$("#bgcolor,#align,#bold,#fs").addClass("hide");
			$("#color").toggleClass("hide");
		}, false);

		//背景色
		base.Get("menuBgColor").addEventListener('tap', function(event) {
			$("#color,#align,#bold,#fs").addClass("hide");
			$("#bgcolor").toggleClass("hide");
		}, false);

		//加粗
		base.Get("menuBold").addEventListener('tap', function(event) {
			$("#color,#bgcolor,#align,#fs").addClass("hide");
			$("#bold").toggleClass("hide");
		}, false);

		//颜色切换
		mui('#color').on('tap', 'div', setTxtStyle);

		//背景色切换
		mui('#bgcolor').on('tap', 'div', setTxtStyle);

		//对齐
		mui('#common').on('tap', '.btnAlign', function() {
			$("#color,#bgcolor,#bold,#fs").addClass("hide");
			$("#align").toggleClass("hide");
		});

		//加粗
		base.Get("btnBold").addEventListener('tap', setTxtStyle, false);

		//斜体
		base.Get("btnItalic").addEventListener('tap', setTxtStyle, false);

		//下划线
		base.Get("btnUnderline").addEventListener('tap', setTxtStyle, false);

		//居左
		base.Get("btnLeft").addEventListener('tap', function() {
			InitAlign(this);
			$("#edit").addClass("tl");
		}, false);

		//居中
		base.Get("btnCenter").addEventListener('tap', function() {
			InitAlign(this);
			$("#edit").addClass("tc");
		}, false);

		//居右
		base.Get("btnRight").addEventListener('tap', function() {
			InitAlign(this);
			$("#edit").addClass("tr");
		}, false);

		//超链接
		base.Get("menuLink").addEventListener('tap', setTxtStyle, false);
	})

	//初始化对齐
	function InitAlign(item) {
		$("#btnLeft,#btnCenter,#btnRight").removeClass("active");
		$(item).addClass("active");
		$("#edit").removeClass("tl tc tr");
	}

	var addarticlePage = null;
	mui.plusReady(function() {

		var self = plus.webview.currentWebview();
		ArticleID = self.ArticleID || 0;
		ArticleNumber = self.ArticleNumber;
		PartID = self.PartID || 0;

		var html = self.title;
		if(base.IsNullOrEmpty(html)) {
			html = '<div class="edit f12 tl"></div>';
		}
		$("#divedit").html(html).find("div").attr({
			"id": "edit",
			"contenteditable": "true"
		});

		var $item = $("#edit");
		if($item.hasClass("f14")) {
			$("#btn20").addClass("hide");
			$("#btn21").removeClass("hide");
		} else {
			$("#btn21").addClass("hide");
			$("#btn20").removeClass("hide");
		}
		if($item.hasClass("tl")) {
			$("#menuLeft").removeClass("hide");
		}
		if($item.hasClass("tc")) {
			$("#menuCenter").removeClass("hide");
		}
		if($item.hasClass("tr")) {
			$("#menuRight").removeClass("hide");
		}

		//字数限制
		base.Get("edit").ontouchend = function() {
			console.log("ontouchend");
			base.Get("edit").innerHTML = base.Get("edit").innerHTML.replace(/(^.{5000}).*/g, '$1');
		}

		base.Get("edit").onblur = function() {
			console.log("onblur");
			$("#color,#bgcolor,#bold,#fs,#align").addClass("hide");
		}

		//提交
		base.Get("submit").addEventListener('tap', function(event) {
			if(isLoading) {
				return;
			}
			isLoading = true;
			if(base.IsNullOrEmpty($("#divedit").html())) {
				isLoading = false;
				return mui.toast("请编辑文字");
			}
			$("#edit").removeAttr("contenteditable").removeAttr("id");

			if(!addarticlePage) {
				addarticlePage = base.GetView('addarticle');
			}
			addarticlePage.evalJS("AddText('" + (PartID == 0 ? base.GetUid() : PartID) + "','" + escape($("#divedit").html()) + "','" + PartID + "')");
			plus.webview.close("editdesc");
		}, false);
	});

	//打开编辑
	function ShowLink() {
		var link = "";
		var text = link;
		var length = $("#edit").find("span").length;
		if(length > 0) {
			link = $("#edit").find("span").attr("link");
			text = $("#edit").find("span").html();
		}
		base.OpenWindow("edithref", "edithref.html", {
			Link: link,
			Text: text
		});
	}

	//编辑超链接
	function UpdateLink(link, text) {
		if(!base.IsNullOrEmpty(link) && !base.IsNullOrEmpty(text)) {
			ChangeLink(link);
			console.log($("#edit").html())
		}
	}

	//删除超链接
	function DeleteLink(link, text) {
		var length = $("#edit").find("span").length;
		if(length > 0) {
			$("#edit").find("span").remove();
		}
		$("#btn51").addClass("hide");
		$("#btn50").removeClass("hide");
		Link = "";
	}

	function setTxtStyle(e) {
		var that = e.target;
		console.log(that.id);
		$(this).toggleClass("curr")
		var type = this.getAttribute("data-type") || "";
		var valueTxt = this.getAttribute("data") || "";
		if(that.id === "btnLink") {
			valueTxt = "placeholder";
			ShowLink();
		};
		document.execCommand(type, false, valueTxt);
	};

	function ChangeLink(link) {
		var wrap = base.Get("edit");
		var node = wrap.querySelectorAll("a");
		var Url = "";
		for(var i = 0; i < node.length; i++) {
			Url = node[i].getAttribute("href");
			if(Url === "placeholder") {
				node[i].setAttribute("href", "#");
				node[i].setAttribute("link", link);
				node[i].classList.add("link");
			};
		};
	};
</script>