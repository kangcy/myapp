<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title>编辑文字</title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<link rel="stylesheet" href="../css/mui.min.css">
		<style type="text/css">
			.mui-bar-tab img {
				width: 35px;
				height: 35px;
				margin-top: 7px;
			}
			
			.color {
				width: 20px;
				height: 20px;
				margin: 15px;
				display: inline-block;
			}
			
			.edit {
				height: auto;
				min-height: 400px;
				line-height: 1.25rem;
				outline: 0px;
			}
		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav" style="background:#fff;">
			<a class="mui-icon mui-action-back  mui-text c333 fl">取消</a>
			<a id="submit" class="mui-icon  mui-text c333 fr">保存</a>
			<h1 class="mui-title c333">编辑文字</h1>
		</header>
		<div class="mui-content">
			<div style="padding: 5%;" id="divedit">

			</div>
		</div>
		<nav id="color" class="mui-bar mui-bar-tab hide" style="background:#fff;bottom:50px;">
			<div class="color fl" style="background:#000;" color="#000"></div>
			<div class="color fl" style="background:#808080;" color="#808080"></div>
			<div class="color fl" style="background:#ED2308;" color="#ED2308"></div>
			<div class="color fl" style="background:#FF8A00;" color="#FF8A00"></div>
			<div class="color fl" style="background:#39B54A;" color="#39B54A"></div>
			<div class="color fl" style="background:#167EFB;" color="#167EFB"></div>
			<div class="color fl" style="background:#B04FBB;" color="#B04FBB"></div>
		</nav>
		<nav class="mui-bar mui-bar-tab" style="background:#F4F4F4;display:inline-block;">
			<!--加粗-->
			<img src="../images/edittxt/1.png" class="fl ml5 hide" id="btn10" />
			<img src="../images/edittxt/01.png" class="fl ml5 hide" id="btn11" />
			<!--字体大小-->
			<img src="../images/edittxt/2.png" class="fl ml5 hide" id="btn20" />
			<img src="../images/edittxt/02.png" class="fl ml5 hide" id="btn21" />
			<!--文字位置-->
			<img src="../images/edittxt/3.png" class="fl ml5 hide" id="btn30" />
			<img src="../images/edittxt/03.png" class="fl ml5 hide" id="btn31" />
			<!--字体颜色-->
			<img src="../images/edittxt/4.png" class="fl ml5" id="btn40" />
			<!--超链接-->
			<img src="../images/edittxt/5.png" class="fl ml5 hide" id="btn50" />
			<img src="../images/edittxt/05.png" class="fl ml5 hide" id="btn51" />
		</nav>
	</body>

</html>
<script src="../js/jquery-1.10.2.min.js"></script>
<script src="../js/mui.min.js"></script>
<script src="../js/base.js"></script>
<script type="text/javascript">
	var ArticleID = 0;
	var ArticleNumber = ""; //文章编号
	var PartID = 0;
	var isLoading = false;
	var userinfo = base.GetUserInfo();

	var Color = "";
	var Align = "tl";
	var FontSize = "f12";
	var FontWeight = "";
	var Link = "";

	//编辑变动缓存
	var ActionCache = [];
	var CurrActionCache = 0;

	mui.init();

	mui.ready(function() {

		//加粗
		base.Get("btn10").addEventListener('tap', function(event) {
			$("#edit").addClass("bold");
			$("#btn10,#btn11").toggleClass("hide");
			FontWeight = "bold";
		}, false);

		//字体放大
		base.Get("btn20").addEventListener('tap', function(event) {
			$("#edit").removeClass("f12").addClass("f14");
			$("#btn20,#btn21").toggleClass("hide");
			FontSize = "f14";
		}, false);

		//文字居中
		base.Get("btn30").addEventListener('tap', function(event) {
			$("#edit").removeClass("tl").addClass("tc");
			$("#btn30,#btn31").toggleClass("hide");
			Align = "center";
		}, false);

		//颜色
		base.Get("btn40").addEventListener('tap', function(event) {
			$("#color").toggleClass("hide");
		}, false);

		//切换颜色
		mui('#color').on('tap', '.color', function() {
			var $this = $(this);
			$("#edit").css("color", $this.attr("color"));
			$("#color").toggleClass("hide");
			Color = $this.attr("color");
		});

		//超链接
		base.Get("btn50").addEventListener('tap', function(event) {
			$("#btn50,#btn51").toggleClass("hide");
			ShowLink();
		}, false);

		//取消加粗
		base.Get("btn11").addEventListener('tap', function(event) {
			$("#edit").removeClass("bold");
			$("#btn10,#btn11").toggleClass("hide");
			FontWeight = "";
		}, false);

		//字体缩小
		base.Get("btn21").addEventListener('tap', function(event) {
			$("#edit").removeClass("f14").addClass("f12");
			$("#btn20,#btn21").toggleClass("hide");
			FontSize = "f12";
		}, false);

		//取消文字居中
		base.Get("btn31").addEventListener('tap', function(event) {
			$("#edit").removeClass("tc").addClass("tl");
			$("#btn30,#btn31").toggleClass("hide");
			Align = "tl";
		}, false);

		//取消超链接
		base.Get("btn51").addEventListener('tap', function(event) {
			ShowLink();
		}, false);
	})

	var addarticlePage = null;
	mui.plusReady(function() {

		var self = plus.webview.currentWebview();
		ArticleID = self.ArticleID || 0;
		ArticleNumber = self.ArticleNumber;
		PartID = self.PartID || 0;

		Color = self.Color || "";
		Align = self.Align || "";
		FontSize = self.FontSize || "";
		FontWeight = self.FontWeight || "";
		Link = self.Link || "";

		var html = self.title;
		if(base.IsNullOrEmpty(html)) {
			html = '<div class="edit f12 tl"></div>';
		}
		$("#divedit").html(html).find("div").attr({
			"id": "edit",
			"contenteditable": "true"
		});

		var $item = $("#edit");
		if($item.hasClass("bold")) {
			$("#btn10").addClass("hide");
			$("#btn11").removeClass("hide");
		} else {
			$("#btn11").addClass("hide");
			$("#btn10").removeClass("hide");
		}
		if($item.hasClass("f14")) {
			$("#btn20").addClass("hide");
			$("#btn21").removeClass("hide");
		} else {
			$("#btn21").addClass("hide");
			$("#btn20").removeClass("hide");
		}
		if($item.hasClass("tc")) {
			$("#btn30").addClass("hide");
			$("#btn31").removeClass("hide");
		} else {
			$("#btn31").addClass("hide");
			$("#btn30").removeClass("hide");
		}

		if($item.find("span").length > 0) {
			$("#btn50").addClass("hide");
			$("#btn51").removeClass("hide");
		} else {
			$("#btn51").addClass("hide");
			$("#btn50").removeClass("hide");
		}

		//字数限制
		base.Get("edit").ontouchend = function() {
			base.Get("edit").innerHTML = base.Get("edit").innerHTML.replace(/(^.{3000}).*/g, '$1');
		}

		//提交
		base.Get("submit").addEventListener('tap', function(event) {
			if(isLoading) {
				return;
			}
			isLoading = true;
			if(base.IsNullOrEmpty($("#divedit").html())) {
				isLoading = false;
				return mui.toast("请编辑文字");
			}
			$("#edit").removeAttr("contenteditable").removeAttr("id");

			if(!addarticlePage) {
				addarticlePage = base.GetView('addarticle');
			}
			addarticlePage.evalJS("AddText('" + (PartID == 0 ? base.GetUid() : PartID) + "','" + escape($("#divedit").html()) + "','" + PartID + "')");
			plus.webview.close("editdesc");
		}, false);
	});

	//打开编辑
	function ShowLink() {
		var link = "";
		var text = link;
		var length = $("#edit").find("span").length;
		if(length > 0) {
			link = $("#edit").find("span").attr("link");
			text = $("#edit").find("span").html();
		}
		base.OpenWindow("edithref", "edithref.html", {
			Link: link,
			Text: text
		});
	}

	//编辑超链接
	function UpdateLink(link, text) {
		if(!base.IsNullOrEmpty(link) && !base.IsNullOrEmpty(text)) {
			var length = $("#edit").find("span").length;
			if(length == 0) {
				$("#edit").append('<span class="link td" link="' + link + '">' + text + '</span>')
			} else {
				$("#edit").find("span").attr("link", link).html(text);
			}
			Link = link;
		}
	}

	//删除超链接
	function DeleteLink(link, text) {
		var length = $("#edit").find("span").length;
		if(length > 0) {
			$("#edit").find("span").remove();
		}
		$("#btn51").addClass("hide");
		$("#btn50").removeClass("hide");
		Link = "";
	}
</script>