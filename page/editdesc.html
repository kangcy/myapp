<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title>编辑文字</title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<link rel="stylesheet" href="../mincss/mui.min.css">
		<style type="text/css">
			.mui-bar-tab img {
				width: 35px;
				height: 35px;
				margin-top: 7px;
			}
			
			.color {
				width: 20px;
				height: 20px;
				margin: 15px;
				display: inline-block;
			}
			
			.menu {
				height: 100%;
				float: right;
				display: inline-block;
				background-repeat: no-repeat;
				background-position: center center;
				background-size: auto 60%;
			}
			
			.menu.curr {
				background-color: #0080ff;
				color: #fff;
			}
			
			.menus {
				display: inline-block;
				border: 1px solid #ddd;
				border-radius: 10px;
				float: right;
				height: 45px;
				line-height: 45px;
				overflow: hidden;
			}
			
			#btnBold {
				background-image: url(../images/edittxt/022.png);
			}
			
			#btnBold.curr {
				background-image: url(../images/edittxt/023.png);
			}
			
			#btnItalic {
				background-image: url(../images/edittxt/042.png);
			}
			
			#btnItalic.curr {
				background-image: url(../images/edittxt/043.png);
			}
			
			#btnUnderline {
				background-image: url(../images/edittxt/052.png);
			}
			
			#btnUnderline.curr {
				background-image: url(../images/edittxt/053.png);
			}
			
			#btnLeft {
				background-image: url(../images/edittxt/062.png);
			}
			
			#btnLeft.curr {
				background-image: url(../images/edittxt/063.png);
			}
			
			#btnCenter {
				background-image: url(../images/edittxt/072.png);
			}
			
			#btnCenter.curr {
				background-image: url(../images/edittxt/073.png);
			}
			
			#btnRight {
				background-image: url(../images/edittxt/082.png);
			}
			
			#btnRight.curr {
				background-image: url(../images/edittxt/083.png);
			}
			
			#menuPrev {
				background-image: url(../images/edittxt/prev.png);
			}
			
			#menuNext {
				background-image: url(../images/edittxt/next.png);
			}
			
			#menuLink {
				background-image: url(../images/edittxt/0112.png);
			}
			
			#menuBgColor {
				background-image: url(../images/edittxt/09.png);
			}
			
			#menuColor {
				background-image: url(../images/edittxt/010.png);
			}
			
			#menuSize {
				background-image: url(../images/edittxt/012.png);
			}
			
			#menuBold {
				background-image: url(../images/edittxt/022.png);
			}
			
			#menuAlign.menuLeft {
				background-image: url(../images/edittxt/062.png);
			}
			
			#menuAlign.menuLeft.curr {
				background-image: url(../images/edittxt/061.png);
			}
			
			#menuAlign.menuCenter {
				background-image: url(../images/edittxt/072.png);
			}
			
			#menuAlign.menuCenter.curr {
				background-image: url(../images/edittxt/071.png);
			}
			
			#menuAlign.menuRight {
				background-image: url(../images/edittxt/082.png);
			}
			
			#menuAlign.menuRight.curr {
				background-image: url(../images/edittxt/081.png);
			}
			
			#all {
				background: #0080ff;
				color: #fff;
				position: fixed;
				left: 10px;
				bottom: 60px;
				height: 30px;
				line-height: 30px;
				display: inline-block;
				border-radius: 10px;
			}
			
			.editor {
				border: 1px solid #f5f5f5;
			}
		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav" id="header">
			<a class="mui-icon mui-action-back  mui-text cfff fl">取消</a>
			<a id="submit" class="mui-icon  mui-text cfff fr">保存</a>
			<h1 class="mui-title cfff">编辑文字</h1>
		</header>
		<nav id="color" class="mui-bar mui-bar-tab hide" style="background:#ddd;bottom:50px;">
			<div class="color fr" style="background:#000;" data-type="ForeColor" data="#000"></div>
			<div class="color fr" style="background:#808080;" data-type="ForeColor" data="#808080"></div>
			<div class="color fr" style="background:#ED2308;" data-type="ForeColor" data="#ED2308"></div>
			<div class="color fr" style="background:#FF8A00;" data-type="ForeColor" data="#FF8A00"></div>
			<div class="color fr" style="background:#39B54A;" data-type="ForeColor" data="#39B54A"></div>
			<div class="color fr" style="background:#167EFB;" data-type="ForeColor" data="#167EFB"></div>
			<div class="color fr" style="background:#B04FBB;" data-type="ForeColor" data="#B04FBB"></div>
		</nav>
		<nav id="bgcolor" class="mui-bar mui-bar-tab hide" style="background:#ddd;bottom:50px;">
			<div class="color fr" style="background:#fff;" data-type="BackColor" data="transparent"></div>
			<div class="color fr" style="background:#808080;" data-type="BackColor" data="#808080"></div>
			<div class="color fr" style="background:#ED2308;" data-type="BackColor" data="#ED2308"></div>
			<div class="color fr" style="background:#FF8A00;" data-type="BackColor" data="#FF8A00"></div>
			<div class="color fr" style="background:#39B54A;" data-type="BackColor" data="#39B54A"></div>
			<div class="color fr" style="background:#167EFB;" data-type="BackColor" data="#167EFB"></div>
			<div class="color fr" style="background:#B04FBB;" data-type="BackColor" data="#B04FBB"></div>
		</nav>
		<nav id="align" class="mui-bar mui-bar-tab tc hide" style="background:#fff;bottom:50px;">
			<div class="menus" id="align_first">
				<div class="menu format" id="btnRight"> </div>
				<div class="menu format" id="btnCenter"> </div>
				<div class="menu format" id="btnLeft"> </div>
			</div>
		</nav>

		<nav id="bold" class="mui-bar mui-bar-tab tc hide" style="background:#fff;bottom:50px;">
			<div class="menus" id="bold_first">
				<!--下划线-->
				<div class="menu" data-type="Underline" id="btnUnderline"> </div>
				<!--斜体-->
				<div class="menu" data-type="Italic" id="btnItalic"> </div>
				<!--加粗-->
				<div class="menu" data-type="Bold" id="btnBold"> </div>
			</div>
		</nav>
		<nav id="fs" class="mui-bar mui-bar-tab tc hide" style="background:#fff;bottom:50px;">
			<div class="menus" id="fs_first">
				<div class="menu fs f36" data-type="FontSize" data="7">
					A
				</div>
				<div class="menu fs f24" data-type="FontSize" data="6">
					A
				</div>
				<div class="menu fs f20" data-type="FontSize" data="5">
					A
				</div>
				<div class="menu fs f14" data-type="FontSize" data="4">
					A
				</div>
				<div class="menu fs f12" data-type="FontSize" data="3">
					A
				</div>
			</div>
		</nav>
		<nav id="all" class="menu f11 tc">全选</nav>
		<nav id="common" class="mui-bar mui-bar-tab tc" style="background:#F4F4F4;display:inline-block;">
			<!--上一步-->
			<div class="menu fl" id="menuPrev"> </div>
			<!--下一步-->
			<div class="menu fl" id="menuNext"></div>
			<!--超链接-->
			<div class="menu" data-type="CreateLink" id="menuLink"></div>
			<!--背景颜色-->
			<div class="menu" id="menuBgColor"></div>
			<!--字体颜色-->
			<div class="menu" id="menuColor"></div>
			<!--文字位置-->
			<div class="menu btnAlign hide" id="menuAlign"> </div>
			<!--字体大小-->
			<div class="menu" id="menuSize"> </div>
			<!--加粗-->
			<div class="menu" id="menuBold"> </div>
		</nav>
		<div id="muicontent">
			<iframe src="../paste/iframeblankpage.html" id="editor" class="editor" frameborder="0" width="100%"></iframe>
		</div>
	</body>

</html>
<script src="../minjs/mui.min.js"></script>
<script src="../minjs/base.min.js"></script>
<script src="../paste/paste.js"></script>
<script type="text/javascript">
	var ArticleID = 0;
	var ArticleNumber = ""; //文章编号
	var PartID = 0;
	var SelectAll = false; //是否全选
	var isLoading = false;
	var userinfo = base.GetUserInfo();
	var mask = base.CreateMask(false, function() {
		base.CloseWaiting();
	});

	//编辑变动缓存
	var ActionCache = [];
	var CurrActionCache = -1;

	var $edit = base.Get("editor");

	window.onload = function() {
		$edit.style.height = window.innerHeight - 165 + "px";
	};
	window.onresize = function() {
		$edit.style.height = window.innerHeight - 165 + "px";
	};

	mui.init();

	mui.ready(function() {
		base.Immersed();

		var limit = window.innerWidth / 9;
		mui.each(mui(".menu"), function(i, item) {
			item.style.width = limit + "px";
		})
		base.Get("align_first").style.marginRight = limit * 2 + "px";
		base.Get("fs_first").style.marginRight = limit * 2 + "px";
		base.Get("bold_first").style.marginRight = limit * 4 + "px";

		//全选 
		base.Get("all").addEventListener('tap', function(event) {
			objEditorBody.focus();
			if(this.classList.contains("select")) {
				SelectAll = false;
				this.classList.remove("select");
				edDoc.execCommand("Unselect");
			} else {
				SelectAll = true;
				this.classList.add("select");
				edDoc.execCommand("SelectAll");
			}
		}, false);

		//上一步
		base.Get("menuPrev").addEventListener('tap', function(event) {
			if(isLoading) {
				return
			}
			isLoading = true;
			if(CurrActionCache > 0) {
				CurrActionCache -= 1;
				objEditorBody.innerHTML = ActionCache[CurrActionCache];
			} else {
				CurrActionCache = 0;
			}
			isLoading = false;
		}, false);

		//下一步 
		base.Get("menuNext").addEventListener('tap', function(event) {
			if(isLoading) {
				return
			}
			isLoading = true;
			if(CurrActionCache < ActionCache.length - 1) {
				CurrActionCache += 1;
				objEditorBody.innerHTML = ActionCache[CurrActionCache];
			} else {
				CurrActionCache = ActionCache.length - 1;
			}
			isLoading = false;
		}, false);

		//字体大小
		base.Get("menuSize").addEventListener('tap', function(event) {
			base.AddClass(["#color", "#bgcolor", "#align", "#bold"], "hide");
			base.Get("fs").classList.toggle("hide");
		}, false);

		//颜色 
		base.Get("menuColor").addEventListener('tap', function(event) {
			base.AddClass(["#bgcolor", "#align", "#bold", "#fs"], "hide");
			base.Get("color").classList.toggle("hide");
		}, false);

		//背景色
		base.Get("menuBgColor").addEventListener('tap', function(event) {
			base.AddClass(["#color", "#align", "#bold", "#fs"], "hide");
			base.Get("bgcolor").classList.toggle("hide");
		}, false);

		//加粗
		base.Get("menuBold").addEventListener('tap', function(event) {
			objEditorBody.focus();
			var node = ShowParentNode();
			mui.each(node, function(i, item) {
				if(item == "B") {
					base.Get("btnBold").classList.add("curr");
				} else {
					base.Get("btnBold").classList.remove("curr");
				}
				if(item == "I") {
					base.Get("btnItalic").classList.add("curr");
				} else {
					base.Get("btnItalic").classList.remove("curr");
				}
				if(item == "U") {
					base.Get("btnUnderline").classList.add("curr");
				} else {
					base.Get("btnUnderline").classList.remove("curr");
				}
			})
			base.AddClass(["#color", "#bgcolor", "#align", "#fs"], "hide");
			base.Get("bold").classList.toggle("hide");

		}, false);

		//颜色切换
		mui('#color').on('tap', 'div', SetStyle);

		//背景色切换
		mui('#bgcolor').on('tap', 'div', SetStyle);

		//大小切换
		mui('#fs').on('tap', 'div', SetStyle);

		//对齐
		base.Get("menuAlign").addEventListener('tap', function(event) {
			base.AddClass(["#color", "#bgcolor", "#bold", "#fs"], "hide");
			base.Get("align").classList.toggle("hide");
		}, false);

		//加粗
		base.Get("btnBold").addEventListener('tap', SetStyle, false);

		//斜体
		base.Get("btnItalic").addEventListener('tap', SetStyle, false);

		//下划线
		base.Get("btnUnderline").addEventListener('tap', SetStyle, false);

		//居左
		base.Get("btnLeft").addEventListener('tap', function() {
			edDoc.execCommand("justifyLeft");
			InitAlign(this, "tl");
		}, false);

		//居中
		base.Get("btnCenter").addEventListener('tap', function() {
			edDoc.execCommand("justifyCenter");
			InitAlign(this, "tc");
		}, false);

		//居右
		base.Get("btnRight").addEventListener('tap', function() {
			edDoc.execCommand("justifyRight");
			InitAlign(this, "tr");
		}, false);

		//超链接
		base.Get("menuLink").addEventListener('tap', SetStyle, false);
	})

	//初始化对齐
	function InitAlign(item, name) {
		base.RemoveClass(["#btnLeft", "#btnCenter", "#btnRight"], "curr");
		item.classList.add("curr");
		objEditorBody.classList.remove("tl");
		objEditorBody.classList.remove("tc");
		objEditorBody.classList.remove("tr");

		objEditorBody.classList.add(name);
		InsertPush();
	}
	var time = 0;
	var addarticlePage = null;
	mui.plusReady(function() {

		var self = plus.webview.currentWebview();
		ArticleID = self.ArticleID || 0;
		ArticleNumber = self.ArticleNumber;
		PartID = self.PartID || 0;

		var html = self.title;
		if(base.IsNullOrEmpty(html)) {
			initEditor('');
		} else {
			var div = document.createElement("div");
			div.innerHTML = html;
			div.childNodes[0].setAttribute("contenteditable", true);
			initEditor(div.innerHTML)
		}

		InsertPush();

		objEditorBody.focus();

		if(objEditorBody.classList.contains("tl")) {
			base.Get("menuAlign").classList.add("menuLeft");
		} else if(objEditorBody.classList.contains("tc")) {
			base.Get("menuAlign").classList.add("menuCenter");
		} else if(objEditorBody.classList.contains("tr")) {
			base.Get("menuAlign").classList.add("menuRight");
		} else {
			base.Get("menuAlign").classList.add("menuLeft");
		}

		base.Get("menuAlign").classList.remove("hide");

		//字数限制
		edDoc.getElementsByClassName("edit")[0].ontouchend = function() {
			return
			base.AddClass(["#color", "#bgcolor", "#bold", "#fs", "#align"], "hide");
			base.RemoveClass([".curr"], "curr");

			/*SelectAll = false;
			base.Get("all").classList.remove("select");
			edDoc.execCommand("Unselect");*/

		}

		edDoc.onkeyup = function() {
			InsertPush();
		}

		//提交
		base.Get("submit").addEventListener('tap', function(event) {
			if(isLoading) {
				return;
			}
			isLoading = true;

			var val = objEditorBody.innerHTML;
			if(base.IsNullOrEmpty(val)) {
				isLoading = false;
				return mui.toast("请编辑文字");
			}
			mask.show();
			base.ShowWaiting("正在保存设置");

			//过滤敏感词 
			HttpPost(base.RootUrl + "System/CheckDirty", {
				Title: escape(val)
			}, function(data) {
				if(data != null) {
					if(data.result) {
						if(!addarticlePage) {
							addarticlePage = base.GetView('addarticle');
						}
						objEditorBody.removeAttribute("contenteditable");
						addarticlePage.evalJS("AddText('" + (PartID == 0 ? base.GetUid() : PartID) + "','" + escape(objEditorBody.outerHTML) + "','" + PartID + "')");
						plus.webview.close("editdesc");
					} else {
						mui.toast(data.message);
					}
				}
				isLoading = false;
				mask.close();
			});
		}, false);
	});

	//打开编辑
	function ShowLink() {
		base.OpenWindow("edithref", "edithref.html", {
			Link: "",
			Text: ""
		});
	}

	//编辑超链接
	function UpdateLink(link) {
		if(!base.IsNullOrEmpty(link)) {
			ChangeLink(link);
		}
	}

	//撤销链接
	function Undo() {
		edDoc.execCommand('undo');
	}

	//改变样式 
	function SetStyle(e) {
		document.activeElement.blur();

		var that = e.target;
		var type = this.getAttribute("data-type") || "";
		var valueTxt = this.getAttribute("data") || "";
		if(that.id === "menuLink") {
			valueTxt = "placeholder";
			ShowLink();
		};
		edDoc.execCommand(type, false, valueTxt);
		if(this.classList.contains("fs")) {
			base.RemoveClass([".fs"], "curr");
			ChangeFontSize();
		} else {
			if(that.id !== "menuLink") {
				this.classList.toggle("curr")
			}
		}
		if(type == "BackColor") {
			this.classList.toggle("inline")
		}
		if(that.id !== "menuLink") {
			InsertPush();
		}
	};

	//超链接替换
	function ChangeLink(link) {
		mui.each(objEditorBody.getElementsByTagName("a"), function(i, node) {
			if(node.getAttribute("href") === "placeholder") {
				node.setAttribute("href", "#");
				node.setAttribute("link", link);
				node.classList.add("link");
			};
		});
	};

	//字体大小替换
	function ChangeFontSize() {
		var size = "";
		if(SelectAll) {
			mui.each(objEditorBody.getElementsByClassName("f12"), function(i, node) {
				node.classList.remove("f12");
			});
			mui.each(edDoc.getElementsByClassName("f14"), function(i, node) {
				node.classList.remove("f14");
			});
			mui.each(edDoc.getElementsByClassName("f20"), function(i, node) {
				node.classList.remove("f20");
			});
			mui.each(edDoc.getElementsByClassName("f24"), function(i, node) {
				node.classList.remove("f24");
			});
			mui.each(edDoc.getElementsByClassName("f36"), function(i, node) {
				node.classList.remove("f36");
			});
		}
		mui.each(objEditorBody.getElementsByTagName("font"), function(i, node) {
			if(node.hasAttribute("size")) {
				size = node.getAttribute("size");
				node.classList.remove("f12");
				node.classList.remove("f14");
				node.classList.remove("f20");
				node.classList.remove("f24");
				node.classList.remove("f36");
				switch(size) {
					case "3":
						node.classList.add("f12");
						break;
					case "4":
						node.classList.add("f14");
						break;
					case "5":
						node.classList.add("f20");
						break;
					case "6":
						node.classList.add("f24");
						break;
					case "7":
						node.classList.add("f36");
						break;
					default:
						break;
				}
				node.removeAttribute("size");
			}
		})
	}

	//添加缓存
	function InsertPush() {
		ActionCache.push(objEditorBody.outerHTML);
		CurrActionCache = ActionCache.length - 1;
	}
</script>