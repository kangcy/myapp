<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title></title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<link rel="stylesheet" href="../mincss/mui.min.css">
		<link rel="stylesheet" href="../mincss/fan.min.css">
		<link rel="stylesheet" href="../swipe/swiper.min.css">
		<style type="text/css">
			.my-pagination {
				transition: transform .3s;
				position: relative;
			}
			
			.my-pagination ul {
				display: -webkit-box;
				margin: 0px;
				padding: 0px;
			}
			
			.my-pagination li {
				display: block;
				background: #fff;
				overflow: hidden;
				box-flex: 1;
				-moz-box-flex: 1;
				-webkit-box-flex: 1;
				height: 2.5rem;
				line-height: 2.5rem;
				position: relative;
				font-size: 15px;
				transition: transform .25s;
			}
			
			.my-pagination .tabs_border {
				position: absolute;
				bottom: 0;
				width: 100%;
				left: 0;
				height: 2px;
				background-color: #f5f5f5;
				z-index: 0;
				transition: transform .25s cubic-bezier(.645, .045, .355, 1);
				list-style: none;
			}
			
			.my-pagination .swiper-pagination-bullet {
				text-align: center;
				border-radius: 0;
				opacity: 1;
			}
			
			.my-pagination .swiper-pagination-bullet-active {
				color: #20a0ff;
			}
			
			.swiper-container {
				background: #f5f5f5;
			}
			
			.scroll-wrapper {
				position: absolute;
				z-index: 0;
				top: 0px;
				bottom: 0px;
				left: 0;
				width: 100%;
				background: #f5f5f5;
				overflow: hidden;
			}
			
			.scroll-wrapper .scroller {
				background: #fff;
				position: absolute;
				z-index: 1;
				-webkit-tap-highlight-color: rgba(0, 0, 0, 0);
				width: 100%;
				-webkit-transform: translateZ(0);
				-moz-transform: translateZ(0);
				-ms-transform: translateZ(0);
				-o-transform: translateZ(0);
				transform: translateZ(0);
				-webkit-touch-callout: none;
				-webkit-user-select: none;
				-moz-user-select: none;
				-ms-user-select: none;
				user-select: none;
				-webkit-text-size-adjust: none;
				-moz-text-size-adjust: none;
				-ms-text-size-adjust: none;
				-o-text-size-adjust: none;
				text-size-adjust: none;
			}
			
			.icon {
				width: 1rem !important;
			}
			
			.green {
				color: #24b224;
			}
			
			.red {
				color: #e33e3e;
			}
			
			.mui-table-view-cell:after {
				height: 0px !important;
			}
			
			#scroll-more0,
			#scroll-more1,
			#scroll-more2,
			#scroll-none0 {
				background: #f5f5f5;
				padding: 1rem 0px 0.7rem;
			}
		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav" id="header">
			<a id="btnSearch" class="mui-icon mui-icon-search fr cfff" style="width:15%;" id="btnSearch"></a>
			<div class="mui-input-row mui-search" style="width:87%;	display: inline-block;">
				<input id="search" type="search" class="mui-input-speech mui-input-clear c999" placeholder="搜索昵称、标题、支持语音搜索" maxlength="10" style="height:34px;font-size:15px;">
			</div>
		</header>
		<div class="mui-content" id="muicontent">
			<div class="my-pagination" id="pagination">
				<ul class="my-pagination-ul swiper-pagination-clickable"> </ul>
				<div class="tabs_active" id="pagination_border"></div>
				<div class="tabs_border"></div>
			</div>
			<div class="swiper-container swiper-container-horizontal" id="swiper-container">
				<div class="swiper-wrapper">
					<div class="swiper-slide">
						<div id="wrapper0" class="scroll-wrapper">
							<div id="scroll0" class="scroller">
								<div id="scroll-view0">
									<div id="scroll-view0"></div>
								</div>
								<div id="scroll-more0" class="full tc">
									<div class="inline"><img src="../images/loading.gif" class="fl" style="width:0.9rem" /><span class="c999 f12 fl ml5">正在加载...</span></div>
								</div>
								<div id="scroll-none0" class="full tc hide">
									<div class="inline"><span class="c999 f12 fl ml5">暂无更多数据</span></div>
								</div>
							</div>
						</div>
						<div id="none0" class="full tc hide">
							<img src="../images/my/555.png" class="none" />
							<p class="f13 mt10">大波内容正在赶来，敬请期待~</p>
						</div>
					</div>
					<div class="swiper-slide">
						<div id="wrapper1" class="scroll-wrapper">
							<div id="scroll1" class="scroller">
								<div id="scroll-view1"></div>
								<div id="scroll-more1" class="full tc">
									<div class="inline"><img src="../images/loading.gif" class="fl" style="width:0.9rem" /><span class="c999 f12 fl ml5">正在加载...</span></div>
								</div>
								<div id="scroll-none1" class="full tc hide">
									<div class="inline"><span class="c999 f12 fl ml5">暂无更多数据</span></div>
								</div>
							</div>
						</div>
						<div id="none1" class="full tc hide">
							<img src="../images/my/555.png" class="none" />
							<p class="f13 mt10">大波内容正在赶来，敬请期待~</p>
						</div>
					</div>
				</div>
			</div>
		</div>
	</body>

</html>
<script src="../minjs/mui.min.js"></script>
<script src="../minjs/base.min.js"></script>
<script src="../swipe/swiper.min.js"></script>
<script src="../swipe/iscroll.js"></script>
<script type="text/javascript">
	var userinfo = base.GetUserInfo();
	var $border = base.Get("pagination_border");
	var scroll0, scroll1 = null;
	var currpage = [1, 1];
	var totalpage = [2, 2];
	var records = [0, 0];
	var isLoading = [false, false];
	var pagesize = 10;
	var search = base.Get("search");
	mui.init();

	mui.ready(function() {
		base.Immersed();

		var mySwiper = new Swiper('#swiper-container', {
			pagination: '.my-pagination-ul',
			paginationClickable: true,
			paginationBulletRender: function(swiper, index, className) {
				switch(index) {
					case 0:
						name = '用户';
						break;
					case 1:
						name = '文章';
						break;
					default:
						name = '';
				}
				return '<li class="' + className + '"><span class="f14">' + name + '</span></li>';
			},
			onTransitionStart: function(swiper) {
				var $this = mui("#pagination li")[swiper.activeIndex]
				$border.style.width = $this.clientWidth * 0.4 + "px";
				$border.style.transform = "translateX(" + ($this.offsetLeft + $this.clientWidth * (1 - 0.4) / 2) + "px)";

				if(swiper.activeIndex == 1 && scroll1 == null) {
					scroll1 = new iScroll("wrapper1", {
						hScroll: false,
						onScrollEnd: function() {
							if(this.y >= this.maxScrollY) {
								LoadScroll1();
							}
						}
					});
					LoadScroll1();
				}

				if(swiper.activeIndex == 2 && scroll2 == null) {
					scroll2 = new iScroll("wrapper2", {
						hScroll: false,
						onScrollEnd: function() {
							if(this.y >= this.maxScrollY) {
								LoadScroll2();
							}
						}
					});
					LoadScroll2()
				}
			},
			onInit: function(swiper) {
				var swiperheight = (window.innerHeight - base.Get("header").clientHeight - base.Get("pagination").clientHeight) + "px";
				base.Get("swiper-container").style.height = swiperheight;

				var $this = mui("#pagination li")[0];
				$border.style.width = $this.clientWidth * 0.4 + "px";
				$border.style.transform = "translateX(" + ($this.offsetLeft + $this.clientWidth * (1 - 0.4) / 2) + "px)";

				scroll0 = new iScroll("wrapper0", {
					hScroll: false,
					onScrollEnd: function() {
						if(this.y >= this.maxScrollY) {
							LoadScroll0();
						}
					}
				});
				LoadScroll0();
			}
		})

		base.Get("btnSearch").addEventListener('tap', function(e) {
			Search();
		});

		//监听软键盘搜索键
		base.Get("search").addEventListener("keydown", function(e) {
			if(13 == e.keyCode) {
				document.activeElement.blur(); //隐藏软键盘 
				Search();
			}
		}, false);
	});

	mui.plusReady(function() {
		base.ShowUser("#swiper-container");
		base.ShowArticle("#swiper-container", "List", userinfo.Number);
		ArticleAction("#swiper-container", userinfo);
	});

	//执行搜索
	function Search() {
		var searchval = search.value;
		if(base.IsNullOrEmpty(searchval)) {
			currpage = [1, 1];
			totalpage = [2, 2];
			records = [0, 0];
		}
		LoadScroll0(searchval)
		LoadScroll1(searchval)
	}

	//用户
	function LoadScroll0(searchval) {
		if(isLoading[0]) {
			return;
		}
		isLoading[0] = true;
		if(currpage[0] > totalpage[0]) {
			isLoading[0] = false;
			return false;
		}
		var data = {
			page: currpage[0],
			rows: pagesize,
			UserNumber: userinfo.Number,
			NickName: searchval
		}
		LoadPullList(base.RootUrl + "Api/User/Search", data, true, 0, function(item) {
			return base.AppendUser(item, true, true, false, "", false, true);
		}, function() {
			scroll0.refresh();
			if(currpage[0] >= totalpage[0]) {
				base.Get("scroll-more0").classList.add("hide");
				if(base.Get("scroll0").clientHeight > base.Get("wrapper0").clientHeight) {
					base.Get("scroll-none0").classList.remove("hide");
				}
			}
			if(base.Get("scroll0").clientHeight < base.Get("wrapper0").clientHeight) {
				scroll0.destroy();
			}
			currpage[0]++;
			isLoading[0] = false;
		});
	}

	//文章
	function LoadScroll1(searchval) {
		if(isLoading[1]) {
			return;
		}
		isLoading[1] = true;
		if(currpage[1] > totalpage[1]) {
			isLoading[1] = false;
			return false;
		}
		var data = {
			page: currpage[1],
			rows: pagesize,
			UserNumber: userinfo.Number,
			ID: userinfo.ID,
			Title: searchval
		}
		LoadPullList(base.RootUrl + "Api/Article/Search", data, true, 1, function(item) {
			return AppendArticle(userinfo.Number, item, false, false, true)
		}, function() {
			scroll1.refresh();
			if(currpage[1] >= totalpage[1]) {
				base.Get("scroll-more1").classList.add("hide");
				if(base.Get("scroll1").clientHeight > base.Get("wrapper1").clientHeight) {
					base.Get("scroll-none1").classList.remove("hide");
				}
			}
			if(base.Get("scroll1").clientHeight < base.Get("wrapper1").clientHeight) {
				scroll1.destroy();
			}
			currpage[1]++;
			isLoading[1] = false;
		});
	}

	/**
	 * 加载封装 
	 * url：接口请求地址
	 * data：接口请求参数
	 * showNone：是否显示空提示
	 * showNone：是否显示加载动画
	 * appendCallback：拼接方法
	 * endCallback：回调方法
	 */
	function LoadPullList(url, data, showNone, index, appendCallback, endCallback) {
		base.Get("wrapper" + index).classList.remove("hide");
		HttpGet(url, data, function(data) {
			data = JSON.parse(data);
			if(data != null) {
				if(data.result) {
					data = data.message;
					totalpage[index] = data.totalpage;
					records[index] = data.records;
					if(showNone) {
						base.Get("none" + index).classList.add("hide");
					}
					var table = base.Get('scroll-view' + index);
					if(records[index] > 0) {
						var fragment = document.createDocumentFragment();
						mui.each(data.list, function(index, item) {
							fragment.appendChild(appendCallback(item));
						});
						table.appendChild(fragment);
					}
				} else {
					totalpage[index] = 1;
					records[index] = 0;
				}
			}
			if(records[index] == 0 && showNone) {
				base.Get("wrapper" + index).classList.add("hide");
				base.Get("none" + index).classList.remove("hide");
			}
			if(endCallback) {
				endCallback();
			}
		});
	}
</script>