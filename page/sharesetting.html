<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title></title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<link rel="stylesheet" href="../mincss/mui.min.css">
		<style type="text/css">
			.mui-icon-checkmarkempty {
				top: 18%;
				position: absolute;
				display: none;
			}
			
			.mui-table-view:after {
				height: 0px;
			}
			
			.mui-table-view-cell:last-child:after,
			.mui-table-view-cell:last-child:before {
				height: 1px;
			}
			
			.mui-popup-title+.mui-popup-text {
				display: none;
			}
			
			.check .mui-icon-checkmarkempty {
				display: block !important;
			}
		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav" id="header">
			<a class="mui-icon mui-icon-back mui-action-back fl cfff"></a>
			<a id="submit" class="mui-icon mui-text cfff fr" onclick="SaveArticlePower()">完成</a>
			<h1 class="mui-title cfff">分享设置</h1>
		</header>
		<div class="mui-content" id="muicontent">
			<ul class="mui-table-view f13 mt0" id="list">
				<li class="mui-table-view-cell" style="background:#f5f5f5;">
					<span class="fl f11 c999">谁可以看</span>
				</li>
				<li class="mui-table-view-cell list index3" index="3">
					<div class="flex-box flex-row">
						<div style="flex:0 0 40%;" class="flex-item">
							<span class="c000">公开</span>
						</div>
						<div style="flex:0 0 55%;" class="flex-item">
							<span class="f11 c999 fr">所有人都可以看到</span>
						</div>
						<div style="flex:0 0 5%;" class="flex-item tr">
							<span class="c999 mui-icon mui-icon-checkmarkempty f25"></span>
						</div>
					</div>
				</li>
				<li class="mui-table-view-cell list index2" index="2">
					<div class="flex-box flex-row">
						<div style="flex:0 0 40%;" class="flex-item">
							<span class="c000">不公开</span>
						</div>
						<div style="flex:0 0 55%;" class="flex-item">
							<span class="f11 c999 fr">仅通过自己分享后才可见</span>
						</div>
						<div style="flex:0 0 5%;" class="flex-item tr">
							<span class="c999 mui-icon mui-icon-checkmarkempty f25"></span>
						</div>
					</div>
				</li>
				<li class="mui-table-view-cell list index1" index="1">
					<div class="flex-box flex-row">
						<div style="flex:0 0 40%;" class="flex-item">
							<span class="c000">密码可见</span>
						</div>
						<div style="flex:0 0 55%;" class="flex-item">
							<span class="f11 c999 fr">设置密码,输入密码才可见</span>
						</div>
						<div style="flex:0 0 5%;" class="flex-item tr">
							<span class="c999 mui-icon mui-icon-checkmarkempty f25"></span>
						</div>
					</div>
				</li>
				<li class="mui-table-view-cell list index0" index="0">
					<div class="flex-box flex-row">
						<div style="flex:0 0 40%;" class="flex-item">
							<span class="c000">私密</span>
						</div>
						<div style="flex:0 0 55%;" class="flex-item">
							<span class="f11 c999 fr">仅自己可见</span>
						</div>
						<div style="flex:0 0 5%;" class="flex-item tr">
							<span class="c999 mui-icon mui-icon-checkmarkempty f25"></span>
						</div>
					</div>
				</li>
			</ul>
			<ul class="mui-table-view f13 mt0">
				<li class="mui-table-view-cell" id="articletype">
					<div class="flex-box flex-row">
						<div style="flex:0 0 70%;" class="flex-item">
							<p class="c000 full">分类</p>
							<span class="f10 c999 mt3">准确设置文章类别，方便以后归纳整理</span>
						</div>
						<div style="flex:0 0 26%;" class="flex-item tr">
							<span class="fr c999 f12 mr5" id="article_type"></span>
						</div>
						<div style="flex:0 0 4%;" class="flex-item tr">
							<span class="mui-icon mui-icon-arrowright c999 f16"></span>
						</div>
					</div>
				</li>
			</ul>
			<div class="splitline"></div>
			<ul class="mui-table-view f13 mt0">
				<li class="mui-table-view-cell">
					<div class="flex-box flex-row">
						<div style="flex:0 0 80%;" class="flex-item">
							<p class="c000 full">投稿</p>
							<span class="f10 c999 mt3">每篇文章每天只有一次投稿机会，被选中的文章会有“精”字标识，投稿审核期内暂时不可编辑文章</span>
						</div>
						<div style="flex:0 0 20%;" class="flex-item tr">
							<div class="my-switch" id="switch">
								<div></div>
							</div>
						</div>
					</div>
				</li>
			</ul>
		</div>
		<div class="mytanbg hide" id="mytanbg"></div>
		<div class="boxshadow hide" id="notice" style="position:fixed;bottom:40%;left:5%;width:90%;z-index:99999;background:#fff;">
			<div style="padding:30px;padding-bottom:15px;">
				<p class="blue f15 bold">投稿失败</p>
				<p class="c333 f12 mt5" id="error"></p>
			</div>
			<div class="full tc fl f13" style="height:2.5rem;line-height:2.5rem;position:relative;border-top:1px solid #eee;" onclick="ActionTan(0)">
				我知道了
			</div>
		</div>
	</body>

</html>
<script src="../minjs/mui.min.js"></script>
<script src="../minjs/base.min.js"></script>
<script type="text/javascript">
	var ArticleID = 0;
	var ArticleNumber = "";
	var ArticlePower = 0;
	var ArticlePowerPwd = "";
	var ArticleType = 0;
	var ArticleTypeName = "";
	var Source = "";
	var isLoading = false;
	var userinfo = base.GetUserInfo();
	var mask = base.CreateMask(false, function() {
		base.CloseWaiting();
	});

	mui.init();

	mui.ready(function() {
		base.Immersed();

		//选中切换
		mui("#list").on('tap', '.list', function(event) {
			var $this = this;
			var index = this.getAttribute("index");

			if(index > 0) {
				//密码验证
				if(index == 1) {
					if(ArticleType == 0) {
						mui.confirm('请先设置文章类别', '', ['去设置', '取消'], function(e) {
							if(e.index < 0) {
								return;
							}
							if(e.index == 0) {
								base.OpenWindow("articletype", "articletype.html", {
									ArticleID: ArticleID,
									ArticleType: ArticleType,
									ArticleTypeName: ArticleTypeName
								});
							}
						});
						return;
					} else {
						mui.prompt('设置密码', '输入4位数字密码', '分享设置', ['确定', '取消'], function(e) {
							if(e.index == 0) {
								if(ChechPwd(e.value)) {
									ArticlePowerPwd = e.value;
									base.RemoveClass([".check"], "check");
									$this.classList.add("check");
									ArticlePower = index;
									SaveArticlePower();
								}
							}
						});
						return;
					}
				}
				if(ArticleType == 0) {
					mui.confirm('请先设置文章类别', '', ['去设置', '取消'], function(e) {
						if(e.index < 0) {
							return;
						}
						if(e.index == 0) {
							base.OpenWindow("articletype", "articletype.html", {
								ArticleID: ArticleID,
								ArticleType: ArticleType,
								ArticleTypeName: ArticleTypeName
							});
						}
					});
					return;
				}
			}
			base.RemoveClass([".check"], "check");
			$this.classList.add("check");
			ArticlePower = index;
		});

		//分类
		base.Get('articletype').addEventListener('tap', function(event) {
			base.OpenWindow("articletype", "articletype.html", {
				ArticleID: ArticleID,
				ArticleType: ArticleType,
				ArticleTypeName: ArticleTypeName
			});
		});
	});

	mui.plusReady(function() {
		var self = plus.webview.currentWebview();
		ArticleID = self.ArticleID;
		ArticleNumber = self.ArticleNumber;
		ArticlePower = self.ArticlePower || 0;
		ArticlePowerPwd = self.ArticlePowerPwd || "";
		ArticleType = self.ArticleType || 0;
		ArticleTypeName = self.ArticleTypeName || "";
		Source = self.Source || "";

		if(ArticleType == 0) {
			ArticleTypeName = "请选择"
		}
		base.Get("article_type").innerHTML = ArticleTypeName;

		//初始化
		mui("#list .index" + ArticlePower + "")[0].classList.add("check");

		//返回
		mui.back = function() {
			var articleDetailPage = base.GetView('articledetail');
			if(articleDetailPage == null) {
				console.log('aa')
				base.OpenWindow("articledetail", "articledetail.html", {
					ArticleID: ArticleID,
					Source: Source
				}, false, "none");
			} else {
				articleDetailPage.evalJS("UpdateDetail()");
				articleDetailPage.evalJS("UpdatePower(" + ArticlePower + ",'" + ArticlePowerPwd + "'," + ArticleType + ",'" + ArticleTypeName + "')");
				plus.webview.close(self);
			}
		}

		//投稿
		base.Get("switch").addEventListener('tap', function(event) {
			if(isLoading) {
				return;
			}
			isLoading = true;
			var draw = base.HasClass(this, "active");
			base.SwitchChange("switch", !draw);
			if(!draw) {
				mask.show();
				base.ShowWaiting("正在投稿");
				HttpGet(base.RootUrl + "Article/Recommend", {
						ID: userinfo.ID,
						UserNumber: userinfo.Number,
						ArticleID: ArticleID,
						ArticleNumber: ArticleNumber,
						ArticlePower: ArticlePower
					},
					function(data) {
						mui.later(function() {
							mask.close();
							if(data.result) {

								//刷新文章，关闭当前页面
								var page = base.GetView("articledetail");
								if(page) {
									page.evalJS("UpdateAction()");
								} else {
									base.OpenWindow("articledetail", "articledetail.html", {
										ArticleID: ArticleID,
										Source: Source
									}, false, "none");
								}
								mui.toast("投稿成功");
							} else {
								base.SwitchChange("switch", draw);
								ActionTan(1, data.message);
							}
							isLoading = false;
						}, 250);
					});
			} else {
				isLoading = false;
			}
		});

		/*mui.later(function() {
			plus.webview.close("articlepreview", "none");
			plus.webview.close("addarticle", "none");
		}, 500)*/
	});

	//校验权限密码
	function ChechPwd(str) {
		if(base.IsNullOrEmpty(str)) {
			return false;
		}
		str = str.trim();
		if(str.length != 4 || isNaN(str)) {
			mui.toast("输入4位数字密码");
			return false;
		}
		return true;
	}

	//保存权限
	function SaveArticlePower() {
		HttpGet(base.RootUrl + "Article/EditArticlePower", {
				ID: userinfo.ID,
				ArticleID: ArticleID,
				ArticlePower: ArticlePower,
				ArticlePowerPwd: ArticlePowerPwd
			},
			function(data) {
				if(data.result) {
					mui.toast("设置成功");
					mui.back();
				} else {
					mui.toast(data.message);
				}
			});
	}

	function UpdateArticleType(id, name) {
		ArticleType = id;
		ArticleTypeName = name;
		base.Get("article_type").innerHTML = name;
	}

	//操作弹窗
	function ActionTan(index, text) {
		if(index == 0) {
			base.Get("mytanbg").classList.add("hide");
			base.RemoveClass(["#notice"], "bounceIn");
			base.AddClass(["#notice"], "bounceOut hide");
		} else {
			base.Get("error").innerHTML = text;
			base.Get("mytanbg").classList.remove("hide");
			base.RemoveClass(["#notice"], "hide bounceOut");
			base.AddClass(["#notice"], "bounceIn");
		}
	}
</script>