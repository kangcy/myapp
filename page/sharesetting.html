<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title></title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<link rel="stylesheet" href="../css/mui.min.css">
		<style type="text/css">
			.check {
				background: url(../images/check.png) 97% center no-repeat;
				background-size: 1.25rem;
			}
			
			.mui-table-view-cell {
				padding: .8rem 0.9375rem;
			}
			
			.mui-table-view:after {
				height: 0px;
			}
			
			.mui-table-view-cell:last-child:after,
			.mui-table-view-cell:last-child:before {
				height: 1px;
			}
			
			.mui-popup-title+.mui-popup-text {
				display: none;
			}
		</style>
	</head>

	<body style="height: 100%;">
		<header class="mui-bar mui-bar-nav" style="box-shadow:0px 0px 0.5px #999;background:#fff;">
			<a id="back" class="mui-icon mui-icon-back fl"></a>
			<h1 class="mui-title c333 f15">分享设置</h1>
		</header>
		<div class="mui-content">
			<ul class="mui-table-view f13 mt0" id="list">
				<li class="mui-table-view-cell" style="background:#E8E8E8;">
					<span class="fl">权限设置</span>
				</li>
				<li class="mui-table-view-cell list" index="3">
					<span class="fl">公开</span>
					<span class="fr caaa mr20 f12">所有人都可以看到</span>
				</li>
				<li class="mui-table-view-cell list" index="2">
					<span class="fl">不公开</span>
					<span class="fr caaa mr20 f12">仅通过自己分享后才可见</span>
				</li>
				<li class="mui-table-view-cell list" index="1">
					<span class="fl">密码可见</span>
					<span class="fr caaa mr20 f12">设置密码,输入密码才可见</span>
				</li>
				<li class="mui-table-view-cell list" index="0">
					<span class="fl">私密</span>
					<span class="fr caaa mr20 f12">仅自己可见</span>
				</li>
			</ul>
			<ul class="mui-table-view f13">
				<li class="mui-table-view-cell" style="background:#E8E8E8;height:0.5rem;padding:0px;">
				</li>
				<li class="mui-table-view-cell" id="articletype">
					<a class="mui-navigate-right">
						<span class="f13 c333 fl">分类</span>
						<!--<span class="f11 mt5 caaa">准确设置文章类别，方便以后归纳整理</span>-->
						<span class="fr caaa mr20 f12" id="article_type"></span>
					</a>
				</li>
				<li class="mui-table-view-cell">
					<p class="f13 c333">投稿</p>
					<p class="caaa mt5 f12" style="margin-right:20%;">每周只有一次投稿机会，被选中的文章会有“精”字标识</p>
					<div class="mui-switch mui-switch-blue" id="switch">
						<div class="mui-switch-handle"></div>
					</div>
				</li>
			</ul>
		</div>
		<div class="mytanbg hide" id="mytanbg"></div>
		<div class="boxshadow hide" id="notice" style="position:fixed;bottom:30%;left:5%;width:90%;z-index:99999;background:#fff;">
			<div style="padding:30px;padding-bottom:15px;">
				<p class="blue f15 bold">投稿失败</p>
				<p class="c333 f12 mt5" id="error"></p>
			</div>
			<div class="full tc fl f13" style="height:2.5rem;line-height:2.5rem;position:relative;border-top:1px solid #eee;" onclick="ActionTan(0)">
				我知道了
			</div>
		</div>
	</body>

</html>
<script src="../js/default.js"></script>
<script src="../js/jquery-1.10.2.min.js"></script>
<script src="../js/mui.min.js"></script>
<script src="../js/base.js"></script>
<script type="text/javascript">
	var ArticleID = 0; //文章ID
	var ArticlePower = 0; //分享权限
	var ArticlePowerPwd = ""; //权限密码
	var ArticleType = 0; //文章类型ID
	var ArticleTypeName = ""; //文章类型名称
	var isLoading = false;
	var userinfo = base.GetUserInfo();
	mui.init({
		gestureConfig: {
			doubletap: true
		},
		swipeBack: false //启用右滑关闭功能
	});

	$(function() {
		//选中切换
		$("#list").on('tap', '.list', function(event) {
			var $this = $(this);
			var index = $this.attr("index");
			//密码验证
			if(index == 1) {
				var btnArray = ['确定', '取消'];
				mui.prompt('设置密码', '输入4位数字密码', '分享设置', btnArray, function(e) {
					if(e.index == 0) {
						if(ChechPwd(e.value)) {
							ArticlePowerPwd = e.value;
							$(".check").removeClass("check");
							$this.addClass("check");
							ArticlePower = index;
							SaveArticlePower();
						}
					}
				})
			} else {
				$(".check").removeClass("check");
				$this.addClass("check");
				ArticlePower = index;
				SaveArticlePower();
			}
		});

		//分类
		document.getElementById('articletype').addEventListener('tap', function(event) {
			base.OpenWindow("articleType", "articleType.html", {
				ArticleID: ArticleID,
				ArticleType: ArticleType,
				ArticleTypeName: ArticleTypeName
			});
		});

		//修改文章类型
		window.addEventListener("UpdateArticleType", function(e) {
			ArticleType = e.detail.ArticleType;
			ArticleTypeName = e.detail.ArticleTypeName;
			document.getElementById("article_type").innerHTML = ArticleTypeName;
		});

		//投稿
		document.getElementById("switch").addEventListener('toggle', function(event) {
			if(isLoading) {
				return;
			}
			isLoading = true;
			if(event.detail.isActive) {
				base.ShowWaiting("正在投稿~")
				HttpGet(base.RootUrl + "Article/Recommend", {
						ID: userinfo.ID,
						ArticleID: ArticleID
					},
					function(data) {
						plus.nativeUI.closeWaiting();
						if(data.result) {
							mui.toast("投稿成功~");
						} else {
							ActionTan(1, data.message);
						}
						isLoading = false;
					});
			} else {
				isLoading = false;
			}
		});
	})

	mui.plusReady(function() {
		var self = plus.webview.currentWebview();
		ArticleID = self.ArticleID;
		ArticlePower = self.ArticlePower;
		ArticlePowerPwd = self.ArticlePowerPwd;
		ArticleType = self.ArticleType;
		ArticleTypeName = self.ArticleTypeName;

		if(ArticleType == -1) {
			ArticleTypeName = "其它"
		} else if(ArticleType == 0) {
			ArticleTypeName = "请选择"
		}
		document.getElementById("article_type").innerHTML = ArticleTypeName;

		//初始化
		$("#list").find("[index=" + ArticlePower + "]").addClass("check");

		//返回
		mui.back = function() {
			var page = plus.webview.getWebviewById("articledetail");
			if(page) {
				mui.fire(page, "UpdatePower", {
					ArticlePower: ArticlePower,
					ArticlePowerPwd: ArticlePowerPwd,
					ArticleType: ArticleType,
					ArticleTypeName: ArticleTypeName
				});
			}

			plus.webview.close(self);
		}

		//返回
		document.getElementById('back').addEventListener('tap', function(e) {
			mui.back();
		});
	});

	//校验权限密码
	function ChechPwd(str) {
		if(base.IsNullOrEmpty(str)) {
			return false;
		}
		str = str.trim();
		if(str.length != 4 || isNaN(str)) {
			mui.toast("输入4位数字密码");
			return false;
		}
		return true;
	}

	//保存权限
	function SaveArticlePower() {
		plus.nativeUI.showWaiting("正在修改权限~~");
		setTimeout(function() {
			HttpGet(base.RootUrl + "Article/EditArticlePower", {
					ID: userinfo.ID,
					ArticleID: ArticleID,
					ArticlePower: ArticlePower,
					ArticlePowerPwd: ArticlePowerPwd
				},
				function(data) {
					plus.nativeUI.closeWaiting();
					mui.toast(data.result ? "编辑成功~" : data.message);
				});
		}, 500);
	}

	//操作弹窗
	function ActionTan(index, text) {
		if(index == 0) {
			$("#mytanbg").addClass("hide");
			$("#notice").removeClass("bounceIn").addClass("bounceOut").addClass("hide");
		} else {
			$("#error").html(text);
			$("#mytanbg").removeClass("hide");
			$("#notice").removeClass("hide").removeClass("bounceOut").addClass("bounceIn");
		}
	}
</script>