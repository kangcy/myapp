<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title></title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<link rel="stylesheet" href="../mincss/mui.min.css">
		<link rel="stylesheet" href="../mincss/loading.min.css">
		<link rel="stylesheet" href="../mincss/animate.min.css">
		<link rel="stylesheet" href="../mincss/user.min.css">
	</head>

	<body id="body">
		<header id="header" class="mui-bar" immersed="none">
			<span class="mui-action-back mui-icon mui-icon-left-nav fl cfff"></span>
			<span class="cfff f25 fr more" onclick="More()">•••</span>
			<h1 class="mui-title cfff">Ta的资料</h1>
		</header>
		<div class="loading hide" id="loader">
			<div class="card">
				<span class="circles-loader"></span>
			</div>
		</div>
		<!--操作-->
		<div id="power" class="mui-popover mui-popover-action mui-popover-bottom">
			<ul class="mui-table-view">
				<li class="mui-table-view-cell" id="mypic">
					<a href="#" class="c333 f13" onclick="Pic()">查看相册</a>
				</li>
				<li class="mui-table-view-cell" id="share">
					<a href="#" class="c333 f13" onclick="Share()">分享给朋友</a>
				</li>
				<li class="mui-table-view-cell" id="copy">
					<a href="#" class="c333 f13" onclick="Copy()">复制链接</a>
				</li>
				<li class="mui-table-view-cell noborder hide" id="inblack">
					<a href="#black" class="red f13">加入黑名单</a>
				</li>
				<li class="mui-table-view-cell noborder hide" id="outblack">
					<a href="#" class="red f13" onclick="OutBlack()">解除黑名单</a>
				</li>
			</ul>
			<ul class="mui-table-view">
				<li class="mui-table-view-cell noborder">
					<a href="#power" class="c333 f13">取消</a>
				</li>
			</ul>
		</div>
		<div id="black" class="mui-popover mui-popover-action mui-popover-bottom">
			<ul class="mui-table-view">
				<li class="mui-table-view-cell noborder c999 f11">
					你将不再关注Ta,并屏蔽Ta的文章，<br /> Ta不能对你的文章做互动操作
				</li>
				<li class="mui-table-view-cell noborder">
					<a href="#" class="red f13" onclick="InBlack()">确认加入</a>
				</li>
			</ul>
			<ul class="mui-table-view">
				<li class="mui-table-view-cell noborder">
					<a href="#black" class="c333 f13">取消</a>
				</li>
			</ul>
		</div>
		<!--分享-->
		<div class="mui-backdrop hide" id="mysharebg" onclick="ShareTan(0)"></div>
		<div class="myshare hide" id="myshare">
			<p class="f16 c333 tc mt10 mb0">分享到</p>
			<div class="tc myshare_body">
				<div class="myshare_items" onclick="ShareAction(1)"><img src="../images/share/01.png" />
					<p class="f11 mb0 c333">朋友圈</p>
				</div>
				<div class="myshare_items" onclick="ShareAction(2)"><img src="../images/share/02.png" />
					<p class="f11 mb0 c333">微信</p>
				</div>
				<div class="myshare_items" onclick="ShareAction(3)"><img src="../images/share/03.png" />
					<p class="f11 mb0 c333">新浪微博</p>
				</div>
				<div class="myshare_items" onclick="ShareAction(4)"><img src="../images/share/04.png" />
					<p class="f11 mb0 c333">QQ</p>
				</div>
				<div class="myshare_items" onclick="ShareAction(5)"><img src="../images/share/05.png" />
					<p class="f11 mb0 c333">QQ空间</p>
				</div>
				<div class="myshare_items" onclick="ShareAction(6)"><img src="../images/share/06.png" />
					<p class="f11 mb0 c333">其他</p>
				</div>
				<div class="c333 mt10 f11 fl btnExit" onclick="ShareTan(0)">取消</div>
			</div>
		</div>

		<div class="bg" id="bg"></div>
		<div class="avatar">
			<img id="avatar" src="../images/avatar.png" />
		</div>
		<div class="f15 tc mt10 c000 bold" id="nickname"></div>
		<div class="signature mt5 tc f12 c999" id="signature"></div>
		<div class="full tc mt10 mb5 hide" id="action">
			<div id="guanzhu" class="guanzhu f14 mr30">关注TA</div>
			<div id="dashang" class="dashang f14" onclick="Payment()">打赏</div>
		</div>
		<div style="padding:0.3125rem 5%;" class="mt10 f13 c000">
			<div class="flex-box flex-row f13 tc">
				<div style="flex:0 0 25%;" class="flex-item hide" id="showZan" onclick="Zan()">
					<p class="f25 mb0 blue bold" id="showZanNum">0</p>
					<p>喜欢</p>
				</div>
				<div style="flex:0 0 25%;" class="flex-item hide" id="showFollow" onclick="Follow()">
					<p class="f25 mb0 blue bold" id="showFollowNum">0</p>
					<p>关注</p>
				</div>
				<div style="flex:0 0 25%;" class="flex-item hide" id="showFan" onclick="Fan()">
					<p class="f25 mb0 blue bold" id="showFanNum">0</p>
					<p>粉丝</p>
				</div>
				<div style="flex:0 0 25%;" class="flex-item hide" id="showKeep" onclick="Keep()">
					<p class="f25 mb0 blue bold" id="showKeepNum">0</p>
					<p>收藏</p>
				</div>
			</div>
		</div>
		<div id="article" class="hide f13 c999 full">
			<div class="head tl"><span class="ml15" id="a_title">0篇文章</span></div>
			<div id="a_list" class="inline full">
			</div>
			<div id="mynone" class="mb20 hide">
				<p class="full tc f13 c333 mt50">记录生活中美好的瞬间</p>
				<div class="tc cfff mt20 submit" id="add">去发布</div>
			</div>
			<div id="none" class="mb20 hide">
				<p class="full tc f13 c333 mt50">暂未发表过动态</p>
			</div>
		</div>
		<div id="blacktip" class="hide f13 red tc mt50">您已经将Ta拉黑</div>
	</body>

</html>
<script src="../minjs/mui.min.js"></script>
<script src="../minjs/base.min.js"></script>
<script src="../minjs/mui.lazyload.min.js"></script>
<script src="../minjs/mui.lazyload.img.min.js"></script>
<script src="../js/addarticle.js"></script>
<script type="text/javascript">
	var PageName = "";
	var currpage = 1;
	var totalpage = 2;
	var isLoading = false;
	var pagesize = base.PageSize;
	var UserNumber = "";
	var NickName = "";
	var Avatar = "";
	var Cover = "";
	var Sex = 0;
	var ShareInfo = {};
	var $bg = base.Get("bg");
	var name = base.BrowserName();
	var userinfo = base.GetUserInfo();
	var mask = base.CreateMask(false, function() {
		base.CloseWaiting();
	});

	var Intent = null,
		File = null,
		Uri = null,
		main = null;

	mui.init({
		gestureConfig: {
			doubletap: true
		}
	});

	mui.ready(function() {
		base.Immersed();
		$bg.style.minHeight = window.innerWidth * 3 / 4 + "px";
		$bg.style.background = "#eee";
		$bg.style.backgroundSize = "cover";

		base.Get("guanzhu").style.background = name + 'linear-gradient(right,#ff6900 0%,#fb2879 100%)';
		base.Get("dashang").style.background = name + 'linear-gradient(right,#24c3fb 20%,#4e8cfb 100%)';

		var num = 0;
		var browserName = base.BrowserName();
		var $header = base.Get("header");
		//滚动监听、背景色渐变
		window.addEventListener('scroll', function(e) {
			num = window.pageYOffset / 200;
			if(num <= 1) {
				$header.style.background = browserName + 'linear-gradient(left,rgba(78,140,251,' + num + ') 0%,rgba(36,195,251,' + num + ') 75%,rgba(57,184,253,' + num + ') 100%)';
			}
		});

		base.ToTop();
	});

	mui.plusReady(function() {
		var self = plus.webview.currentWebview();
		PageName = self.PageName || "";
		UserNumber = self.UserNumber || "";
		NickName = self.NickName || "";
		Avatar = self.Avatar || "";
		Cover = self.Cover || "";

		if(!base.IsNullOrEmpty(NickName)) {
			NickName = base.UnUnicodeText(NickName);
			base.Get("nickname").innerHTML = NickName;
		}
		if(!base.IsNullOrEmpty(Avatar)) {
			base.Get("avatar").setAttribute("src", base.ShowThumb(Avatar, 2));
		}
		if(!base.IsNullOrEmpty(Cover)) {
			$bg.style.background = "url(" + base.ShowThumb(Cover, 1) + ") center center no-repeat";
			$bg.style.backgroundSize = "cover";
		}

		LoadUserInfo(function(data) {

			//检查关注
			if(userinfo.Number != UserNumber) {
				CheckFan(data.IsFan);
			} else {
				base.Get("add").addEventListener('tap', function() {
					if(isLoading) {
						return false;
					}
					isLoading = true;
					var view = base.GetView("action");
					if(view) {
						view.evalJS("ResetAction(1,'subindex')");
					} else {
						base.OpenWindow("action", "action.html", {
							Type: 1,
							PageName: "subindex"
						}, "none", false, false, "transparent");
					}
					isLoading = false;
				});
			}

			//分享设置
			UpdateSerivces();

			if(plus.os.name == "Android") {
				Intent = plus.android.importClass("android.content.Intent");
				File = plus.android.importClass("java.io.File");
				Uri = plus.android.importClass("android.net.Uri");
				main = plus.android.runtimeMainActivity();
			}
		});

		LoadArticle(function() {
			base.ShowArticle("#a_list", "List", userinfo.Number);
		});

		/*mui.back = function() {
			plus.webview.close(PageName, base.HideAnimate(), base.AnimateDuration);
		}*/
	});

	var lazyLoad = mui(document).imageLazyload({
		placeholder: '../images/default.png',
		destroy: false
	});

	//刷新用户页
	function ResetUser(pagename, usernumber, nickname, avatar, cover) {
		PageName = pagename || "";
		UserNumber = usernumber || "";
		NickName = nickname || "";
		Avatar = avatar || "";
		Cover = cover || "";

		if(!base.IsNullOrEmpty(NickName)) {
			NickName = base.UnUnicodeText(NickName);
			base.Get("nickname").innerHTML = NickName;
		}
		if(!base.IsNullOrEmpty(Avatar)) {
			base.Get("avatar").setAttribute("src", base.ShowThumb(Avatar, 2));
		}
		if(!base.IsNullOrEmpty(Cover)) {
			$bg.style.background = "url(" + base.ShowThumb(Cover, 1) + ") center center no-repeat";
			$bg.style.backgroundSize = "cover";
		}

		LoadUserInfo();

		plus.webview.show(PageName, base.ShowAnimate(), base.AnimateDuration);
	};

	//获取用户信息
	function LoadUserInfo(callback) {
		HttpGet(base.RootUrl + "User/Detail", {
			Number: UserNumber,
			CurrNumber: userinfo.Number
		}, function(data) {
			if(data.result) {
				data = data.message;

				Sex = data.Sex;
				if(base.IsNullOrEmpty(Cover)) {
					$bg.style.background = "url(" + base.ShowThumb(data.Cover, 1) + ") center center no-repeat";
					$bg.style.backgroundSize = "cover";
				}
				if(base.IsNullOrEmpty(Avatar)) {
					Avatar = data.Avatar;
					base.Get("avatar").setAttribute("src", base.ShowThumb(data.Avatar, 2));
				}
				if(base.IsNullOrEmpty(NickName)) {
					NickName = base.UnUnicodeText(data.NickName);
					base.Get("nickname").innerHTML = NickName;
				}
				base.Get("signature").innerHTML = base.UnUnicodeText(data.Signature);

				//在黑名单 
				if(data.IsBlack == 1) {
					base.AddClass(["#article", "#mypic", "#share", "#copy", "#inblack"], "hide");
					base.RemoveClass(["#blacktip", "#outblack"], "hide");
				} else {

					base.AddClass(["#blacktip", "#outblack"], "hide");
					base.RemoveClass(["#article", "#inblack"], "hide");

					var showcount = 0;
					if(data.ShowZan == 1) {
						base.Get("showZanNum").innerHTML = data.Zans;
						base.Get("showZan").classList.remove("hide");
						showcount++;
					}
					if(data.ShowKeep == 1) {
						base.Get("showKeepNum").innerHTML = data.Keeps;
						base.Get("showKeep").classList.remove("hide");
						showcount++;
					}
					if(data.ShowFollow == 1) {
						base.Get("showFollowNum").innerHTML = data.Follows;
						base.Get("showFollow").classList.remove("hide");
						showcount++;
					}
					if(data.ShowFan == 1) {
						base.Get("showFanNum").innerHTML = data.Fans;
						base.Get("showFan").classList.remove("hide");
						showcount++;
					}
					switch(showcount) {
						case 1:
							base.Get("showZan").style.flex = "0 0 100%";
							base.Get("showKeep").style.flex = "0 0 100%";
							base.Get("showFollow").style.flex = "0 0 100%";
							base.Get("showFan").style.flex = "0 0 100%";
							break;
						case 2:
							base.Get("showZan").style.flex = "0 0 50%";
							base.Get("showKeep").style.flex = "0 0 50%";
							base.Get("showFollow").style.flex = "0 0 50%";
							base.Get("showFan").style.flex = "0 0 50%";
							break;
						case 3:
							base.Get("showZan").style.flex = "0 0 33.3%";
							base.Get("showKeep").style.flex = "0 0 33.3%";
							base.Get("showFollow").style.flex = "0 0 33.3%";
							base.Get("showFan").style.flex = "0 0 33.3%";
							break;
						case 4:
							base.Get("showZan").style.flex = "0 0 25%";
							base.Get("showKeep").style.flex = "0 0 25%";
							base.Get("showFollow").style.flex = "0 0 25%";
							base.Get("showFan").style.flex = "0 0 25%";
							break;
					}
				}

				//分享信息 
				ShareInfo.Title = base.UnUnicodeText(NickName) + "的专栏";
				ShareInfo.Cover = Avatar;
				ShareInfo.Url = data.ShareUrl;

				if(callback) {
					callback(data);
				}
			} else {
				mui.toast(data.message);
				plus.webview.currentWebview().close();
			}
			base.CloseWaiting();
			base.ShowLoading(false);
			mask.close();

		});
	}

	//文章
	function LoadArticle(callback) {
		var data = {
			UserNumber: UserNumber,
			CurrUserNumber: userinfo.Number
		}
		HttpGet(base.RootUrl + "User/Article", data, function(data) {
			var table = base.Get('a_list');
			table.innerHTML = "";
			var length = 0;
			if(data != null) {
				length = data.records;
				if(length > 0) {
					base.Get("a_title").innerHTML = length + "篇文章";
					for(var i = 0; i < data.list.length; i++) {
						var html = [];
						var div = document.createElement('div');
						div.className = 'title tc mt15 mb15 f14';
						div.innerHTML = '<div style="border:1px solid #0080ff;color:#0080ff;border-radius:30px;display:inline-block;width:60%;"><span>' + data.list[i].CreateDate + '</span><span class="ml15" id="a_num">' + data.list[i].Count + '篇文章</span></div>';
						table.appendChild(div);

						var div2 = document.createElement('div');
						div2.className = 'list full';

						var fragment = document.createDocumentFragment();
						mui.each(data.list[i].List, function(index, item) {
							var img = document.createElement('img');
							img.className = 'article';
							img.setAttribute("data-lazyload", base.ShowThumb(item.Cover, 2));
							img.setAttribute("articleid", item.ID);
							img.setAttribute("userid", item.CreateUserNumber);
							img.setAttribute("power", item.ArticlePower);
							img.setAttribute("nickname", NickName);

							fragment.appendChild(img);
						});
						div2.appendChild(fragment);
						table.appendChild(div2);
					}

					lazyLoad.refresh(true);
				}
			}
			if(length == 0) {
				if(userinfo.Number == UserNumber)
					base.Get("mynone").classList.remove("hide");
				else
					base.Get("none").classList.remove("hide");
			}
			if(callback) {
				callback();
			}
		});
	}

	//关注
	function Follow() {
		base.OpenWindow("follow", "follow.html", {
			Name: userinfo.Number == UserNumber ? "我" : NickName,
			Sex: Sex == 0 ? "他" : "她",
			UserNumber: UserNumber
		});
	}

	//粉丝
	function Fan() {
		base.OpenWindow("fan", "fan.html", {
			Name: userinfo.Number == UserNumber ? "我" : NickName,
			Sex: Sex == 0 ? "他" : "她",
			UserNumber: UserNumber
		});
	}

	//收藏
	function Keep() {
		base.OpenWindow("keep", "keep.html", {
			Name: userinfo.Number == UserNumber ? "我" : NickName,
			Sex: Sex == 0 ? "他" : "她",
			UserNumber: UserNumber
		});
	}

	//喜欢
	function Zan() {
		base.OpenWindow("zan", "zan.html", {
			Name: userinfo.Number == UserNumber ? "我" : NickName,
			Sex: Sex == 0 ? "他" : "她",
			UserNumber: UserNumber,
			ShowMe: 0
		});
	}

	//判断是否关注
	function CheckFan(isfan) {
		if(isLoading) {
			return false;
		}
		isLoading = true;
		var $guanzhu = base.Get("guanzhu");
		if(isfan == 1) {
			$guanzhu.style.background = name + 'linear-gradient(right,#7e7e7e 0%,#a2a2a2 100%)';
			$guanzhu.classList.add("guanzhu2");
			$guanzhu.classList.remove("guanzhu");
			$guanzhu.innerHTML = "已关注";
			isLoading = false;
		} else {
			isLoading = false;
			$guanzhu.addEventListener('tap', function(e) {
				if(isLoading) {
					return false;
				}
				isLoading = true;
				var data = {
					ID: userinfo.ID,
					ToUserNumber: UserNumber
				}
				HttpGet(base.RootUrl + "Api/Fan/Edit", data, function(data) {
					data = JSON.parse(data);
					base.CheckLogin(userinfo, data.code);
					if(data != null) {
						mui.toast(data.result ? "关注成功,在[关注]中可以找到Ta哦!" : data.message);
						if(data.result) {
							base.UpdateFan(userinfo, data.message);
							$guanzhu.style.background = name + 'linear-gradient(right,#7e7e7e 0%,#a2a2a2 100%)';
							$guanzhu.classList.add("guanzhu2");
							$guanzhu.classList.remove("guanzhu")
							$guanzhu.innerHTML = "已关注";
						}
					}
					isLoading = false;
				});
			});
		}
		base.Get("action").classList.remove("hide");
	}

	//添加黑名单
	function InBlack() {
		if(isLoading) {
			return false;
		}
		isLoading = true;
		mui('#black').popover('toggle');
		var data = {
			ID: userinfo.ID,
			ToUserNumber: UserNumber
		}
		HttpGet(base.RootUrl + "Api/Black/Edit", data, function(data) {
			base.CloseWaiting();
			data = JSON.parse(data);
			base.CheckLogin(userinfo, data.code);
			if(data != null) {
				mui.toast(data.result ? "加入黑名单成功" : "加入黑名单失败");
				if(data.result) {
					base.UpdateFan(userinfo, data.message);
					plus.webview.currentWebview().reload();
				}
			}
			isLoading = false;
		});
	}

	//解除黑名单
	function OutBlack() {
		if(isLoading) {
			return false;
		}
		isLoading = true;
		mui('#power').popover('toggle');
		var data = {
			ID: userinfo.ID,
			ToUserNumber: UserNumber
		}
		HttpGet(base.RootUrl + "Api/Black/Delete", data, function(data) {
			base.CloseWaiting();
			data = JSON.parse(data);
			base.CheckLogin(userinfo, data.code);
			if(data != null) {
				mui.toast(data.result ? "解除黑名单成功" : "解除黑名单失败");
				if(data.result) {
					plus.webview.currentWebview().reload();
					var black = base.GetView("black");
					if(black) {
						black.evalJS("Load()");
					}
				}
			}
			isLoading = false;
		});
	}

	//查看相册
	function Pic() {
		mui('#power').popover('toggle');
		base.OpenWindow("pic", "pic.html", {
			UserNumber: UserNumber,
			Title: base.UnUnicodeText(NickName) + "的相册"
		});
	}

	//打赏
	function Payment() {
		base.OpenWindow("money", "money.html", {
			ArticleNumber: "",
			ArticleUserNumber: UserNumber,
			Name: NickName,
			Avatar: Avatar
		});
	}

	//复制链接
	function Copy() {
		mui('#power').popover('toggle');
		CopyToClip();
	}

	//复制到剪贴板 
	function CopyToClip() {
		var Context = plus.android.importClass("android.content.Context");
		var main = plus.android.runtimeMainActivity();
		var clip = main.getSystemService(Context.CLIPBOARD_SERVICE);
		plus.android.invoke(clip, "setText", ShareInfo.Url);
		mui.toast("分享链接已复制到剪贴板");
	}

	//操作
	function More() {
		mui('#power').popover('toggle');
	}

	//分享
	function Share() {
		mui('#power').popover('toggle');
		ShareTan(1);
	}

	//分享
	var shares = null; //分享服务
	var shareImageUrl = ''; //分享图片地址

	//更新分享服务
	function UpdateSerivces() {
		plus.share.getServices(function(s) {
			shares = {};
			for(var i in s) {
				var t = s[i];
				shares[t.id] = t;
			}
		}, function(e) {
			console.log("获取分享服务列表失败：" + e.message);
		});
	}

	//分享弹窗
	function ShareTan(index) {
		var myshare = base.Get("myshare");
		if(index == 0) {
			base.Get("mysharebg").classList.add("hide");
			myshare.classList.remove("bounceInUp");
			myshare.classList.add("hide");
		} else {
			base.Get("mysharebg").classList.remove("hide");
			myshare.classList.remove("hide");
			myshare.classList.add("bounceInUp");
		}
	}

	//分享信息 
	function ShareAction(index) {
		ShareTan(0); //关闭分享弹窗

		//系统分享
		if(index == 6) {
			ShareSystem();
			return;
		}
		var id = "";
		var ex = "";
		switch(index) {
			//朋友圈
			case 1:
				id = "weixin";
				ex = "WXSceneTimeline";
				break;
				//微信
			case 2:
				id = "weixin";
				ex = "WXSceneSession";
				break;
				//新浪微博
			case 3:
				id = "sinaweibo";
				ex = "";
				break;
				//qq
			case 4:
				id = "qq";
				ex = "";
				break;
				//qq空间
			case 5:
				id = "qq";
				ex = "";
				break;
			default:
				break;
		}
		var s = null;
		if(!id || !(s = shares[id])) {
			console.log("无效的分享服务！");
			return;
		}
		if(s.authenticated) {
			shareMessage(s, ex, id);
		} else {
			mui.toast("授权中");
			s.authorize(function() {
				shareMessage(s, ex, id);
			}, function(e) {
				mui.toast("认证授权失败");
			});
		}
	}

	//系统分享
	function ShareSystem() {
		if(plus.os.name !== "Android") {
			plus.nativeUI.alert("此平台暂不支持系统分享功能");
			return;
		}
		var intent = new Intent(Intent.ACTION_SEND);
		intent.setType("text/plain");
		intent.putExtra(Intent.EXTRA_SUBJECT, "");
		intent.putExtra(Intent.EXTRA_TEXT, "分享自「小微篇」" + ShareInfo.Title + " " + ShareInfo.Url);
		intent.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK);
		main.startActivity(Intent.createChooser(intent, "系统分享"));
		base.ShareLog(userinfo.ID, "", "system");
	}

	//发送分享信息 
	function shareMessage(s, ex, id) {
		var msg = {
			href: ShareInfo.Url,
			title: ShareInfo.Title,
			content: "分享自「小微篇」",
			thumbs: [ShareInfo.Cover],
			pictures: [ShareInfo.Cover],
			extra: {
				scene: ex
			}
		};
		s.send(msg, function() {
			mui.toast("分享成功");
			base.ShareLog(userinfo.ID, "", id);
		}, function(e) {
			mui.toast("分享失败");
		});
	}
</script>