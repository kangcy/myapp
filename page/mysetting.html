<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title></title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<link rel="stylesheet" href="../css/mui.min.css">
		<link rel="stylesheet" href="../css/mui.picker.css">
		<link rel="stylesheet" href="../css/mui.poppicker.css">
		<style type="text/css">
			.mui-bar {
				background: #fff;
			}
			
			#signature {
				width: 12rem;
				line-height: 20px;
				white-space: normal;
			}
			
			.mui-table-view-cell {
				padding: 0.9375rem 0.9375rem;
			}
			
			.mui-icon-arrowright {
				margin-right: -0.3rem;
			}
			
			.mui-badge-danger {
				width: 10px;
				height: 10px;
				padding: 0px;
				top: 0.5rem !important;
				right: 0.5rem !important;
				position: absolute;
				background: red;
			}
		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav">
			<a class="mui-icon mui-icon-back mui-action-back fl c333"></a>
			<h1 class="mui-title c333">编辑个人资料</h1>
		</header>
		<div class="mui-content">
			<ul class="mui-table-view f13 mt0">
				<li class="mui-table-view-cell" id="divavatar">
					<span class="fl mt25">头像</span>
					<span class="mui-pull-right head">
						<img class="head-img mui-action-preview" id="avatar" src="../images/logo_default.png" style="width:4rem;height:4rem;border-radius:50%;" />
					</span>
				</li>
				<li class="mui-table-view-cell" id="editnickname" style="position:relative;">
					<span class="fl">昵称</span>
					<span class="mui-icon mui-icon-arrowright fr caaa f16"></span>
					<span class="fr c999 mr10" id="nickname"></span>
					<span class="mui-badge mui-badge-danger hide"></span>
				</li>
				<li class="mui-table-view-cell" id="editnickname">
					<span class="fl">ID</span>
					<span class="mui-icon mui-icon-arrowright fr caaa f16"></span>
					<span class="fr c999 mr10" id="userid"></span>
				</li>
				<li class="mui-table-view-cell" id="sexPicker">
					<span class="fl">性别</span>
					<span class="mui-icon mui-icon-arrowright fr caaa f16"></span>
					<span class="fr c999 mr10" id="sex"></span>
				</li>
				<li class="mui-table-view-cell" id="cityPicker" style="position:relative;">
					<span class="fl">地区</span>
					<span class="mui-icon mui-icon-arrowright fr caaa f16"></span>
					<span class="fr c999 mr10" id="city"></span>
					<span class="mui-badge mui-badge-danger hide"></span>
				</li>
				<li class="mui-table-view-cell" data-options='{"type":"date","beginYear":"1949","endYear":"2050"}' id="timePicker" style="position:relative;">
					<span class="fl">生日</span>
					<span class="mui-icon mui-icon-arrowright fr caaa f16"></span>
					<span class="fr c999 mr10" id="time"></span>
					<span class="mui-badge mui-badge-danger hide"></span>
				</li>
				<li class="mui-table-view-cell" id="editsignature" style="position:relative;">
					<span class="fl">个性签名</span>
					<span class="mui-icon mui-icon-arrowright fr caaa f16"></span>
					<span class="fr c999 tr mr10" id="signature"></span></a>
					<span class="mui-badge mui-badge-danger hide"></span>
				</li>
			</ul>
		</div>
	</body>

</html>
<script src="../js/jquery-1.10.2.min.js"></script>
<script src="../js/mui.min.js"></script>
<script src="../js/base.js"></script>
<script src="../js/mui.picker.min.js"></script>
<script src="../js/mui.poppicker.js"></script>
<script type="text/javascript">
	var auths = {};
	var isLoading = false; //是否操作中
	var userinfo = base.GetUserInfo();
	var mask = mui.createMask(function() {}); //显示遮罩

	mui.init();

	mui.ready(function() {
		base.InitScroll();
		$("#userid").html(userinfo.ID);
		$("#avatar").attr("src", base.ShowThumb(userinfo.Avatar, 1));
		$("#nickname").html(base.FormatStr(base.UnUnicodeText(userinfo.NickName), "请填写"));
		$("#sex").html(userinfo.Sex);
		$("#city").html(base.FormatStr(userinfo.Address, "请填写"));
		$("#time").html(userinfo.Birthday == "0001-01-01" ? "请设置" : userinfo.Birthday);
		$("#signature").html(base.FormatStr(base.UnUnicodeText(userinfo.Signature), "请填写"));

		if($("#nickname").html() == "请填写") {
			$("#editnickname").find(".mui-badge").removeClass("hide");
		}
		if($("#city").html() == "请填写") {
			$("#cityPicker").find(".mui-badge").removeClass("hide");
		}
		if($("#time").html() == "请设置") {
			$("#timePicker").find(".mui-badge").removeClass("hide");
		}
		if($("#signature").html() == "请填写") {
			$("#editsignature").find(".mui-badge").removeClass("hide");
		}

		document.getElementById('cityPicker').addEventListener('tap', function(event) {
			base.OpenWindow("province", "province.html", {});
		});

		//性别选择

		var sexResult = document.getElementById('sexResult');
		document.getElementById('sexPicker').addEventListener('tap', function(event) {
			var sexPicker = new mui.PopPicker();
			sexPicker.setData([{
				value: '0',
				text: "男"
			}, {
				value: '1',
				text: "女"
			}]);
			sexPicker.show(function(items) {
				if(isLoading) {
					return false;
				}
				isLoading = true;
				mask.show();
				base.ShowWaiting("正在编辑性别");
				document.getElementById("sex").innerHTML = items[0].text;
				setTimeout(function() {
					HttpGet(base.RootUrl + "User/EditSex", {
						ID: userinfo.ID,
						Sex: items[0].value
					}, function(data) {
						base.CloseWaiting();
						mask.close();
						if(data.result) {
							userinfo.Sex = items[0].value == "0" ? "男" : "女";
							localStorage.setItem('$userinfo', JSON.stringify(userinfo));
						} else {
							mui.toast(data.message);
						}
						isLoading = false;
					});
					sexPicker.dispose();
				}, 500);
			});
		}, false);

		//日期
		document.getElementById('timePicker').addEventListener('tap', function() {
			var optionsJson = this.getAttribute('data-options') || '{}';
			var options = JSON.parse(optionsJson);
			var id = this.getAttribute('id');
			var picker = new mui.DtPicker(options);
			picker.show(function(rs) {
				if(isLoading) {
					return false;
				}
				isLoading = true;
				mask.show();
				base.ShowWaiting("正在编辑生日");
				document.getElementById("time").innerHTML = rs.text;
				setTimeout(function() {
					HttpGet(base.RootUrl + "User/EditBirthday", {
						ID: userinfo.ID,
						Birthday: rs.text
					}, function(data) {
						base.CloseWaiting();
						mask.close();

						if(data.result) {
							userinfo.Birthday = rs.y.text + "-" + rs.m.text + "-" + rs.d.text;
							localStorage.setItem('$userinfo', JSON.stringify(userinfo));
						} else {
							mui.toast(data.message);
						}
						isLoading = false;
					});
					picker.dispose();
				}, 500);
			});
		}, false);

		//头像
		document.getElementById('divavatar').addEventListener('tap', function(event) {
			base.OpenWindow("editimage", "editimage.html", {
				Url: userinfo.Avatar,
				Source: "UserAvatar",
				Standard: "UserAvatar"
			});
		});
	})

	mui.plusReady(function() {

		//返回
		mui.back = function() {
			var self = plus.webview.currentWebview();
			var myPage = plus.webview.getWebviewById('my.html');
			if(myPage) {
				myPage.evalJS("Refresh()");
			}
			plus.webview.close(self);
		}
	});

	var editnickname = document.getElementById("editnickname");
	var editsignature = document.getElementById("editsignature");
	var nickname = document.getElementById("nickname");
	var signature = document.getElementById("signature");

	//修改头像
	function UpdateAvatar(url) {
		if(userinfo.Avatar == url) {
			return;
		}
		HttpGet(base.RootUrl + "User/EditAvatar", {
			ID: userinfo.ID,
			Avatar: url
		}, function(data) {
			if(data.result) {
				$("#avatar").attr("src", base.ShowThumb(url, 1));
				userinfo.Avatar = url;
				localStorage.setItem('$userinfo', JSON.stringify(userinfo));
			} else {
				mui.toast(data.message);
			}
		});
	}

	//修改昵称
	function UpdateNickName(t) {
		nickname.innerHTML = t;
		mask.show();
		base.ShowWaiting("正在编辑昵称");
		setTimeout(function() {
			HttpGet(base.RootUrl + "User/EditNickName", {
				ID: userinfo.ID,
				NickName: t
			}, function(data) {
				base.CloseWaiting();
				mask.close();
				if(data.result) {
					userinfo.NickName = t;
					localStorage.setItem('$userinfo', JSON.stringify(userinfo));
				} else {
					mui.toast(data.message);
				}
			});
		}, 500);
	}

	//修改签名
	function UpdateSignature(t) {
		signature.innerHTML = t;
		mask.show();
		base.ShowWaiting("正在编辑签名");
		setTimeout(function() {
			HttpGet(base.RootUrl + "User/EditSignature", {
				ID: userinfo.ID,
				Signature: t
			}, function(data) {
				base.CloseWaiting();
				mask.close();
				if(data.result) {
					userinfo.Signature = t;
					localStorage.setItem('$userinfo', JSON.stringify(userinfo));
				} else {
					mui.toast(data.message);
				}
			});
		}, 500);
	}

	//编辑昵称
	editnickname.addEventListener('tap', function(event) {
		var text = nickname.innerHTML.trim();
		base.OpenWindow("edittext", "edittext.html", {
			source: "nickname",
			title: text == "请填写" ? "" : text
		});
	});

	//编辑个性签名
	editsignature.addEventListener('tap', function(event) {
		var text = signature.innerHTML.trim();
		base.OpenWindow("edittext", "edittext.html", {
			source: "signature",
			title: text == "请填写" ? "" : text
		});
	});

	//修改地址 
	function UpdateAddress(province, city) {
		mask.show();
		base.ShowWaiting("正在编辑地区");
		setTimeout(function() {
			document.getElementById("city").innerHTML = province + " " + city;
			HttpGet(base.RootUrl + "User/EditAddress", {
				ID: userinfo.ID,
				Province: province,
				City: city
			}, function(data) {
				base.CloseWaiting();
				mask.close();
				if(data.result) {
					userinfo.Address = province + " " + city
					localStorage.setItem('$userinfo', JSON.stringify(userinfo));
				} else {
					mui.toast(data.message);
				}
				plus.webview.close("province");
				plus.webview.close("city");
			});
		}, 500);
	}
</script>