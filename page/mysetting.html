<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title></title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<link rel="stylesheet" href="../css/mui.min.css">
		<link rel="stylesheet" href="../css/mui.picker.css">
		<link rel="stylesheet" href="../css/mui.poppicker.css">
		<style type="text/css">
			.mui-bar {
				background: #fff;
			}
			
			#signature {
				width: 12rem;
				line-height: 20px;
				white-space: normal;
			}
			
			.mui-table-view-cell {
				padding: 0.9375rem 0.9375rem;
			}
			
			.mui-icon-arrowright {
				margin-right: -0.3rem;
			}
			.mui-badge-danger{
				width:10px;height:10px;padding:0px;top:0.5rem;right:0.5rem;position:absolute;background:red;
			}
		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav">
			<a id="back" class="mui-icon mui-icon-back fl c333"></a>
			<h1 class="mui-title c333">编辑个人资料</h1>
		</header>
		<div class="mui-content">
			<ul class="mui-table-view f13 mt0">
				<li class="mui-table-view-cell" id="divavatar">
					<span class="fl mt25">头像</span>
					<span class="mui-pull-right head">
						<img class="head-img mui-action-preview" id="avatar" src="../images/logo_default.png" style="width:4rem;height:4rem;border-radius:50%;" />
					</span>
				</li>
				<li class="mui-table-view-cell" id="editnickname" style="position:relative;">
					<span class="fl">昵称</span>
					<span class="mui-icon mui-icon-arrowright fr caaa f16"></span>
					<span class="fr c999 mr10" id="nickname"></span>
					<span class="mui-badge mui-badge-danger hide"></span>
				</li>
				<li class="mui-table-view-cell" id="editnickname">
					<span class="fl">ID</span>
					<span class="mui-icon mui-icon-arrowright fr caaa f16"></span>
					<span class="fr c999 mr10" id="userid"></span>
				</li>
				<li class="mui-table-view-cell" id="sexPicker">
					<span class="fl">性别</span>
					<span class="mui-icon mui-icon-arrowright fr caaa f16"></span>
					<span class="fr c999 mr10" id="sex"></span>
				</li>
				<li class="mui-table-view-cell" id="cityPicker" style="position:relative;">
					<span class="fl">地区</span>
					<span class="mui-icon mui-icon-arrowright fr caaa f16"></span>
					<span class="fr c999 mr10" id="city"></span>
					<span class="mui-badge mui-badge-danger hide"></span>
				</li>
				<li class="mui-table-view-cell" data-options='{"type":"date","beginYear":"1949","endYear":"2050"}' id="timePicker" style="position:relative;">
					<span class="fl">生日</span>
					<span class="mui-icon mui-icon-arrowright fr caaa f16"></span>
					<span class="fr c999 mr10" id="time"></span>
					<span class="mui-badge mui-badge-danger hide"></span>
				</li>
				<li class="mui-table-view-cell" id="editsignature" style="position:relative;">
					<span class="fl">个性签名</span>
					<span class="mui-icon mui-icon-arrowright fr caaa f16"></span>
					<span class="fr c999 tr mr10" id="signature"></span></a>
					<span class="mui-badge mui-badge-danger hide"></span>
				</li>
			</ul>
		</div>
	</body>

</html>
<script src="../js/jquery-1.10.2.min.js"></script>
<script src="../js/mui.min.js"></script>
<script src="../js/base.js"></script>
<script src="../js/mui.picker.min.js"></script>
<script src="../js/mui.poppicker.js"></script>
<script src="../js/login.js"></script>
<script type="text/javascript">
	var auths = {};
	var isLoading = false; //是否操作中
	var userinfo = base.GetUserInfo();
	mui.init({
		gestureConfig: {
			doubletap: true
		},
		swipeBack: false //启用右滑关闭功能
	});

	mui.ready(function() {
		base.InitScroll();

		$("#userid").html(userinfo.ID);
		$("#avatar").attr("src", base.ShowThumb(userinfo.Avatar, 1));
		$("#nickname").html(base.FormatStr(userinfo.NickName, "请填写"));
		$("#sex").html(userinfo.Sex);
		$("#city").html(base.FormatStr(userinfo.Address, "请填写"));
		$("#time").html(userinfo.Birthday == "0001-01-01" ? "请设置" : userinfo.Birthday);
		$("#signature").html(base.FormatStr(userinfo.Signature, "请填写"));

		if($("#nickname").html() == "请填写") {
			$("#editnickname").find(".mui-badge").removeClass("hide");
		}
		if($("#city").html() == "请填写") {
			$("#cityPicker").find(".mui-badge").removeClass("hide");
		}
		if($("#time").html() == "请设置") {
			$("#timePicker").find(".mui-badge").removeClass("hide");
		}
		if($("#signature").html() == "请填写") {
			$("#editsignature").find(".mui-badge").removeClass("hide");
		}

		document.getElementById('cityPicker').addEventListener('tap', function(event) {
			base.OpenWindow("province", "province.html", {});
		});

		//性别选择
		var sexPicker = new mui.PopPicker();
		sexPicker.setData([{
			value: '0',
			text: "男"
		}, {
			value: '1',
			text: "女"
		}]);
		var sexResult = document.getElementById('sexResult');
		document.getElementById('sexPicker').addEventListener('tap', function(event) {
			if(isLoading) {
				return false;
			}
			isLoading = true;

			sexPicker.show(function(items) {
				base.ShowWaiting("正在编辑性别");
				document.getElementById("sex").innerHTML = items[0].text;
				setTimeout(function() {
					HttpGet(base.RootUrl + "User/EditSex", {
						ID: userinfo.ID,
						Sex: items[0].value
					}, function(data) {
						base.CloseWaiting();
						mui.toast(data.result ? "编辑成功" : data.message);
						if(data.result) {
							userinfo.Sex = items[0].value == "0" ? "男" : "女";
							localStorage.setItem('$userinfo', JSON.stringify(userinfo));
						}
					});
					sexPicker.dispose(); //资源释放
				}, 1000);
			});
		}, false);

		//日期
		document.getElementById('timePicker').addEventListener('tap', function() {
			if(isLoading) {
				return false;
			}
			isLoading = true;

			var optionsJson = this.getAttribute('data-options') || '{}';
			var options = JSON.parse(optionsJson);
			var id = this.getAttribute('id');
			var picker = new mui.DtPicker(options);
			picker.show(function(rs) {
				base.ShowWaiting("正在编辑生日");
				document.getElementById("time").innerHTML = rs.text;
				setTimeout(function() {
					HttpGet(base.RootUrl + "User/EditBirthday", {
						ID: userinfo.ID,
						Birthday: rs.text
					}, function(data) {
						base.CloseWaiting();
						mui.toast(data.result ? "编辑成功" : data.message);
						if(data.result) {
							userinfo.Birthday = rs.y.text + "-" + rs.m.text + "-" + rs.d.text;
							localStorage.setItem('$userinfo', JSON.stringify(userinfo));
						}
					});
					picker.dispose(); //资源释放
				}, 1000);
			});
		}, false);

		//头像
		document.getElementById('divavatar').addEventListener('tap', function(event) {
			base.OpenWindow("editimage", "editimage.html", {
				Url: userinfo.Avatar,
				Source: "UserAvatar",
				Standard: "UserAvatar"
			});
		});
	})

	mui.plusReady(function() {

		//返回
		mui.back = function() {
			var self = plus.webview.currentWebview();
			var myPage = plus.webview.getWebviewById('my.html');
			myPage.evalJS("Load()");
			plus.webview.close(self);
		}

		//返回
		document.getElementById('back').addEventListener('tap', function(e) {
			mui.back();
		});
	});

	var editnickname = document.getElementById("editnickname");
	var editsignature = document.getElementById("editsignature");
	var nickname = document.getElementById("nickname");
	var signature = document.getElementById("signature");

	//修改头像
	function UpdateAvatar(url) {
		if(userinfo.Avatar == url) {
			mui.toast("编辑成功");
			return;
		}
		HttpGet(base.RootUrl + "User/EditAvatar", {
			ID: userinfo.ID,
			Avatar: url
		}, function(data) {
			mui.toast(data.result ? "编辑成功" : data.message);
			if(data.result) {
				$("#avatar").attr("src", base.ShowThumb(url, 1));
				userinfo.Avatar = url;
				localStorage.setItem('$userinfo', JSON.stringify(userinfo));
			}
		});
	}

	//修改昵称
	function UpdateNickName(t) {
		nickname.innerHTML = t;
		base.ShowWaiting("正在编辑昵称");
		setTimeout(function() {
			HttpGet(base.RootUrl + "User/EditNickName", {
				ID: userinfo.ID,
				NickName: t
			}, function(data) {
				base.CloseWaiting();
				mui.toast(data.result ? "编辑成功" : data.message);
				if(data.result) {
					userinfo.NickName = t;
					localStorage.setItem('$userinfo', JSON.stringify(userinfo));
				}
			});
		}, 1000);
	}

	//修改签名
	function UpdateSignature(t) {
		signature.innerHTML = t;
		base.ShowWaiting("正在编辑签名");
		setTimeout(function() {
			HttpGet(base.RootUrl + "User/EditSignature", {
				ID: userinfo.ID,
				Signature: t
			}, function(data) {
				base.CloseWaiting();
				mui.toast(data.result ? "编辑成功" : data.message);
				if(data.result) {
					userinfo.Signature = t;
					localStorage.setItem('$userinfo', JSON.stringify(userinfo));
				}
			});
		}, 1000);
	}

	//编辑昵称
	editnickname.addEventListener('tap', function(event) {
		var text = nickname.innerHTML.trim();
		base.OpenWindow("editnickname", "editnickname.html", {
			title: text == "请填写" ? "" : text
		});
	});

	//编辑个性签名
	editsignature.addEventListener('tap', function(event) {
		var text = signature.innerHTML.trim();
		base.OpenWindow("editsignature", "editsignature.html", {
			title: text == "请填写" ? "" : text
		});
	});

	//修改地址
	function UpdateAddress(province, city) {
		document.getElementById("city").innerHTML = province + " " + city;
		HttpGet(base.RootUrl + "User/EditAddress", {
			ID: userinfo.ID,
			ProvinceName: province,
			CityName: city
		}, function(data) {
			mui.toast(data.result ? "编辑成功" : data.message);
			if(data.result) {
				userinfo.Address = province + " " + city
				localStorage.setItem('$userinfo', JSON.stringify(userinfo));
			}
			plus.webview.close("province");
			plus.webview.close("city");
		});
	}

	//登录操作 
	function authLogin(type) {
		if(isLoading) {
			return false;
		}
		isLoading = true;
		base.ShowWaiting("正在绑定");
		var s;
		for(var i = 0; i < auths.length; i++) {
			if(auths[i].id == type) {
				s = auths[i];
				break;
			}
		}
		if(!s.authResult) {
			s.login(function(e) {
				authUserInfo(type, s);
			}, function(e) {
				base.ShowWaiting("取消绑定");
				switch(type) {
					case "weixin":
						base.SwitchChange("weixinSwitch", false);
						break;
					case "sinaweibo":
						base.SwitchChange("weiboSwitch", false);
						break;
					case "qq":
						base.SwitchChange("qqSwitch", false);
						break;
					default:
						break;
				}
				setTimeout(function() {
					base.CloseWaiting();
				}, 1000);
			});
		} else {
			authUserInfo(type, s);
		}
		isLoading = false;
	}

	//注销 
	function authLogout(id) {
		for(var i in auths) {
			var s = auths[i];
			if(s.id == id) {
				if(s.authResult) {
					s.logout(function(e) {
						console.log("注销登录认证成功");
					}, function(e) {
						console.log("注销登录认证失败");
					});
				}

				var key = 0;
				var source = 0;
				switch(id) {
					case "weixin":
						source = 1;
						break;
					case "qq":
						source = 2;
						break;
					case "sinaweibo":
						source = 3;
						break;
					default:
						break;
				}
				for(var j = 0; j < userinfo.UserLogin.length; j++) {
					if(userinfo.UserLogin[j].Source == source) {
						key = userinfo.UserLogin[j].ID;
					}
				}
				if(key > 0 && source > 0) {
					HttpGet(base.RootUrl + "UserLogin/Delete", {
						ID: key
					}, function(data) {
						if(data == null) {
							return callback("系统异常,请稍后再试");
						} else {
							if(data.result) {
								base.UpdateUser(userinfo.Number);
								userinfo = base.GetUserInfo();
							} else {
								return callback(data.message);
							}
						}
						mui.toast("解绑成功");
					});
				} else {
					mui.toast("解绑失败");
					switch(source) {
						case 1:
							base.SwitchChange("weixinSwitch", true);
							break;
						case 2:
							base.SwitchChange("qqSwitch", true);
							break;
						case 3:
							base.SwitchChange("weiboSwitch", true);
							break;
						default:
							break;
					}
				}
			}
		}
	}

	//登录认证信息 
	function authUserInfo(type, s) {
		if(!s.authResult) {
			base.CloseWaiting();
			mui.toast("未授权登录");
		} else {
			s.getUserInfo(function(e) {
				var josnStr = JSON.stringify(s.userInfo);
				var jsonObj = s.userInfo;
				console.log("获取用户信息成功：" + josnStr);
				var openId = showData(type, jsonObj);
				var url = "";
				switch(type) {
					case "weixin":
						url = "User/BindWeixin";
						break;
					case "sinaweibo":
						url = "User/BindWeibo";
						break;
					case "qq":
						url = "User/BindQQ";
						break;
					default:
						break;
				}
				if(url == "" || openId == "") {
					base.CloseWaiting();
					return mui.toast("授权失败");
				}
				HttpGet(base.RootUrl + url, {
					ID: userinfo.ID,
					Key: openId
				}, function(data) {
					base.CloseWaiting();
					if(data == null) {
						return callback("系统异常,请稍后再试");
					} else {
						if(data.result) {
							base.UpdateUser(userinfo.Number);
							userinfo = base.GetUserInfo();
							mui.toast("绑定成功");
						} else {
							return callback(data.message);
						}
					}
				});
			}, function(e) {
				base.CloseWaiting();
				mui.toast("获取用户信息失败：" + e.message + " - " + e.code);
			});
		}
	}

	//显示用户信息 
	function showData(type, data) {
		var openId
		switch(type) {
			case 'weixin':
				//{"openid":"oRrdQt8RTwroyZTnROSsJKHRM1Yw","nickname":"一个傻瓜","sex":1,"language":"zh_CN","city":"Changzhou","province":"Jiangsu","country":"CN","headimgurl":"http://wx.qlogo.cn/mmopen/eytJa9K5jkpPNvxRBGM4nIVq8iaaAH7Al37gxgs7t3TomcxByyFmYcvxhmBPRRFwrtKHapYGs8OSTticyOWLhbanpmrgMQiabsR/0","privilege":[],"unionid":"oU5Yyt4lcveMTHQvHHnE_kymcuDQ"}
				openId = data.openid;
				break;
			case 'qq':
				//{"ret":0,"msg":"","is_lost":0,"nickname":"你好，陌生人","gender":"男","province":"江苏","city":"南京","figureurl":"http://qzapp.qlogo.cn/qzapp/1104455702/6CDDCBB7B812BEA1D889FD32F6483A99/30","figureurl_1":"http://qzapp.qlogo.cn/qzapp/1104455702/6CDDCBB7B812BEA1D889FD32F6483A99/50","figureurl_2":"http://qzapp.qlogo.cn/qzapp/1104455702/6CDDCBB7B812BEA1D889FD32F6483A99/100","figureurl_qq_1":"http://q.qlogo.cn/qqapp/1104455702/6CDDCBB7B812BEA1D889FD32F6483A99/40","figureurl_qq_2":"http://q.qlogo.cn/qqapp/1104455702/6CDDCBB7B812BEA1D889FD32F6483A99/100","is_yellow_vip":"0","vip":"0","yellow_vip_level":"0","level":"0","is_yellow_year_vip":"0"}
				openId = data.figureurl_qq_2.split("/")[4];
				break;
			case 'sinaweibo':
				//{"id":5332090239,"idstr":"5332090239","class":1,"screen_name":"康春阳93212","name":"康春阳93212","province":"100","city":"1000","location":"其他","description":"","url":"","profile_image_url":"http://tva4.sinaimg.cn/crop.0.0.100.100.50/005OQUftjw8elc7b5ibj4j302s02sa9v.jpg","cover_image_phone":"http://ww1.sinaimg.cn/crop.0.0.640.640.640/549d0121tw1egm1kjly3jj20hs0hsq4f.jpg","profile_url":"u/5332090239","domain":"","weihao":"","gender":"m","followers_count":1,"friends_count":22,"pagefriends_count":0,"statuses_count":0,"favourites_count":0,"created_at":"Wed Oct 15 22:15:06 +0800 2014","following":false,"allow_all_act_msg":false,"geo_enabled":true,"verified":false,"verified_type":-1,"remark":"","ptype":0,"allow_all_comment":true,"avatar_large":"http://tva4.sinaimg.cn/crop.0.0.100.100.180/005OQUftjw8elc7b5ibj4j302s02sa9v.jpg","avatar_hd":"http://tva4.sinaimg.cn/crop.0.0.100.100.1024/005OQUftjw8elc7b5ibj4j302s02sa9v.jpg","verified_reason":"","verified_trade":"","verified_reason_url":"","verified_source":"","verified_source_url":"","follow_me":false,"online_status":0,"bi_followers_count":0,"lang":"zh-cn","star":0,"mbtype":0,"mbrank":0,"block_word":0,"block_app":0,"credit_score":80,"user_ability":0,"urank":3}
				openId = data.id;
				break;
			default:
				break;
		}
		return openId;
	}
</script>