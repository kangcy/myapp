function InitComment(){mui("#divcomment").load("../part/comment.html",function(e){$commentwrapper=base.Get("commentwrapper"),base.Get("tab0").setAttribute("src",base.RootUrl+"/Images/Icons/face/0.png"),base.Get("tab1").setAttribute("src",base.RootUrl+"/Images/Icons/animal/49.png"),base.Get("tab2").setAttribute("src",base.RootUrl+"/Images/Icons/food/0.png"),base.Get("tab3").setAttribute("src",base.RootUrl+"/Images/Icons/heart/0.png"),base.Get("tab4").setAttribute("src",base.RootUrl+"/Images/Icons/travel/0.png");var t=base.GetCurrentPosition();base.Get("address").innerHTML=base.IsNullOrEmpty(t.City)?"未识别":t.City,$edit=base.Get("remark"),window.getSelection&&document.createRange?(saveSelection=function(e){var t=window.getSelection().getRangeAt(0),i=t.cloneRange();return i.selectNodeContents(e),i.setEnd(t.startContainer,t.startOffset),i.toString().length},restoreSelection=function(e,t){var i=0,n=document.createRange();n.setStart(e,0),n.collapse(!0);for(var a,s=[e],o=!1;!o&&(a=s.pop());)if(3==a.nodeType){var r=i+a.length;t>=i&&t<=r&&(n.setStart(a,t-i),n.setEnd(a,t-i),o=!0),i=r}else for(var m=a.childNodes.length;m--;)s.push(a.childNodes[m]);(t=window.getSelection()).removeAllRanges(),t.addRange(n)}):document.selection&&document.body.createTextRange&&(saveSelection=function(e){var t=document.selection.createRange(),i=document.body.createTextRange();i.moveToElementText(e),i.setEndPoint("EndToStart",t);var n=i.text.length;return[n,n+t.text.length]},restoreSelection=function(e,t){var i=document.body.createTextRange();i.moveToElementText(e),i.collapse(!0),i.moveEnd("character",t[1]),i.moveStart("character",t[0]),i.select()});var i=document.createDocumentFragment(),n=0,a=[],s=[];mui.each([{Name:"face",Count:80},{Name:"animal",Count:146},{Name:"food",Count:58},{Name:"heart",Count:97},{Name:"travel",Count:70}],function(e,t){n=0,s=[],(a=[]).push('<div class="mui-slider-group">'),s.push('<div class="mui-slider-indicator">');for(var o=0;o<t.Count;o++){n++;var r=document.createElement("img");if(r.setAttribute("src",base.RootUrl+"Images/Icons/"+t.Name+"/"+o+".png"),r.className="commenticon",i.appendChild(r),n>=21&&n%21==0||n==t.Count&&n%21>0){var m=document.createElement("div");m.className="mui-slider-item",m.appendChild(i),a.push(m.outerHTML),i=document.createDocumentFragment(),21==n?s.push('<div class="mui-indicator mui-active"></div>'):s.push('<div class="mui-indicator"></div>')}}a.push("</div>"),s.push("</div>"),base.Get("slider"+(e+1)).innerHTML=a.join("")+s.join("")}),$commentwrapperReady=!0,base.IsNullOrEmpty(action)?($bottomAction.classList.remove("hide"),$bottomAction.classList.add("bounceIn")):Comment()}),base.ShowUser("#scroll-view"),mui("#scroll-view").on("tap",".sub",function(){if(base.TriggerMain)return!1;base.TriggerMain=!0,mui.later(function(){base.TriggerMain=!1},500);var e=this.getAttribute("number"),t=this.getAttribute("name");base.OpenWindow("subcomment","subcomment.html",{Number:e,ArticleNumber:curredit.ArticleNumber,Name:t})}),mui("#scroll-view").on("tap",".mui-table-view-cell",function(){if(base.TriggerMain)return!1;var e=this;this.style.background="#e5e5e5",curredit.Id=this.getAttribute("id"),curredit.ParentCommentNumber=this.getAttribute("cid"),curredit.ParentUserNumber=this.getAttribute("userid"),curredit.ArticleNumber=this.getAttribute("articlenumber"),curredit.Count=this.getAttribute("count"),mui("#action").popover("show"),mui.later(function(){e.style.background=""},150)})}function Reply(){isLoading||(isLoading=!0,mui("#action").popover("hide"),ShowComment(!0),isLoading=!1)}function Copy(){isLoading||(isLoading=!0,mui("#action").popover("hide"),$("#remark").html(base.Get("summary"+curredit.ParentCommentNumber).innerHTML),ShowComment(!0),isLoading=!1)}function ShowComment(e){if($commentwrapperReady)if(0==e)mask.close();else if(base.Get("commenttitle").innerHTML=base.IsNullOrEmpty(curredit.ParentCommentNumber)?"发表评论":"回复楼主",mask.show(),$bottomAction&&($bottomAction.classList.remove("fadeInUp"),$bottomAction.classList.add("hide")),$commentwrapper.classList.remove("hide"),$commentwrapper.classList.remove("bounceOutUp"),$commentwrapper.classList.add("bounceInUp"),base.ShowLoading(!1),!showIcon){showIcon=!0,mui("#slider1,#slider2,#slider3,#slider4,#slider5").slider({interval:0});var t=mui("#slider0").slider({interval:0});mui("#iconTab").on("tap","div",function(){mui("#iconTab>div").each(function(e,t){t.classList.remove("curr")}),t.gotoItem(this.getAttribute("index")),this.classList.add("curr")}),mui("#commentwrapper").on("tap",".commenticon",function(){$edit.focus(),saveSelection($edit),InsertIcon('<img src="'+this.getAttribute("src")+'" />')})}}function ShowPosition(e){showPosition=e,0==e?(base.Get("addresswrapper1").classList.add("hide"),base.Get("addresswrapper2").classList.remove("hide")):(base.Get("addresswrapper2").classList.add("hide"),base.Get("addresswrapper1").classList.remove("hide"))}function ShowIcon(){base.Get("divIcon").classList.toggle("height")}function Comment(){curredit.ParentCommentNumber="",curredit.ParentUserNumber="",ShowComment(!0)}function CommitComment(){if(!isLoading){isLoading=!0;var e=$edit.innerHTML;if(base.IsNullOrEmpty(e))return isLoading=!1,mui.toast("请填写内容");mask.show(),base.ShowWaiting("正在提交"),ShowComment(!1);var t=base.GetCurrentPosition();HttpPost(base.RootUrl+"Comment/Edit_1_3",{ID:userinfo.ID,ArticleNumber:curredit.ArticleNumber,ParentCommentNumber:curredit.ParentCommentNumber,ParentUserNumber:curredit.ParentUserNumber,Summary:escape(e),Province:t.Province,City:t.City,District:t.District,Street:t.Street,DetailName:t.DetailName,CityCode:t.CityCode,Latitude:t.Latitude,Longitude:t.Longitude,ShowPosition:showPosition},function(t){base.CheckLogin(userinfo,t.code),mui.later(function(){if(mask.close(),mui.toast(t.result?"感谢您的评论":t.message),t.result){if(NewId=t.message,base.IsNullOrEmpty(curredit.ParentCommentNumber))AppendComment();else{var i=$("#comment0"+curredit.ParentCommentNumber),n=i.parents(".mui-table-view-cell"),a=parseInt(curredit.Count)+1;i.html("查看"+a+"条回复"),n.find(".tip0").find("span").html(base.UnUnicodeText(userinfo.NickName)+" : "+base.UnUnicodeText(e)),1==a&&(n.find(".tip1").addClass("hide"),n.find(".tip0").removeClass("hide")),a>1&&(n.find(".tip0").addClass("hide"),n.find(".tip1").removeClass("hide"))}var s=base.GetView("articledetail");s&&s.evalJS("UpdateComment()")}isLoading=!1},500)})}}function AppendComment(){HttpGet(base.RootUrl+"Api/Comment/Detail",{ID:NewId},function(e){if(e=JSON.parse(e),base.CheckLogin(userinfo,e.code),null!=e){if(e.result){$("#none").addClass("hide");var t=base.Get("scroll-view"),i=document.createElement("div");i.innerHTML=template("comment",{list:[e.message]}),t.appendChild(i)}}else mui.toast("失败");isLoading=!1})}function CommentClear(){$edit.innerHTML=""}function InsertIcon(e){var t,i;if(window.getSelection){if((t=window.getSelection()).getRangeAt&&t.rangeCount){(i=t.getRangeAt(0)).deleteContents();var n=document.createElement("div");n.innerHTML=e;for(var a,s,o=document.createDocumentFragment();a=n.firstChild;)s=o.appendChild(a);i.insertNode(o),s&&((i=i.cloneRange()).setStartAfter(s),i.collapse(!0),t.removeAllRanges(),t.addRange(i))}}else document.selection&&"Control"!=document.selection.type&&document.selection.createRange().pasteHTML(e)}function AppendStr(e){var t=document.createElement("div");t.className="mui-table-view-cell",t.setAttribute("id","article"+e.Number),t.setAttribute("cid",e.Number),t.setAttribute("userid",e.UserNumber),t.setAttribute("articlenumber",e.ArticleNumber),t.setAttribute("count",e.SubCommentCount);var i=[];return i.push('<div class="oa-contact-cell mui-table mt10 mb10">'),i.push('<div class="mui-table-cell oa-contact-avatar"><img onload="StorageImg(this)" src="../images/avatar.png" data-lazyload="'+base.ShowThumb(e.Avatar,1)+'" class="user" userid="'+e.UserNumber+'" /></div>'),i.push('<p class="f12 user bold" style="color:#576B95;display:inline-block;" userid="'+e.UserNumber+'">'+base.UnUnicodeText(e.NickName)+'</p><p class="f12 c888 mt3 full">'+e.CreateDateText+(1==e.ShowPosition?'<span class="ml5 mr5">来自</span>'+e.City:"")+"</p>"),i.push('<div class="f12 c333 mt5 full summary" style="line-height:1.3rem;">'+base.UnUnicodeText(e.Summary)),i.push('<p class="tip tip1 mb0 f12 mt5 '+(e.SubCommentCount>1?"":"hide")+'"><span class="blue sub" number="'+e.Number+'" id="comment0'+e.Number+'" name="'+e.NickName+'">查看'+e.SubCommentCount+"条回复</span></p>"),i.push('<p class="tip tip0 mb0 f12 mt5 '+(1==e.SubCommentCount?"":"hide")+'"><span class="blue summary">'+base.UnUnicodeText(e.SubUserName)+'<span class="c999"> : '+base.UnUnicodeText(e.SubSummary)+"</span></span></p>"),t.innerHTML=i.join(""),t}var saveSelection,restoreSelection,self=null,action="",showIcon=!1,showPosition=1,$edit=null,curredit={Id:0,Number:"",ParentCommentNumber:0,ParentUserNumber:0,ArticleNumber:"",Count:0},NewId=0,editor=null,$commentwrapper=null,$commentwrapperReady=!1,$bottomAction=base.Get("bottomAction"),mask=base.CreateMask(!1,function(){base.CloseWaiting(),$commentwrapper.classList.remove("bounceInUp"),$commentwrapper.classList.add("bounceOutUp"),$bottomAction&&($bottomAction.classList.remove("hide"),$bottomAction.classList.add("bounceIn")),base.Get("divIcon").classList.add("height"),CommentClear()});