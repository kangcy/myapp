function InitComment(){mui("#divcomment").load("../part/comment.html",function(e){$commentwrapper=base.Get("commentwrapper"),base.Get("tab0").setAttribute("src",base.RootUrl+"/Images/Icons/face/0.png"),base.Get("tab1").setAttribute("src",base.RootUrl+"/Images/Icons/animal/49.png"),base.Get("tab2").setAttribute("src",base.RootUrl+"/Images/Icons/food/0.png"),base.Get("tab3").setAttribute("src",base.RootUrl+"/Images/Icons/heart/0.png"),base.Get("tab4").setAttribute("src",base.RootUrl+"/Images/Icons/travel/0.png");var t=base.GetCurrentPosition();base.Get("address").innerHTML=base.IsNullOrEmpty(t.City)?"未识别":t.City,$edit=base.Get("remark"),window.getSelection&&document.createRange?(saveSelection=function(e){var t=window.getSelection().getRangeAt(0),s=t.cloneRange();return s.selectNodeContents(e),s.setEnd(t.startContainer,t.startOffset),s.toString().length},restoreSelection=function(e,t){var s=0,n=document.createRange();n.setStart(e,0),n.collapse(!0);for(var a,i=[e],o=!1;!o&&(a=i.pop());)if(3==a.nodeType){var r=s+a.length;t>=s&&t<=r&&(n.setStart(a,t-s),n.setEnd(a,t-s),o=!0),s=r}else for(var m=a.childNodes.length;m--;)i.push(a.childNodes[m]);(t=window.getSelection()).removeAllRanges(),t.addRange(n)}):document.selection&&document.body.createTextRange&&(saveSelection=function(e){var t=document.selection.createRange(),s=document.body.createTextRange();s.moveToElementText(e),s.setEndPoint("EndToStart",t);var n=s.text.length;return[n,n+t.text.length]},restoreSelection=function(e,t){var s=document.body.createTextRange();s.moveToElementText(e),s.collapse(!0),s.moveEnd("character",t[1]),s.moveStart("character",t[0]),s.select()});var s=document.createDocumentFragment(),n=0,a=[],i=[];mui.each([{Name:"face",Count:80},{Name:"animal",Count:146},{Name:"food",Count:58},{Name:"heart",Count:97},{Name:"travel",Count:70}],function(e,t){n=0,i=[],(a=[]).push('<div class="mui-slider-group">'),i.push('<div class="mui-slider-indicator">');for(var o=0;o<t.Count;o++){n++;var r=document.createElement("img");if(r.setAttribute("src",base.RootUrl+"Images/Icons/"+t.Name+"/"+o+".png"),r.className="commenticon",s.appendChild(r),n>=21&&n%21==0||n==t.Count&&n%21>0){var m=document.createElement("div");m.className="mui-slider-item",m.appendChild(s),a.push(m.outerHTML),s=document.createDocumentFragment(),21==n?i.push('<div class="mui-indicator mui-active"></div>'):i.push('<div class="mui-indicator"></div>')}}a.push("</div>"),i.push("</div>"),base.Get("slider"+(e+1)).innerHTML=a.join("")+i.join("")}),$commentwrapperReady=!0,base.IsNullOrEmpty(action)?$("#bottomAction").removeClass("hide").addClass("bounceIn"):Comment()}),base.ShowUser("#scroll-view"),mui("#scroll-view").on("tap",".goods",function(){if(!isLoading){isLoading=!0;var e=this.getAttribute("cid");HttpGet(base.RootUrl+"Api/Zan/CommentZanEdit",{ID:userinfo.ID,CommentNumber:e},function(t){if(t=JSON.parse(t),base.CheckLogin(userinfo,t.code),null!=t){if(t.result){var s=$("#goods"+e),n=parseInt(s.find("span").html());1==t.message.split("|")[0]?(s.removeClass("heartbeat red"),s.attr("already","0"),s.find("img").attr("src","../images/article/btn_good.png"),s.find("span").html(n-1<0?0:n-1)):(s.addClass("heartbeat red"),s.attr("already","1"),s.find("img").attr("src","../images/article/btn_good2.png"),s.find("span").html(n+1))}}else mui.toast("失败");isLoading=!1})}}),mui("#scroll-view").on("tap",".comments",function(){isLoading||(isLoading=!0,ParentCommentNumber=this.getAttribute("cid"),ParentUserNumber=this.getAttribute("userid"),ArticleNumber=this.getAttribute("articlenumber"),Count=this.getAttribute("count"),ShowComment(!0),isLoading=!1)}),mui("#scroll-view").on("tap",".sub",function(){var e=this.getAttribute("number"),t=this.getAttribute("name");base.OpenWindow("subcomment","subcomment.html",{Number:e,ArticleNumber:ArticleNumber,Name:t})})}function ShowComment(e){if($commentwrapperReady)if(0==e)mask.close();else if(base.Get("commenttitle").innerHTML=base.IsNullOrEmpty(ParentCommentNumber)?"发表评论":"回复楼主",mask.show(),base.Get("bottomAction")&&(base.Get("bottomAction").classList.remove("fadeInUp"),base.Get("bottomAction").classList.add("hide")),$commentwrapper.classList.remove("hide"),$commentwrapper.classList.remove("bounceOutUp"),$commentwrapper.classList.add("bounceInUp"),base.ShowLoading(!1),!showIcon){showIcon=!0,mui("#slider1,#slider2,#slider3,#slider4,#slider5").slider({interval:0});var t=mui("#slider0").slider({interval:0});mui("#iconTab").on("tap","div",function(){mui("#iconTab>div").each(function(e,t){t.classList.remove("curr")}),t.gotoItem(this.getAttribute("index")),this.classList.add("curr")}),mui("#commentwrapper").on("tap",".commenticon",function(){$edit.focus(),saveSelection($edit),InsertIcon('<img src="'+this.getAttribute("src")+'" />')})}}function ShowPosition(e){showPosition=e,0==e?(base.Get("addresswrapper1").classList.add("hide"),base.Get("addresswrapper2").classList.remove("hide")):(base.Get("addresswrapper2").classList.add("hide"),base.Get("addresswrapper1").classList.remove("hide"))}function ShowIcon(){base.Get("divIcon").classList.toggle("height")}function Comment(){ParentCommentNumber="",ParentUserNumber="",ShowComment(!0)}function CommitComment(){if(!isLoading){isLoading=!0;var e=$edit.innerHTML;if(base.IsNullOrEmpty(e))return isLoading=!1,mui.toast("请填写内容");mask.show(),base.ShowWaiting("正在提交"),ShowComment(!1);var t=base.GetCurrentPosition();HttpPost(base.RootUrl+"Comment/Edit_1_3",{ID:userinfo.ID,ArticleNumber:ArticleNumber,ParentCommentNumber:ParentCommentNumber,ParentUserNumber:ParentUserNumber,Summary:escape(e),Province:t.Province,City:t.City,District:t.District,Street:t.Street,DetailName:t.DetailName,CityCode:t.CityCode,Latitude:t.Latitude,Longitude:t.Longitude,ShowPosition:showPosition},function(t){base.CheckLogin(userinfo,t.code),mui.later(function(){if(mask.close(),mui.toast(t.result?"感谢您的评论":t.message),t.result){if(NewId=t.message,base.IsNullOrEmpty(ParentCommentNumber))AppendComment();else{var s=$("#comment0"+ParentCommentNumber),n=s.parents(".mui-table-view-cell"),a=parseInt(Count)+1;s.html("查看"+a+"条回复"),n.find(".tip0").find("span").html(base.UnUnicodeText(userinfo.NickName)+" : "+base.UnUnicodeText(e)),1==a&&(n.find(".tip1").addClass("hide"),n.find(".tip0").removeClass("hide")),a>1&&(n.find(".tip0").addClass("hide"),n.find(".tip1").removeClass("hide")),base.Get("comment1"+ParentCommentNumber).setAttribute("count",a)}var i=base.GetView("articledetail");i&&i.evalJS("UpdateComment()")}isLoading=!1},500)})}}function AppendComment(){HttpGet(base.RootUrl+"Api/Comment/Detail",{ID:NewId},function(e){if(e=JSON.parse(e),base.CheckLogin(userinfo,e.code),null!=e){if(e.result){$("#none").addClass("hide");var t=base.Get("scroll-view"),s=AppendStr(e.message);t.appendChild(s)}}else mui.toast("失败");isLoading=!1})}function CommentClear(){$edit.innerHTML=""}function InsertIcon(e){var t,s;if(window.getSelection){if((t=window.getSelection()).getRangeAt&&t.rangeCount){(s=t.getRangeAt(0)).deleteContents();var n=document.createElement("div");n.innerHTML=e;for(var a,i,o=document.createDocumentFragment();a=n.firstChild;)i=o.appendChild(a);s.insertNode(o),i&&((s=s.cloneRange()).setStartAfter(i),s.collapse(!0),t.removeAllRanges(),t.addRange(s))}}else document.selection&&"Control"!=document.selection.type&&document.selection.createRange().pasteHTML(e)}function AppendStr(e){var t=document.createElement("div");t.className="mui-table-view-cell mt10 mb10",t.setAttribute("id","article"+e.Number);var s=[];return s.push('<div class="oa-contact-cell mui-table">'),s.push('<div class="mui-table-cell oa-contact-avatar"><img onload="StorageImg(this)" src="../images/avatar.png" data-lazyload="'+base.ShowThumb(e.Avatar,1)+'" class="user" userid="'+e.UserNumber+'" /></div>'),s.push('<div class="flex-box flex-row full">'),s.push('<div style="flex:0 0 65%;" class="flex-item"><p class="c333 f13 user" userid="'+e.UserNumber+'">'+base.UnUnicodeText(e.NickName)+'</p><p class="f11 c999 mt3 full">'+e.CreateDateText+(1==e.ShowPosition?'<span class="ml5 mr5">来自</span>'+e.City:"")+"</p></div>"),s.push('<div style="flex:0 0 35%;" class="flex-item c999 tr"><img src="../images/article/btn_comment.png" style="width:0.9rem;" class="ml15 fr mt1 comments" cid="'+e.Number+'" userid="'+e.UserNumber+'" articlenumber="'+e.ArticleNumber+'" count="'+e.SubCommentCount+'" id="comment1'+e.Number+'" /><div id="goods'+e.Number+'" cid="'+e.Number+'" already="'+(0==e.IsZan?0:1)+'" class="goods fr '+(0==e.IsZan?"":"red")+'"><span class="f13 ml5 fr" >'+e.Goods+'</span><img src="../images/article/'+(0==e.IsZan?"btn_good":"btn_good2")+'.png" style="width:0.9rem;" class="fr"  /></div></div></div>'),s.push('<div class="f12 c333 mt5 full summary" style="line-height:1.3rem;">'+base.UnUnicodeText(e.Summary)+"</div>"),s.push('<p class="tip tip1 mb0 f12 mt5 '+(e.SubCommentCount>1?"":"hide")+'"><span class="blue sub" number="'+e.Number+'" id="comment0'+e.Number+'" name="'+e.NickName+'">查看'+e.SubCommentCount+"条回复</span></p>"),s.push('<p class="tip tip0 mb0 f12 mt5 '+(1==e.SubCommentCount?"":"hide")+'"><span class="blue summary">'+base.UnUnicodeText(e.SubUserName)+'<span class="c999"> : '+base.UnUnicodeText(e.SubSummary)+"</span></span></p>"),t.innerHTML=s.join(""),t}var saveSelection,restoreSelection,self=null,action="",showIcon=!1,showPosition=1,$edit=null,Number="",ArticleNumber="",ParentCommentNumber=0,ParentUserNumber=0,Count=0,NewId=0,editor=null,$commentwrapper=null,$commentwrapperReady=!1,mask=base.CreateMask(!1,function(){base.CloseWaiting(),$commentwrapper.classList.remove("bounceInUp"),$commentwrapper.classList.add("bounceOutUp"),base.Get("bottomAction")&&(base.Get("bottomAction").classList.remove("hide"),base.Get("bottomAction").classList.add("bounceIn")),base.Get("divIcon").classList.add("height"),CommentClear()});