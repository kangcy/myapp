function InitImg(e){$image.attr("src",e);$image.width();var t=$image.height();$image.css({width:"auto",height:"auto","margin-top":"0px","margin-left":"0px"}),totalheight>=t&&$image.css("margin-top",(totalheight-t)/2+"px"),"UserCover"==Standard||"UserAvatar"==Standard?openpop():($image.show(),base.Get("openpop").style.display="inline-block",mask.close())}function Camera(){mui("#upload").popover("hide");plus.camera.getCamera().captureImage(function(e){plus.io.resolveLocalFileSystemURL(e,function(e){closepop();compressImage(e.toLocalURL(),dstname="_downloads/"+base.GetUid()+".jpg",function(e,t){e&&$image.attr("src",t)})})})}function Gallery(){mui("#upload").popover("hide"),plus.gallery.pick(function(e){closepop(),dstname="_downloads/"+base.GetUid()+".jpg",compressImage(e.files[0],dstname,function(e,t){if(e){var a=new Image;a.src=t,a.complete?InitImg(a.src):a.onload=function(){InitImg(a.src)}}})},function(e){},{filter:"image",maximum:1,multiple:!0,system:!1})}function Pic(){mui("#upload").popover("hide"),base.OpenWindow("mypic","mypic.html",{})}function cutImg(e){if(!iscutimging)if(iscutimging=!0,base.Get("rotateimgright").style.display="none",base.Get("openpop").style.display="none",base.Get("closepop").style.display="none","UserCover"==Standard||"UserAvatar"==Standard){var t=1;switch(Standard){case"UserCover":t=4/3;break;case"UserAvatar":t=1}$image.cropper({checkImageOrigin:!0,aspectRatio:t,autoCropArea:1,toggleDragModeOnDblclick:!1,dragCrop:!1,zoomable:!0,movable:!1,resizable:!1,built:function(){e(),$image.show(),base.Get("rotateimgright").style.display="inline-block"}})}else $image.cropper({checkImageOrigin:!0,autoCropArea:.6,toggleDragModeOnDblclick:!1,dragCrop:!1,zoomable:!0,movable:!0,resizable:!0,built:function(){e(),$image.show(),base.Get("rotateimgright").style.display="inline-block",base.Get("closepop").style.display="inline-block"}})}function rotateimgright(){base.IsNullOrEmpty(dstname)&&(dstname=$image.attr("src")),dstname.toLowerCase().startsWith("http://")?iscutimging?$image.cropper("rotate",90):cutImg(function(){$image.cropper("rotate",90)}):plus.zip.compressImage({src:dstname,dst:dstname,overwrite:!0,rotate:90},function(e){dstname=e.target,$image.cropper("rotate",90)},function(e){console.log("Compress error!")})}function rotateimgleft(){iscutimging?$image.cropper("rotate",-90):cutImg(function(){$image.cropper("rotate",-90)})}function openpop(){cutImg(function(){mask.close()})}function closepop(){base.Get("rotateimgright").style.display="none",base.Get("closepop").style.display="none",base.Get("openpop").style.display="inline-block",$image.cropper("destroy"),iscutimging=!1}function confirm(e){var t=$image.attr("src");if(base.IsNullOrEmpty(t))$.isFunction(e)&&e(t);else if(iscutimging){mask.show();Upload(t=$image.cropper("getCroppedCanvas").toDataURL("image/jpeg",1),e)}else{if(t.toLowerCase().indexOf("http")>-1)return void($.isFunction(e)&&e(t));mask.show();var a=new Image;a.src=t,a.onload=function(){Upload(getBase64Image(a),e)}}}function Upload(e,t){base.ShowWaiting("正在上传图片"),HttpPost(base.UploadUrl+"Upload/Upload",{str:e,standard:Standard,Number:userinfo.Number},function(e){null!=e&&(e.result?(t&&t(e.message),base.Get("closepop").style.display="none",base.Get("openpop").style.display="inline-block",$image.cropper("destroy"),iscutimging=!1):mui.toast(e.message),mask.close())})}function compressImage(e,t,a){plus.zip.compressImage({src:e,dst:t,overwrite:!0,quality:90,width:"720px",format:"jpg"},function(e){$.isFunction(a)&&a(!0,e.target)},function(t){$.isFunction(a)&&(mui.toast(t.message),a(!1,e))})}function ConfirmImg(e){$image.hide().attr("src",e).load(function(){var t=$readyimg.width(),a=$readyimg.height();totalheight>=a&&$image.css("margin-top",(totalheight-a)/2+"px"),totalwidth>=t&&$image.css("margin-left",(totalwidth-t)/2+"px"),$image.css({"max-width":totalwidth+"px","max-height":totalheight+"px"}),$image.cropper("replace",e),$image.show()})}function getBase64Image(e){var t=document.createElement("canvas"),a=e.width,i=e.height;t.width=a,t.height=i;return t.getContext("2d").drawImage(e,0,0,a,i),t.toDataURL("image/jpeg",1)}var iscutimging=!1,dstname="";