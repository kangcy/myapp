(function(doc, win) {
	// 分辨率Resolution适配
	var docEl = doc.documentElement,
		resizeEvt = 'orientationchange' in window ? 'orientationchange' : 'resize',
		recalc = function() {
			var clientWidth = docEl.clientWidth;
			if(!clientWidth) return;
			docEl.style.fontSize = 16 * (clientWidth / 320) + 'px';
			docEl.style.width = '100%';
			docEl.style.height = '100%';
			//docEl.style.overflow = 'hidden';
		};

	if(!doc.addEventListener) return;
	win.addEventListener(resizeEvt, recalc, false);
	doc.addEventListener('DOMContentLoaded', recalc, false);

	// 一物理像素在不同屏幕的显示效果不一样。要根据devicePixelRatio来修改meta标签的scale,要注释上面的meta标签
	(function() {
		return;
		var dpr = scale = 1;
		var isIPhone = win.navigator.appVersion.match(/iphone/gi);
		var devicePixelRatio = win.devicePixelRatio;
		if(isIPhone) {
			// iOS下，对于2和3的屏，用2倍的方案，其余的用1倍方案
			if(devicePixelRatio >= 3 && (!dpr || dpr >= 3)) {
				dpr = 3;
			} else if(devicePixelRatio >= 2 && (!dpr || dpr >= 2)) {
				dpr = 2;
			} else {
				dpr = 1;
			}
		} else {
			// 其他设备下，仍旧使用1倍的方案
			dpr = 1;
		}
		scale = 1 / dpr;
		var metaEl = "";
		metaEl = doc.createElement('meta');
		metaEl.setAttribute('name', 'viewport');
		metaEl.setAttribute('content', 'initial-scale=' + scale + ', maximum-scale=' + scale + ', minimum-scale=' + scale + ', user-scalable=no');
		if(docEl.firstElementChild) {
			docEl.firstElementChild.appendChild(metaEl);
		} else {
			var wrap = doc.createElement('div');
			wrap.appendChild(metaEl);
			doc.write(wrap.innerHTML);
		}
	})();

})(document, window);

//等待框
var waiting = new function() {
	//创建
	this.create = function(title) {
		var item = base.Get("waiting");
		if(item) {
			base.Get("waiting_title").innerHTML = title;
			return item;
		}
		var div = document.createElement('div');
		div.className = 'waiting c333 f13 tc';
		div.setAttribute("id", "waiting");
		div.style.zIndex = "2147483647";
		div.innerHTML = '<div><img src="../images/loading.gif" class="fl" /><span id="waiting_title">' + title + '</span></div>';
		document.getElementsByTagName("body")[0].appendChild(div);
		return div;
	}
	this.setTitle = function(title) {
		var item = this.create(title);
		base.Get("waiting_title").innerHTML = title;
	}
	this.show = function(title) {
		var item = this.create(title);
		item.classList.remove("hide");
	}
	this.close = function() {
		var item = this.create("");
		item.classList.add("hide");
	}
}

//是否数组
var isArray = function(obj) {
	return Object.prototype.toString.call(obj) === '[object Array]';
}

//浏览器类型
var browser = {
	versions: function() {
		var u = navigator.userAgent,
			app = navigator.appVersion;
		return { //移动终端浏览器版本信息   
			trident: u.indexOf("Trident") > -1, //IE内核  
			presto: u.indexOf("Presto") > -1, //opera内核  
			webKit: u.indexOf("AppleWebKit") > -1, //苹果、谷歌内核  
			gecko: u.indexOf("Gecko") > -1 && u.indexOf("KHTML") == -1, //火狐内核  
			mobile: !!u.match(/AppleWebKit.*Mobile.*/), //是否为移动终端  
			ios: !!u.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/), //ios终端  
			android: u.indexOf("Android") > -1 || u.indexOf("Linux") > -1, //android终端或者uc浏览器  
			iPhone: u.indexOf("iPhone") > -1, //是否为iPhone或者QQHD浏览器  
			iPad: u.indexOf("iPad") > -1, //是否iPad  
			webApp: u.indexOf("Safari") == -1 //是否web应该程序，没有头部与底部  
		};
	}(),
	language: (navigator.browserLanguage || navigator.language).toLowerCase()
}

var base = new function() {

	/**
	 * 接口错误码
	 **/
	this.ErrorCode = {
		UnLogin: 1
	}

	/**
	 * 触发层级(触发父元素事件)
	 **/
	this.TriggerMain = true;

	/**
	 * 当前定位信息
	 **/
	this.Province = ""; //省份名称
	this.City = ""; //城市名称
	this.District = ""; //地区名称
	this.Street = ""; //街道名称
	this.DetailName = ""; //详细定位
	this.CityCode = ""; //城市编码
	this.Latitude = ""; //纬度
	this.Longitude = ""; //经度

	/**
	 * 系统定位
	 **/
	this.GetCurrentPosition = function(callback1, callback2) {
		plus.geolocation.getCurrentPosition(function(p) {
			base.Province = p.address.province;
			base.City = p.address.city;
			base.District = p.address.district;
			base.Street = p.address.street;
			base.DetailName = p.address.poiName;
			base.CityCode = p.address.cityCode;
			base.Latitude = p.coords.latitude;
			base.Longitude = p.coords.longitude;
			if(callback1) {
				callback1();
			}
		}, function(e) {
			base.Province = "";
			base.City = "";
			base.District = "";
			base.Street = "";
			base.DetailName = "";
			base.CityCode = "";
			base.Latitude = "";
			base.Longitude = "";
			if(callback2) {
				callback2();
			}
		});
	}

	/**
	 * 优酷
	 **/
	this.youku_client_id = "59bec9b0be1fc34b";
	this.youku_client_secret = "244a6bbc4b212e01b8702745b879e52d";

	/**
	 * 是否正在加载
	 **/
	this.IsLoading = false;

	/**
	 * 当前动画标识
	 **/
	this.CurrAnimate = "";

	/**
	 * 列表每次请求数
	 **/
	this.PageSize = 15;

	/**
	 * 窗口动画持续时间
	 **/
	this.AnimateDuration = 350;

	/**
	 * 接口请求根路径
	 **/
	this.RootUrl = "http://www.ishaoxia.com/";

	/**
	 * 默认图片
	 **/
	this.DefaultImg = "../images/logo_default.png";

	/**
	 * 默认头像
	 **/
	this.DefaultAvatar = "../images/avatar.png";

	/**
	 * 显示等待、关闭等待
	 **/
	this.ShowLoading = function(show) {
		if(show)
			base.Get("loader").classList.remove("hide");
		else
			base.Get("loader").classList.add("hide");
	}

	/**
	 * 显示列表空、关闭列表空
	 **/
	this.ShowNone = function(show) {
		if(show)
			base.Get("none").classList.remove("hide");
		else
			base.Get("none").classList.add("hide");
	}

	/**
	 * 获取当前用户信息
	 **/
	this.GetUserInfo = function() {
		var settingsText = localStorage.getItem('$userinfo') || "{}";
		return JSON.parse(settingsText);
	}

	/**
	 * 设置应用本地配置
	 **/
	this.GetSettings = function() {
		var settingsText = localStorage.getItem('$settings') || "{}";
		return JSON.parse(settingsText);
	}

	/**
	 * 判断用户是否登录
	 **/
	this.CheckLogin = function(userinfo, code) {
		if(userinfo == "{}" || code == base.ErrorCode.UnLogin) {
			base.IsLoading = false;
			base.OpenWindow("login", "../page/login.html", {}, "fade-in");
			return false;
		}
	}

	/**
	 * 校验字符串是否为空
	 **/
	this.IsNullOrEmpty = function(str) {
		if(!str) {
			return true;
		}
		if(str == "") {
			return true;
		}
		if(str.toString().toLowerCase() == "null") {
			return true;
		}
		return false;
	}

	/**
	 * 格式化字符串显示
	 **/
	this.FormatStr = function(str, defaultStr) {
		return base.IsNullOrEmpty(str) || str == " " ? defaultStr : str
	}

	/**
	 * 产生一个随机数
	 **/
	this.GetUid = function() {
		return new Date().getTime().toString();
	}

	/**
	 * 手机号码校验
	 **/
	this.CheckPhone = function(phone) {
		if(base.IsNullOrEmpty(phone)) {
			return false;
		}
		return phone.length == 11 && !isNaN(phone) && (/^1[3|4|5|6|7|8|9][0-9]\d{4,8}$/.test(phone));
	};

	/**
	 * 打开等待提示框 
	 **/
	this.ShowWaiting = function(title) {
		waiting.show(title);
	}

	/**
	 * 关闭等待提示框
	 **/
	this.CloseWaiting = function() {
		waiting.close();
	}

	//等待提示框
	this.Waiting = function(show, title) {
		if(show) {
			plus.nativeUI.showWaiting(title, {
				width: "80%",
				padding: "5%",
				background: "rgba(0,0,0,0.6)",
				loading: {
					display: "inline"
				}
			})
		} else {
			plus.nativeUI.closeWaiting();
		}
	}

	/**
	 * 创建弹出层
	 **/
	this.CreateMask = function(enable, callback) {
		var element = document.createElement('div');
		element.classList.add('mui-backdrop');
		element.addEventListener(mui.EVENT_MOVE, mui.preventDefault);
		element.addEventListener('tap', function() {
			if(mask._enable) {
				mask.close();
			}
		});
		var mask = [element];
		mask._show = false;
		mask._enable = enable;
		mask.show = function() {
			mask._show = true;
			element.setAttribute('style', 'opacity:1');
			document.body.appendChild(element);
			return mask;
		};
		mask._remove = function() {
			if(mask._show) {
				mask._show = false;
				element.setAttribute('style', 'opacity:0');
				mui.later(function() {
					var body = document.body;
					element.parentNode === body && body.removeChild(element);
				}, 350);
			}
			return mask;
		};
		mask.close = function() {
			mask._remove();
			callback();
		};
		return mask;
	};

	/**
	 * 防止连续点击
	 */
	var Repeat_Action = null;
	this.RepeatAction = function() {
		if(Repeat_Action) {
			return true;
		}
		Repeat_Action = new Date().getTime();
		mui.later(function() {
			Repeat_Action = null;
		}, 1000);
		return false;
	}

	/**
	 * 窗体动画
	 **/
	this.ShowAnimate = function() {
		var show = "pop-in";
		//var show = "slide-in-right";
		if(mui.os.android) {
			if(parseFloat(mui.os.version) < 4.4) {
				show = "slide-in-right";
			}
		}
		return show;
	}

	/**
	 * 打开新页面
	 **/
	this.OpenWindow = function(id, url, data, aniShow, bounce) {
		if(base.RepeatAction()) {
			return;
		}
		mui.openWindow({
			id: id,
			url: url,
			show: {
				autoShow: true,
				duration: base.AnimateDuration,
				aniShow: aniShow ? aniShow : base.ShowAnimate()
			},
			styles: {
				zindex: 10000,
				hardwareAccelerated: true, //开启硬件加速
				bounce: bounce ? bounce : "vertical",
				scrollIndicator: "none" //显示滚动条
				//render: "always" // Webview在任何时候都渲染
			},
			createNew: true,
			waiting: {
				autoShow: false
			},
			extras: data
		});
	}

	//5+ 预截原动画 打开webview
	this.OpenWindowNew = function(url, id, op, data) {
		var nw = plus.webview.create(url, id, op, data),
			bitmap = new plus.nativeObj.Bitmap('nwbitmap');

		console.log("aa");

		//开始原生动画
		var startAnimation = function(type, bitmap, callback) {
			console.log("aaaa");
			plus.nativeObj.View.startAnimation({
				type: type || 'pop-in' //默认
			}, {}, {
				bitmap: bitmap
			}, function() {
				console.log('动画结束');
				callback && callback();
				//关闭原生动画 
				//plus.nativeObj.View.clearAnimation();
			});
		}

		console.log("bb");

		//webview截图
		var drawWebView = function(webview, bitmap, callback) {
			bitmap = bitmap || new plus.nativeObj.Bitmap('defultBitMap');
			webview.draw(bitmap, function() {
				callback && callback(bitmap);
			}, function(err) {
				callback && callback();
				console.log('截图错误：' + JSON.stringify(err))
			});
		}

		console.log("cc");

		//webview onloaded事件
		nw.onloaded = function(e) {
			console.log("dd");
			//开始截图open
			drawWebView(nw, bitmap, function(bitmap) {
				console.log(bitmap)
				if(!bitmap) {
					nw.show('pop-in', 250);
					return;
				}
				//播放页面打开的动画
				startAnimation('pop-in', bitmap, function() {
					console.log("ee")
					//动画播放完毕后
					//显示webview
					nw.show('none', 0, function() {
						console.log("ff")
						//当webview关闭时
						nw.onclose = function() {
							//播放页面关闭动画
							startAnimation('pop-out', bitmap, function() {
								//关闭页面原生动画 
								plus.nativeObj.View.clearAnimation();
							});
						}
						//关闭页面原生动画 
						plus.nativeObj.View.clearAnimation();
					})
				});
			});
		}
	}

	/**
	 * 更新关注数
	 **/
	this.UpdateFan = function(userinfo, num) {
		if(num) {
			userinfo.Follows = num;
		} else {
			userinfo.Follows += 1;
		}
		localStorage.setItem('$userinfo', JSON.stringify(userinfo));
		base.RefreshUser();
	}

	/**
	 * 监听标题滑动切换
	 **/
	this.InitSlider = function(isbounce) {
		mui('.mui-slider').slider({
			bounce: isbounce
		});
		mui('.mui-scroll-wrapper.mui-slider-indicator.mui-segmented-control').scroll({
			scrollY: false,
			scrollX: true,
			indicators: false,
			bounce: false,
			snap: '.mui-control-item'
		});
	}

	/**
	 * 初始化滚动条
	 **/
	this.InitScroll = function(isbounce) {
		var deceleration = mui.os.ios ? 0.003 : 0.0009; // 阻尼系数
		mui('.mui-scroll-wrapper').scroll({
			bounce: isbounce ? isbounce : false,
			indicators: false, // 是否显示滚动条
			deceleration: deceleration
		});

		//base.ScrollTop();
	}

	/**
	 * 刷新滚动条
	 **/
	this.RefreshScroll = function() {
		mui(".mui-scroll-wrapper").scroll().refresh(); //刷新下拉
	}

	/**
	 * 双击顶部滚动到顶部
	 **/
	this.ScrollTop = function() {
		if(document.querySelectorAll('header').length > 0) {
			document.querySelector('header').addEventListener('doubletap', function() {
				mui.each(mui(".mui-scroll-wrapper"), function() {
					mui(this).scroll().scrollTo(0, 0, 1000);
				});
			});
		}
	}

	//双击顶部滚动到顶部
	this.ToTop = function() {
		base.Get("header").addEventListener("doubletap", function() {
			if(base.IsLoading) {
				return;
			}
			base.IsLoading = true;
			mui.scrollTo(0, 250);
			mui.later(function() {
				base.IsLoading = false;
			}, 250)
		}, false);
	}

	/**
	 * 更新用户信息
	 **/
	this.UpdateUser = function(id, callback) {
		HttpGet(base.RootUrl + "User/Info", {
			Number: id
		}, function(data) {
			if(data != null) {
				if(data.result) {
					data = data.message;
					var info = {
						ID: data.ID,
						Sex: data.Sex == "0" ? "男" : "女",
						Signature: data.Signature,
						Password: data.Password,
						Avatar: data.Avatar == "" ? base.DefaultImg : data.Avatar,
						NickName: data.NickName,
						Address: data.Address,
						Birthday: data.BirthdayText,
						Follows: data.Follows,
						Fans: data.Fans,
						Articles: data.Articles,
						Keeps: data.Keeps,
						Comments: data.Comments,
						Zans: data.Zans,
						Cover: data.Cover,
						Phone: data.Phone,
						WeiXin: data.WeiXin,
						QQ: data.QQ,
						Weibo: data.Weibo,
						ShareNick: data.ShareNick,
						AutoMusic: data.AutoMusic,
						IsPay: data.IsPay,
						Money: data.Money,
						UseDraw: data.UseDraw,
						Number: data.Number,
						ShowArticle: data.ShowArticle,
						ShowFollow: data.ShowFollow,
						ShowFan: data.ShowFan,
						ShowPush: data.ShowPush,
						ShowPosition: data.ShowPosition,
						UserRole: data.UserRole
					}
					localStorage.setItem('$userinfo', JSON.stringify(info));

					if(callback) {
						callback(info);
					}
				}
			}
		});
	}

	/**
	 * 展示用户信息
	 **/
	this.ShowUser = function(id) {
		mui(id).on('tap', '.user', function(event) {
			if(!base.TriggerMain) {
				return false;
			}
			var userid = this.getAttribute("userid");
			var nickname = this.getAttribute("nickname");
			var cover = this.getAttribute("cover");
			var avatar = this.getAttribute("avatar");
			base.OpenWindow("user" + userid, "user.html", {
				UserNumber: userid,
				NickName: nickname,
				Cover: cover,
				Avatar: avatar
			}, "", "none");
		});
	}

	/**
	 * 展示文章信息
	 **/
	this.ShowArticle = function(id, Source, currUserNumber) {
		mui(id).on('tap', '.article', function(event) {
			var articleId = this.getAttribute("articleid");
			var userNumber = this.getAttribute("userid");
			var power = this.getAttribute("power").toString();
			var nickname = this.getAttribute("nickname").toString();
			if(currUserNumber == userNumber) {
				power = 3;
			}
			base.OpenWindow("articledetail", "articledetail.html", {
				ArticleID: articleId,
				Source: Source,
				ArticlePower: power,
				NickName: nickname
			}, null, "none");
		});
	}

	/**
	 * 格式化缩略图显示
	 */
	this.ShowThumb = function(url, thumb) {
		if(base.IsNullOrEmpty(url)) {
			return base.DefaultImg;
		}
		if(url.indexOf('_0') < 0) {
			return url;
		}
		return url.replace("_0", "_" + thumb);
	}

	/**
	 * 分享日志
	 */
	this.ShareLog = function(userid, articleNumber, source) {
		HttpGet(base.RootUrl + "ShareLog/Edit", {
			ID: userid,
			ArticleNumber: articleNumber,
			Source: source
		}, function(data) {

		});
	}

	/**
	 * 切换Switch
	 */
	this.SwitchChange = function(id, isopen) {
		base.ToggleClass(["#" + id], "active", isopen);
	}

	/**
	 * 拼接用户列表
	 * item:JSON数据
	 * isSignature:是否显示签名
	 * isFollow:是否显示关注
	 * isDelete:是否显示删除
	 * deletNname:删除名称
	 * isDistance:显示距离
	 * isLazy:是否图片懒加载
	 */
	this.AppendUser = function(item, isSignature, isFollow, isDelete, deleteName, isDistance, isLazy, showAnimate) {
		/*var div = document.createElement('div');
		if(showAnimate) {
			div.className = 'mui-table-view-cell user user1 bounceInUp';
		} else {
			div.className = 'mui-table-view-cell user user1';
		}
		div.setAttribute("userid", item.Number);
		var model = [];
		if(isDelete) {
			model.push('<div class="mui-slider-right mui-disabled"><a class="mui-btn mui-btn-red">' + deleteName + '</a></div>');
			model.push('<div class="mui-slider-cell mui-slider-handle">');
		}
		model.push('<div class="mui-table oa-contact-cell">');
		if(isLazy) {
			model.push('<div class="mui-table-cell avatar"><img data-lazyload="' + base.ShowThumb(item.Avatar, 1) + '"  /></div>');
		} else {
			model.push('<div class="mui-table-cell avatar"><img src="' + base.ShowThumb(item.Avatar, 1) + '"  /></div>');
		}
		model.push('<div class="mui-table-cell"><p class="f14 mb5 c333">' + base.UnUnicodeText(item.NickName) + '</p>');
		if(isSignature) {
			model.push('<p class="f11 c999">' + base.UnUnicodeText(item.Signature) + '</p>');
		}
		if(isDistance) {
			var distance = parseFloat(item.Distance);
			var meter = parseInt(distance / 100);
			if(meter < 9) {
				model.push('<p class="f11 c999">' + (meter + 1) + '00米以内</p>');
			} else {
				model.push('<p class="f11 c999">' + (parseInt(distance / 1000) + 1) + '公里以内</p>');
			}
		}
		model.push('</div>');
		if(isFollow) {
			if(item.IsFollow == 0 && userinfo.Number != item.Number) {
				model.push('<div class="mui-table-cell guanzhu" userid="' + item.Number + '"><img src="../images/base/follow0.png" /></div>');
			} else {
				model.push('<div class="mui-table-cell guanzhu2"><img src="../images/base/follow1.png" /></div>');
			}
		}
		model.push('</div>');
		if(isDelete) {
			model.push('</div>');
		}
		div.innerHTML = model.join('');
		return div;*/

		var div = document.createElement('div');
		if(showAnimate) {
			div.className = 'mui-table-view-cell user user1 bounceInUp';
		} else {
			div.className = 'mui-table-view-cell user user1';
		}
		div.setAttribute("userid", item.Number);
		div.setAttribute("nickname", item.NickName);
		div.setAttribute("cover", item.Cover);
		div.setAttribute("avatar", item.Avatar);
		var model = [];
		if(isDelete) {
			model.push('<div class="mui-slider-right mui-disabled"><a class="mui-btn mui-btn-red">' + deleteName + '</a></div>');
			model.push('<div class="mui-slider-cell mui-slider-handle">');
		}
		model.push('<div class="flex-box flex-row">');
		//头像
		model.push('<div style="flex:0 0 16%;" class="flex-item tl">');
		if(isLazy) {
			model.push('<div class="avatar"><img data-lazyload="' + base.ShowThumb(item.Avatar, 1) + '" class="fl"  /></div>');
		} else {
			model.push('<div class="avatar"><img src="' + base.ShowThumb(item.Avatar, 1) + '" class="fl"  /></div>');
		}
		model.push('</div>');
		//昵称信息
		if(isFollow)
			model.push('<div style="flex:0 0 64%;" class="flex-item tl">');
		else
			model.push('<div style="flex:0 0 84%;" class="flex-item">');
		model.push('<p class="f14 c333">' + base.UnUnicodeText(item.NickName) + '</p>');
		if(isSignature) {
			model.push('<p class="f10 mt3 c999">' + base.UnUnicodeText(item.Signature) + '</p>');
		}
		if(isDistance) {
			var distance = parseFloat(item.Distance);
			var meter = parseInt(distance / 100);
			if(meter < 9) {
				model.push('<p class="f10 mt3 c999">' + (meter + 1) + '00米以内</p>');
			} else {
				model.push('<p class="f10 mt3 c999">' + (parseInt(distance / 1000) + 1) + '公里以内</p>');
			}
		}
		model.push('</div>');
		//关注
		if(isFollow) {
			model.push('<div style="flex:0 0 20%;" class="flex-item tr">');
			if(item.IsFollow == 0 && userinfo.Number != item.Number) {
				model.push('<div class="guanzhu" userid="' + item.Number + '"><img src="../images/base/follow0.png" class="fr" /></div>');
			} else {
				model.push('<div class="guanzhu2"><img src="../images/base/follow1.png" class="fr" /></div>');
			}
			model.push('</div>');
		}
		model.push('</div>');
		if(isDelete) {
			model.push('</div>');
		}
		div.innerHTML = model.join('');
		return div;
	}

	/**
	 * 用户列表添加关注
	 * id:容器ID
	 * userinfo:当前用户信息
	 */
	this.UserAddFan = function(id, userinfo) {
		mui(id).on('tap', '.guanzhu', function(event) {
			base.TriggerMain = false;
			if(base.IsLoading) {
				return false;
			}
			base.IsLoading = true;
			var $this = this;
			var UserNumber = this.getAttribute("userid");
			var data = {
				ID: userinfo.ID,
				ToUserNumber: UserNumber
			}
			HttpGet(base.RootUrl + "Api/Fan/Edit", data, function(data) {
				data = JSON.parse(data);
				base.CheckLogin(userinfo, data.code);
				if(data != null) {
					if(data.result) {
						$this.classList.remove("guanzhu");
						$this.classList.add("guanzhu2");
						$this.childNodes[0].setAttribute("src", "../images/base/follow1.png");
						base.UpdateFan(userinfo, data.message);
					}
					mui.toast(data.result ? "关注成功,在[关注]中可以找到Ta哦!" : data.message);
				} else {
					mui.toast("失败");
				}
				base.IsLoading = false;
				base.TriggerMain = true;
			});
		});
	}

	/**
	 * js Unicode编码
	 */
	this.UnicodeText = function(str) {
		if(base.IsNullOrEmpty(str)) {
			return "";
		}
		return escape(str).toLocaleLowerCase().replace(/%u/gi, '\\u');
	}

	/**
	 * js Unicode解码
	 */
	this.UnUnicodeText = function(str) {
		if(base.IsNullOrEmpty(str)) {
			return "";
		}
		return unescape(str.replace(/\\u/gi, '%u'));
	}

	/**
	 * 新增样式
	 * name:元素名称集合
	 * classname:样式名称集合
	 */
	this.AddClass = function(name, classname) {
		this.ToggleClass(name, classname, true);
	}

	/**
	 * 删除样式
	 * name:元素名称集合
	 * classname:样式名称集合
	 */
	this.RemoveClass = function(name, classname) {
		this.ToggleClass(name, classname, false);
	}

	/**
	 * 切换样式
	 * name:元素名称集合
	 * classname:样式名称集合
	 */
	this.ToggleClass = function(name, classnames, add) {
		if(base.IsNullOrEmpty(name)) {
			return;
		}
		var classname = classnames.split(' ');
		if(add) {
			mui.each(name, function(index1, n) {
				if(n.indexOf('.') < 0) {
					var item = mui(n)[0];
					mui.each(classname, function(index2, cn) {
						item.classList.add(cn);
					});
				} else {
					mui.each(classname, function(index2, cn) {
						mui(n).each(function(index3, item) {
							item.classList.add(cn);
						});
					});
				}
			});
		} else {
			mui.each(name, function(index1, n) {
				if(n.indexOf('.') < 0) {
					var item = mui(n)[0];
					mui.each(classname, function(index2, cn) {
						item.classList.remove(cn);
					});
				} else {
					mui.each(classname, function(index2, cn) {
						mui(n).each(function(index3, item) {
							item.classList.remove(cn);
						});
					});
				}
			});
		}
	}

	//是否包含样式
	this.HasClass = function(item, name) {
		return item.className.indexOf(name) >= 0;
	}

	//获取对象
	this.Get = function(name) {
		if(name.indexOf('.') < 0) {
			return mui("#" + name)[0];
		} else {
			return mui(name);
		}
	}

	//获取页面对象
	this.GetView = function(id) {
		return plus.webview.getWebviewById(id);
	}

	//刷新用户信息
	this.RefreshUser = function() {
		base.GetView("my").evalJS("Refresh()");
	}

	/**
	 * 初始化下拉
	 * id：容器ID
	 * downCallback：下拉回调方法
	 * upCallback：上拉回调方法
	 */
	this.InitPull = function(id, downCallback, upCallback) {
		mui(base.Get(id)).pullToRefresh({
			down: {
				callback: function() {
					if(downCallback) {
						downCallback();
					}
					var self = this;
					pulldownRefresh(self);
				}
			},
			up: {
				auto: true,
				callback: function() {
					if(upCallback) {
						upCallback();
					}
					var self = this;
					pullupRefresh(self);
				}
			}
		});
	}

	//浏览器前缀
	this.BrowserName = function() {
		var name = "";
		if(browser.versions.webKit) {
			name = "-webkit-"; //谷歌内核
		} else if(browser.versions.gecko) {
			name = "-moz-"; //火狐内核
		} else if(browser.versions.presto) {
			name = "-o-"; //opera内核
		} else if(browser.versions.trident) {
			name = "-ms-"; //IE内核 
		}
		return name;
	}

	//沉浸式状态栏
	this.Immersed = function(effect) {
		var immersed = 0;
		var ms = (/Html5Plus\/.+\s\(.*(Immersed\/(\d+\.?\d*).*)\)/gi).exec(navigator.userAgent);
		if(ms && ms.length >= 3) {
			immersed = parseFloat(ms[2]);
		}
		if(!immersed) {
			return;
		}
		var t = document.getElementById('header');
		if(t) {
			t.style.paddingTop = immersed + 'px';
			t.style.paddingBottom = '45px';
			if(t.getAttribute("immersed") != "none") {
				t.style.background = '-webkit-linear-gradient(left,#4e8cfb 0%,#24c3fb 75%,#39b8fd 100%)';
				var name = base.BrowserName();
				t.style.background = name + 'linear-gradient(left,#4e8cfb 0%,#24c3fb 75%,#39b8fd 100%)';

				t = document.getElementById('scroll-wrapper');
				if(t) {
					t.style.marginTop = immersed + 'px';
				}
			} else {
				t.style.background = "transparent";
				t = document.getElementById('scroll-wrapper');
				if(t) {
					t.style.marginTop = '0px';
				}
			}
		}
		t = document.getElementById('muicontent');
		if(t) {
			t.style.paddingTop = immersed + 45 + 'px';
		}
	}

	//打开模板页
	this.ShowTemplate = function(id, url, title, param, animate, top) {
		if(base.RepeatAction()) {
			return;
		}
		base.GetView("template").evalJS("InitPage('" + id + "', '" + url + "', '" + title + "', '" + param + "', '" + top + "')");
		base.GetView("template").show(base.IsNullOrEmpty(animate) ? base.ShowAnimate() : animate, base.AnimateDuration);
	}
}

/**
 * Get请求
 **/
function HttpGet(url, data, callback) {
	mui.getJSON(url, data, callback);
}

/**
 * Post请求
 **/
function HttpPost(url, data, callback) {
	mui.post(url, data, callback, 'json');
}

//样式切换
function ChangeSlider($this) {
	var item = $this.parentNode.children[0];
	item.style.width = $this.clientWidth + "px";
	item.style.transform = "translateX(" + $this.offsetLeft + "px)";
	base.RemoveClass([".tabs_item"], "is-active");
	$this.classList.add("is-active");
}

/**
 * 加载封装 
 * url：接口请求地址
 * data：接口请求参数
 * showNone：是否显示空提示
 * showNone：是否显示加载动画
 * appendCallback：拼接方法
 * endCallback：回调方法
 */
function LoadPull(url, data, showNone, showAnimate, appendCallback, endCallback) {
	HttpGet(url, data, function(data) {
		data = JSON.parse(data);
		if(data != null) {
			if(data.result) {
				data = data.message;
				totalpage = data.totalpage;
				records = data.records;
				if(showNone) {
					base.ShowNone(false);
				}
				var table = base.Get('scroll-view');
				if(records > 0) {
					if(showAnimate) {
						DelayEachArray(data.list, 0, 50, base.CurrAnimate, function(item) {
							var div = appendCallback(item);
							table.appendChild(div);
						})
					} else {
						//使用容器存放临时变更， 最后再一次性更新DOM
						var fragment = document.createDocumentFragment();
						mui.each(data.list, function(index, item) {
							fragment.appendChild(appendCallback(item));
						});
						table.appendChild(fragment);
					}
				}
			} else {
				totalpage = 1;
				records = 0;
			}
		}
		if(records == 0 && showNone) {
			base.ShowNone(true);
		}
		if(endCallback) {
			endCallback();
		}
		base.ShowLoading(false);
	});
}

/**
 * 动态加载JS 
 * url：JS地址
 * callback：回调方法
 */
function LoadScript(url, callback) {
	var script = document.createElement("script");
	script.type = "text/javascript";
	if(typeof(callback) != "undefined") {
		if(script.readyState) {
			script.onreadystatechange = function() {
				if(script.readyState == "loaded" || script.readyState == "complete") {
					script.onreadystatechange = null;
					callback();
				}
			};
		} else {
			script.onload = function() {
				callback();
			};
		}
	}
	script.src = url;
	document.body.appendChild(script);
}

/**
 * 延迟遍历 
 * arr：集合
 * index：当前遍历索引
 * delay：延迟毫秒数
 * curranimate：当前动画标识
 * callback：回调方法
 */
function DelayEachArray(arr, index, delay, curranimate, callback) {
	if(index == 0) {
		base.CurrAnimate = curranimate;
	}
	if(curranimate != base.CurrAnimate) {
		return;
	}

	if(callback) {
		callback(arr[index]);
	}
	index++;
	if(index < arr.length) {
		mui.later(function() {
			DelayEachArray(arr, index, delay, curranimate, callback);
		}, delay);
	} else {
		base.CurrAnimate = "";
	}
}

//返回顶部
function Top() {
	mui.scrollTo(0, 250);
}

//下拉启用
function SetPullEnable(enable, callback) {
	if(enable) {
		self.setPullToRefresh({
			support: true,
			height: "100px",
			style: "circle"
		}, function() {
			if(callback) {
				callback();
			} else {
				pulldownRefresh();
			}
		});
	} else {
		self.setPullToRefresh({
			support: false,
			style: "circle",
			height: "0px"
		}, function() {

		});
	}
}

//推送类型
var PushType = {
	Comment: 1, //用户评论
	Money: 2, //用户打赏
	Fan: 3, //关注用户
	FanArticle: 4, //关注用户发布文章
	Article: 5, //系统文章推荐
	Update: 10 //APP升级
}