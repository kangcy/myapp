var ArticleNumber="";var ParentCommentNumber=0;var ParentUserNumber=0;var Count=0;var NewId=0;var editor=null;var mask=base.CreateMask(false,function(){base.CloseWaiting();$(".emojionearea").removeClass("zoomIn").addClass("zoomOut hide");$("#bottomAction").removeClass("hide").addClass("bounceIn");if(editor!=null){editor[0].emojioneArea.setText("")}});function InitComment(){pulldownRefresh(function(){NewId=0});base.ShowUser("#scroll-view");mui("#scroll-view").on("tap",".goods",function(){if(isLoading){return}isLoading=true;var a=this.getAttribute("cid");HttpGet(base.RootUrl+"Api/Zan/CommentZanEdit",{ID:userinfo.ID,CommentNumber:a},function(d){d=JSON.parse(d);base.CheckLogin(userinfo,d.code);if(d!=null){if(d.result){var c=$("#goods"+a);var b=parseInt(c.find("span").html());var e=d.message.split("|");if(e[0]==1){c.removeClass("heartbeat red");c.attr("already","0");c.find("img").attr("src","../images/article/btn_good.png");c.find("span").html(b-1<0?0:b-1)}else{c.addClass("heartbeat red");c.attr("already","1");c.find("img").attr("src","../images/article/btn_good2.png");c.find("span").html(b+1)}}}else{mui.toast("失败")}isLoading=false})});mui("#scroll-view").on("tap",".comments",function(){if(isLoading){return}isLoading=true;ParentCommentNumber=this.getAttribute("cid");ParentUserNumber=this.getAttribute("userid");ArticleNumber=this.getAttribute("articlenumber");Count=this.getAttribute("count");if(editor==null){editor=$("#textarea").emojioneArea({template:"<editor/><filters/><tabs/>"})}EditorShow();isLoading=false});mui("#scroll-view").on("tap",".sub",function(){var b=this.getAttribute("number");var a=this.getAttribute("name");base.OpenWindow("subcomment","subcomment.html",{Number:b,ArticleNumber:ArticleNumber,Name:a})})}function Comment(){ParentCommentNumber="";ParentUserNumber="";if(editor==null){editor=$("#textarea").emojioneArea({template:"<editor/><filters/><tabs/>"})}EditorShow()}function EditorShow(){mask.show();$("#bottomAction").removeClass("bounceIn").addClass("hide");$(".emojionearea").removeClass("zoomOut hide").addClass("zoomIn")}function EditorHide(){$(".emojionearea").removeClass("zoomIn").addClass("zoomOut hide");$("#bottomAction").removeClass("hide").addClass("bounceIn");if(editor!=null){editor[0].emojioneArea.setText("")}}function EditorClose(){mask.close()}function AppendStr(b){var c=document.createElement("div");c.className="mui-table-view-cell";c.setAttribute("id","article"+b.Number);var a=[];a.push('<div class="mui-slider-cell mt10 mb10"><div class="oa-contact-cell mui-table">');a.push('<div class="mui-table-cell oa-contact-avatar"><img src="'+base.ShowThumb(b.Avatar,1)+'" class="user" userid="'+b.UserNumber+'" /></div>');a.push('<div class="mui-table-cell pb0"><p class="f13 user c333" userid="'+b.UserNumber+'">'+base.UnUnicodeText(b.NickName)+'<span class="fr f11 c999">'+b.CreateDateText+"</span></p>");a.push('<p class="f12 c999 mt3 mb10" style="line-height:1.3rem;">'+base.UnUnicodeText(b.Summary)+"</p>");a.push('<p class="tip tip1 mb0 f12 '+(b.SubCommentCount>1?"":"hide")+'"><span class="blue sub" number="'+b.Number+'" id="comment0'+b.Number+'" name="'+b.NickName+'">查看'+b.SubCommentCount+"条回复</span></p>");a.push('<p class="tip tip0 mb0 f12 '+(b.SubCommentCount==1?"":"hide")+'"><span class="c999">'+base.UnUnicodeText(b.SubUserName)+" : "+base.UnUnicodeText(b.SubSummary)+"</span></p>");a.push('<div class="full tr mt10 mb5 c999" style="display:inline-block;"><img src="../images/article/btn_comment.png" style="width:0.9rem;" class="ml15 fr mt1 comments" cid="'+b.Number+'" userid="'+b.UserNumber+'" articlenumber="'+b.ArticleNumber+'" count="'+b.SubCommentCount+'" id="comment1'+b.Number+'" />');a.push('<div id="goods'+b.Number+'" cid="'+b.Number+'" already="'+(b.IsZan==0?0:1)+'" class="goods fr '+(b.IsZan==0?"":"red")+'"><span class="f13 ml5 fr" >'+b.Goods+'</span><img src="../images/article/'+(b.IsZan==0?"btn_good":"btn_good2")+'.png" style="width:0.9rem;" class="ml15 fr"  />');a.push("</div></div></div></div>");c.innerHTML=a.join("");return c}function AppendComment(){HttpGet(base.RootUrl+"Api/Comment/Detail",{ID:NewId},function(b){b=JSON.parse(b);base.CheckLogin(userinfo,b.code);if(b!=null){if(b.result){$("#none").addClass("hide");var a=base.Get("scroll-view");var c=AppendStr(b.message);a.appendChild(c)}}else{mui.toast("失败")}isLoading=false})}function EditorSubmit(){if(isLoading){return}isLoading=true;if(editor==null){isLoading=false;return mui.toast("信息异常")}var a=editor[0].emojioneArea.getHtml();if(base.IsNullOrEmpty(a)){isLoading=false;return mui.toast("请填写内容")}mask.show();base.ShowWaiting("正在提交");EditorHide();HttpGet(base.RootUrl+"Api/Comment/Edit",{ID:userinfo.ID,ArticleNumber:ArticleNumber,ParentCommentNumber:ParentCommentNumber,ParentUserNumber:ParentUserNumber,Summary:escape(a)},function(b){b=JSON.parse(b);base.CheckLogin(userinfo,b.code);mui.later(function(){mask.close();mui.toast(b.result?"感谢您的评论":b.message);if(b.result){NewId=b.message;if(base.IsNullOrEmpty(ParentCommentNumber)){AppendComment()}else{var c=$("#comment0"+ParentCommentNumber);var f=c.parents(".mui-table-view-cell");var d=(parseInt(Count)+1);c.html("查看"+d+"条回复");f.find(".tip0").find("span").html(base.UnUnicodeText(userinfo.NickName)+" : "+base.UnUnicodeText(a));if(d==1){f.find(".tip1").addClass("hide");f.find(".tip0").removeClass("hide")}if(d>1){f.find(".tip0").addClass("hide");f.find(".tip1").removeClass("hide")}$("#comment1"+ParentCommentNumber).attr("count",d)}var e=base.GetView("articledetail");if(e){e.evalJS("UpdateComment()")}}isLoading=false},500)})};